{% extends 'composant_generale/admin/base.html' %}
{% load static %}

{% block title %}Modifier la promotion {{ promotion.nom }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <!-- En-tête -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Modifier la promotion</h1>
            <p class="mt-1 text-sm text-gray-600">Modifiez les détails de la promotion et ses articles associés.</p>
        </div>

        <!-- Formulaire -->
        <div class="bg-white shadow rounded-lg">
            <form method="POST" class="p-6 space-y-6">
                {% csrf_token %}
                
                <!-- Informations de base -->
                <div class="space-y-4">
                    <!-- Nom -->
                    <div>
                        <label for="{{ form.nom.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.nom.label }} *</label>
                        {{ form.nom }}
                        {% if form.nom.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.nom.errors|join:", " }}</p>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.description.errors|join:", " }}</p>
                        {% endif %}
                    </div>

                    <!-- Pourcentage de réduction -->
                    <div>
                        <label for="{{ form.pourcentage_reduction.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.pourcentage_reduction.label }} *</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            {{ form.pourcentage_reduction }}
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm">%</span>
                            </div>
                        </div>
                        {% if form.pourcentage_reduction.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.pourcentage_reduction.errors|join:", " }}</p>
                        {% endif %}
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ form.date_debut.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.date_debut.label }} *</label>
                            {{ form.date_debut }}
                            {% if form.date_debut.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.date_debut.errors|join:", " }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.date_fin.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.date_fin.label }} *</label>
                            {{ form.date_fin }}
                            {% if form.date_fin.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.date_fin.errors|join:", " }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Statut -->
                    <div class="flex items-center">
                        {{ form.active }}
                        <label for="{{ form.active.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                            Promotion active
                        </label>
                        {% if form.active.errors %}
                            <p class="ml-2 text-sm text-red-600">{{ form.active.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Articles -->
                <div>
                    <label for="{{ form.articles.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.articles.label }} *</label>
                    
                    <!-- Filtres et recherche d'articles -->
                    <div class="mb-4 space-y-3">
                        <div class="flex flex-col md:flex-row gap-3">
                            <!-- Champ de recherche -->
                            <div class="w-full md:w-1/3">
                                <label for="{{ form.article_search.id_for_label }}" class="block text-xs font-medium text-gray-500">{{ form.article_search.label }}</label>
                                {{ form.article_search }}
                            </div>
                            
                            <!-- Filtres -->
                            <div class="w-full md:w-1/3">
                                <label for="{{ form.article_filter_categorie.id_for_label }}" class="block text-xs font-medium text-gray-500">{{ form.article_filter_categorie.label }}</label>
                                {{ form.article_filter_categorie }}
                            </div>
                            <div class="w-full md:w-1/3">
                                <label for="{{ form.article_filter_couleur.id_for_label }}" class="block text-xs font-medium text-gray-500">{{ form.article_filter_couleur.label }}</label>
                                {{ form.article_filter_couleur }}
                            </div>
                        </div>
                        
                        <!-- Compteur d'articles sélectionnés -->
                        <div class="text-sm text-gray-600">
                            <span id="selected-count">0</span> article(s) sélectionné(s) sur <span id="total-count">0</span> disponible(s)
                        </div>
                    </div>
                    
                    <!-- Liste des articles -->
                    <div class="max-h-60 overflow-y-auto border rounded-md p-4">
                        {{ form.articles }}
                    </div>
                    {% if form.articles.errors %}
                        <p class="mt-2 text-sm text-red-600">{{ form.articles.errors|join:", " }}</p>
                    {% endif %}
                </div>

                <!-- Boutons d'action -->
                <div class="flex justify-end space-x-3 pt-6 border-t">
                    <a href="{% url 'article:detail_promotion' promotion.id %}" 
                       class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Annuler
                    </a>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if messages %}
<div class="fixed bottom-0 right-0 m-6">
    {% for message in messages %}
    <div class="bg-white border-l-4 {% if message.tags == 'error' %}border-red-500{% else %}border-green-500{% endif %} text-gray-700 p-4 mb-4 shadow-lg rounded-r">
        <p>{{ message }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Masquer les messages après 5 secondes
    setTimeout(function() {
        const messages = document.querySelectorAll('.messages div');
        messages.forEach(function(message) {
            message.style.display = 'none';
        });
    }, 5000);
    
    // Styliser les champs du formulaire
    document.addEventListener('DOMContentLoaded', function() {
        // Style pour le textarea
        document.querySelectorAll('textarea').forEach(function(textarea) {
            textarea.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'shadow-sm', 'focus:border-purple-500', 'focus:ring-purple-500');
        });
        
        // Style pour les inputs
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(input) {
            input.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'shadow-sm', 'focus:border-purple-500', 'focus:ring-purple-500');
        });
        
        // Style pour les inputs datetime
        document.querySelectorAll('input[type="datetime-local"]').forEach(function(input) {
            input.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'shadow-sm', 'focus:border-purple-500', 'focus:ring-purple-500');
            
            // S'assurer que la valeur est au format ISO 8601
            if (input.value) {
                // Tenter de convertir au format correct si nécessaire
                try {
                    const date = new Date(input.value);
                    if (!isNaN(date.getTime())) {
                        // Format ISO 8601 sans secondes (compatible avec datetime-local)
                        const isoString = date.toISOString().slice(0, 16);
                        input.value = isoString;
                    }
                } catch (e) {
                    console.error("Erreur lors de la conversion de la date:", e);
                }
            }
        });
        
        // Style pour les checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
            checkbox.classList.add('h-4', 'w-4', 'text-purple-600', 'focus:ring-purple-500', 'border-gray-300', 'rounded');
        });
        
        // Style pour les selects
        document.querySelectorAll('select').forEach(function(select) {
            select.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'shadow-sm', 'focus:border-purple-500', 'focus:ring-purple-500');
        });
        
        // Gestion des dates au moment de la soumission du formulaire
        const promotionForm = document.querySelector('form');
        if (promotionForm) {
            promotionForm.addEventListener('submit', function(e) {
                const dateDebut = document.querySelector('[name="date_debut"]');
                const dateFin = document.querySelector('[name="date_fin"]');
                
                // Vérifier si les dates sont valides
                if (dateDebut && !dateDebut.validity.valid) {
                    e.preventDefault();
                    alert('La date de début est dans un format incorrect. Utilisez le format AAAA-MM-JJThh:mm');
                    return;
                }
                
                if (dateFin && !dateFin.validity.valid) {
                    e.preventDefault();
                    alert('La date de fin est dans un format incorrect. Utilisez le format AAAA-MM-JJThh:mm');
                    return;
                }
                
                // Comparer les dates
                if (dateDebut && dateFin && new Date(dateDebut.value) >= new Date(dateFin.value)) {
                    e.preventDefault();
                    alert('La date de fin doit être postérieure à la date de début.');
                    return;
                }
            });
        }
        
        // Fonctionnalités de recherche et filtrage
        const searchInput = document.querySelector('.article-search-input');
        const categoryFilter = document.querySelector('[data-filter="categorie"]');
        const colorFilter = document.querySelector('[data-filter="couleur"]');
        const checkboxes = document.querySelectorAll('.article-selection input[type="checkbox"]');
        
        // Mettre à jour le compteur d'articles
        function updateCounter() {
            const totalItems = document.querySelectorAll('.article-selection input[type="checkbox"]:not([style*="display: none"])').length;
            const selectedItems = document.querySelectorAll('.article-selection input[type="checkbox"]:checked').length;
            
            document.getElementById('total-count').textContent = totalItems;
            document.getElementById('selected-count').textContent = selectedItems;
        }
        
        // Ajouter des attributs data- aux éléments de liste pour faciliter le filtrage
        checkboxes.forEach(function(checkbox) {
            const label = checkbox.nextElementSibling;
            if (label) {
                const text = label.textContent.trim();
                const parts = text.split(' - ');
                
                if (parts.length >= 3) {
                    const labelContainer = checkbox.parentElement;
                    labelContainer.setAttribute('data-nom', parts[0].toLowerCase());
                    labelContainer.setAttribute('data-couleur', parts[1].toLowerCase());
                    labelContainer.setAttribute('data-categorie', parts.length > 3 ? parts[3].toLowerCase() : '');
                }
            }
        });
        
        // Fonction de filtrage
        function filterArticles() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value.toLowerCase();
            const selectedColor = colorFilter.value.toLowerCase();
            
            document.querySelectorAll('.article-selection > div').forEach(function(item) {
                const nom = item.getAttribute('data-nom') || '';
                const couleur = item.getAttribute('data-couleur') || '';
                const categorie = item.getAttribute('data-categorie') || '';
                
                const matchesSearch = searchTerm === '' || nom.includes(searchTerm);
                const matchesCategory = selectedCategory === '' || categorie === selectedCategory;
                const matchesColor = selectedColor === '' || couleur === selectedColor;
                
                if (matchesSearch && matchesCategory && matchesColor) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateCounter();
        }
        
        // Événements
        if (searchInput) searchInput.addEventListener('input', filterArticles);
        if (categoryFilter) categoryFilter.addEventListener('change', filterArticles);
        if (colorFilter) colorFilter.addEventListener('change', filterArticles);
        
        // Initialiser le compteur
        updateCounter();
        
        // Événement pour les cases à cocher
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', updateCounter);
        });
        
        // Bouton pour tout sélectionner/désélectionner
        const selectAllBtn = document.createElement('button');
        selectAllBtn.type = 'button';
        selectAllBtn.className = 'text-sm text-purple-600 hover:text-purple-800 mb-2';
        selectAllBtn.textContent = 'Tout sélectionner';
        selectAllBtn.onclick = function() {
            const visibleCheckboxes = document.querySelectorAll('.article-selection input[type="checkbox"]:not([style*="display: none"])');
            const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);
            
            visibleCheckboxes.forEach(function(checkbox) {
                checkbox.checked = !allChecked;
            });
            
            this.textContent = allChecked ? 'Tout sélectionner' : 'Tout désélectionner';
            updateCounter();
        };
        
        // Ajouter le bouton avant la liste des articles
        const articleContainer = document.querySelector('.article-selection').parentElement;
        articleContainer.insertBefore(selectAllBtn, document.querySelector('.article-selection'));
    });
</script>
{% endblock %} 