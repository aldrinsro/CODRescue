{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}

{% block title %}Créer Commande - YZ-CMD{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, var(--confirmation-primary), var(--confirmation-light));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-plus-circle mr-3" style="color: var(--confirmation-border-accent);"></i>
                Nouvelle Commande
            </h1>
            <p style="color: var(--confirmation-border-accent);">Enregistrez une nouvelle commande dans le système.</p>
        </div>
        <a href="{% url 'operatConfirme:liste_commandes' %}" class="mt-4 md:mt-0 inline-flex items-center text-white px-4 py-2 rounded-lg font-medium transition-all shadow-md hover:shadow-lg" style="background-color: var(--confirmation-primary); hover:background-color: var(--confirmation-light);">
            <i class="fas fa-arrow-left mr-2"></i>Retour à la liste
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-8" style="border-color: var(--confirmation-border-accent);">
        <form method="post" id="commandeForm">
            {% csrf_token %}

            <!-- Section Client -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--confirmation-primary);">
                    <i class="fas fa-user mr-2"></i>
                    Informations Client
                </h3>
                
                <!-- Type de client -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Type de client</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="type_client" value="existant" checked 
                                   class="form-radio" style="color: var(--confirmation-primary);">
                            <span class="ml-2">Client existant</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="type_client" value="nouveau" 
                                   class="form-radio" style="color: var(--confirmation-primary);">
                            <span class="ml-2">Nouveau client</span>
                        </label>
                    </div>
                </div>

                <!-- Section client existant -->
                <div id="section-client-existant" class="mb-6">
                    <!-- Recherche par numéro de téléphone -->
                    <div class="mb-4">
                        <label for="recherche_telephone" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Rechercher par numéro de téléphone</label>
                        <div class="flex gap-2">
                            <input type="tel" id="recherche_telephone" placeholder="Ex: 06XXXXXXXX" 
                                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                            <button type="button" id="btn_rechercher_client" class="px-4 py-3 text-white rounded-lg font-medium transition-all shadow-md" style="background-color: var(--confirmation-primary);">
                                <i class="fas fa-search mr-2"></i>Rechercher
                            </button>
                        </div>
                        <div id="resultat_recherche" class="mt-2 hidden">
                            <!-- Les résultats de recherche apparaîtront ici -->
                        </div>
                </div>

                    <!-- Sélection manuelle -->
                        <div>
                        <label for="client" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Ou sélectionner manuellement</label>
                            <select name="client" id="client" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                                <option value="">Sélectionner un client</option>
                                {% for client in clients %}
                                <option value="{{ client.pk }}">{{ client.get_full_name }} ({{ client.numero_tel }})</option>
                        {% endfor %}
                    </select>
                    </div>
                </div>

                <!-- Section nouveau client -->
                <div id="section-nouveau-client" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nouveau_prenom" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Prénom</label>
                            <input type="text" id="nouveau_prenom" name="nouveau_prenom" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="nouveau_nom" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Nom</label>
                            <input type="text" id="nouveau_nom" name="nouveau_nom" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="nouveau_telephone" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Téléphone</label>
                            <input type="tel" id="nouveau_telephone" name="nouveau_telephone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                        </div>
                        <div>
                            <label for="nouveau_email" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Email (Optionnel)</label>
                            <input type="email" id="nouveau_email" name="nouveau_email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Livraison -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--confirmation-primary);">
                    <i class="fas fa-truck mr-2"></i>
                    Informations de Livraison
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="ville_livraison" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Ville de livraison</label>
                        <select name="ville_livraison" id="ville_livraison" onchange="chargerRegionEtFrais()" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                            <option value="">Sélectionner une ville...</option>
                            {% for ville in villes %}
                                <option value="{{ ville.pk }}" 
                                        data-frais="{{ ville.frais_livraison|stringformat:'.2f' }}"
                                        data-region="{{ ville.region.nom_region|default:'' }}"
                                        data-delai-min="{{ ville.Delai_livraison_min|default:0 }}"
                                        data-delai-max="{{ ville.Delai_livraison_max|default:0 }}">
                                    {{ ville.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="frais_livraison" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Frais de livraison (DH)</label>
                        <div class="flex gap-2">
                            <input type="text" id="frais_livraison" name="frais_livraison" class="flex-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                            <button type="button" id="toggle_frais_livraison" onclick="toggleFraisLivraison()" class="px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-toggle-off" id="frais_icon"></i>
                            </button>
                        </div>
                        <input type="hidden" name="frais_livraison_actif" id="frais_livraison_actif" value="true">
                    </div>
                    
                    <div>
                        <label for="region_livraison" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Région de livraison</label>
                        <input type="text" id="region_livraison" name="region_livraison" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                    </div>
                    
                    <div>
                        <label for="delai_livraison" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Délai de livraison</label>
                        <input type="text" id="delai_livraison" name="delai_livraison" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="adresse" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Adresse complète</label>
                        <textarea name="adresse" id="adresse" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Section de la commande -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--confirmation-primary);">
                    <i class="fas fa-info-circle mr-2"></i>
                    Informations sur la commande
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Source de la commande -->
                    <div>
                        <label for="source" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Source de la commande :</label>
                        <select name="source" id="source" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                            <option value="">Sélectionner une source...</option>
                            <option value="Appel">Appel</option>
                            <option value="Whatsapp">Whatsapp</option>
                            <option value="SMS">SMS</option>
                            <option value="Email">Email</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Youcan">Youcan</option>
                            <option value="Shopify">Shopify</option>
                        </select>
                    </div>
                    
                    <!-- Statut de paiement -->
                    <div>
                        <label for="payement" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Statut de paiement :</label>
                        <select name="payement" id="payement" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--confirmation-border-accent)] focus:border-transparent transition duration-200">
                            <option value="Non payé" selected>Non payé</option>
                            <option value="Payé">Payé</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section Articles -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: var(--confirmation-primary);">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Articles
                    <span class="ml-2 text-sm font-normal text-gray-500">(Optionnel)</span>
                </h3>
                
                <!-- Message informatif -->
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium">Les articles sont optionnels</p>
                            <p>Vous pouvez créer une commande sans articles et les ajouter plus tard via la modification.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Container pour les articles ajoutés -->
                <div id="articles-container" class="space-y-4 mb-6">
                    <!-- Les articles seront ajoutés ici par JavaScript -->
                </div>

                <!-- Bouton pour ouvrir le modal directement -->
                <button type="button" id="btn-ouvrir-modal" onclick="ouvrirModalAjouterArticle(event)" class="mt-4 inline-flex items-center px-4 py-2 text-white rounded-lg font-medium transition-all shadow-md" style="background-color: var(--confirmation-primary);">
                    <i class="fas fa-plus mr-2"></i>
                    Ajouter un article
                            </button>
            </div>

            <!-- Options et Total -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 mb-6 pt-4 border-t" style="border-color: var(--confirmation-border-accent);">
             
                    <div>
                    <label for="total_cmd" class="block text-sm font-medium mb-2" style="color: var(--confirmation-primary);">Total Commande (DH)</label>
                    <input type="number" name="total_cmd" id="total_cmd" step="0.01" min="0" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                </div>
            </div>

            <!-- Bouton de soumission -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Vous pouvez créer la commande avec ou sans articles
                </div>
            <button type="submit" class="px-6 py-3 text-white rounded-lg font-medium transition-all shadow-md" style="background-color: var(--confirmation-primary); hover:background-color: var(--confirmation-light);">
                <i class="fas fa-save mr-2"></i>
                Créer la commande
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal réutilisable pour ajouter des articles -->
{% include 'composant_generale/modal_ajout_articles.html' %}

<!-- Script JSON pour les articles disponibles -->
{{ articles_json|json_script:"articles-data" }}

<!-- Inclusion du JavaScript du modal réutilisable -->
<script src="{% static 'js/modal_ajout_articles.js' %}?v={{ request.META.SERVER_NAME|default:'local' }}{{ request.META.SERVER_PORT|default:'8000' }}"></script>

<!-- Script de diagnostic -->
<script>
    // Vérifier que le script est chargé
    window.addEventListener('load', function() {
        console.log('🔍 Diagnostic du modal d\'ajout d\'articles:');
        console.log('- Fonction ouvrirModalAjouterArticle:', typeof ouvrirModalAjouterArticle);
        console.log('- Modal articleModal:', document.getElementById('articleModal') ? '✅ Trouvé' : '❌ Non trouvé');
        console.log('- Modal variantModal:', document.getElementById('variantModal') ? '✅ Trouvé' : '❌ Non trouvé');
        console.log('- Bouton btn-ouvrir-modal:', document.getElementById('btn-ouvrir-modal') ? '✅ Trouvé' : '❌ Non trouvé');
        
        if (typeof ouvrirModalAjouterArticle !== 'function') {
            console.error('❌ PROBLÈME: Fonction ouvrirModalAjouterArticle non disponible');
            console.log('🔍 Tentative de rechargement du script...');
            
            // Créer un nouveau script
            const script = document.createElement('script');
            script.src = "{% static 'js/modal_ajout_articles.js' %}";
            script.onload = function() {
                console.log('✅ Script rechargé avec succès');
                console.log('- Fonction ouvrirModalAjouterArticle:', typeof ouvrirModalAjouterArticle);
            };
            script.onerror = function() {
                console.error('❌ Erreur lors du rechargement du script');
            };
            document.head.appendChild(script);
        }
    });
</script>

<script>
console.log('🚀 Script de la page de création chargé');
console.log('🔧 Fonction ouvrirModalAjouterArticle disponible:', typeof ouvrirModalAjouterArticle);

// Fonction pour charger automatiquement la région, les frais et les délais
function chargerRegionEtFrais() {
    const villeSelect = document.getElementById('ville_livraison');
    const selectedOption = villeSelect.options[villeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const region = selectedOption.getAttribute('data-region');
        const frais = selectedOption.getAttribute('data-frais');
        const delaiMin = selectedOption.getAttribute('data-delai-min');
        const delaiMax = selectedOption.getAttribute('data-delai-max');
        
        // Formater les frais avec 2 décimales
        const fraisFormates = parseFloat(frais || 0).toLocaleString('fr-FR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        document.getElementById('frais_livraison').value = fraisFormates;
        document.getElementById('region_livraison').value = region || '';
        document.getElementById('delai_livraison').value = `${delaiMin} - ${delaiMax} jours`;
        
        // Mettre à jour l'état du toggle des frais de livraison
        updateFraisLivraisonToggle();
        
        // Recalculer le total avec les nouveaux frais de livraison
        if (typeof calculerTotal === 'function') {
            calculerTotal();
        }
        console.log(`🏙️ Ville changée: ${selectedOption.text}, Frais: ${fraisFormates} DH, Livreur: ${region}, Délai: ${delaiMin}-${delaiMax} jours`);
    }
    else {
        // Réinitialiser les champs si aucune ville n'est sélectionnée
        document.getElementById('frais_livraison').value = '';
        document.getElementById('region_livraison').value = '';
        document.getElementById('delai_livraison').value = '';
        updateFraisLivraisonToggle();
        
        // Recalculer le total sans frais de livraison
        if (typeof calculerTotal === 'function') {
            calculerTotal();
        }
    }
}

// Fonction pour basculer l'activation des frais de livraison
function toggleFraisLivraison() {
    const toggleButton = document.getElementById('toggle_frais_livraison');
    const fraisIcon = document.getElementById('frais_icon');
    const fraisActifInput = document.getElementById('frais_livraison_actif');
    const fraisInput = document.getElementById('frais_livraison');
    
    const isActif = fraisActifInput.value === 'true';
    
    if (isActif) {
        // Désactiver les frais de livraison
        fraisActifInput.value = 'false';
        toggleButton.className = 'px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors';
        fraisIcon.className = 'fas fa-toggle-off';
        fraisInput.style.backgroundColor = '#f3f4f6';
        fraisInput.style.color = '#6b7280';
        
        console.log('🚫 Frais de livraison désactivés');
    } else {
        // Activer les frais de livraison
        fraisActifInput.value = 'true';
        toggleButton.className = 'px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors';
        fraisIcon.className = 'fas fa-toggle-on';
        fraisInput.style.backgroundColor = '#dcfce7';
        fraisInput.style.color = '#166534';
        
        console.log('✅ Frais de livraison activés');
    }
    
    // Recalculer le total avec les nouveaux frais de livraison
    if (typeof calculerTotal === 'function') {
        calculerTotal();
    }
}

// Fonction pour mettre à jour l'apparence du toggle selon l'état
function updateFraisLivraisonToggle() {
    const fraisActifInput = document.getElementById('frais_livraison_actif');
    const toggleButton = document.getElementById('toggle_frais_livraison');
    const fraisIcon = document.getElementById('frais_icon');
    const fraisInput = document.getElementById('frais_livraison');
    
    const isActif = fraisActifInput.value === 'true';
    
    if (isActif) {
        toggleButton.className = 'px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors';
        fraisIcon.className = 'fas fa-toggle-on';
        fraisInput.style.backgroundColor = '#dcfce7';
        fraisInput.style.color = '#166534';
    } else {
        toggleButton.className = 'px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors';
        fraisIcon.className = 'fas fa-toggle-off';
        fraisInput.style.backgroundColor = '#f3f4f6';
        fraisInput.style.color = '#6b7280';
    }
}

/**
 * Gestion de l'affichage des sections selon le type de client
 * Affiche/masque les sections client existant vs nouveau client
 */
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser l'affichage du type de client
    const typeClientRadios = document.querySelectorAll('input[name="type_client"]');
    
    if (typeClientRadios.length === 0) {
        console.warn('⚠️ Aucun radio button type_client trouvé');
            return;
        }

    typeClientRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const clientExistantSection = document.getElementById('section-client-existant');
            const nouveauClientSection = document.getElementById('section-nouveau-client');
            
            if (!clientExistantSection || !nouveauClientSection) {
                console.error('❌ Sections client non trouvées');
                return;
            }
            
            if (this.value === 'existant') {
                clientExistantSection.style.display = 'block';
                nouveauClientSection.style.display = 'none';
                
                const nouveauClientFields = [
                    'nouveau_prenom',
                    'nouveau_nom', 
                    'nouveau_telephone',
                    'nouveau_email'
                ];
                
                nouveauClientFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = '';
                    }
                });
            }
            else {
                clientExistantSection.style.display = 'none';
                nouveauClientSection.style.display = 'block';
                
                const clientSelect = document.getElementById('client');
                if (clientSelect) {
                    clientSelect.selectedIndex = 0;
                }
            }
        });
    });
    
    const checkedRadio = Array.from(typeClientRadios).find(radio => radio.checked);
    if (checkedRadio) {
        checkedRadio.dispatchEvent(new Event('change'));
    }

    // Event listener pour le changement de ville
    const villeSelect = document.getElementById('ville_livraison');
    if (villeSelect) {
        villeSelect.addEventListener('change', chargerRegionEtFrais);
        
        // Charger les données initiales
        chargerRegionEtFrais();
    }

    // Recherche de client par téléphone
    const btnRechercherClient = document.getElementById('btn_rechercher_client');
    if (btnRechercherClient) {
        btnRechercherClient.addEventListener('click', function() {
            const telephone = document.getElementById('recherche_telephone').value.trim();
            const resultatDiv = document.getElementById('resultat_recherche');
            
            if (!telephone) {
                alert('Veuillez saisir un numéro de téléphone');
        return;
    }
    
            // Afficher un indicateur de chargement
            resultatDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Recherche en cours...</div>';
            resultatDiv.classList.remove('hidden');
            
            // Faire la requête AJAX
            fetch(`/operateur-confirme/rechercher-client-telephone/?telephone=${encodeURIComponent(telephone)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.client) {
                        // Client trouvé
                        resultatDiv.innerHTML = `
                            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-semibold">${data.client.nom_complet}</div>
                                        <div class="text-sm">📞 ${data.client.numero_tel}</div>
                                        ${data.client.email ? `<div class="text-sm">📧 ${data.client.email}</div>` : ''}
                                        ${data.client.adresse ? `<div class="text-sm">📍 ${data.client.adresse}</div>` : ''}
                                    </div>
                                    <button type="button" onclick="selectionnerClientRecherche(${data.client.id}, '${data.client.nom_complet}', '${data.client.numero_tel}')" 
                                            class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                        <i class="fas fa-check mr-1"></i>Sélectionner
                        </button>
            </div>
            </div>
                        `;
                    } else {
                        // Aucun client trouvé
                        resultatDiv.innerHTML = `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                ${data.error || 'Aucun client trouvé avec ce numéro de téléphone'}
            </div>
        `;
        }
    })
    .catch(error => {
                    console.error('Erreur lors de la recherche:', error);
                    resultatDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Erreur lors de la recherche. Veuillez réessayer.
            </div>
        `;
                });
        });
    }

    // Recherche automatique lors de la saisie
    const rechercheTelephoneInput = document.getElementById('recherche_telephone');
    if (rechercheTelephoneInput) {
        rechercheTelephoneInput.addEventListener('input', function() {
            const resultatDiv = document.getElementById('resultat_recherche');
            if (this.value.length === 0) {
                resultatDiv.classList.add('hidden');
            }
        });
    }

    // Event listener de secours pour le bouton d'ajout d'article
    const btnOuvrirModal = document.getElementById('btn-ouvrir-modal');
    if (btnOuvrirModal) {
        btnOuvrirModal.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Attendre un peu pour s'assurer que le script est chargé
            setTimeout(() => {
                // Vérifier si la fonction existe
                if (typeof ouvrirModalAjouterArticle === 'function') {
                    console.log('✅ Fonction ouvrirModalAjouterArticle trouvée, ouverture du modal...');
                    ouvrirModalAjouterArticle(event);
                } else {
                    console.error('❌ Fonction ouvrirModalAjouterArticle non disponible');
                    console.log('🔍 Fonctions disponibles:', Object.keys(window).filter(key => key.includes('Modal')));
                    alert('Erreur: Fonction non disponible. Veuillez recharger la page.');
                }
            }, 100);
        });
    }
});

// Fonction pour sélectionner un client trouvé par recherche
function selectionnerClientRecherche(clientId, nomComplet, telephone) {
    // Sélectionner le client dans le dropdown
    const clientSelect = document.getElementById('client');
    if (clientSelect) {
        clientSelect.value = clientId;
    }
    
    // Masquer le résultat de recherche
    document.getElementById('resultat_recherche').classList.add('hidden');
    
    // Vider le champ de recherche
    document.getElementById('recherche_telephone').value = '';
    
    // Afficher un message de confirmation
    const resultatDiv = document.getElementById('resultat_recherche');
    resultatDiv.innerHTML = `
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg">
            <i class="fas fa-check mr-2"></i>
            Client sélectionné avec succès !
            </div>
        `;
    resultatDiv.classList.remove('hidden');
    
    // Masquer le message après 3 secondes
    setTimeout(() => {
        resultatDiv.classList.add('hidden');
    }, 3000);
}
</script>

{% endblock content %}