{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}
{% load commande_filters %}
{% load remise_filters %}

{% block title %}Modifier Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent" data-commande-id="{{ commande.id }}">
    <!-- En-t√™te de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3" style="color: #f7d9c4;"></i>
                Modifier Commande {{ commande.id_yz }}
            </h1>
            <p style="color: #f7d9c4;">Modification compl√®te des d√©tails de la commande</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold" style="color: #f7d9c4;" id="total_commande_haut_page">{{ commande.total_cmd|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold" style="color: #f7d9c4;" id="compteur-upsell-header">Niveau {{ commande.compteur }}</div>
                <div class="text-sm opacity-80">Upsell actuel</div>
          
            </div>
        </div>
    </div>

    <!-- Formulaire de modification -->
    <form method="post" id="modification-form">
        {% csrf_token %}
        
        <!-- Disposition en une seule colonne pour √©liminer les espaces vides -->
        <div class="space-y-6">
            <!-- Section 1: Informations principales (2 colonnes) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informations de commande -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-receipt mr-3" style="color: #6d4b3b;"></i>Informations Commande
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">N¬∞ Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Num√©ro Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total (Non modifiable)</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                </div>

                <!-- Informations client -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-user mr-3" style="color: #6d4b3b;"></i>Informations Client
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="client_nom" class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input id="client_nom" type="text" name="client_nom" value="{{ commande.client.nom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label for="client_prenom" class="block text-sm font-medium text-gray-700 mb-2">Pr√©nom</label>
                            <input id="client_prenom" type="text" name="client_prenom" value="{{ commande.client.prenom | default:' ' }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label for="client_telephone" class="block text-sm font-medium text-gray-700 mb-2">Num√©ro de t√©l√©phone</label>
                            <input id="client_telephone" type="tel" name="client_telephone" value="{{ commande.client.numero_tel }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client (Non modifiable)</label>
                            <input type="text" value="{{ commande.ville_init|default:'Non sp√©cifi√©e' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-client', event)" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-user-check mr-2"></i>Valider les infos client
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section 2: Informations de livraison (largeur compl√®te) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.5s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-truck mr-3" style="color: #6d4b3b;"></i>Informations Livraison
                    </h3>
                    
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="ville-select" class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                            <select name="ville_livraison" id="ville-select" onchange="chargerRegionEtFrais()"
                                    class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                    style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                                <option value="">-- S√©lectionner une ville --</option>
                                {% for ville in villes %}
                                    <option value="{{ ville.id }}" 
                                            data-region="{{ ville.region.nom_region }}" 
                                            data-frais="{{ ville.frais_livraison|default:0 }}"
                                            data-delai-min="{{ ville.Delai_livraison_min|default:0 }}"
                                            data-delai-max="{{ ville.Delai_livraison_max|default:0 }}"
                                            {% if commande.ville.id == ville.id %}selected{% endif %}>
                                        {{ ville.nom }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="region-display" class="block text-sm font-medium text-gray-700 mb-2">Livreur (Automatique)</label>
                            <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label for="frais-display" class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="frais-display" value="{{ commande.montant_frais_livraison|default:0 }} DH" readonly
                                       class="flex-1 p-3 bg-gray-100 border rounded-lg text-gray-600">
                                <div class="flex items-center gap-2">
                                    {% if commande.frais_livraison %}
                                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span class="text-sm font-medium text-green-600" id="frais-status-text">Activ√©s</span>
                                    {% else %}
                                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                                        <span class="text-sm font-medium text-gray-600" id="frais-status-text">D√©sactiv√©s</span>
                                    {% endif %}
                                </div>
                                <button type="button" id="toggle-frais-livraison" 
                                        class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200
                                               {% if commande.frais_livraison %}
                                                   bg-red-100 text-red-700 hover:bg-red-200 border border-red-300
                                               {% else %}
                                                   bg-green-100 text-green-700 hover:bg-green-200 border border-green-300
                                               {% endif %}"
                                        onclick="toggleFraisLivraison()">
                                    {% if commande.frais_livraison %}
                                        <i class="fas fa-times mr-1"></i>D√©sactiver
                                    {% else %}
                                        <i class="fas fa-check mr-1"></i>Activer
                                    {% endif %}
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1" id="frais-info-text">
                                <i class="fas fa-info-circle mr-1"></i>
                                {% if commande.frais_livraison %}
                                    Les frais de livraison sont inclus dans le total de la commande
                                {% else %}
                                    Les frais de livraison ne sont pas inclus dans le total
                                {% endif %}
                            </p>
                        </div>
                    <div>
                        <label for="delai-display" class="block text-sm font-medium text-gray-700 mb-2">delai de livraison (Automatique)</label>
                        <input type="text" id="delai-display" value="{{ commande.ville.Delai_livraison_min|default:0 }} - {{ commande.ville.Delai_livraison_max|default:0 }} jours" readonly
                               class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                </div>
                        </div>
                        <div>
                            <label for="adresse_livraison" class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                            <textarea id="adresse_livraison" name="adresse_livraison" rows="3"
                                      class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                      style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;"
                                      placeholder="Adresse compl√®te de livraison">{{ commande.adresse }}</textarea>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-livraison', event)" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-truck mr-2"></i>Valider la livraison
                        </button>
                    </div>
                </div>

            <!-- Section 3: Gestion des Op√©rations (largeur compl√®te) -->
            <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.6s;">
                                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                    <i class="fas fa-cogs mr-3" style="color: #6d4b3b;"></i>Gestion des Op√©rations de Confirmation
                    </h3>
                    
                    <div class="space-y-6">

                        <!-- Gestion des op√©rations -->
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-medium text-blue-800 mb-3">
                                <i class="fas fa-cogs mr-2"></i>Gestion des Op√©rations de Confirmation
                            </h4>
                            
                            <div id="operations-container" class="space-y-4">
                                <!-- Tableau des op√©rations -->
                                <div class="overflow-x-auto">
                                    <table class="w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                        <thead>
                                            <tr class="bg-gray-50 border-b border-gray-200">
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-hashtag mr-1"></i>ID
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-cogs mr-1"></i>Type d'op√©ration
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-calendar mr-1"></i>Date d'op√©ration
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-comment mr-1"></i>Commentaire
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="operations-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Les lignes seront ajout√©es dynamiquement par JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Bouton pour ajouter une nouvelle op√©ration -->
                                <div class="text-center mt-4">
                                    <button type="button" onclick="ajouterNouvelleOperation()" 
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Ajouter une op√©ration
                                    </button>
                            </div>
                                
                                <!-- √âtape 1: S√©lection du type principal d'op√©ration -->
                                <div id="type-principal-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fas fa-step-forward mr-2"></i>Choisissez le type d'op√©ration :
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <button type="button" onclick="choisirTypePrincipal('APPEL')" 
                                                class="p-4 border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-phone text-2xl text-blue-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-blue-800">Appel T√©l√©phonique</div>
                                                <div class="text-xs text-blue-600 mt-1">Appels de confirmation client</div>
                                </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('SMS')" 
                                                class="p-4 border-2 border-green-200 bg-green-50 hover:bg-green-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-sms text-2xl text-green-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-green-800">SMS</div>
                                                <div class="text-xs text-green-600 mt-1">Messages texte courts</div>
                            </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('WHATSAPP')" 
                                                class="p-4 border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fab fa-whatsapp text-2xl text-emerald-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-emerald-800">WhatsApp</div>
                                                <div class="text-xs text-emerald-600 mt-1">Messages WhatsApp</div>
                        </div>
                                        </button>
                            </div>
                                    
                                    <div class="mt-4 text-center">
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                    </div>
                                
                                <!-- √âtape 2: S√©lection de l'op√©ration sp√©cifique -->
                                <div id="operation-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fab fa-whatsapp mr-2 text-emerald-600"></i>S√©lectionnez le type de communication WhatsApp :
                                    </h5>
                                    <div id="operations-list" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <!-- Les op√©rations seront ajout√©es dynamiquement par JavaScript -->
                </div>

                                    <div class="mt-4 flex justify-between">
                                        <button type="button" onclick="retourTypePrincipal()" 
                                                class="px-3 py-1 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-1"></i>Retour
                        </button>
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                        </div>
                        
                                <div class="text-center mt-4">
                                    <div class="text-sm text-red-600 mb-2 font-medium">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        IMPORTANT : Chaque op√©ration s√©lectionn√©e DOIT avoir un commentaire r√©dig√© par l'op√©rateur
                            </div>

                        </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                </div>

                        <!-- Section 4: Articles de la commande (largeur compl√®te) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.8s;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" style="color: #4B352A;">
                            <i class="fas fa-box mr-3" style="color: #6d4b3b;"></i>Articles de la Commande (<span id="articles-count">{{ commande.paniers.count }}</span> article<span id="articles-plural">{{ commande.paniers.count|pluralize }}</span>) 
                        {% if commande.compteur > 0 %}
                        <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                        </span>
                        {% endif %}
                      
                          <button type="button"
                            class="px-1.5 py-0.5 bg-purple-500 hover:bg-purple-300 text-white rounded text-sm font-medium transition-all">
                                 Activer la remise</button>
                          {% if commande.remise %}
                                {% endif %}


                    {% if commande.produit_init %}
                <div class="mt-4">
                            <p class="block text-sm font-medium text-gray-700 mb-2">Produit Initial (Sheets)</p>
                            <div class="w-full p-3 bg-blue-50 border border-blue-200 rounded-lg text-gray-700 whitespace-pre-line">
                    {{ commande.produit_init }}
                            </div>
                    </div>
                    {% endif %}
                        
                        </h3>
                        <div class="flex space-x-3">
                            <button type="button" onclick="ajouterNouvelArticle()" 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                                <i class="fas fa-plus mr-2"></i>Ajouter un article
                            </button>
                      
                        </div>
                    </div>
                    
                    <!-- Liste des articles existants -->
                    <div id="articles-container" class="space-y-3 mb-6">
                        {% include 'operatConfirme/partials/_articles_section.html' %}
                    </div>

                    <!-- R√©sum√© total avec d√©tail -->
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
                        <div class="space-y-2 mb-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">
                                    <i class="fas fa-shopping-cart mr-2"></i>Sous-total des articles:
                                </span>
                                <span id="sous-total-articles" class="font-medium text-gray-800">
                                    {{ commande.total_articles|floatformat:2 }} DH
                                </span>
                                
                            </div>
                            {% if commande.frais_livraison %}
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">
                                    <i class="fas fa-shipping-fast mr-2"></i>Frais de livraison:
                                </span>
                                <span id="frais-display" class="font-medium text-gray-800">
                                    {{ commande.montant_frais_livraison|floatformat:2 }} DH
                                </span>
                            </div>
                            {% endif %}
                            <hr class="border-gray-300">
                        </div>

                        <!-- Total final -->
                        <div class="flex justify-between items-center">
                            <div class="text-lg font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-calculator mr-2"></i>Total de la commande:
                            </div>
                            <div class="text-2xl font-bold" style="color: #4B352A;" id="total-commande">
                                {{ commande.total_cmd|floatformat:2 }} DH
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton supprim√© - Section articles-commande -->
                
                </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-between items-center mt-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex gap-4">
                <a href="{% url 'operatConfirme:confirmation' %}" 
                   class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Retour √† la confirmation
                </a>

            </div>
            
            <div class="flex gap-4">
                
                {% if commande.etat_actuel.enum_etat.libelle == 'Affect√©e' %}
                <button type="button" onclick="lancerConfirmation()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="fas fa-play mr-2"></i>
                    Lancer Confirmation
                </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'En cours de confirmation' %}
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                <button type="button" onclick="confirmerCommande()" 
                class="btn-confirm px-6 py-3 rounded-lg font-medium text-white transition-all" 
                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
            <i class="fas fa-check-circle mr-2"></i>
            Confirmer la Commande
                    </button>
                    <button type="button" onclick="reporterCommande({{ commande.id }})" data-action="reporter-commande" data-commande-id="{{ commande.id }}" 
                class="btn-confirm px-6 py-3 rounded-lg font-medium text-white transition-all" 
                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
            <i class="fas fa-check-circle mr-2"></i>
            Reporter la Commande
                    </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'Report de confirmation' %}
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                <button type="button" onclick="confirmerCommande()" 
                class="btn-confirm px-6 py-3 rounded-lg font-medium text-white transition-all" 
                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
            <i class="fas fa-check-circle mr-2"></i>
            Confirmer la Commande
                    </button>
                {% endif %}

            </div>
        </div>
    </form>
</div>

<!-- Modale de commentaire pour les op√©rations -->
<div id="commentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-comment text-blue-500 mr-3"></i>
            Commentaire pour <span id="operationName" class="text-blue-600"></span>
        </h3>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Conclusion de l'op√©rateur
            </label>
            <select id="commentSelect" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- S√©lectionnez une conclusion --</option>
                <!-- Les options seront remplies dynamiquement selon le type d'op√©ration -->
            </select>
            <div class="mt-1 text-xs text-red-600 font-medium">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                S√©lection obligatoire - l'op√©ration sera ignor√©e sans conclusion
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closeCommentModal()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-1"></i>Annuler
            </button>
            <button onclick="saveComment()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 hover:bg-blue-700 text-white">
                <i class="fas fa-save mr-1"></i>Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modale pour ajouter un article -->
<div id="articleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-4 sm:p-6 w-full max-w-7xl mx-auto shadow-2xl max-h-[95vh] overflow-y-auto">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
            <div class="flex items-center">
            <i class="fas fa-box text-blue-500 mr-2 sm:mr-3"></i>
            <span id="articleModalTitle">Ajouter un article</span>
            </div>
            <span id="FermerModalAjouterArticle" class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalAjouterArticle()">
                <i class="fas fa-times text-lg sm:text-xl"></i>
            </span>
        </h3>

           <!-- Barre de recherche -->
           <div class="mt-3 mb-3">
            <p class="text-sm text-gray-500 mb-2">Rechercher un article</p>
            <input id="recherche-article-input" type="text" placeholder="Nom, r√©f√©rence, couleur, pointure..." 
                   class="w-full p-2 sm:p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                   oninput="rechercherArticles(this.value)" />
        </div>

        <form id="articleForm" class="space-y-4">
                <!-- S√©lection d'article (pour nouveaux articles) -->
                <div id="article-selection-field">
                    <!-- L√©gende des badges -->
                    <div class="mb-3 p-2 sm:p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between mb-2 sm:mb-3">
                            <div class="text-xs sm:text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-info-circle mr-1 sm:mr-2 text-blue-500"></i>
                             types d'articles :
                        </div>
                         
                        </div>
                        <div class="badge-legend grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-1 sm:gap-2 lg:gap-3 text-xs sm:text-sm">
                            <span id="filter-all" class="inline-flex items-center justify-center px-2 sm:px-4 py-1 sm:py-2 bg-gray-100 text-gray-700 rounded-full font-medium cursor-pointer filter-badge active whitespace-nowrap hover:bg-gray-200 transition-colors" 
                                  onclick="filtrerArticles('all')" title="Afficher tous les articles">
                                üîç TOUS
                            </span>
                            <span id="filter-promo" class="inline-flex items-center justify-center px-2 sm:px-4 py-1 sm:py-2 bg-red-100 text-red-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-red-200 transition-colors" 
                                  onclick="filtrerArticles('promo')" title="Filtrer les articles en promotion">
                                üî• PROMO
                            </span>
                            <span id="filter-liquidation" class="inline-flex items-center justify-center px-2 sm:px-4 py-1 sm:py-2 bg-orange-100 text-orange-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-orange-200 transition-colors" 
                                  onclick="filtrerArticles('liquidation')" title="Filtrer les articles en liquidation">
                                üè∑Ô∏è LIQUIDATION
                            </span>
                            <span id="filter-test" class="inline-flex items-center justify-center px-2 sm:px-4 py-1 sm:py-2 bg-blue-100 text-blue-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-blue-200 transition-colors" 
                                  onclick="filtrerArticles('test')" title="Filtrer les articles en test">
                                üß™ TEST
                            </span>
                            <span id="filter-upsell" class="inline-flex items-center justify-center px-2 sm:px-4 py-1 sm:py-2 bg-green-100 text-green-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-green-200 transition-colors" 
                                  onclick="filtrerArticles('upsell')" title="Filtrer les articles upsell">
                                ‚¨ÜÔ∏è UPSELL
                            </span>
                        </div>
                    </div>
                    
                <!-- Select d'origine conserv√© (masqu√©) pour compatibilit√© -->
                <select id="articleSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hidden">
                        <option value="">-- S√©lectionner un article --</option>
                        <!-- Les articles seront charg√©s dynamiquement -->
                    </select>

                <!-- Section des articles avec navigation fixe -->
                <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
                    <!-- Zone de scroll avec barre de navigation personnalis√©e -->
                    <div class="relative">
                        <!-- Conteneur principal avec scroll -->
                        <div id="articlesScrollContainer" class="max-h-64 sm:max-h-96 overflow-y-auto" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                            <table class="w-full table-fixed">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="w-2/4 px-2 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Article</th>
                                        <th class="w-1/6 px-1 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Prix</th>
                                        <th class="w-1/6 px-1 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                                        <th class="w-1/6 px-1 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="articlesTableBody" class="bg-white divide-y divide-gray-100">
                                    <!-- Lignes d'articles rendues dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                    </div>
                    
                    <!-- Indicateur de navigation -->
                    <div class="bg-gray-50 border-t border-gray-200 px-2 sm:px-4 py-2 flex items-center justify-between text-xs text-gray-500">
                        <span id="scrollInfo">Articles disponibles</span>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button id="scrollUp" class="p-1 hover:bg-gray-200 rounded" title="Monter">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button id="scrollDown" class="p-1 hover:bg-gray-200 rounded" title="Descendre">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Affichage du nom d'article (pour modifications) -->
                <div id="article-display-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                    <input type="text" id="articleDisplay" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                </div>
                
            <!-- Quantit√© (masqu√©e car g√©r√©e dans le tableau) -->
            <div class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quantit√© </label>
                    <input type="number" id="quantiteInput" min="1" step="1" value="1" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Informations de l'article s√©lectionn√© -->
            <div id="article-info" class="hidden mt-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-3 sm:p-4">
                    <h4 class="text-base sm:text-lg font-semibold text-blue-800 mb-3 sm:mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>D√©tails de l'article
                    </h4>
                    
                    <!-- Informations principales organis√©es en cartes -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <!-- Carte Informations produit -->
                        <div class="bg-white rounded-lg p-3 sm:p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-2 sm:mb-3 flex items-center text-sm sm:text-base">
                                <i class="fas fa-tag mr-2 text-blue-600"></i>Informations produit
                            </h5>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm sm:text-base">
                                    <span class="text-gray-600">R√©f√©rence :</span>
                                    <span id="info-reference" class="font-medium text-gray-800"></span>
                                </div>
                                <div class="flex justify-between text-sm sm:text-base">
                                    <span class="text-gray-600">Prix unitaire :</span>
                                    <span id="info-prix" class="font-bold text-green-600"></span>
                                </div>
                                <div class="flex justify-between border-t pt-2 text-sm sm:text-base">
                                    <span class="text-gray-700 font-medium">Sous-total :</span>
                                    <span id="info-sous-total" class="font-bold text-blue-600 text-base sm:text-lg"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Carte Caract√©ristiques -->
                        <div class="bg-white rounded-lg p-3 sm:p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-2 sm:mb-3 flex items-center text-sm sm:text-base">
                                <i class="fas fa-palette mr-2 text-purple-600"></i>Caract√©ristiques du produit
                            </h5>
                            
                            <!-- Conteneur pour les badges de caract√©ristiques -->
                            <div id="caracteristiques-badges" class="flex flex-wrap gap-1 sm:gap-2 mb-2 sm:mb-3">
                                <!-- Les badges seront ajout√©s dynamiquement par JavaScript -->
                            </div>
                            
                            <!-- Affichage classique format√© -->
                            <div class="space-y-2 text-xs sm:text-sm">
                                <div>
                                    <span class="text-gray-700 font-medium">Taille : </span>
                                    <span id="info-pointure" class="text-purple-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Couleur : </span>
                                    <span id="info-couleur" class="text-orange-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Cat√©gorie : </span>
                                    <span id="info-categorie" class="text-indigo-600 font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock et description -->
                    <div class="bg-white rounded-lg p-3 sm:p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-800 flex items-center text-sm sm:text-base">
                                <i class="fas fa-boxes mr-2 text-teal-600"></i>Stock disponible
                            </h5>
                            <span id="info-stock" class="px-2 sm:px-3 py-1 rounded-full font-medium transition-all duration-300 text-xs sm:text-sm"></span>
                        </div>
                        <div class="flex items-center mt-2 mb-2">
                            <div class="w-full bg-gray-200 rounded-full h-2 sm:h-2.5">
                                <div id="stock-progress" class="h-2 sm:h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="stock-percentage" class="ml-2 text-xs font-medium"></div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Le stock affich√© est mis √† jour en temps r√©el depuis la base de donn√©es
                        </div>
                        <div id="info-description" class="text-xs sm:text-sm text-gray-600 italic"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>




<script src="{% static 'js/operatConfirme/Confirmation_commande/reporter_commande.js' %}"></script>

<script src="{% static 'js/operatConfirme/Confirmation_commande/Gestion_operation.js' %}"></script>

<script>
    const commandeId = {{ commande.id }};
    const urlModifier = `/operateur-confirme/commandes/${commandeId}/modifier/`;
    // Exposer pour les scripts JS statiques
    window.commandeId = commandeId;
    window.urlModifier = urlModifier;
</script>

<script src="{%static 'js/operatConfirme/Confirmation_commande/Validation_section.js' %}"></script>






<script src="{% static 'js/operatConfirme/Confirmation_commande/Gestion_articles.js' %}">
</script>



<!--Gestion des information de livraison -->
<script> 
      
// Fonction pour charger automatiquement la r√©gion, les frais et les d√©lais
function chargerRegionEtFrais() {
    const villeSelect = document.getElementById('ville-select');
    const selectedOption = villeSelect.options[villeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const region = selectedOption.getAttribute('data-region');
        const frais = selectedOption.getAttribute('data-frais');
        const delaiMin = selectedOption.getAttribute('data-delai-min');
        const delaiMax = selectedOption.getAttribute('data-delai-max');
        
        document.getElementById('region-display').value = region;
        document.getElementById('frais-display').value = frais + ' DH';
        document.getElementById('delai-display').value = delaiMin + ' - ' + delaiMax + ' jours';
        
        // Mettre √† jour l'affichage des frais et recalculer le total
        mettreAJourAffichageFraisResume();
        mettreAJourTotalCommande();
        
        console.log(`üèôÔ∏è Ville chang√©e: ${selectedOption.text}, Frais: ${frais} DH, R√©gion: ${region}, D√©lai: ${delaiMin}-${delaiMax} jours`);
    } else {
        // R√©initialiser les champs si aucune ville n'est s√©lectionn√©e
        document.getElementById('region-display').value = '';
        document.getElementById('frais-display').value = '';
        document.getElementById('delai-display').value = '';
        
        // Mettre √† jour l'affichage des frais et recalculer le total
        mettreAJourAffichageFraisResume();
        mettreAJourTotalCommande();
    }
}

// Fonction pour v√©rifier une section
function verifierSection(section) {
    const sectionElement = document.querySelector(`[onclick="verifierSection('${section}')"]`).closest('.verification-item');
    sectionElement.classList.add('verified');
}

// Fonction pour v√©rifier toutes les sections
function verifierTout() {
    const sections = document.querySelectorAll('.verification-item');
    sections.forEach(section => {
        section.classList.add('verified');
    });
}
</script>

<script>

// ================== SYST√àME DE FILTRAGE DES ARTICLES ==================

// Fonction principale de filtrage des articles
function filtrerArticles(typeFiltre) {
    console.log(`üîç Filtrage des articles par type: ${typeFiltre}`);
    
    filtreActuel = typeFiltre;
    
    // Mettre √† jour l'√©tat visuel des badges
    mettreAJourBadgesActifs(typeFiltre);
    
    // Appliquer le filtre sur la liste d√©roulante
    appliquerFiltreSelect(typeFiltre);
    
    // Afficher une notification
    const compteur = compterArticlesParType(typeFiltre);
    const message = typeFiltre === 'all' ? 
        `üîç Affichage de tous les articles (${compteur} total)` :
        `üîç Filtrage par ${typeFiltre.toUpperCase()}: ${compteur} article(s) trouv√©(s)`;
    
    showNotification(message, 'info', 2000);
}

// Fonction pour mettre √† jour l'√©tat visuel des badges
function mettreAJourBadgesActifs(typeActif) {
    // Retirer la classe active de tous les badges
    document.querySelectorAll('.filter-badge').forEach(badge => {
        badge.classList.remove('active');
    });
    
    // Ajouter la classe active au badge s√©lectionn√©
    const badgeActif = document.getElementById(`filter-${typeActif}`);
    if (badgeActif) {
        badgeActif.classList.add('active');
    }
}

// Fonction pour appliquer le filtre sur la liste d√©roulante
function appliquerFiltreSelect(typeFiltre) {
    const select = document.getElementById('articleSelect');
    const tableBody = document.getElementById('articlesTableBody');
    if (!select) {
        console.warn('‚ö†Ô∏è Select des articles introuvable');
        return;
    }
    
    // Sauvegarder la s√©lection actuelle
    const selectionActuelle = select.value;
    
    // Vider et reconstruire la liste
    select.innerHTML = '<option value="">-- S√©lectionner un article --</option>';
    if (tableBody) tableBody.innerHTML = '';
    
    if (!articlesDisponibles || articlesDisponibles.length === 0) {
        select.innerHTML = '<option value="">-- Aucun article disponible --</option>';
        return;
    }
    
    let articlesAffiches = 0;
    
    articlesDisponibles.forEach((article, index) => {
        // V√©rifier si l'article correspond au filtre
        if (typeFiltre === 'all' || correspondAuFiltre(article, typeFiltre)) {
            try {
                const option = document.createElement('option');
                option.value = article.id;
                
                // Construire le texte de l'option
                let optionText = article.nom || 'Article sans nom';
                
                // Ajouter les badges de statut
                const badges = [];
                if (article.has_promo_active) badges.push('üî•PROMO');
                if (article.phase === 'LIQUIDATION') badges.push('üè∑Ô∏èLIQUIDATION');
                if (article.phase === 'EN_TEST') badges.push('üß™TEST');
                if (article.isUpsell) badges.push('‚¨ÜÔ∏èUPSELL');
                
                if (badges.length > 0) {
                    optionText += ` [${badges.join(' ')}]`;
                }
                
                if (article.prix_actuel) {
                    optionText += ` - ${article.prix_actuel} DH`;
                }
                
                // Ajouter d√©tails
                const details = [];
                if (article.pointure && article.pointure.trim()) {
                    details.push(`T:${article.pointure}`);
                }
                if (article.couleur && article.couleur.trim()) {
                    details.push(`C:${article.couleur}`);
                }
                
                if (details.length > 0) {
                    optionText += ` (${details.join(', ')})`;
                }
                
                option.textContent = optionText;
                option.dataset.article = JSON.stringify(article);
                
                // Appliquer le style selon le type
                appliquerStyleOption(option, article);
                
                select.appendChild(option);

                // Rendu tableau
                if (tableBody) {
                    const tr = document.createElement('tr');
                    tr.dataset.article = JSON.stringify(article);
                    let rowBg = '';
                    let badgeHtml = '';
                    if (article.has_promo_active) { rowBg = 'bg-red-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-fire mr-1"></i>PROMO</span>'; }
                    if (article.phase === 'LIQUIDATION') { rowBg = 'bg-orange-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-tags mr-1"></i>LIQUIDATION</span>'; }
                    if (article.phase === 'EN_TEST') { rowBg = 'bg-blue-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-flask mr-1"></i>TEST</span>'; }
                    if (article.isUpsell) { rowBg = 'bg-green-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-arrow-up mr-1"></i>UPSELL</span>'; }
                    tr.className = rowBg;
                    const prixActuel = (typeof article.prix_actuel === 'number' ? article.prix_actuel : (article.prix_unitaire || 0));
                    const stock = (typeof article.qte_disponible === 'number' ? article.qte_disponible : (parseInt(article.qte_disponible || '0') || 0));
                    tr.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="flex items-start space-x-4">
                                <!-- Image de l'article -->
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 border-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                        ${article.image_url ? 
                                            `<img src="${article.image_url}" alt="Image de ${article.nom}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
                                            ''
                                        }
                                        <div class="w-full h-full flex items-center justify-center text-gray-400 ${article.image_url ? 'hidden' : ''}">
                                            <i class="fas fa-image text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informations de l'article -->
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900">${article.nom || ''}</div>
                                    <div class="text-xs text-gray-500">R√©f: ${article.reference || '-'}</div>
                                    <div class="mt-1">${badgeHtml}</div>
                                    <div class="mt-1 flex flex-wrap gap-2 text-xs">
               
                                        ${typeof article.categorie === 'string' ? `<span class=\"px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full\"><i class=\"fas fa-tag mr-1\"></i>${article.categorie}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-1 py-3 text-center">
                            <div class="text-sm font-semibold text-gray-900">${prixActuel} DH</div>
                        </td>
                        <td class="px-1 py-3 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${stock <= 0 ? 'bg-red-100 text-red-800' : (stock < 5 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800')}">${stock <= 0 ? '√âpuis√©' : stock + ' unit√©s'}</span>
                        </td>
                        <td class="px-1 py-3 text-center">
                            <button type="button" class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-colors bg-purple-100 text-purple-700 hover:bg-purple-200" onclick="ajouterDepuisLigne(this)"> + Ajouter</button>
                        </td>`;
                    tableBody.appendChild(tr);
                }
                articlesAffiches++;
                
            } catch (error) {
                console.error(`‚ùå Erreur lors de l'ajout de l'article filtr√© ${index + 1}:`, error);
            }
        }
    });
    
    // Restaurer la s√©lection si elle est toujours visible
    if (selectionActuelle) {
        select.value = selectionActuelle;
    }
    
    console.log(`üìä Filtrage termin√©: ${articlesAffiches} article(s) affich√©(s) sur ${articlesDisponibles.length} total`);
    
    // R√©initialiser la scrollbar apr√®s le filtrage
    setTimeout(() => {
        if (typeof reinitScrollbarAfterArticlesLoad === 'function') {
            reinitScrollbarAfterArticlesLoad();
        }
    }, 100);
}

// Fonction pour v√©rifier si un article correspond au filtre
function correspondAuFiltre(article, typeFiltre) {
    switch (typeFiltre) {
        case 'promo':
            return Boolean(article.has_promo_active);
        case 'liquidation':
            return article.phase === 'LIQUIDATION';
        case 'test':
            return article.phase === 'EN_TEST';
        case 'upsell':
            return Boolean(article.isUpsell);
        case 'all':
        default:
            return true;
    }
}

// Fonction pour appliquer le style √† une option selon le type d'article
function appliquerStyleOption(option, article) {
    if (article.has_promo_active) {
        option.style.backgroundColor = '#fef2f2';
        option.style.color = '#dc2626';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'LIQUIDATION') {
        option.style.backgroundColor = '#fff7ed';
        option.style.color = '#ea580c';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'EN_TEST') {
        option.style.backgroundColor = '#eff6ff';
        option.style.color = '#2563eb';
        option.style.fontWeight = 'bold';
    } else if (article.isUpsell) {
        option.style.backgroundColor = '#f0fdf4';
        option.style.color = '#16a34a';
        option.style.fontWeight = 'bold';
    }
}

// Fonction pour compter les articles par type
function compterArticlesParType(typeFiltre) {
    if (!articlesDisponibles || articlesDisponibles.length === 0) {
        return 0;
    }
    
    if (typeFiltre === 'all') {
        return articlesDisponibles.length;
    }
    
    return articlesDisponibles.filter(article => correspondAuFiltre(article, typeFiltre)).length;
}

// Fonction pour mettre √† jour les compteurs sur les badges
function mettreAJourCompteursFiltre() {
    const types = ['all', 'promo', 'liquidation', 'test', 'upsell'];
    
    types.forEach(type => {
        const badge = document.getElementById(`filter-${type}`);
        if (badge) {
            const compteur = compterArticlesParType(type);
            
            // Supprimer l'ancien compteur s'il existe
            const ancienCompteur = badge.querySelector('.article-count');
            if (ancienCompteur) {
                ancienCompteur.remove();
            }
            
            // Ajouter le nouveau compteur
            if (compteur > 0) {
                const compteurElement = document.createElement('span');
                compteurElement.className = 'article-count';
                compteurElement.textContent = `(${compteur})`;
                badge.appendChild(compteurElement);
            }
        }
    });
    
    

}

// Fonction pour r√©initialiser le filtre
function reinitialiserFiltre() {
    filtrerArticles('all');
}

// Ajouter des raccourcis clavier pour le filtrage
document.addEventListener('keydown', function(event) {
    // Uniquement si la modale d'articles est ouverte
    const articleModal = document.getElementById('articleModal');
    if (articleModal && articleModal.style.display === 'flex') {
        if (event.altKey) {
            switch (event.key) {
                case '1':
                    event.preventDefault();
                    filtrerArticles('all');
                    break;
                case '2':
                    event.preventDefault();
                    filtrerArticles('promo');
                    break;
                case '3':
                    event.preventDefault();
                    filtrerArticles('liquidation');
                    break;
                case '4':
                    event.preventDefault();
                    filtrerArticles('test');
                    break;
                case '5':
                    event.preventDefault();
                    filtrerArticles('upsell');
                    break;
            }
        }
    }
});

// Autres modifications similaires dans le script
function mettreAJourSousTotal() {
    const articleSelectionne = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');
    
    if (articleSelectionne && quantiteInput) {
        const selectedArticle = JSON.parse(articleSelectionne.value);
        const quantite = parseInt(quantiteInput.value) || 1;
        
        // V√©rifier si le prix actuel est d√©fini, sinon utiliser le prix unitaire
        const prixActuel = selectedArticle.prix_actuel !== undefined ? selectedArticle.prix_actuel : selectedArticle.prix_unitaire;
        const sousTotal = (prixActuel * quantite).toFixed(2);
        
        document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    }
}

function ajouterArticleAuPanier() {
    const articleSelect = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');
    const articlesContainer = document.getElementById('articles-container');

    if (!articleSelect || !quantiteInput || !articlesContainer) {
        console.error('‚ùå √âl√©ments de s√©lection ou conteneur d\'articles introuvables');
        showNotification('‚ùå Erreur de chargement des √©l√©ments', 'error');
        return;
    }

    const selectedOption = articleSelect.options[articleSelect.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        showNotification('‚ùå Veuillez s√©lectionner un article', 'error');
        return;
    }

    const article = JSON.parse(selectedOption.dataset.article);
    const quantite = parseInt(quantiteInput.value) || 1;
    const prixActuel = article.prix_actuel !== undefined ? article.prix_actuel : article.prix_unitaire;
    const sousTotal = (prixActuel * quantite).toFixed(2);

    // Cr√©er la nouvelle carte d'article
    const articleCard = document.createElement('div');
    articleCard.className = 'article-card p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all shadow-sm';
    // On ajoute un attribut pour pouvoir le supprimer/modifier plus tard si besoin.
    // NOTE: Cet ID est temporaire c√¥t√© client. Il devra √™tre mis √† jour avec l'ID de la base de donn√©es apr√®s sauvegarde.
    articleCard.dataset.articleId = `new-${Date.now()}`; 

    articleCard.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4">
                    <div class="min-w-0 flex-1">
                        <div class="font-semibold text-lg" style="color: #4B352A;">${article.nom}</div>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-hashtag mr-1"></i>R√©f: ${article.reference || 'N/A'}
                        </div>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                <i class="fas fa-ruler-vertical mr-1"></i>${article.pointure || 'N/A'}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                <i class="fas fa-palette mr-1"></i>${article.couleur || 'N/A'}
                            </span>
                             <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                <i class="fas fa-boxes mr-1"></i>Stock: ${article.qte_disponible}
                            </span>
                        </div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Quantit√©</div>
                        <div class="font-medium text-blue-600">${quantite} unit√©${quantite > 1 ? 's' : ''}</div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Prix actuel</div>
                        <div class="font-medium text-green-600">${prixActuel} DH</div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Sous-total</div>
                        <div class="text-lg font-bold" style="color: #6d4b3b;">${sousTotal} DH</div>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2 ml-4">
                <button type="button" onclick="modifierArticle(${articleCard.dataset.articleId})" class="px-3 py-2 text-white text-sm rounded-lg transition-all flex items-center" style="background: linear-gradient(135deg, #2563eb, #3b82f6); hover:shadow-lg;" title="Modifier">
                    <i class="fas fa-edit mr-1"></i>Modifier
                </button>
                <button type="button" onclick="supprimerArticle(this)" class="px-3 py-2 text-white text-sm rounded-lg transition-all flex items-center" style="background: linear-gradient(135deg, #dc2626, #ef4444); hover:shadow-lg;" title="Supprimer">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    `;

    articlesContainer.appendChild(articleCard);

    mettreAJourTotalCommande();

    // Fermer la modale d'ajout
    const modal = document.getElementById('addArticleModal');
    if(modal) {
        modal.classList.add('hidden');
    }
    
    showNotification('‚úÖ Article ajout√© au panier', 'success');
}

// La fonction mettreAJourTotalCommande est d√©j√† d√©finie plus haut dans le fichier

// Fonction pour afficher une notification
function showNotification(message, type = 'info', duration = 3000) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-orange-500'
    };
    
    // Cr√©er l'√©l√©ment de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg z-50 animate-fade-in`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle mr-2"></i>${message}`;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Ajouter une animation d'entr√©e
    notification.style.animation = 'fadeIn 0.3s ease-in-out';
    notification.style.opacity = '0';
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Supprimer apr√®s la dur√©e sp√©cifi√©e
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, duration);
}

// Fonction pour rafra√Æchir les donn√©es de stock d'un article
function rafraichirStockArticle(articleId) {
    console.log('üîÑ Rafra√Æchissement du stock pour l\'article ID:', articleId);
    
    // R√©cup√©rer le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('‚ùå Token CSRF introuvable');
        return Promise.reject('Token CSRF manquant');
    }
    
    // Appel AJAX pour r√©cup√©rer les donn√©es √† jour de l'article
    return fetch(`{% url 'operatConfirme:api_recherche_article_ref' %}?id=${articleId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es article rafra√Æchies:', data);
        
        try {
            if (data.success && data.article) {
                // Mettre √† jour l'affichage du stock
                const infoStock = document.getElementById('info-stock');
                const stockProgressBar = document.getElementById('stock-progress');
                const stockPercentage = document.getElementById('stock-percentage');
                
                if (infoStock) {
                    // S'assurer que qte_disponible est un nombre valide
                    let stock = 0;
                    try {
                        stock = typeof data.article.qte_disponible === 'number' ? 
                                data.article.qte_disponible : 
                                (data.article.qte_disponible ? parseInt(data.article.qte_disponible) : 0);
                        
                        // Si la conversion a √©chou√©, utiliser 0
                        if (isNaN(stock)) {
                            console.warn('‚ö†Ô∏è Valeur de stock non num√©rique:', data.article.qte_disponible);
                            stock = 0;
                        }
                    } catch (e) {
                        console.error('‚ùå Erreur lors de la conversion du stock:', e);
                        stock = 0;
                    }
                    
                    // Mettre √† jour l'affichage du stock avec style conditionnel
                    if (stockProgressBar && stockPercentage) {
                        // D√©finir une capacit√© maximale th√©orique pour la barre de progression
                        const capaciteMaximale = Math.max(stock, 100);
                        
                        // Calculer le pourcentage du stock
                        const pourcentage = Math.min(Math.round((stock / capaciteMaximale) * 100), 100);
                        
                        // Mettre √† jour le texte et la couleur selon le niveau de stock
                        if (stock <= 0) {
                            infoStock.textContent = '√âpuis√©';
                            infoStock.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-full font-medium';
                            stockProgressBar.style.width = '0%';
                            stockProgressBar.className = 'h-2.5 rounded-full bg-red-500';
                            stockPercentage.textContent = '0%';
                            stockPercentage.className = 'ml-2 text-xs font-medium text-red-700';
                        } else if (stock < 5) {
                            infoStock.textContent = `${stock} unit√©(s) - Faible`;
                            infoStock.className = 'px-3 py-1 bg-orange-100 text-orange-700 rounded-full font-medium';
                            stockProgressBar.style.width = `${pourcentage}%`;
                            stockProgressBar.className = 'h-2.5 rounded-full bg-orange-500';
                            stockPercentage.textContent = `${pourcentage}%`;
                            stockPercentage.className = 'ml-2 text-xs font-medium text-orange-700';
                        } else {
                            infoStock.textContent = `${stock} unit√©(s)`;
                            infoStock.className = 'px-3 py-1 bg-teal-100 text-teal-700 rounded-full font-medium';
                            stockProgressBar.style.width = `${pourcentage}%`;
                            stockProgressBar.className = 'h-2.5 rounded-full bg-teal-600';
                            stockPercentage.textContent = `${pourcentage}%`;
                            stockPercentage.className = 'ml-2 text-xs font-medium text-teal-700';
                        }
                    } else {
                        // Fallback si les √©l√©ments de la barre de progression n'existent pas
                        infoStock.textContent = `${stock} unit√©(s)`;
                    }
                    
                    console.log('üì¶ Stock mis √† jour:', stock);
                    
                    // Mettre √† jour les badges avec les informations de l'article
                    try {
                        const caracteristiques = {
                            stock: `Stock: ${stock}`
                        };
                        mettreAJourBadgesModale(caracteristiques);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erreur lors de la mise √† jour des badges:', e);
                    }
                    
                    // Afficher une notification discr√®te
                    showNotification(`üì¶ Stock mis √† jour: ${stock} unit√©(s)`, 'info', 2000);
                    
                    return data.article;
                }
            } else {
                console.warn('‚ö†Ô∏è Impossible de rafra√Æchir le stock:', data.error || 'Erreur inconnue');
                // Ne pas afficher de notification pour ne pas d√©ranger l'utilisateur
                return null;
            }
        } catch (e) {
            console.error('‚ùå Erreur lors du traitement des donn√©es de stock:', e);
            return null;
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur lors du rafra√Æchissement du stock:', error);
        // Ne pas afficher de notification pour √©viter de d√©ranger l'utilisateur
        // avec des erreurs techniques
        return null;
    });
}

</script>

<!-- Modal Livraison -->
<div id="livraisonModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-6 sm:p-8 bg-white w-full max-w-lg m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f7d9c4;">
        <!-- En-t√™te du modal -->
        <div class="flex justify-between items-center pb-4 border-b" style="border-color: #f7d9c4;">
            <div class="flex items-center">
                <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center mr-3 sm:mr-4" style="background: linear-gradient(135deg, #4B352A, #6d4b3b);">
                    <i class="fas fa-shipping-fast text-white text-lg sm:text-xl"></i>
                </div>
                <h3 class="text-xl sm:text-2xl font-bold" style="color: #4B352A;">Informations de Livraison</h3>
            </div>
            <button onclick="hideLivraisonModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-5 sm:py-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                <select id="livraisonVilleSelect" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-amber-300 focus:border-amber-300" style="border-color: #f7d9c4;">
                    <option value="">-- S√©lectionnez une ville --</option>
                    {% for v in villes %}
                        <option value="{{ v.id }}">{{ v.region.nom_region }} - {{ v.nom }}</option>
                    {% endfor %}
                </select>
                        </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                <textarea id="livraisonAdresseTextarea" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-amber-300 focus:border-amber-300" style="border-color: #f7d9c4;" placeholder="Rue, quartier, rep√®re..."></textarea>
                        </div>
            <div class="bg-amber-50 p-4 rounded-lg text-sm text-amber-800">
                <i class="fas fa-info-circle mr-2"></i>
                Les frais de livraison seront recalcul√©s selon la ville s√©lectionn√©e.
            </div>
        </div>
        
        <!-- Boutons du modal -->
        <div class="flex justify-end space-x-3 pt-4 border-t" style="border-color: #f7d9c4;">
            <button onclick="hideLivraisonModal()" class="px-5 py-2.5 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" style="background-color: #f7d9c4; color: #4B352A;">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button onclick="saveLivraisonFromModal()" class="px-5 py-2.5 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" style="background: linear-gradient(135deg, #4B352A, #6d4b3b); focus:ring-color: #4B352A;">
                <i class="fas fa-save mr-2"></i>
                Enregistrer
            </button>
    </div>
</div>

</div>
        
<script>
// Modal Livraison: fonctions JS
function showLivraisonModal() {
    const modal = document.getElementById('livraisonModal');
    if (modal) {
        // Pr√©-remplir
        const existingVille = document.getElementById('ville-select');
        const modalVille = document.getElementById('livraisonVilleSelect');
        if (existingVille && modalVille) modalVille.value = existingVille.value || '';
        const existingAdresse = document.querySelector('textarea[name="adresse_livraison"]');
        const modalAdresse = document.getElementById('livraisonAdresseTextarea');
        if (existingAdresse && modalAdresse) modalAdresse.value = existingAdresse.value || '';

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
}
function hideLivraisonModal() {
    const modal = document.getElementById('livraisonModal');
    if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
}
function saveLivraisonFromModal() {
    const villeId = document.getElementById('livraisonVilleSelect')?.value || '';
    const adresse = document.getElementById('livraisonAdresseTextarea')?.value?.trim() || '';
    if (!villeId) { showNotification('‚ö†Ô∏è Veuillez s√©lectionner une ville de livraison', 'error'); return; }
    if (!adresse) { showNotification('‚ö†Ô∏è Veuillez renseigner l\'adresse de livraison', 'error'); return; }

    const url = '{% url "operatConfirme:modifier_commande" commande.id %}';
    const formData = new FormData();
    formData.append('action', 'save_livraison');
    formData.append('ville_livraison', villeId);
    formData.append('adresse_livraison', adresse);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Informations de livraison sauvegard√©es', 'success');
            const existingVille = document.getElementById('ville-select');
            if (existingVille) existingVille.value = villeId;
            const existingAdresse = document.querySelector('textarea[name="adresse_livraison"]');
            if (existingAdresse) existingAdresse.value = adresse;
            if (typeof data.nouveau_total !== 'undefined') {
                const totalEl = document.getElementById('total-commande-display');
                if (totalEl) totalEl.textContent = parseFloat(data.nouveau_total).toFixed(2) + ' DH';
            }
            hideLivraisonModal();
        } else {
            showNotification(data.error || 'Erreur lors de la sauvegarde de la livraison', 'error');
        }
    })
    .catch(err => {
        console.error(err);
        showNotification('Erreur de connexion lors de la sauvegarde de la livraison', 'error');
    });
}
</script>


<!-- Modal de Confirmation Tailwind -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-lg m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f7d9c4;">
        <!-- En-t√™te du modal -->
        <div class="flex justify-between items-center pb-4 border-b" style="border-color: #f7d9c4;">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background: linear-gradient(135deg, #4B352A, #6d4b3b);">
                    <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold" style="color: #4B352A;">Confirmer la Commande</h3>
            </div>
            <button onclick="hideConfirmationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">√ätes-vous s√ªr de vouloir confirmer cette commande ?</h4>
                    <div class="text-gray-600 space-y-2">
                        <p class="flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Cette action va d√©cr√©menter le stock des articles
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-ban mr-2 text-red-500"></i>
                            Cette action ne peut pas √™tre annul√©e
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-paper-plane mr-2 text-green-500"></i>
                            La commande sera envoy√©e vers l'administration
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t" style="border-color: #f7d9c4;">
            <button onclick="hideConfirmationModal()" 
                    class="px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" 
                    style="background-color: #f7d9c4; color: #4B352A;">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button onclick="confirmerCommande()" 
                    class="px-6 py-3 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" 
                    style="background: linear-gradient(135deg, #4B352A, #6d4b3b); focus:ring-color: #4B352A;">
                <i class="fas fa-check mr-2"></i>
                Confirmer la Commande
            </button>
        </div>
    </div>
</div>

<!-- Modal de Stock Insuffisant Tailwind -->
<div id="stockInsuffisantModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f87171;">
        <!-- En-t√™te du modal -->
        <div class="flex justify-between items-center pb-4 border-b border-red-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-red-700">Stock Insuffisant</h3>
            </div>
            <button onclick="hideStockInsuffisantModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-times-circle text-red-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Confirmation impossible</h4>
                    <p class="text-gray-600">Les articles suivants n'ont pas un stock suffisant pour traiter cette commande :</p>
                </div>
            </div>
            
            <!-- Liste des articles en rupture -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <ul id="stockInsuffisantList" class="space-y-3">
                    <!-- Les √©l√©ments seront ajout√©s dynamiquement par JavaScript -->
                </ul>
            </div>
            
            <!-- Suggestions d'action -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-lightbulb text-blue-600"></i>
                    </div>
                    <div>
                        <h5 class="font-semibold text-blue-900 mb-2">Suggestions :</h5>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li class="flex items-center">
                                <i class="fas fa-edit mr-2"></i>
                                Modifier les quantit√©s des articles concern√©s
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Retirer les articles en rupture de stock
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Remplacer par des articles similaires disponibles
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-red-200">
            <button onclick="hideStockInsuffisantModal()" 
                    class="px-6 py-3 bg-red-600 text-white rounded-lg font-medium transition-all duration-200 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transform hover:-translate-y-0.5">
                <i class="fas fa-check mr-2"></i>
                Compris
            </button>
        </div>
    </div>
</div>


<script src ="{% static 'js/operatConfirme/Confirmation_commande/confirmaton.js' %}"></script>
<script>
    window.commandeId = {{ commande.id }};
  </script>





<!-- Modal de Suppression d'Article Tailwind -->
<div id="deleteArticleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #ef4444;">
        <!-- En-t√™te du modal -->
        <div class="flex justify-between items-center pb-4 border-b border-red-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-red-700">Confirmer la Suppression</h3>
            </div>
            <button onclick="hideDeleteArticleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">√ätes-vous s√ªr de vouloir supprimer cet article ?</h4>
                    <p class="text-gray-600">Cette action est irr√©versible et l'article sera retir√© de la commande.</p>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
            <button onclick="hideDeleteArticleModal()" 
                    class="px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button id="confirmDeleteArticleBtn"
                    class="px-6 py-3 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" 
                    style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-trash-alt mr-2"></i>
                Confirmer la suppression
            </button>
        </div>
    </div>
</div>


<!-- Modal de s√©lection des variantes -->
<div id="variantModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-4" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-4 sm:p-6 w-full max-w-7xl mx-auto shadow-2xl max-h-[95vh] overflow-y-auto">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-table text-blue-500 mr-2 sm:mr-3"></i>
                <span class="text-sm sm:text-base">S√©lectionner des variantes - Tableau crois√©</span>
            </div>
            <span class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalVariantes(event)">
                <i class="fas fa-times text-lg sm:text-xl"></i>
            </span>
        </h3>

        <!-- Informations de l'article s√©lectionn√© -->
        <div id="articleInfo" class="mb-4 p-3 sm:p-4 bg-gray-50 rounded-lg">
            <h4 id="articleNom" class="font-medium text-gray-900 text-sm sm:text-base"></h4>
            <p id="articleReference" class="text-xs sm:text-sm text-gray-600"></p>
        </div>

        <!-- Tableau crois√© des variantes -->
        <div id="variantsTableContainer" class="mb-4 overflow-x-auto">
            <div class="text-center py-6 sm:py-8 text-gray-500">
                <i class="fas fa-table text-3xl sm:text-4xl mb-3 sm:mb-4 text-gray-300"></i>
                <p class="text-base sm:text-lg">S√©lectionnez un article pour voir ses variantes</p>
            </div>
        </div>

        <!-- Informations des variantes s√©lectionn√©es -->
        <div id="selectedVariantsInfo" class="mb-4 p-3 sm:p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <h5 class="font-medium text-blue-900 mb-2 text-sm sm:text-base">Variantes s√©lectionn√©es:</h5>
            <div id="selectedVariantsDetails" class="text-xs sm:text-sm text-blue-800"></div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 gap-3">
            <button type="button" id="clearSelectionBtn" onclick="effacerSelectionVariantes(event)" 
                    class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors hidden text-sm sm:text-base">
                <i class="fas fa-times mr-1 sm:mr-2"></i>Effacer la s√©lection
            </button>
            
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                <button type="button" id="addSelectedVariantsBtn" onclick="ajouterVariantesSelectionnees(event)" 
                        class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors hidden text-sm sm:text-base">
                    <i class="fas fa-plus mr-1 sm:mr-2"></i>Ajouter les variantes s√©lectionn√©es
                </button>
                <button type="button" onclick="fermerModalVariantes(event)" 
                        class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors text-sm sm:text-base">
                    Retour
                </button>
            </div>
        </div>
    </div>
</div>


</script>

<script>

// Fonction pour basculer le statut des frais de livraison
function toggleFraisLivraison() {
    const button = document.getElementById('toggle-frais-livraison');
    const statusText = document.getElementById('frais-status-text');
    const statusDot = statusText.previousElementSibling;
    const infoText = document.getElementById('frais-info-text');
    
    // D√©sactiver le bouton pendant la requ√™te
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Chargement...';
    
    // D√©terminer le nouveau statut (inverser l'actuel)
    const currentStatus = statusText.textContent.trim() === 'Activ√©s';
    const nouveauStatut = !currentStatus;
    
    // Pr√©parer les donn√©es √† envoyer
    const formData = new FormData();
    formData.append('action', 'toggle_frais_livraison');
    formData.append('frais_livraison_actif', nouveauStatut.toString());
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Envoyer la requ√™te AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mettre √† jour l'interface
            if (data.nouveau_statut) {
                // Frais activ√©s
                statusText.textContent = 'Activ√©s';
                statusText.className = 'text-sm font-medium text-green-600';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                button.innerHTML = '<i class="fas fa-times mr-1"></i>D√©sactiver';
                button.className = 'px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-red-100 text-red-700 hover:bg-red-200 border border-red-300';
                infoText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Les frais de livraison sont inclus dans le total de la commande';
            } else {
                // Frais d√©sactiv√©s
                statusText.textContent = 'D√©sactiv√©s';
                statusText.className = 'text-sm font-medium text-gray-600';
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Activer';
                button.className = 'px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-green-100 text-green-700 hover:bg-green-200 border border-green-300';
                infoText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Les frais de livraison ne sont pas inclus dans le total';
            }
            
            // Mettre √† jour l'affichage des frais dans le r√©sum√©
            mettreAJourAffichageFraisResume();
            
            // Recalculer le total de la commande
            mettreAJourTotalCommande();
            
            // Mettre √† jour le total de la commande si affich√©
            const totalElement = document.querySelector('[data-total-commande]');
            if (totalElement) {
                totalElement.textContent = data.total_commande.toFixed(2) + ' DH';
            }
            
            // Afficher le message de succ√®s
            showNotification(data.message, 'success');
            
        } else {
            // Afficher l'erreur
            showNotification(data.error || 'Erreur lors du changement du statut', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur de connexion', 'error');
    })
    .finally(() => {
        // R√©activer le bouton
        button.disabled = false;
    });
}

// Fonction utilitaire pour afficher les notifications
function showNotification(message, type = 'info') {
    // Cr√©er l'√©l√©ment de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
    
    if (type === 'success') {
        notification.className += ' bg-green-100 border border-green-400 text-green-700';
    } else if (type === 'error') {
        notification.className += ' bg-red-100 border border-red-400 text-red-700';
    } else {
        notification.className += ' bg-blue-100 border border-blue-400 text-blue-700';
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animer l'apparition
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Supprimer apr√®s 3 secondes
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>


{% endblock %} 