{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}

{% block title %}Modifier Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .verification-item {
        transition: all 0.3s ease;
    }
    
    .verification-item.verified {
        background-color: #dcfce7 !important;
        border-color: #16a34a !important;
    }
    
    .check-icon {
        display: none;
        color: #16a34a;
    }
    
    .verification-item.verified .check-icon {
        display: inline;
    }
    
    .btn-verification {
        background: linear-gradient(to right, #16a34a, #15803d);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-verification:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-operation {
        background-color: #8B5A2B !important;
        color: white !important;
        transition: all 0.3s ease;
    }
    
    .btn-operation:hover {
        background-color: #6d4b3b !important;
        transform: scale(1.05);
    }
    
    .btn-confirm {
        background: linear-gradient(to right, #4B352A, #6d4b3b);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-confirm:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Styles pour la modale d'articles - amélioration de l'affichage */
    #articleModal {
        z-index: 9999;
    }
    
    #articleModal .bg-white.rounded-xl {
        max-height: 90vh;
        overflow-y: auto;
    }
    
    /* Animation pour la modale */
    #articleModal.flex {
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* Amélioration de l'affichage des badges */
    .article-card .gap-2 span {
        white-space: nowrap;
    }
    
    /* Style pour les informations d'article dans la modale */
    #article-info {
        transition: all 0.3s ease;
    }
    
    /* Amélioration du responsiveness */
    @media (max-width: 768px) {
        #articleModal .max-w-2xl {
            margin: 1rem;
            max-width: calc(100% - 2rem);
        }
        
        #article-info .grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3" style="color: #f7d9c4;"></i>
                Modifier Commande {{ commande.id_yz }}
            </h1>
            <p style="color: #f7d9c4;">Modification complète des détails de la commande</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold" style="color: #f7d9c4;">{{ commande.total_cmd|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
        </div>
    </div>



    <!-- Formulaire de modification -->
    <form method="post" id="modification-form">
        {% csrf_token %}
        
        <!-- Disposition en une seule colonne pour éliminer les espaces vides -->
        <div class="space-y-6">
            <!-- Section 1: Informations principales (2 colonnes) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informations de commande -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-receipt mr-3" style="color: #6d4b3b;"></i>Informations Commande
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID YZ (Non modifiable)</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total (Non modifiable)</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-commande')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-check mr-2"></i>Valider les informations
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

                <!-- Informations client -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-user mr-3" style="color: #6d4b3b;"></i>Informations Client
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" name="client_nom" value="{{ commande.client.nom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" name="client_prenom" value="{{ commande.client.prenom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro de téléphone</label>
                            <input type="tel" name="client_telephone" value="{{ commande.client.numero_tel }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client (Non modifiable)</label>
                            <input type="text" value="{{ commande.ville_init|default:'Non spécifiée' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-client')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-user-check mr-2"></i>Valider les infos client
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>
            </div>

            <!-- Section 2: Informations de livraison (largeur complète) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.5s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-truck mr-3" style="color: #6d4b3b;"></i>Informations Livraison
                    </h3>
                    
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                            <select name="ville_livraison" id="ville-select" onchange="chargerRegionEtFrais()"
                                    class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                    style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                                <option value="">-- Sélectionner une ville --</option>
                                {% for ville in villes %}
                                    <option value="{{ ville.id }}" 
                                            data-region="{{ ville.region.nom_region }}" 
                                            data-frais="{{ ville.frais_livraison|default:0 }}"
                                            {% if commande.ville.id == ville.id %}selected{% endif %}>
                                        {{ ville.nom }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Région (Automatique)</label>
                            <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison (Automatique)</label>
                            <input type="text" id="frais-display" value="{{ commande.ville.frais_livraison|default:0 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                            <textarea name="adresse_livraison" rows="3"
                                      class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                      style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;"
                                      placeholder="Adresse complète de livraison">{{ commande.adresse }}</textarea>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-livraison')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-truck mr-2"></i>Valider la livraison
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

            <!-- Section 3: Gestion des Opérations (largeur complète) -->
            <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.6s;">
                                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                    <i class="fas fa-cogs mr-3" style="color: #6d4b3b;"></i>Gestion des Opérations de Confirmation
                    </h3>
                    
                    <div class="space-y-6">

                        
                        <!-- Gestion des opérations -->
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-medium text-blue-800 mb-3">
                                <i class="fas fa-cogs mr-2"></i>Gestion des Opérations de Confirmation
                            </h4>
                            
                            <div id="operations-container" class="space-y-4">
                                <!-- Tableau des opérations -->
                                <div class="overflow-x-auto">
                                    <table class="w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                        <thead>
                                            <tr class="bg-gray-50 border-b border-gray-200">
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-hashtag mr-1"></i>ID
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-cogs mr-1"></i>Type d'opération
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-calendar mr-1"></i>Date d'opération
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-comment mr-1"></i>Commentaire
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="operations-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Les lignes seront ajoutées dynamiquement par JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Bouton pour ajouter une nouvelle opération -->
                                <div class="text-center mt-4">
                                    <button type="button" onclick="ajouterNouvelleOperation()" 
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Ajouter une opération
                                    </button>
                            </div>
                                
                                <!-- Étape 1: Sélection du type principal d'opération -->
                                <div id="type-principal-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fas fa-step-forward mr-2"></i>Choisissez le type d'opération :
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <button type="button" onclick="choisirTypePrincipal('APPEL')" 
                                                class="p-4 border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-phone text-2xl text-blue-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-blue-800">Appel Téléphonique</div>
                                                <div class="text-xs text-blue-600 mt-1">Appels de confirmation client</div>
                                </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('SMS')" 
                                                class="p-4 border-2 border-green-200 bg-green-50 hover:bg-green-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-sms text-2xl text-green-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-green-800">SMS</div>
                                                <div class="text-xs text-green-600 mt-1">Messages texte courts</div>
                            </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('WHATSAPP')" 
                                                class="p-4 border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fab fa-whatsapp text-2xl text-emerald-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-emerald-800">WhatsApp</div>
                                                <div class="text-xs text-emerald-600 mt-1">Messages WhatsApp</div>
                        </div>
                                        </button>
                            </div>
                                    
                                    <div class="mt-4 text-center">
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                    </div>
                                
                                <!-- Étape 2: Sélection de l'opération spécifique -->
                                <div id="operation-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fab fa-whatsapp mr-2 text-emerald-600"></i>Sélectionnez le type de communication WhatsApp :
                                    </h5>
                                    <div id="operations-list" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <!-- Les opérations seront ajoutées dynamiquement par JavaScript -->
                </div>

                                    <div class="mt-4 flex justify-between">
                                        <button type="button" onclick="retourTypePrincipal()" 
                                                class="px-3 py-1 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-1"></i>Retour
                        </button>
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                        </div>
                        
                                <div class="text-center mt-4">
                                    <div class="text-sm text-red-600 mb-2 font-medium">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        IMPORTANT : Chaque opération sélectionnée DOIT avoir un commentaire rédigé par l'opérateur
                            </div>


                        </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('gestion-operations')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-cogs mr-2"></i>Valider les opérations
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

                        <!-- Section 4: Articles de la commande (largeur complète) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.8s;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" style="color: #4B352A;">
                            <i class="fas fa-box mr-3" style="color: #6d4b3b;"></i>Articles de la Commande (<span id="articles-count">{{ commande.paniers.count }}</span> article<span id="articles-plural">{{ commande.paniers.count|pluralize }}</span>)
                        </h3>
                        <button type="button" onclick="ajouterNouvelArticle()" 
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                            <i class="fas fa-plus mr-2"></i>Ajouter un article
                        </button>
                    </div>
                    
                    <!-- Liste des articles existants -->
                    <div id="articles-container" class="space-y-3 mb-6">
                        {% for panier in commande.paniers.all %}
                        <div class="article-card p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all shadow-sm" data-article-id="{{ panier.id }}">
                            <div class="flex items-center justify-between">
                                <!-- Informations de l'article -->
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4">
                                        <!-- Nom et référence -->
                                        <div class="min-w-0 flex-1">
                                            <div class="font-semibold text-lg" style="color: #4B352A;">{{ panier.article.nom }}</div>
                                            <div class="text-sm text-gray-500">
                                                <i class="fas fa-hashtag mr-1"></i>Réf: {{ panier.article.reference }}
                                            </div>
                                            <!-- Informations détaillées -->
                                            <div class="mt-2 flex flex-wrap gap-2">
                                                {% if panier.article.pointure %}
                                                <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                                    <i class="fas fa-ruler-vertical mr-1"></i>{{ panier.article.pointure }}
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                                    <i class="fas fa-ruler-vertical mr-1"></i>Taille N/A
                                                </span>
                                                {% endif %}
                                                
                                                {% if panier.article.couleur %}
                                                <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                                    <i class="fas fa-palette mr-1"></i>{{ panier.article.couleur }}
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                                    <i class="fas fa-palette mr-1"></i>Couleur N/A
                                                </span>
                                                {% endif %}
                                                
                                                {% if panier.article.categorie %}
                                                <span class="inline-flex items-center px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                                    <i class="fas fa-tag mr-1"></i>{{ panier.article.categorie }}
                                                </span>
                                                {% else %}
                                                <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                                    <i class="fas fa-tag mr-1"></i>Catégorie N/A
                                                </span>
                                                {% endif %}
                                                
                                                {% if panier.article.stock_disponible %}
                                                <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                                    <i class="fas fa-boxes mr-1"></i>Stock: {{ panier.article.stock_disponible }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Quantité -->
                                        <div class="text-center min-w-0">
                                            <div class="text-sm text-gray-500">Quantité</div>
                                            <div class="font-medium text-blue-600">{{ panier.quantite }} unité{{ panier.quantite|pluralize }}</div>
                                        </div>
                                        
                                        <!-- Prix unitaire -->
                                        <div class="text-center min-w-0">
                                            <div class="text-sm text-gray-500">Prix unitaire</div>
                                            <div class="font-medium text-green-600">{{ panier.article.prix_unitaire }} DH</div>
                                        </div>
                                        
                                        <!-- Sous-total -->
                                        <div class="text-center min-w-0">
                                            <div class="text-sm text-gray-500">Sous-total</div>
                                            <div class="text-lg font-bold" style="color: #6d4b3b;">{{ panier.sous_total }} DH</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Boutons d'action -->
                                <div class="flex space-x-2 ml-4">
                                    <button type="button" onclick="modifierArticle({{ panier.id }})" 
                                            class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                                            title="Modifier">
                                        <i class="fas fa-edit mr-1"></i>Modifier
                                    </button>
                                    <button type="button" onclick="supprimerArticle({{ panier.id }})" 
                                            class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                                            title="Supprimer">
                                        <i class="fas fa-trash mr-1"></i>Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Résumé total -->
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <div class="text-lg font-semibold text-gray-700">
                                <i class="fas fa-calculator mr-2"></i>Total de la commande:
                            </div>
                            <div class="text-2xl font-bold" style="color: #4B352A;" id="total-commande">
                                {{ commande.total_cmd|floatformat:2 }} DH
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('articles-commande')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-box mr-2"></i>Valider les articles
                        </button>
                    </div>
                
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-between items-center mt-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex gap-4">
                <a href="{% url 'operatConfirme:confirmation' %}" 
                   class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Retour à la confirmation
                </a>
                

            </div>
            
            <div class="flex gap-4">
                
                {% if commande.etat_actuel.enum_etat.libelle == 'Affectée' %}
                <button type="button" onclick="lancerConfirmation()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="fas fa-play mr-2"></i>
                    Lancer Confirmation
                </button>
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'En cours de confirmation' %}
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                {% endif %}
                
                <button type="button" onclick="confirmerCommande()" 
                        class="btn-confirm px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-check-circle mr-2"></i>
                    Confirmer la Commande
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modale de commentaire pour les opérations -->
<div id="commentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-comment text-blue-500 mr-3"></i>
            Commentaire pour <span id="operationName" class="text-blue-600"></span>
        </h3>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Conclusion de l'opérateur
            </label>
            <select id="commentSelect" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- Sélectionnez une conclusion --</option>
                <!-- Les options seront remplies dynamiquement selon le type d'opération -->
            </select>
            <div class="mt-1 text-xs text-red-600 font-medium">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Sélection obligatoire - l'opération sera ignorée sans conclusion
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closeCommentModal()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-1"></i>Annuler
            </button>
            <button onclick="saveComment()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 hover:bg-blue-700 text-white">
                <i class="fas fa-save mr-1"></i>Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modale pour ajouter/modifier un article -->
<div id="articleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-box text-blue-500 mr-3"></i>
            <span id="articleModalTitle">Ajouter un article</span>
        </h3>
        
        <form id="articleForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Sélection d'article (pour nouveaux articles) -->
                <div id="article-selection-field">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                    <select id="articleSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Sélectionner un article --</option>
                        <!-- Les articles seront chargés dynamiquement -->
                    </select>
                </div>
                
                <!-- Affichage du nom d'article (pour modifications) -->
                <div id="article-display-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                    <input type="text" id="articleDisplay" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                </div>
                
                <!-- Quantité -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantité</label>
                    <input type="number" id="quantiteInput" min="1" step="1" value="1" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <!-- Informations de l'article sélectionné -->
            <div id="article-info" class="hidden mt-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>Détails de l'article
                    </h4>
                    
                    <!-- Informations principales organisées en cartes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Carte Informations produit -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tag mr-2 text-blue-600"></i>Informations produit
                            </h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Référence :</span>
                                    <span id="info-reference" class="font-medium text-gray-800"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Prix unitaire :</span>
                                    <span id="info-prix" class="font-bold text-green-600"></span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-gray-700 font-medium">Sous-total :</span>
                                    <span id="info-sous-total" class="font-bold text-blue-600 text-lg"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Carte Caractéristiques -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-palette mr-2 text-purple-600"></i>Caractéristiques du produit
                            </h5>
                            
                            
                            <!-- Affichage classique formaté -->
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-700 font-medium">Taille : </span>
                                    <span id="info-pointure" class="text-purple-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Couleur : </span>
                                    <span id="info-couleur" class="text-orange-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Catégorie : </span>
                                    <span id="info-categorie" class="text-indigo-600 font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock et description -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-800 flex items-center">
                                <i class="fas fa-boxes mr-2 text-teal-600"></i>Stock disponible
                            </h5>
                            <span id="info-stock" class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full font-medium"></span>
                        </div>
                        <div id="info-description" class="text-sm text-gray-600 italic"></div>
                    </div>
                </div>
                
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeArticleModal()" 
                        class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-times mr-1"></i>Annuler
                </button>
                <button type="button" onclick="saveArticle()" 
                        class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 hover:bg-blue-700 text-white">
                    <i class="fas fa-save mr-1"></i>Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
// Fonction pour charger automatiquement la région et les frais
function chargerRegionEtFrais() {
    const villeSelect = document.getElementById('ville-select');
    const selectedOption = villeSelect.options[villeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const region = selectedOption.getAttribute('data-region');
        const frais = selectedOption.getAttribute('data-frais');
        
        document.getElementById('region-display').value = region;
        document.getElementById('frais-display').value = frais + ' DH';
    } else {
        document.getElementById('region-display').value = '';
        document.getElementById('frais-display').value = '';
    }
}

// Fonction pour vérifier une section
function verifierSection(section) {
    const sectionElement = document.querySelector(`[onclick="verifierSection('${section}')"]`).closest('.verification-item');
    sectionElement.classList.add('verified');
}

// Fonction pour vérifier toutes les sections
function verifierTout() {
    const sections = document.querySelectorAll('.verification-item');
    sections.forEach(section => {
        section.classList.add('verified');
    });
}

// Variables globales pour la modale
let currentOperationType = '';
let currentOperationName = '';

// Fonction pour ouvrir la modale de commentaire
function openCommentModal(operationType, operationName) {
    console.log('Ouverture modale pour:', operationType, operationName);
    
    try {
        currentOperationType = operationType;
        currentOperationName = operationName;
        
        // Vérifier que la modale existe
        const modal = document.getElementById('commentModal');
        if (!modal) {
            console.error('Modale commentModal introuvable !');
            alert('Erreur : Modale de commentaire introuvable');
            return;
        }
        
        // Mettre à jour le titre de la modale
        const operationNameElement = document.getElementById('operationName');
        if (operationNameElement) {
            operationNameElement.textContent = operationName;
        }
        
        // Remplir la liste déroulante selon le type d'opération
        remplirListeCommentaires(operationType);
        
        // Charger le commentaire existant s'il y en a un
        const commentField = document.getElementById('comment_' + operationType);
        const select = document.getElementById('commentSelect');
        
        if (commentField && select) {
            select.value = commentField.value || '';
        }
        
        // Afficher la modale avec animation
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Force le navigateur à reconnaître les changements
        modal.offsetHeight;
        
        console.log('Modale affichée avec succès');
        
        // Focus sur le select après un délai court
        setTimeout(() => {
            if (select) {
                select.focus();
            }
        }, 150);
        
    } catch (error) {
        console.error('Erreur lors de l\'ouverture de la modale:', error);
        alert('Erreur lors de l\'ouverture de la modale: ' + error.message);
    }
}

// Fonction pour fermer la modale
function closeCommentModal() {
    try {
        const modal = document.getElementById('commentModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentOperationType = '';
        currentOperationName = '';
        console.log('Modale fermée');
    } catch (error) {
        console.error('Erreur lors de la fermeture de la modale:', error);
    }
}

// Fonction pour sauvegarder le commentaire
function saveComment() {
    const commentText = document.getElementById('commentTextarea').value.trim();
    
    if (commentText) {
        // Sauvegarder dans le champ hidden
        document.getElementById('comment_' + currentOperationType).value = commentText;
        
        // Mettre à jour l'aperçu
        const previewElement = document.getElementById('preview_' + currentOperationType);
        previewElement.textContent = 'Commentaire: ' + (commentText.length > 50 ? commentText.substring(0, 50) + '...' : commentText);
        previewElement.classList.remove('hidden');
        
        // Cocher automatiquement l'opération si ce n'est pas déjà fait
        document.getElementById('op_' + currentOperationType).checked = true;
    } else {
        // Supprimer le commentaire et l'aperçu
        document.getElementById('comment_' + currentOperationType).value = '';
        document.getElementById('preview_' + currentOperationType).classList.add('hidden');
    }
    
    closeCommentModal();
}

// Variables globales pour le système de tableau
let operationCounter = 1;
let operationsTable = [];

// Variables globales pour le système en deux étapes
let typePrincipalSelectionne = '';

// Fonction pour ajouter une nouvelle opération dans le tableau
function ajouterNouvelleOperation() {
    // Afficher le sélecteur de type principal (Étape 1)
    document.getElementById('type-principal-selector').classList.remove('hidden');
}

// Fonction pour choisir le type principal d'opération (Étape 1)
function choisirTypePrincipal(typePrincipal) {
    typePrincipalSelectionne = typePrincipal;
    
    // Cacher le sélecteur de type principal
    document.getElementById('type-principal-selector').classList.add('hidden');
    
    // Pour WhatsApp, afficher les sous-options
    if (typePrincipal === 'WHATSAPP') {
        // Afficher les opérations spécifiques selon le type choisi
        afficherOperationsSpecifiques(typePrincipal);
        
        // Afficher le sélecteur d'opération (Étape 2)
        document.getElementById('operation-selector').classList.remove('hidden');
    } else {
        // Pour APPEL et SMS, aller directement à la sélection
        console.log(`⚡ Sélection directe pour ${typePrincipal} (pas de sous-menu)`);
        
        if (typePrincipal === 'APPEL') {
            selectionnerTypeOperation('APPEL', 'Appel', 'bg-blue-100 text-blue-800');
        } else if (typePrincipal === 'SMS') {
            selectionnerTypeOperation('ENVOI_SMS', 'Envoi de SMS', 'bg-green-100 text-green-800');
        }
    }
}

// Fonction pour afficher les opérations spécifiques selon le type (uniquement pour WhatsApp)
function afficherOperationsSpecifiques(typePrincipal) {
    const operationsList = document.getElementById('operations-list');
    let operationsHTML = '';
    
    // Cette fonction ne gère maintenant que WhatsApp
    if (typePrincipal === 'WHATSAPP') {
        operationsHTML = `
            <button type="button" onclick="selectionnerTypeOperation('Appel Whatsapp', 'Appel WhatsApp', 'bg-emerald-100 text-emerald-800')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                    <i class="fab fa-whatsapp mr-1"></i>Appel WhatsApp
                </span>
            </button>
            <button type="button" onclick="selectionnerTypeOperation('Message Whatsapp', 'Message WhatsApp', 'bg-emerald-200 text-emerald-900')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-200 text-emerald-900">
                    <i class="fas fa-message mr-1"></i>Message WhatsApp
                </span>
            </button>
            <button type="button" onclick="selectionnerTypeOperation('Vocal Whatsapp', 'Vocal WhatsApp', 'bg-teal-100 text-teal-800')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                    <i class="fas fa-microphone mr-1"></i>Vocal WhatsApp
                </span>
            </button>
        `;
    } else {
        console.warn(`⚠️ afficherOperationsSpecifiques() appelée pour un type non-WhatsApp: ${typePrincipal}`);
    }
    
    operationsList.innerHTML = operationsHTML;
}

// Fonction pour retourner au choix du type principal
function retourTypePrincipal() {
    // Cacher le sélecteur d'opération
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Afficher à nouveau le sélecteur de type principal
    document.getElementById('type-principal-selector').classList.remove('hidden');
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
}

// Fonction pour annuler la sélection d'opération
function annulerSelectionOperation() {
    // Cacher tous les sélecteurs
    document.getElementById('type-principal-selector').classList.add('hidden');
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
}

// Fonction pour sélectionner un type d'opération
function selectionnerTypeOperation(typeOperation, nomOperation, classeCouleur) {
    // Cacher tous les sélecteurs
    document.getElementById('type-principal-selector').classList.add('hidden');
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Générer un ID unique pour les nouvelles opérations
    const operationId = 'NEW-' + operationCounter.toString().padStart(3, '0');
    operationCounter++;
    
    // Date/heure actuelle
    const maintenant = new Date();
    const dateOperation = maintenant.toLocaleDateString('fr-FR') + ' ' + 
                         maintenant.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    
    // Ajouter le type principal au nom pour plus de clarté
    const nomComplet = `${typePrincipalSelectionne} - ${nomOperation}`;
    
    // Créer l'objet opération
    const nouvelleOperation = {
        id: operationId,
        type: typeOperation,
        nom: nomComplet,
        classe: classeCouleur,
        date: dateOperation,
        commentaire: '',
        typePrincipal: typePrincipalSelectionne
    };
    
    // Ajouter à la liste
    operationsTable.push(nouvelleOperation);
    
    // Mettre à jour l'affichage du tableau
    mettreAJourTableauOperations();
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
    
    console.log(`✅ Opération ajoutée: ${typeOperation} (${nomComplet})`);
    console.log('🗃️ Types d\'opérations valides en base:', ['APPEL', 'Appel Whatsapp', 'Message Whatsapp', 'Vocal Whatsapp', 'ENVOI_SMS']);
    
    // Ouvrir immédiatement la modale de commentaire
    setTimeout(() => {
        ouvrirModaleCommentaireTableau(operationId, nomComplet);
    }, 100);
}

// Fonction pour mettre à jour l'affichage du tableau
function mettreAJourTableauOperations() {
    const tbody = document.getElementById('operations-table-body');
    
    if (operationsTable.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-2xl mb-2"></i>
                    <div>Aucune opération ajoutée</div>
                    <div class="text-xs">Cliquez sur "Ajouter une opération" pour commencer</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = operationsTable.map(operation => {
        // Déterminer l'icône selon le type principal
        let iconeType = 'fas fa-cogs';
        let couleurType = 'text-gray-600';
        
        if (operation.typePrincipal === 'APPEL') {
            iconeType = 'fas fa-phone';
            couleurType = 'text-blue-600';
        } else if (operation.typePrincipal === 'SMS') {
            iconeType = 'fas fa-sms';
            couleurType = 'text-green-600';
        } else if (operation.typePrincipal === 'WHATSAPP') {
            iconeType = 'fab fa-whatsapp';
            couleurType = 'text-emerald-600';
        }
        
        return `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <i class="fas fa-hashtag mr-1" style="font-size: 8px;"></i>${operation.id}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">
                <div class="flex items-center space-x-2">
                    <i class="${iconeType} ${couleurType}" title="${operation.typePrincipal || 'Type non défini'}"></i>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${operation.classe}">
                        ${operation.nom}
                    </span>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">
                <i class="fas fa-clock mr-1"></i>${operation.date}
            </td>
            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center justify-center">
                        <button type="button" onclick="ouvrirModaleCommentaireTableau('${operation.id}', '${operation.nom}')" 
                                class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center">
                            <i class="fas fa-edit mr-1"></i>
                            Modifier
                        </button>
                </div>
                ${operation.commentaire ? `
                    <div class="mt-1 text-xs text-gray-600 italic flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-1"></i>
                        "${operation.commentaire.length > 50 ? operation.commentaire.substring(0, 50) + '...' : operation.commentaire}"
                    </div>
                ` : '<div class="mt-1 text-xs text-red-500 flex items-center"><i class="fas fa-exclamation-circle mr-1"></i>Commentaire requis</div>'}
            </td>
        </tr>
        `;
    }).join('');
}

// Fonction pour ouvrir la modale de commentaire spécifique au tableau
function ouvrirModaleCommentaireTableau(operationId, nomOperation) {
    currentOperationType = operationId; // Réutiliser la variable globale
    currentOperationName = nomOperation;
    
    // Trouver l'opération dans le tableau
    const operation = operationsTable.find(op => op.id === operationId);
    
    // Mettre à jour le titre de la modale
    document.getElementById('operationName').textContent = nomOperation + ' (' + operationId + ')';
    
    // Remplir la liste déroulante selon le type d'opération
    if (operation) {
        remplirListeCommentaires(operation.type);
    }
    
    // Charger le commentaire existant
    const select = document.getElementById('commentSelect');
    select.value = operation ? operation.commentaire : '';
    
    // Afficher la modale
    const modal = document.getElementById('commentModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale commentModal introuvable lors de l\'affichage');
    }
    
    // Focus sur le select
    setTimeout(() => {
        select.focus();
    }, 150);
}

// Fonction pour sauvegarder le commentaire (modifiée pour le tableau)
function saveComment() {
    const commentText = document.getElementById('commentSelect').value.trim();
    
    if (!commentText) {
        alert('Vous devez sélectionner une conclusion pour enregistrer l\'opération !');
        return;
    }
    
    console.log(`💾 DEBUG: Sauvegarde du commentaire: "${commentText}" pour ${currentOperationType}`);
    
    // Trouver et mettre à jour l'opération dans le tableau
    const operation = operationsTable.find(op => op.id === currentOperationType);
    if (operation) {
        const ancienCommentaire = operation.commentaire;
        operation.commentaire = commentText;
        
        console.log(`🔍 DEBUG: Opération trouvée: ${operation.id}, fromDatabase: ${operation.fromDatabase}`);
        console.log(`📝 DEBUG: Commentaire ancien: "${ancienCommentaire}" → nouveau: "${commentText}"`);
        
        // NOUVEAU: Sauvegarder TOUTES les opérations immédiatement en base de données
        if (operation.fromDatabase) {
            // Opération existante : utiliser update_operation
            console.log(`🔄 DEBUG: Sauvegarde d'une opération existante (DB)`);
            sauvegarderOperationExistante(operation, commentText);
        } else {
            // Nouvelle opération : créer en base de données immédiatement
            console.log(`🆕 DEBUG: Sauvegarde d'une nouvelle opération`);
            sauvegarderNouvelleOperation(operation, commentText);
        }
        
        // Mettre à jour l'affichage
        mettreAJourTableauOperations();
    }
    
    closeCommentModal();
}

// Fonction pour sauvegarder immédiatement une opération existante en base de données
function sauvegarderOperationExistante(operation, nouveauCommentaire) {
    console.log(`🔄 DEBUG: Sauvegarde immédiate de l'opération ${operation.id} en base de données...`);
    console.log(`📝 DEBUG: Nouveau commentaire à sauvegarder: "${nouveauCommentaire}"`);
    
    // Extraire l'ID numérique de l'opération (ex: "DB-51" -> "51")
    const operationDbId = operation.id.replace('DB-', '');
    console.log(`🔢 DEBUG: ID numérique extrait: ${operationDbId}`);
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        console.log(`🔐 DEBUG: Token CSRF ajouté: ${csrfToken.value.substring(0, 10)}...`);
    } else {
        console.error('❌ DEBUG: Token CSRF introuvable !');
    }
    
    // Ajouter l'action spécifique pour modifier une opération existante
    formData.append('action', 'update_operation');
    formData.append('operation_id', operationDbId);
    formData.append('nouveau_commentaire', nouveauCommentaire);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Debug des données envoyées
    console.log('📦 DEBUG: Données envoyées au serveur:');
    for (let [key, value] of formData.entries()) {
        console.log(`   - ${key}: ${value}`);
    }
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse reçue, status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données de réponse:', data);
        
        if (data.success) {
            console.log('✅ DEBUG: Opération mise à jour en base de données avec succès');
            console.log(`📋 DEBUG: Ancien commentaire: "${data.ancien_commentaire}"`);
            console.log(`📝 DEBUG: Nouveau commentaire: "${data.nouveau_commentaire}"`);
            
            if (data.debug_info) {
                console.log(`🔍 DEBUG: Vérification en base: "${data.debug_info.verification_conclusion}"`);
                console.log(`📊 DEBUG: Total opérations: ${data.debug_info.total_operations}`);
            }
            
            showNotification(`✅ Opération "${operation.nom}" mise à jour en base de données`, 'success');
            
            // Recharger les opérations depuis la base de données pour refléter les changements
            rechargerOperationsDepuisBase();
            } else {
            console.error('❌ DEBUG: Erreur lors de la mise à jour:', data.error);
            showNotification('❌ Erreur lors de la sauvegarde: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors de la sauvegarde', 'error');
    });
}

// Fonction pour sauvegarder immédiatement une nouvelle opération en base de données
function sauvegarderNouvelleOperation(operation, commentaire) {
    console.log(`🆕 DEBUG: Création immédiate d'une nouvelle opération en base de données...`);
    console.log(`📝 DEBUG: Type: ${operation.type}, Commentaire: "${commentaire}"`);
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        console.log(`🔐 DEBUG: Token CSRF ajouté`);
    } else {
        console.error('❌ DEBUG: Token CSRF introuvable !');
    }
    
    // Ajouter l'action pour créer une nouvelle opération
    formData.append('action', 'create_operation');
    formData.append('type_operation', operation.type);
    formData.append('commentaire', commentaire);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Debug des données envoyées
    console.log('📦 DEBUG: Données envoyées pour création opération:');
    for (let [key, value] of formData.entries()) {
        console.log(`   - ${key}: ${value}`);
    }
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse création reçue, status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données de réponse création:', data);
        
        if (data.success) {
            console.log('✅ DEBUG: Nouvelle opération créée en base de données avec succès');
            console.log(`🔢 DEBUG: Nouvel ID en base: ${data.operation_id}`);
            
            // Transformer l'opération locale en opération de base de données
            operation.id = `DB-${data.operation_id}`;
            operation.fromDatabase = true;
            
            console.log(`🔄 DEBUG: Opération transformée: ${operation.id} (fromDatabase: true)`);
            
            showNotification(`✅ Opération "${operation.nom}" créée et sauvegardée en base de données`, 'success');
            
            // Recharger les opérations depuis la base de données pour refléter les changements
            rechargerOperationsDepuisBase();
        } else {
            console.error('❌ DEBUG: Erreur lors de la création:', data.error);
            showNotification('❌ Erreur lors de la création: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion lors de la création:', error);
        showNotification('❌ Erreur de connexion lors de la création', 'error');
    });
}





// Types d'opérations valides selon la base de données
const TYPES_OPERATIONS_VALIDES = ['APPEL', 'Appel Whatsapp', 'Message Whatsapp', 'Vocal Whatsapp', 'ENVOI_SMS'];

// Variable globale pour stocker les commentaires chargés depuis l'API
let COMMENTAIRES_PREDEFINIES = {};

// Charger les commentaires depuis l'API Django au démarrage
function chargerCommentairesDisponibles() {
    console.log('🔄 Chargement des commentaires depuis l\'API Django...');
    
    fetch('{% url "operatConfirme:api_commentaires_disponibles" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                COMMENTAIRES_PREDEFINIES = data.commentaires;
                console.log('✅ Commentaires chargés depuis la base de données:', COMMENTAIRES_PREDEFINIES);
                
                // Afficher le nombre de commentaires par type d'opération
                Object.keys(COMMENTAIRES_PREDEFINIES).forEach(type => {
                    console.log(`📝 ${type}: ${COMMENTAIRES_PREDEFINIES[type].length} commentaires disponibles`);
                });
            } else {
                console.error('❌ Erreur lors du chargement des commentaires:', data.error);
                // Utiliser un fallback en cas d'erreur
                utiliserCommentairesFallback();
            }
        })
        .catch(error => {
            console.error('❌ Erreur de connexion à l\'API commentaires:', error);
            // Utiliser un fallback en cas d'erreur
            utiliserCommentairesFallback();
        });
}

// Fonction de fallback en cas d'erreur de chargement des commentaires
function utiliserCommentairesFallback() {
    console.warn('⚠️ Utilisation des commentaires de fallback');
    COMMENTAIRES_PREDEFINIES = {
        'APPEL': [
            { value: 'Client contacté avec succès', label: 'Client contacté avec succès' }
        ],
        'ENVOI_SMS': [
            { value: 'SMS envoyé avec succès', label: 'SMS envoyé avec succès' }
        ],
        'Appel Whatsapp': [
            { value: 'Appel WhatsApp réussi', label: 'Appel WhatsApp réussi' }
        ],
        'Message Whatsapp': [
            { value: 'Message WhatsApp envoyé', label: 'Message WhatsApp envoyé' }
        ],
        'Vocal Whatsapp': [
            { value: 'Message vocal envoyé', label: 'Message vocal envoyé' }
        ]
    };
}

// Fonction pour recharger les opérations depuis la base de données via AJAX
function rechargerOperationsDepuisBase() {
    console.log('🔄 DEBUG: Rechargement des opérations depuis la base de données...');
    console.log(`📊 DEBUG: État actuel du tableau: ${operationsTable.length} opération(s)`);
    
    // Faire une requête AJAX pour récupérer les opérations mises à jour
    fetch(`/operateur-confirme/api/commandes/{{ commande.id }}/operations/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse API reçue, status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données API reçues:', data);
        
        if (data.success) {
            console.log(`🔄 DEBUG: ${data.operations.length} opération(s) rechargée(s) depuis la base`);
            
            // Séparer les nouvelles opérations des existantes (celles qui ne sont pas encore en base)
            const nouvellesOperations = operationsTable.filter(op => !op.fromDatabase);
            console.log(`📝 DEBUG: ${nouvellesOperations.length} nouvelle(s) opération(s) locale(s) conservée(s)`);
            
            // Remplacer les opérations existantes par les données fraîches de la base
            const operationsFromDatabase = data.operations.map(op => {
                console.log(`🔍 DEBUG: Opération de la base DB-${op.id}: "${op.conclusion}"`);
                return {
                    id: `DB-${op.id}`,
                    type: op.type_operation,
                    nom: op.nom_display,
                    classe: op.classe_css,
                    date: op.date_operation,
                    commentaire: op.conclusion,
                    typePrincipal: op.type_principal,
                    fromDatabase: true
                };
            });
            
            // Debug avant recombination
            console.log('📋 DEBUG: Comparaison avant/après recombination:');
            console.log('   - Ancien tableau operationsTable:', operationsTable);
            console.log('   - Nouvelles opérations de la base:', operationsFromDatabase);
            console.log('   - Nouvelles opérations locales conservées:', nouvellesOperations);
            
            // Recombiner : opérations de base + nouvelles opérations
            operationsTable = [...operationsFromDatabase, ...nouvellesOperations];
            
            console.log(`📊 DEBUG: Tableau final: ${operationsTable.length} opération(s) total`);
            console.log('   - Depuis la base:', operationsFromDatabase.length);
            console.log('   - Nouvelles locales:', nouvellesOperations.length);
            console.log('📋 DEBUG: Nouveau tableau operationsTable:', operationsTable);
            
            // Mettre à jour l'affichage
            mettreAJourTableauOperations();
            
            console.log('✅ DEBUG: Tableau des opérations mis à jour avec les données fraîches de la base');
            showNotification('🔄 Tableau rechargé depuis la base de données', 'info');
        } else {
            console.error('❌ DEBUG: Erreur lors du rechargement:', data.error);
            showNotification('❌ Erreur lors du rechargement: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion:', error);
        showNotification('❌ Erreur lors du rechargement des opérations', 'error');
    });
}

// Fonction pour charger les opérations existantes depuis la base de données
function chargerOperationsExistantes() {
    console.log('🔄 Chargement des opérations existantes depuis la base de données...');
    
    // Récupérer les opérations déjà effectuées depuis les données Django
    {% if commande.operations.all %}
    const operationsExistantes = [
        {% for operation in commande.operations.all %}
        {
            id: 'DB-{{ operation.id }}',
            type: '{{ operation.type_operation }}',
            nom: '{{ operation.get_type_operation_display }}',
            classe: '{% if operation.type_operation == "APPEL" %}bg-blue-100 text-blue-800{% elif operation.type_operation == "ENVOI_SMS" %}bg-green-100 text-green-800{% elif operation.type_operation == "Appel Whatsapp" %}bg-emerald-100 text-emerald-800{% elif operation.type_operation == "Message Whatsapp" %}bg-emerald-100 text-emerald-800{% elif operation.type_operation == "Vocal Whatsapp" %}bg-emerald-100 text-emerald-800{% else %}bg-gray-100 text-gray-800{% endif %}',
            date: '{{ operation.date_operation|date:"d/m/Y H:i" }}',
            commentaire: '{{ operation.conclusion|escapejs }}',
            typePrincipal: '{% if operation.type_operation == "APPEL" %}APPEL{% elif operation.type_operation == "ENVOI_SMS" %}SMS{% elif "Whatsapp" in operation.type_operation %}WHATSAPP{% else %}OTHER{% endif %}',
            fromDatabase: true
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Ajouter les opérations existantes au tableau
    operationsTable = [...operationsExistantes];
    console.log(`✅ ${operationsExistantes.length} opération(s) existante(s) chargée(s) depuis la base`);
    
    // Mettre à jour l'affichage du tableau
    mettreAJourTableauOperations();
    
    // Créer les champs cachés pour ces opérations
    creerChampsFormulaire();
    
    {% else %}
    console.log('ℹ️ Aucune opération existante trouvée en base de données');
    {% endif %}
    
    // Mettre à jour le compteur global des opérations
    if (operationCounter <= operationsTable.length) {
        operationCounter = operationsTable.length + 1;
    }
}

// Fonction pour valider un type d'opération
function validerTypeOperation(typeOperation) {
    const isValid = TYPES_OPERATIONS_VALIDES.includes(typeOperation);
    if (!isValid) {
        console.warn(`⚠️ Type d'opération invalide: "${typeOperation}"`);
        console.log('✅ Types valides:', TYPES_OPERATIONS_VALIDES);
    }
    return isValid;
}

// Fonction pour remplir la liste déroulante de commentaires selon le type d'opération
function remplirListeCommentaires(typeOperation) {
    const select = document.getElementById('commentSelect');
    
    // Réinitialiser la liste
    select.innerHTML = '<option value="">-- Sélectionnez une conclusion --</option>';
    
    // Déterminer le type d'opération à utiliser pour chercher les commentaires
    let typeOperationKey = typeOperation;
    
    // Si c'est un ID d'opération du tableau, extraire le vrai type
    if (typeOperation.startsWith('OP-')) {
        const operation = operationsTable.find(op => op.id === typeOperation);
        if (operation) {
            typeOperationKey = operation.type;
        }
    }
    
    console.log(`📝 Remplissage commentaires pour: ${typeOperationKey}`);
    
    // Remplir avec les commentaires prédéfinis depuis l'API
    const commentaires = COMMENTAIRES_PREDEFINIES[typeOperationKey];
    if (commentaires && commentaires.length > 0) {
        commentaires.forEach(commentaireObj => {
            const option = document.createElement('option');
            // Utiliser la structure {value, label} depuis l'API
            option.value = commentaireObj.value;
            option.textContent = commentaireObj.label;
            select.appendChild(option);
        });
        
        console.log(`✅ ${commentaires.length} commentaires ajoutés pour ${typeOperationKey}`);
    } else {
        console.warn(`⚠️ Aucun commentaire prédéfini trouvé pour: ${typeOperationKey}`);
        
        // Ajouter une option générique si aucun commentaire prédéfini
        const option = document.createElement('option');
        option.value = 'Opération effectuée avec succès';
        option.textContent = 'Opération effectuée avec succès';
        select.appendChild(option);
    }
}

// Fonction pour créer les champs cachés du formulaire
function creerChampsFormulaire() {
    console.log('🔧 Création des champs cachés pour le formulaire...');
    
    // Supprimer les anciens champs
    const anciensChampsOperations = document.querySelectorAll('input[name="operations[]"]');
    const anciensChampsCommentaires = document.querySelectorAll('input[name^="comment_"]');
    
    console.log(`🗑️ Suppression de ${anciensChampsOperations.length} anciens champs d'opérations`);
    console.log(`🗑️ Suppression de ${anciensChampsCommentaires.length} anciens champs de commentaires`);
    
    anciensChampsOperations.forEach(input => input.remove());
    anciensChampsCommentaires.forEach(input => input.remove());
    
    // Vérifier que le formulaire existe
    const form = document.getElementById('modification-form');
    if (!form) {
        console.error('❌ Formulaire modification-form introuvable !');
        return;
    }
    
    let champsCreesOperations = 0;
    let champsCreesCommentaires = 0;
    
    // Créer les nouveaux champs pour chaque opération (sauf celles déjà en base)
    operationsTable.forEach((operation, index) => {
        // Ignorer les opérations déjà sauvegardées en base de données
        if (operation.fromDatabase) {
            console.log(`⏭️ Opération ${index + 1} ignorée (déjà en base): ${operation.type}`);
            return;
        }
        
        if (operation.commentaire && operation.commentaire.trim()) {
            // Valider le type d'opération
            if (!validerTypeOperation(operation.type)) {
                console.error(`❌ Opération ${index + 1} ignorée (type invalide): ${operation.type}`);
                return;
            }
            
            console.log(`➕ Ajout opération ${index + 1}: ${operation.type} = "${operation.commentaire}"`);
            
            // Champ pour le type d'opération
            const inputType = document.createElement('input');
            inputType.type = 'hidden';
            inputType.name = 'operations[]';
            inputType.value = operation.type;
            form.appendChild(inputType);
            champsCreesOperations++;
            
            // Champ pour le commentaire
            const inputComment = document.createElement('input');
            inputComment.type = 'hidden';
            inputComment.name = 'comment_' + operation.type;
            inputComment.value = operation.commentaire;
            form.appendChild(inputComment);
            champsCreesCommentaires++;
            
        } else {
            console.warn(`⚠️ Opération ${index + 1} ignorée (pas de commentaire): ${operation.type}`);
        }
    });
    
    console.log(`✅ ${champsCreesOperations} champs d'opérations créés`);
    console.log(`✅ ${champsCreesCommentaires} champs de commentaires créés`);
    
    // Afficher un résumé des données qui seront envoyées
    if (champsCreesOperations > 0) {
        console.log('📤 Données d\'opérations qui seront envoyées au serveur:');
        const operationsValues = Array.from(document.querySelectorAll('input[name="operations[]"]')).map(input => input.value);
        const commentairesValues = Array.from(document.querySelectorAll('input[name^="comment_"]')).map(input => `${input.name}: "${input.value}"`);
        
        console.log('  - Opérations:', operationsValues);
        console.log('  - Commentaires:', commentairesValues);
    }
}

// Fonction pour vérifier qu'au moins une opération est dans le tableau avant la soumission
function verifierOperationsSelectionnees() {
    console.log('🔍 Vérification des opérations avant sauvegarde...');
    console.log('📊 Opérations dans le tableau:', operationsTable);
    
    const operationsAvecCommentaire = operationsTable.filter(op => op.commentaire && op.commentaire.trim());
    
    // Permettre la sauvegarde sans opérations (pour sauvegarder juste les infos de commande/articles)
    if (operationsTable.length === 0) {
        console.log('ℹ️ Aucune opération ajoutée - sauvegarde des informations de commande uniquement');
        showNotification('💾 Sauvegarde des informations de commande', 'success');
        return true;
    }
    
    const operationsSansCommentaire = operationsTable.filter(op => !op.commentaire || !op.commentaire.trim());
    if (operationsSansCommentaire.length > 0) {
        alert(`❌ COMMENTAIRES OBLIGATOIRES MANQUANTS\n\nLes opérations suivantes nécessitent un commentaire :\n• ${operationsSansCommentaire.map(op => op.nom + ' (' + op.id + ')').join('\n• ')}\n\nVeuillez ajouter des commentaires pour toutes les opérations ou les supprimer du tableau.`);
        return false;
    }
    
    // Créer les champs du formulaire avant la soumission
    console.log('📋 Création des champs cachés pour les opérations...');
    creerChampsFormulaire();
    
    // Vérifier que les champs ont bien été créés
    const operationsFields = document.querySelectorAll('input[name="operations[]"]');
    const commentFields = document.querySelectorAll('input[name^="comment_"]');
    
    console.log(`✅ ${operationsFields.length} champs d'opérations créés`);
    console.log(`✅ ${commentFields.length} champs de commentaires créés`);
    
    if (operationsAvecCommentaire.length > 0) {
        showNotification(`💾 Sauvegarde : ${operationsAvecCommentaire.length} opération(s) avec commentaires`, 'success');
    }
    
    return true;
}

// Fermer la modale avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCommentModal();
    }
});

// Vérification et initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page chargée, initialisation du système...');
    
    try {
        // Vérifier que la modale existe
        const modal = document.getElementById('commentModal');
        if (!modal) {
            console.error('❌ Modale commentModal introuvable !');
            } else {
            console.log('✅ Modale commentModal trouvée');
            
            // Fermer la modale en cliquant à l'extérieur
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeCommentModal();
                }
            });
        }
        
        // Vérifier les éléments de la modale
        const operationNameElement = document.getElementById('operationName');
        const textarea = document.getElementById('commentTextarea');
        
        if (!operationNameElement) {
            console.warn('⚠️ Élément operationName introuvable');
        } else {
            console.log('✅ Élément operationName trouvé');
        }
        
        if (!textarea) {
            console.warn('⚠️ Textarea commentTextarea introuvable');
        } else {
            console.log('✅ Textarea commentTextarea trouvé');
        }
        
        // Vérifier les éléments du nouveau système
        const typePrincipalSelector = document.getElementById('type-principal-selector');
        const operationSelector = document.getElementById('operation-selector');
        const operationsList = document.getElementById('operations-list');
        const operationsTableBody = document.getElementById('operations-table-body');
        
        if (typePrincipalSelector) {
            console.log('✅ Sélecteur de type principal trouvé');
        } else {
            console.warn('⚠️ Sélecteur de type principal introuvable');
        }
        
        if (operationSelector) {
            console.log('✅ Sélecteur d\'opération trouvé');
        } else {
            console.warn('⚠️ Sélecteur d\'opération introuvable');
        }
        
        if (operationsList) {
            console.log('✅ Liste des opérations trouvée');w
        } else {
            console.warn('⚠️ Liste des opérations introuvable');
        }
        
        if (operationsTableBody) {
            console.log('✅ Corps du tableau des opérations trouvé');
        } else {
            console.warn('⚠️ Corps du tableau des opérations introuvable');
        }
        
        console.log('✅ Système de modales initialisé avec succès');
        
        // Initialiser le tableau des opérations avec vérification
        if (typeof mettreAJourTableauOperations === 'function') {
            mettreAJourTableauOperations();
            console.log('✅ Tableau des opérations initialisé');
        } else {
            console.error('❌ Fonction mettreAJourTableauOperations introuvable');
        }
        
        // Fonction de test pour vérifier que les modales fonctionnent
        window.testModal = function() {
            console.log('🧪 Test de la modale...');
            if (typeof openCommentModal === 'function') {
                openCommentModal('TEST', 'Test Opération');
            } else {
                console.error('❌ Fonction openCommentModal introuvable');
            }
        };
        
        // Fonction de test pour le nouveau système d'opérations
        window.testNouveauSysteme = function() {
            console.log('🧪 Test du nouveau système d\'opérations...');
            console.log('Variables globales:');
            console.log('- operationCounter:', typeof operationCounter !== 'undefined' ? operationCounter : 'Non défini');
            console.log('- operationsTable:', typeof operationsTable !== 'undefined' ? operationsTable : 'Non défini');
            console.log('- typePrincipalSelectionne:', typeof typePrincipalSelectionne !== 'undefined' ? typePrincipalSelectionne : 'Non défini');
            
            // Tester l'ajout d'une opération de test
            if (typeof ajouterNouvelleOperation === 'function') {
                ajouterNouvelleOperation();
                console.log('✅ Sélecteur de type principal affiché');
            } else {
                console.error('❌ Fonction ajouterNouvelleOperation introuvable');
            }
        };
        
        // Fonction de debug global
        window.debugSysteme = function() {
            console.log('🔍 Debug du système:');
            console.log('- DOMContentLoaded: ✅');
            console.log('- Modal:', document.getElementById('commentModal') ? '✅' : '❌');
            console.log('- Type principal selector:', document.getElementById('type-principal-selector') ? '✅' : '❌');
            console.log('- Operation selector:', document.getElementById('operation-selector') ? '✅' : '❌');
            console.log('- Operations list:', document.getElementById('operations-list') ? '✅' : '❌');
            console.log('- Operations table body:', document.getElementById('operations-table-body') ? '✅' : '❌');
            console.log('- operationCounter:', typeof operationCounter);
            console.log('- operationsTable:', typeof operationsTable);
            console.log('- typePrincipalSelectionne:', typeof typePrincipalSelectionne);
        };
        
        // Fonction de debug pour les articles
        window.debugArticles = function() {
            console.log('🔍 Debug des articles:');
            console.log('- articleSelect element:', document.getElementById('articleSelect') ? '✅' : '❌');
            console.log('- CSRF token:', document.querySelector('[name=csrfmiddlewaretoken]') ? '✅' : '❌');
            console.log('- API URL: {% url "operatConfirme:api_articles_disponibles" %}');
            console.log('- articlesDisponibles length:', articlesDisponibles ? articlesDisponibles.length : 'Non défini');
            
            // Test direct de l'API
            console.log('🧪 Test de l\'API en cours...');
            chargerArticlesDisponibles();
        };
        
        // Fonction pour tester manuellement l'API des articles
        window.testApiArticles = function() {
            console.log('🧪 Test manuel de l\'API des articles...');
            
            const apiUrl = '{% url "operatConfirme:api_articles_disponibles" %}';
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            
            console.log('📋 Informations de test:');
            console.log('- URL:', apiUrl);
            console.log('- CSRF Token présent:', csrfToken ? 'OUI' : 'NON');
            console.log('- Utilisateur connecté:', '{{ user.username }}');
            console.log('- Type d\'utilisateur:', '{{ user.profil_operateur.type_operateur|default:"Non défini" }}');
            
            if (!csrfToken) {
                console.error('❌ Token CSRF manquant');
                return;
            }
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken.value,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
            })
            .then(response => {
                console.log('📡 Statut de la réponse:', response.status, response.statusText);
                console.log('📋 Headers de réponse:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('❌ Réponse d\'erreur:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('✅ Données reçues:', data);
                
                if (data.success && data.articles) {
                    console.log(`📦 ${data.articles.length} article(s) trouvé(s)`);
                    data.articles.forEach((article, index) => {
                        console.log(`   Article ${index + 1}:`, {
                            id: article.id,
                            nom: article.nom,
                            reference: article.reference,
                            prix: article.prix_unitaire,
                            pointure: article.pointure,
                            couleur: article.couleur,
                            stock: article.qte_disponible
                        });
                    });
                } else {
                    console.error('❌ Pas d\'articles ou erreur:', data.error || 'Erreur inconnue');
                }
            })
            .catch(error => {
                console.error('❌ Erreur lors du test:', error);
            });
        };
        
        console.log('💡 Fonctions de test disponibles:');
        console.log('   - testModal() : Tester la modale');
        console.log('   - testNouveauSysteme() : Tester le système d\'opérations');
        console.log('   - debugSysteme() : Debug complet du système');
        console.log('   - debugArticles() : Debug et test des articles');
        console.log('   - testApiArticles() : Test manuel de l\'API des articles');
        
        // Afficher les informations sur les opérations
        console.log('🗃️ SYSTÈME D\'OPÉRATIONS:');
        console.log('   - Types valides en base de données:', TYPES_OPERATIONS_VALIDES);
        console.log('   - Sauvegarde: Table Operation (commande/models.py)');
        console.log('   - Validation: Automatique côté JavaScript + Django');
        console.log('   - Commentaires: Liste déroulante prédéfinie (plus rapide)');
        
        // Afficher le nombre de commentaires par type
        console.log('📝 COMMENTAIRES PRÉDÉFINIS:');
        Object.keys(COMMENTAIRES_PREDEFINIES).forEach(type => {
            console.log(`   - ${type}: ${COMMENTAIRES_PREDEFINIES[type].length} options`);
        });
        
        console.log('📋 Système complet initialisé avec succès');
        
    } catch (error) {
        console.error('❌ Erreur lors de l\'initialisation:', error);
    }
});

// Fonction pour changer l'opération (ancienne fonction - gardée pour compatibilité)
function changerOperation() {
    // Cette fonction n'est plus utilisée avec le nouveau système
    console.log('Fonction changerOperation() appelée - système d\'opérations individuelles actif');
    
    // Cette fonction est désactivée dans le nouveau système de tableau
    console.log('⚠️ Fonction désactivée - utilisez le système de tableau à la place');
}

// Fonction pour afficher des notifications discrètes
function showNotification(message, type = 'info') {
    try {
        const notification = document.createElement('div');
        
        // Déterminer les couleurs selon le type
        let bgColor = 'bg-blue-500'; // info par défaut
        if (type === 'success') bgColor = 'bg-green-500';
        else if (type === 'error') bgColor = 'bg-red-500';
        else if (type === 'warning') bgColor = 'bg-yellow-500';
        
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-all duration-300 ${bgColor} max-w-sm`;
        
        // Permettre les retours à la ligne dans les notifications
        notification.style.whiteSpace = 'pre-line';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Durée d'affichage variable selon le type et la longueur du message
        let duration = 3000; // 3 secondes par défaut
        if (type === 'success' && message.includes('décrémenté')) {
            duration = 5000; // 5 secondes pour les messages de stock
        } else if (type === 'error') {
            duration = 6000; // 6 secondes pour les erreurs
        }
        
        // Supprimer après la durée déterminée avec vérifications de sécurité
        setTimeout(() => {
            try {
                if (notification && notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        try {
                            if (notification && notification.parentNode) {
                                document.body.removeChild(notification);
                            }
                        } catch (error) {
                            console.warn('⚠️ Erreur lors de la suppression de la notification:', error);
                        }
                    }, 300);
                }
            } catch (error) {
                console.warn('⚠️ Erreur lors de la modification de l\'opacité de la notification:', error);
            }
        }, duration);
    } catch (error) {
        console.error('❌ Erreur lors de la création de la notification:', error);
        // Fallback vers une alerte simple
        alert(message);
    }
}

// Fonction pour afficher des notifications de stock avec plus de détails
function showStockNotification(detailsStock, type = 'success') {
    if (!detailsStock || detailsStock.length === 0) return;
    
    let message = '';
    if (type === 'success') {
        message = `📦 Stock mis à jour avec succès :\n\n`;
        detailsStock.forEach((item, index) => {
            message += `${index + 1}. ${item.article}\n`;
            message += `   ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})\n\n`;
        });
    }
    
    showNotification(message, type);
}



// Fonction pour lancer la confirmation (change l'état de Affectée à En cours)
function lancerConfirmation() {
        fetch(`{% url 'operatConfirme:lancer_confirmation' commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Confirmation lancée avec succès !', 'success');
                // Recharger la page pour voir les changements
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('Erreur lors du lancement : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du lancement de la confirmation.');
        });
}

// Fonction pour annuler définitivement la commande (En cours de confirmation -> Annulée)
function annulerCommande() {
    // Créer et afficher la modal d'annulation
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-bold text-gray-900">Annuler la commande {{ commande.id_yz }}</h3>
                    <p class="text-sm text-gray-600">Cette action est irréversible</p>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="motifAnnulationSelect" class="block text-sm font-semibold mb-2 text-gray-700">
                    Motif d'annulation <span class="text-red-500">*</span>
                </label>
                <select id="motifAnnulationSelect" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent mb-3" 
                        required>
                    <option value="">Sélectionner un motif...</option>
                    <option value="Doublon confirmé">Doublon confirmé</option>
                    <option value="Numéro tel incorrect">Numéro tel incorrect</option>
                    <option value="Numéro de téléphone injoignable">Numéro de téléphone injoignable</option>
                    <option value="Client non intéressé">Client non intéressé</option>
                    <option value="Adresse erronée">Adresse erronée</option>
                    <option value="Erreur de saisie">Erreur de saisie</option>
                    <option value="Autre">Autre (préciser ci-dessous)</option>
                </select>
                
                <div id="motifPersonnaliseDiv" style="display: none;">
                    <label for="motifAnnulation" class="block text-sm font-medium mb-2 text-gray-700">
                        Motif personnalisé
                    </label>
                    <textarea id="motifAnnulation" rows="2" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                            placeholder="Précisez le motif..."></textarea>
                </div>
                
                <p class="text-xs text-gray-500 mt-1">Le motif est obligatoire et sera visible dans l'historique</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" id="btnAnnulerModal" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button type="button" id="btnConfirmerAnnulation" 
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-ban mr-1"></i>Confirmer l'annulation
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Focus sur le select
    const motifSelect = document.getElementById('motifAnnulationSelect');
    const motifInput = document.getElementById('motifAnnulation');
    const motifPersonnaliseDiv = document.getElementById('motifPersonnaliseDiv');
    
    motifSelect.focus();
    
    // Gérer l'affichage du champ personnalisé
    motifSelect.addEventListener('change', function() {
        if (this.value === 'Autre') {
            motifPersonnaliseDiv.style.display = 'block';
            motifInput.focus();
        } else {
            motifPersonnaliseDiv.style.display = 'none';
            motifInput.value = '';
        }
    });
    
    // Fermer la modal
    document.getElementById('btnAnnulerModal').addEventListener('click', function() {
        document.body.removeChild(modal);
    });
    
    // Confirmer l'annulation
    document.getElementById('btnConfirmerAnnulation').addEventListener('click', function() {
        let motif = '';
        
        if (motifSelect.value === 'Autre') {
            motif = motifInput.value.trim();
            if (!motif) {
                motifInput.classList.add('border-red-500');
                motifInput.focus();
                return;
            }
        } else {
            motif = motifSelect.value;
            if (!motif) {
                motifSelect.classList.add('border-red-500');
                motifSelect.focus();
                return;
            }
        }
        
        // Envoyer la requête d'annulation
        fetch(`{% url 'operatConfirme:annuler_commande_confirmation' commande.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                motif: motif
            })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                showNotification('Commande annulée avec succès !', 'success');
                // Rediriger vers la liste des commandes confirmées après un court délai
            setTimeout(() => {
                    window.location.href = '{% url "operatConfirme:commandes_confirmees" %}';
            }, 1500);
        } else {
            alert('Erreur lors de l\'annulation : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'annulation de la commande.');
        })
        .finally(() => {
            document.body.removeChild(modal);
        });
    });
    
    // Fermer en cliquant à l'extérieur
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

// Fonction utilitaire pour sauvegarder les opérations avant une action
function sauvegarderOperationsAvantAction() {
    console.log('💾 Sauvegarde préventive des opérations avant action...');
    
    // Vérifier s'il y a des opérations à sauvegarder
    const operationsAvecCommentaire = operationsTable.filter(op => op.commentaire && op.commentaire.trim());
    
    if (operationsAvecCommentaire.length > 0) {
        // S'assurer que les champs sont créés pour la sauvegarde
        creerChampsFormulaire();
        
        // Soumettre silencieusement le formulaire pour sauvegarder les opérations
        const form = document.getElementById('modification-form');
        if (form) {
            console.log(`📤 Sauvegarde de ${operationsAvecCommentaire.length} opération(s) en cours...`);
            
            // Créer un FormData pour envoi AJAX
            const formData = new FormData(form);
            
            // Envoyer via AJAX pour éviter de recharger la page
            return fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('✅ Opérations sauvegardées avec succès');
                    showNotification('💾 Opérations sauvegardées', 'success');
                    return true;
                } else {
                    console.warn('⚠️ Erreur lors de la sauvegarde des opérations');
                    return false;
                }
            })
            .catch(error => {
                console.error('❌ Erreur de sauvegarde:', error);
                return false;
            });
        }
    }
    
    return Promise.resolve(true);
}

// Fonction pour confirmer la commande
function confirmerCommande() {
    // Vérifier que les sections essentielles sont remplies
    const nomClient = document.querySelector('[name="client_nom"]')?.value?.trim();
    const prenomClient = document.querySelector('[name="client_prenom"]')?.value?.trim();
    const telephoneClient = document.querySelector('[name="client_telephone"]')?.value?.trim();
    const villeId = document.querySelector('[name="ville_livraison"]')?.value;
    const adresse = document.querySelector('[name="adresse_livraison"]')?.value?.trim();
    
    // Vérifications essentielles
    if (!nomClient || !prenomClient) {
        showNotification('⚠️ Veuillez renseigner le nom et prénom du client', 'error');
        return;
    }
    
    if (!telephoneClient) {
        showNotification('⚠️ Veuillez renseigner le numéro de téléphone du client', 'error');
            return;
        }
        
    if (!villeId) {
        showNotification('⚠️ Veuillez sélectionner une ville de livraison', 'error');
        return;
    }
    
    // Vérifier que la région est bien remplie (automatiquement quand on sélectionne une ville)
    const regionDisplay = document.getElementById('region-display')?.value?.trim();
    if (!regionDisplay || regionDisplay === '') {
        showNotification('⚠️ La région n\'est pas définie. Veuillez re-sélectionner une ville de livraison', 'error');
        return;
    }
    
    if (!adresse) {
        showNotification('⚠️ Veuillez renseigner l\'adresse de livraison', 'error');
        return;
    }
    
    // Vérifier qu'il y a au moins un article dans la commande
    const articles = document.querySelectorAll('.article-card');
    if (articles.length === 0) {
        showNotification('⚠️ La commande doit contenir au moins un article', 'error');
        return;
                }
                
    console.log('✅ Toutes les vérifications passées, confirmation en cours...');
    
    // Afficher le modal de confirmation
    showConfirmationModal();
    return;
    
    // Afficher une notification de traitement en cours
    showNotification('⏳ Confirmation en cours... (vérification du stock)', 'info');
    
    // Confirmer directement la commande
    fetch(`/operateur-confirme/commandes/{{ commande.id }}/confirmer-ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'commentaire': 'Commande confirmée après vérification complète'
                })
        })
        .then(response => response.json())
        .then(data => {
            console.log('📬 DEBUG: Réponse de confirmation reçue:', data);
            
            if (data.success) {
                // Message de succès avec détails du stock
                let successMessage = '✅ Commande confirmée avec succès !';
                
                if (data.articles_decrémentes && data.articles_decrémentes > 0) {
                    successMessage += `\n📦 ${data.articles_decrémentes} article(s) décrémenté(s) du stock.`;
                    
                    // Log détaillé des modifications de stock
                    if (data.details_stock && data.details_stock.length > 0) {
                        console.log('📊 DEBUG: Détails de la décrémentation du stock:');
                        data.details_stock.forEach((item, index) => {
                            console.log(`   Article ${index + 1}: ${item.article}`);
                            console.log(`      - Stock: ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})`);
                        });
                    }
                }
                
                showNotification(successMessage, 'success');
                
                // Rediriger après un court délai pour voir la notification
                setTimeout(() => {
                window.location.href = '{% url "operatConfirme:commandes_confirmees" %}';
                }, 3000); // 3 secondes pour lire les détails
                
            } else {
                // Gestion des erreurs de stock insuffisant
                console.error('❌ DEBUG: Erreur de confirmation:', data.message);
                
                if (data.stock_insuffisant && data.stock_insuffisant.length > 0) {
                    // Préparer les données pour le modal de stock insuffisant
                    window.stockInsuffisantData = data.stock_insuffisant;
                    showStockInsuffisantModal();
                } else {
                    showNotification('❌ Erreur lors de la confirmation : ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('❌ DEBUG: Erreur de connexion:', error);
            showNotification('❌ Une erreur de connexion est survenue : ' + error.message, 'error');
        });
}

// ================== GESTION DES ARTICLES ==================

// Variables globales pour les articles
let articlesDisponibles = [];
let currentArticleId = null;
let isEditingArticle = false;

// Fonction pour ajouter un nouvel article
function ajouterNouvelArticle() {
    isEditingArticle = false;
    currentArticleId = null;
    
    // Mettre à jour le titre
    document.getElementById('articleModalTitle').textContent = 'Ajouter un article';
    
    // Afficher le champ de sélection, cacher l'affichage
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Réinitialiser le formulaire
    document.getElementById('articleSelect').value = '';
    document.getElementById('quantiteInput').value = '1';
    document.getElementById('article-info').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticlesDisponibles();
    
    // Afficher la modale
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de l\'ajout d\'article');
    }
}

// Fonction pour modifier un article existant
function modifierArticle(panierId) {
    console.log('🔧 Modification article demandée pour ID:', panierId);
    
    isEditingArticle = true;
    currentArticleId = panierId;
    
    // Mettre à jour le titre
    document.getElementById('articleModalTitle').textContent = 'Modifier l\'article';
    
    // Toujours afficher le champ de sélection pour permettre de changer l'article
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticlesDisponibles();
    
    // Récupérer les données de l'article depuis la carte
    const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
    console.log('🔍 Article card trouvé:', articleCard ? 'OUI' : 'NON', articleCard);
    
    if (articleCard) {
        const quantite = articleCard.querySelector('.text-blue-600').textContent.match(/\d+/)[0];
        document.getElementById('quantiteInput').value = quantite;
        
        // Récupérer la référence de l'article pour le pré-sélectionner
        const referenceText = articleCard.querySelector('.text-gray-500').textContent;
        const reference = referenceText.replace('Réf: ', '').replace('Référence: ', '').trim();
        
        // Attendre que les articles soient chargés puis pré-sélectionner l'article actuel
        setTimeout(() => {
            preselectionnerArticle(reference);
        }, 500);
        
        // Afficher les informations de l'article
        afficherInfosArticleExistant(articleCard);
    }
    
    // Afficher la modale
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de la modification d\'article');
    }
}

// Fonction pour pré-sélectionner un article dans la liste déroulante
function preselectionnerArticle(reference) {
    const select = document.getElementById('articleSelect');
    if (!select) {
        console.error('❌ Élément articleSelect introuvable');
        return;
    }
    
    // Chercher l'option correspondant à la référence
    for (let i = 0; i < select.options.length; i++) {
        const option = select.options[i];
        if (option.dataset.article) {
            try {
                const article = JSON.parse(option.dataset.article);
                if (article.reference === reference) {
                    select.selectedIndex = i;
                    console.log('✅ Article pré-sélectionné:', reference);
                    
                    // Déclencher l'événement de changement pour mettre à jour les informations
                    onArticleSelectionChange();
                    return;
                }
            } catch (error) {
                console.warn('⚠️ Erreur lors de l\'analyse des données article:', error);
            }
        }
    }
    
    console.warn('⚠️ Article non trouvé dans la liste pour référence:', reference);
}

// Fonction pour afficher les infos d'un article existant
function afficherInfosArticleExistant(articleCard) {
    const reference = articleCard.querySelector('.text-gray-500').textContent.replace('Réf: ', '').replace('Référence: ', '');
    const prixText = articleCard.querySelector('.text-green-600').textContent;
    const sousTotal = articleCard.querySelector('.text-lg.font-bold').textContent;
    
    // Informations de base (récupérées du DOM)
    document.getElementById('info-reference').textContent = reference;
    document.getElementById('info-prix').textContent = prixText;
    document.getElementById('info-sous-total').textContent = sousTotal;
    
    // Récupérer les caractéristiques depuis les badges
    const caracteristiques = extraireCaracteristiquesDepuisBadges(articleCard);
    
    // Mettre à jour les informations dans la modale
    console.log('📝 Mise à jour des infos modale:', {
        taille: caracteristiques.taille,
        couleur: caracteristiques.couleur,
        categorie: caracteristiques.categorie
    });
    
    document.getElementById('info-pointure').textContent = caracteristiques.taille || 'Non spécifiée';
    document.getElementById('info-couleur').textContent = caracteristiques.couleur || 'Non spécifiée';
    document.getElementById('info-categorie').textContent = caracteristiques.categorie || 'Non spécifiée';
    
    // Mettre à jour les badges dans la modale
    mettreAJourBadgesModale(caracteristiques);
    
    // Récupérer le stock depuis le badge vert s'il existe
    if (caracteristiques.stock) {
        document.getElementById('info-stock').textContent = caracteristiques.stock;
    } else {
        // Essayer de récupérer depuis l'API
        chargerInfosCompletesArticle(reference);
    }
    
    document.getElementById('info-description').textContent = caracteristiques.description || '';
    
    console.log('📋 Caractéristiques extraites:', caracteristiques);
    
    document.getElementById('article-info').classList.remove('hidden');
}

// Fonction pour extraire les caractéristiques depuis les badges de l'article
function extraireCaracteristiquesDepuisBadges(articleCard) {
    const caracteristiques = {
        taille: null,
        couleur: null,
        categorie: null,
        stock: null,
        description: ''
    };
    
    // Chercher la section contenant les badges
    const badgesContainer = articleCard.querySelector('.flex.flex-wrap.gap-2');
    
    if (badgesContainer) {
        const badges = badgesContainer.querySelectorAll('span');
        
        badges.forEach(badge => {
            const badgeText = badge.textContent.trim();
            const icon = badge.querySelector('i');
            
            if (icon) {
                const iconClasses = icon.className;
                
                // Détecter le type selon l'icône
                if (iconClasses.includes('fa-ruler-vertical')) {
                    // Badge de taille - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.taille = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-palette')) {
                    // Badge de couleur - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.couleur = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-tag')) {
                    // Badge de catégorie - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.categorie = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-boxes')) {
                    // Badge de stock - garde le format complet "Stock: X"
                    caracteristiques.stock = badgeText.trim();
                }
            }
        });
        
        console.log('🏷️ Badges trouvés et analysés:', {
            totalBadges: badges.length,
            caracteristiques: caracteristiques
        });
        
        // Debug détaillé de chaque badge
        badges.forEach((badge, index) => {
            console.log(`Badge ${index + 1}:`, {
                text: badge.textContent.trim(),
                classes: badge.className,
                iconClasses: badge.querySelector('i')?.className || 'Pas d\'icône'
            });
        });
    } else {
        console.warn('⚠️ Conteneur de badges non trouvé pour cet article');
        
        // Fallback : essayer l'ancien format
        const oldInfoSection = articleCard.querySelector('.text-xs.text-gray-600');
        if (oldInfoSection) {
            const infoText = oldInfoSection.textContent;
            
            // Extraire avec regex de l'ancien format
            const tailleMatch = infoText.match(/Taille:\s*([^,\s]+)/i);
            const couleurMatch = infoText.match(/Couleur:\s*([^,\s]+)/i);
            const categorieMatch = infoText.match(/Catégorie:\s*([^,\s]+)/i);
            
            if (tailleMatch) caracteristiques.taille = tailleMatch[1];
            if (couleurMatch) caracteristiques.couleur = couleurMatch[1];
            if (categorieMatch) caracteristiques.categorie = categorieMatch[1];
            
            console.log('🔄 Fallback vers ancien format utilisé');
        }
    }
    
    return caracteristiques;
}

// Fonction pour mettre à jour les badges de caractéristiques dans la modale
function mettreAJourBadgesModale(caracteristiques) {
    const badgesContainer = document.getElementById('caracteristiques-badges');
    
    if (!badgesContainer) {
        console.warn('⚠️ Conteneur de badges de la modale non trouvé');
        return;
    }
    
    // Vider le conteneur
    badgesContainer.innerHTML = '';
    
    // Badge Taille
    const tailleBadge = document.createElement('span');
    if (caracteristiques.taille) {
        tailleBadge.className = 'inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium';
        tailleBadge.innerHTML = `<i class="fas fa-ruler-vertical mr-1"></i>${caracteristiques.taille}`;
    } else {
        tailleBadge.className = 'inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs';
        tailleBadge.innerHTML = '<i class="fas fa-ruler-vertical mr-1"></i>Taille N/A';
    }
    badgesContainer.appendChild(tailleBadge);
    
    // Badge Couleur
    const couleurBadge = document.createElement('span');
    if (caracteristiques.couleur) {
        couleurBadge.className = 'inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium';
        couleurBadge.innerHTML = `<i class="fas fa-palette mr-1"></i>${caracteristiques.couleur}`;
    } else {
        couleurBadge.className = 'inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs';
        couleurBadge.innerHTML = '<i class="fas fa-palette mr-1"></i>Couleur N/A';
    }
    badgesContainer.appendChild(couleurBadge);
    
    // Badge Catégorie
    const categorieBadge = document.createElement('span');
    if (caracteristiques.categorie) {
        categorieBadge.className = 'inline-flex items-center px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium';
        categorieBadge.innerHTML = `<i class="fas fa-tag mr-1"></i>${caracteristiques.categorie}`;
    } else {
        categorieBadge.className = 'inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs';
        categorieBadge.innerHTML = '<i class="fas fa-tag mr-1"></i>Catégorie N/A';
    }
    badgesContainer.appendChild(categorieBadge);
    
    // Badge Stock (seulement si disponible)
    if (caracteristiques.stock) {
        const stockBadge = document.createElement('span');
        stockBadge.className = 'inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium';
        stockBadge.innerHTML = `<i class="fas fa-boxes mr-1"></i>${caracteristiques.stock}`;
        badgesContainer.appendChild(stockBadge);
    }
    
    console.log('🏷️ Badges de la modale mis à jour:', caracteristiques);
}

// Fonction pour charger les informations complètes d'un article par sa référence
function chargerInfosCompletesArticle(reference) {
    // Chercher l'article dans la liste déjà chargée
    if (articlesDisponibles && articlesDisponibles.length > 0) {
        const article = articlesDisponibles.find(a => a.reference === reference);
        if (article) {
            // Mettre à jour avec les informations complètes
            document.getElementById('info-pointure').textContent = article.pointure || '-';
            document.getElementById('info-couleur').textContent = article.couleur || '-';
            document.getElementById('info-categorie').textContent = article.categorie || '-';
            document.getElementById('info-stock').textContent = `${article.qte_disponible || 0} unité(s)`;
            
            console.log('📋 Informations complètes trouvées pour:', reference, article);
            return;
        }
    }
    
    // Si l'article n'est pas dans la liste, afficher des valeurs par défaut
    document.getElementById('info-pointure').textContent = '-';
    document.getElementById('info-couleur').textContent = '-';
    document.getElementById('info-categorie').textContent = '-';
    document.getElementById('info-stock').textContent = '-';
    
    console.log('⚠️ Informations complètes non trouvées pour:', reference);
}

// Fonction pour charger les articles disponibles via API
function chargerArticlesDisponibles() {
    const select = document.getElementById('articleSelect');
    if (!select) {
        console.error('❌ Élément articleSelect introuvable');
        return;
    }
    
    select.innerHTML = '<option value="">-- Chargement des articles... --</option>';
    console.log('🔄 Début du chargement des articles...');
    
    // Récupérer le token CSRF avec vérification
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('❌ Token CSRF introuvable');
        select.innerHTML = '<option value="">-- Erreur: Token CSRF manquant --</option>';
        return;
    }
    
    // URL de l'API
    const apiUrl = '{% url "operatConfirme:api_articles_disponibles" %}';
    console.log('🌐 URL API:', apiUrl);
    
    // Appel AJAX pour récupérer les articles
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        console.log('📡 Réponse reçue, status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('📊 Données reçues:', data);
        
        if (data.success && data.articles) {
            articlesDisponibles = data.articles;
            
            // Remplir le select
            select.innerHTML = '<option value="">-- Sélectionner un article --</option>';
            
            if (articlesDisponibles.length === 0) {
                select.innerHTML = '<option value="">-- Aucun article disponible --</option>';
                console.warn('⚠️ Aucun article trouvé dans la base de données');
                showNotification('⚠️ Aucun article disponible', 'error');
                return;
            }
            
            articlesDisponibles.forEach((article, index) => {
                try {
                    const option = document.createElement('option');
                    option.value = article.id;
                    
                    // Construire un texte plus informatif avec vérifications
                    let optionText = article.nom || 'Article sans nom';
                    
                    if (article.prix_unitaire) {
                        optionText += ` - ${article.prix_unitaire} DH`;
                    }
                    
                    // Ajouter taille et couleur si disponibles
                    const details = [];
                    if (article.pointure && article.pointure.trim()) {
                        details.push(`T:${article.pointure}`);
                    }
                    if (article.couleur && article.couleur.trim()) {
                        details.push(`C:${article.couleur}`);
                    }
                    
                    if (details.length > 0) {
                        optionText += ` (${details.join(', ')})`;
                    }
                    
                    option.textContent = optionText;
                    option.dataset.article = JSON.stringify(article);
                    select.appendChild(option);
                    
                    console.log(`📦 Article ${index + 1} ajouté:`, {
                        id: article.id,
                        nom: article.nom,
                        prix: article.prix_unitaire,
                        pointure: article.pointure,
                        couleur: article.couleur
                    });
                    
                } catch (error) {
                    console.error(`❌ Erreur lors de l'ajout de l'article ${index + 1}:`, error, article);
                }
            });
            
            console.log(`✅ ${articlesDisponibles.length} articles chargés avec succès`);
            showNotification(`✅ ${articlesDisponibles.length} article(s) chargé(s)`, 'success');
            
        } else {
            // Gestion d'erreur plus détaillée
            const errorMsg = data.error || 'Erreur inconnue lors du chargement';
            select.innerHTML = '<option value="">-- Erreur de chargement --</option>';
            console.error('❌ Erreur API:', errorMsg);
            showNotification(`❌ Erreur: ${errorMsg}`, 'error');
            
            // Afficher plus de détails pour le debug
            if (data.error) {
                console.error('📋 Détails de l\'erreur:', data);
            }
        }
    })
    .catch(error => {
        select.innerHTML = '<option value="">-- Erreur de connexion --</option>';
        console.error('❌ Erreur AJAX complète:', error);
        
        // Messages d'erreur plus spécifiques
        let errorMessage = 'Erreur de connexion';
        if (error.message.includes('403')) {
            errorMessage = 'Accès refusé - Vérifiez vos permissions';
        } else if (error.message.includes('404')) {
            errorMessage = 'API introuvable - Vérifiez l\'URL';
        } else if (error.message.includes('500')) {
            errorMessage = 'Erreur serveur - Vérifiez les logs Django';
        }
        
        showNotification(`❌ ${errorMessage}`, 'error');
        
        // Proposer une solution de fallback
        console.log('💡 Solutions possibles:');
        console.log('   1. Vérifiez que vous êtes connecté comme opérateur de confirmation');
        console.log('   2. Vérifiez qu\'il y a des articles dans la base de données');
        console.log('   3. Vérifiez les logs Django pour plus de détails');
    });
}

// Fonction appelée quand un article est sélectionné
function onArticleSelectionChange() {
    const select = document.getElementById('articleSelect');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        const article = JSON.parse(selectedOption.dataset.article);
        afficherInfosArticle(article);
    } else {
        document.getElementById('article-info').classList.add('hidden');
    }
}

// Fonction pour afficher les informations d'un article
function afficherInfosArticle(article) {
    const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
    const sousTotal = (article.prix_unitaire * quantite).toFixed(2);
    
    // Informations de base
    document.getElementById('info-reference').textContent = article.reference || '-';
    document.getElementById('info-prix').textContent = `${article.prix_unitaire} DH`;
    document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    
    // Nouvelles informations détaillées
    document.getElementById('info-pointure').textContent = article.pointure || 'Non spécifiée';
    document.getElementById('info-couleur').textContent = article.couleur || 'Non spécifiée';
    document.getElementById('info-categorie').textContent = article.categorie || 'Non spécifiée';
    document.getElementById('info-stock').textContent = `${article.qte_disponible || 0} unité(s)`;
    
    // Mettre à jour les badges avec les informations de l'article
    const caracteristiques = {
        taille: article.pointure || null,
        couleur: article.couleur || null,
        categorie: article.categorie || null,
        stock: article.qte_disponible ? `Stock: ${article.qte_disponible}` : null,
        description: article.description || ''
    };
    mettreAJourBadgesModale(caracteristiques);
    
    // Description
    document.getElementById('info-description').textContent = article.description || '';
    
    // Afficher la section des informations
    document.getElementById('article-info').classList.remove('hidden');
    
    console.log('📋 Informations article affichées:', {
        nom: article.nom,
        reference: article.reference,
        pointure: article.pointure,
        couleur: article.couleur,
        categorie: article.categorie,
        stock: article.qte_disponible
    });
}

// Fonction pour mettre à jour le sous-total quand la quantité change
function onQuantiteChange() {
    if (!isEditingArticle) {
        const select = document.getElementById('articleSelect');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            const article = JSON.parse(selectedOption.dataset.article);
            afficherInfosArticle(article);
        }
    } else {
        // Pour les modifications, on recalcule avec le prix actuel
        const prixText = document.getElementById('info-prix').textContent;
        const prix = parseFloat(prixText.replace(' DH', ''));
        const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
        const sousTotal = (prix * quantite).toFixed(2);
        
        document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    }
}

// Fonction pour sauvegarder l'article
function saveArticle() {
    const quantite = parseInt(document.getElementById('quantiteInput').value);
    
    if (!quantite || quantite < 1) {
        alert('⚠️ Veuillez saisir une quantité valide (minimum 1)');
        return;
    }
    
    // Vérifier qu'un article est sélectionné (même en mode modification)
        const select = document.getElementById('articleSelect');
        if (!select.value) {
            alert('⚠️ Veuillez sélectionner un article');
            return;
        }
        
        const selectedOption = select.options[select.selectedIndex];
        const article = JSON.parse(selectedOption.dataset.article);
        
    if (!isEditingArticle) {
        // Ajout d'un nouvel article
        ajouterArticleAuContainer(article, quantite);
    } else {
        // Modification d'un article existant - remplacer complètement l'article
        remplacerArticleExistant(article, quantite);
    }
    
    // Mettre à jour le total
    mettreAJourTotalCommande();
    
    // Fermer la modale
    closeArticleModal();
    
    // Sauvegarder immédiatement en base de données
    if (!isEditingArticle) {
        // Nouvel article - sauvegarder directement
        sauvegarderNouvelArticle(article, quantite);
        showNotification('✅ Article ajouté et sauvegardé', 'success');
    } else {
        // Article existant - remplacer en base de données
        sauvegarderRemplacementArticle(currentArticleId, article, quantite);
        showNotification('🔄 Article remplacé et sauvegardé', 'success');
    }
}

// Fonction pour ajouter un article au container
function ajouterArticleAuContainer(article, quantite) {
    const sousTotal = (article.prix_unitaire * quantite).toFixed(2);
    const articleId = `new-${Date.now()}`; // ID temporaire pour les nouveaux articles
    
    const articleHTML = `
        <div class="article-card p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all shadow-sm" data-article-id="${articleId}" data-is-new="true">
            <div class="flex items-center justify-between">
                <!-- Informations de l'article -->
                <div class="flex-1">
                    <div class="flex items-center space-x-4">
                        <!-- Nom et référence -->
                        <div class="min-w-0 flex-1">
                            <div class="font-semibold text-lg" style="color: #4B352A;">${article.nom}</div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-hashtag mr-1"></i>Réf: ${article.reference}
                            </div>
                                                         <!-- Informations détaillées -->
                             <div class="mt-2 flex flex-wrap gap-2">
                                 ${article.pointure ? 
                                     `<span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                         <i class="fas fa-ruler-vertical mr-1"></i>${article.pointure}
                                     </span>` : 
                                     `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                         <i class="fas fa-ruler-vertical mr-1"></i>Taille N/A
                                     </span>`
                                 }
                                 
                                 ${article.couleur ? 
                                     `<span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                         <i class="fas fa-palette mr-1"></i>${article.couleur}
                                     </span>` : 
                                     `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                         <i class="fas fa-palette mr-1"></i>Couleur N/A
                                     </span>`
                                 }
                                 
                                 ${article.categorie ? 
                                     `<span class="inline-flex items-center px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                         <i class="fas fa-tag mr-1"></i>${article.categorie}
                                     </span>` : 
                                     `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                         <i class="fas fa-tag mr-1"></i>Catégorie N/A
                                     </span>`
                                 }
                                 
                                 ${article.stock_disponible ? 
                                     `<span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                         <i class="fas fa-boxes mr-1"></i>Stock: ${article.stock_disponible}
                                     </span>` : ''
                                 }
                             </div>
                        </div>
                        
                        <!-- Quantité -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Quantité</div>
                            <div class="font-medium text-blue-600">${quantite} unité${quantite > 1 ? 's' : ''}</div>
                        </div>
                        
                        <!-- Prix unitaire -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Prix unitaire</div>
                            <div class="font-medium text-green-600">${article.prix_unitaire} DH</div>
                        </div>
                        
                        <!-- Sous-total -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Sous-total</div>
                            <div class="text-lg font-bold" style="color: #6d4b3b;">${sousTotal} DH</div>
                        </div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="flex space-x-2 ml-4">
                    <button type="button" onclick="modifierArticle('${articleId}')" 
                            class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                            title="Modifier">
                        <i class="fas fa-edit mr-1"></i>Modifier
                    </button>
                    <button type="button" onclick="supprimerArticle('${articleId}')" 
                            class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                            title="Supprimer">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </div>
            </div>
            <!-- Champs cachés pour le formulaire -->
            <input type="hidden" name="new_articles[]" value="${article.id}">
            <input type="hidden" name="new_quantities[]" value="${quantite}">
        </div>
    `;
    
    document.getElementById('articles-container').insertAdjacentHTML('beforeend', articleHTML);
    mettreAJourCompteurArticles();
}

// Fonction pour remplacer complètement un article existant
function remplacerArticleExistant(nouvelArticle, nouvelleQuantite) {
    const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
    if (articleCard) {
        const sousTotal = (nouvelArticle.prix_unitaire * nouvelleQuantite).toFixed(2);
        
        // Remplacer tout le contenu de la carte d'article
        const nouveauContenu = `
            <div class="flex items-center justify-between">
                <!-- Informations de l'article -->
                <div class="flex-1">
                    <div class="flex items-center space-x-4">
                        <!-- Nom et référence -->
                        <div class="min-w-0 flex-1">
                            <div class="font-semibold text-lg" style="color: #4B352A;">${nouvelArticle.nom}</div>
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-hashtag mr-1"></i>Réf: ${nouvelArticle.reference}
                            </div>
                            <!-- Informations détaillées -->
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${nouvelArticle.pointure ? 
                                    `<span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-ruler-vertical mr-1"></i>${nouvelArticle.pointure}
                                    </span>` : 
                                    `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                        <i class="fas fa-ruler-vertical mr-1"></i>Taille N/A
                                    </span>`
                                }
                                
                                ${nouvelArticle.couleur ? 
                                    `<span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-palette mr-1"></i>${nouvelArticle.couleur}
                                    </span>` : 
                                    `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                        <i class="fas fa-palette mr-1"></i>Couleur N/A
                                    </span>`
                                }
                                
                                ${nouvelArticle.categorie ? 
                                    `<span class="inline-flex items-center px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-tag mr-1"></i>${nouvelArticle.categorie}
                                    </span>` : 
                                    `<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-500 rounded-full text-xs">
                                        <i class="fas fa-tag mr-1"></i>Catégorie N/A
                                    </span>`
                                }
                                
                                ${nouvelArticle.qte_disponible ? 
                                    `<span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-boxes mr-1"></i>Stock: ${nouvelArticle.qte_disponible}
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        
                        <!-- Quantité -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Quantité</div>
                            <div class="font-medium text-blue-600">${nouvelleQuantite} unité${nouvelleQuantite > 1 ? 's' : ''}</div>
                        </div>
                        
                        <!-- Prix unitaire -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Prix unitaire</div>
                            <div class="font-medium text-green-600">${nouvelArticle.prix_unitaire} DH</div>
                        </div>
                        
                        <!-- Sous-total -->
                        <div class="text-center min-w-0">
                            <div class="text-sm text-gray-500">Sous-total</div>
                            <div class="text-lg font-bold" style="color: #6d4b3b;">${sousTotal} DH</div>
                        </div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="flex space-x-2 ml-4">
                    <button type="button" onclick="modifierArticle('${currentArticleId}')" 
                            class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                            title="Modifier">
                        <i class="fas fa-edit mr-1"></i>Modifier
                    </button>
                    <button type="button" onclick="supprimerArticle('${currentArticleId}')" 
                            class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors flex items-center" 
                            title="Supprimer">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </div>
            </div>
        `;
        
        // Remplacer le contenu HTML
        articleCard.innerHTML = nouveauContenu;
        
        // Mettre à jour ou ajouter les champs cachés pour le formulaire
        if (articleCard.dataset.isNew) {
            // Nouvel article - mettre à jour les champs cachés
            let articleInput = articleCard.querySelector('input[name="new_articles[]"]');
            let quantityInput = articleCard.querySelector('input[name="new_quantities[]"]');
            
            if (!articleInput) {
                articleInput = document.createElement('input');
                articleInput.type = 'hidden';
                articleInput.name = 'new_articles[]';
                articleCard.appendChild(articleInput);
            }
            if (!quantityInput) {
                quantityInput = document.createElement('input');
                quantityInput.type = 'hidden';
                quantityInput.name = 'new_quantities[]';
                articleCard.appendChild(quantityInput);
            }
            
            articleInput.value = nouvelArticle.id;
            quantityInput.value = nouvelleQuantite;
        } else {
            // Article existant - remplacement complet (supprimer l'ancien, ajouter le nouveau)
            
            // 1. Marquer l'ancien article pour suppression
            let deleteInput = articleCard.querySelector('input[name="deleted_articles[]"]');
            if (!deleteInput) {
                deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'deleted_articles[]';
                deleteInput.value = currentArticleId;
                articleCard.appendChild(deleteInput);
            }
            
            // 2. Ajouter le nouvel article
            let newArticleInput = articleCard.querySelector('input[name="new_articles[]"]');
            let newQuantityInput = articleCard.querySelector('input[name="new_quantities[]"]');
            
            if (!newArticleInput) {
                newArticleInput = document.createElement('input');
                newArticleInput.type = 'hidden';
                newArticleInput.name = 'new_articles[]';
                articleCard.appendChild(newArticleInput);
            }
            
            if (!newQuantityInput) {
                newQuantityInput = document.createElement('input');
                newQuantityInput.type = 'hidden';
                newQuantityInput.name = 'new_quantities[]';
                articleCard.appendChild(newQuantityInput);
            }
            
            newArticleInput.value = nouvelArticle.id;
            newQuantityInput.value = nouvelleQuantite;
            
            // 3. Marquer comme article remplacé pour le traitement côté serveur
            articleCard.dataset.isReplaced = 'true';
            
            console.log('🔄 Article existant remplacé:', {
                ancienId: currentArticleId,
                nouveauId: nouvelArticle.id,
                nouveauNom: nouvelArticle.nom,
                quantite: nouvelleQuantite
            });
        }
        
        console.log('✅ Article remplacé avec succès:', {
            ancien: currentArticleId,
            nouveau: nouvelArticle.nom,
            quantite: nouvelleQuantite
        });
        
        // Ajouter une notification explicite pour le remplacement d'article
        if (!articleCard.dataset.isNew) {
            console.log('🔄 Remplacement d\'article détecté - l\'ancien sera supprimé et le nouveau ajouté lors de la sauvegarde');
        }
    }
}

// Fonction pour modifier un article existant (ancienne version - gardée pour compatibilité)
function modifierArticleExistant(nouvelleQuantite) {
    const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
    if (articleCard) {
        // Mettre à jour la quantité
        const quantiteElement = articleCard.querySelector('.text-blue-600');
        quantiteElement.textContent = `${nouvelleQuantite} unité${nouvelleQuantite > 1 ? 's' : ''}`;
        
        // Recalculer le sous-total
        const prixElement = articleCard.querySelector('.text-green-600');
        const prix = parseFloat(prixElement.textContent.replace(' DH', ''));
        const nouveauSousTotal = (prix * nouvelleQuantite).toFixed(2);
        
        const sousTotalElement = articleCard.querySelector('.text-lg.font-bold');
        sousTotalElement.textContent = `${nouveauSousTotal} DH`;
        
        // Mettre à jour les champs cachés si c'est un nouvel article
        if (articleCard.dataset.isNew) {
            const quantityInput = articleCard.querySelector('input[name="new_quantities[]"]');
            if (quantityInput) {
                quantityInput.value = nouvelleQuantite;
            }
        } else {
            // Pour les articles existants, ajouter des champs de modification
            let modifInput = articleCard.querySelector('input[name="modified_articles[]"]');
            if (!modifInput) {
                modifInput = document.createElement('input');
                modifInput.type = 'hidden';
                modifInput.name = 'modified_articles[]';
                modifInput.value = currentArticleId;
                articleCard.appendChild(modifInput);
                
                const quantityInput = document.createElement('input');
                quantityInput.type = 'hidden';
                quantityInput.name = 'modified_quantities[]';
                quantityInput.value = nouvelleQuantite;
                articleCard.appendChild(quantityInput);
            } else {
                const quantityInput = articleCard.querySelector('input[name="modified_quantities[]"]');
                quantityInput.value = nouvelleQuantite;
            }
        }
    }
}

// Fonction pour supprimer un article
function supprimerArticle(articleId) {
    if (confirm('⚠️ Êtes-vous sûr de vouloir supprimer cet article de la commande ?')) {
        const articleCard = document.querySelector(`[data-article-id="${articleId}"]`);
        if (articleCard) {
            // Si c'est un nouvel article non sauvegardé, juste le supprimer du DOM
            if (articleCard.dataset.isNew) {
                articleCard.remove();
                mettreAJourCompteurArticles();
                mettreAJourTotalCommande();
                showNotification('🗑️ Article supprimé', 'success');
            } else {
                // Si c'est un article existant, le supprimer en base de données
                sauvegarderSuppressionArticle(articleId);
            }
        }
    }
}

// Fonction pour sauvegarder la suppression d'un article immédiatement
function sauvegarderSuppressionArticle(articleId) {
    console.log('🗑️ Sauvegarde immédiate de la suppression d\'article...');
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Ajouter les données de suppression
    formData.append('action', 'delete_article');
    formData.append('article_id', articleId);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Article supprimé de la base de données');
            
            // Supprimer du DOM
            const articleCard = document.querySelector(`[data-article-id="${articleId}"]`);
            if (articleCard) {
            articleCard.remove();
            }
            
            // Mettre à jour l'interface
            mettreAJourCompteurArticles();
            
            // Mettre à jour le total si fourni
            if (data.total_commande) {
                document.getElementById('total-commande').textContent = `${data.total_commande.toFixed(2)} DH`;
            }
            
            // Mettre à jour le compteur d'articles
            if (data.nb_articles !== undefined) {
                document.getElementById('articles-count').textContent = data.nb_articles;
                document.getElementById('articles-plural').textContent = data.nb_articles > 1 ? 's' : '';
            }
            
            showNotification('🗑️ Article supprimé et sauvegardé', 'success');
            
        } else {
            console.error('❌ Erreur lors de la suppression:', data.error);
            showNotification('❌ Erreur lors de la suppression: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors de la suppression', 'error');
    });
}

// Fonction pour fermer la modale d'article
function closeArticleModal() {
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de la fermeture');
    }
}

// Fonction pour mettre à jour le compteur d'articles
function mettreAJourCompteurArticles() {
    const articles = document.querySelectorAll('.article-card');
    const count = articles.length;
    
    document.getElementById('articles-count').textContent = count;
    document.getElementById('articles-plural').textContent = count > 1 ? 's' : '';
}

// Fonction pour mettre à jour le total de la commande
function mettreAJourTotalCommande() {
    const articles = document.querySelectorAll('.article-card');
    let total = 0;
    
    articles.forEach(article => {
        const sousTotalText = article.querySelector('.text-lg.font-bold').textContent;
        const sousTotal = parseFloat(sousTotalText.replace(' DH', ''));
        total += sousTotal;
    });
    
    document.getElementById('total-commande').textContent = `${total.toFixed(2)} DH`;
}

// Fonction pour sauvegarder un nouvel article immédiatement
function sauvegarderNouvelArticle(article, quantite) {
    console.log('💾 Sauvegarde immédiate d\'un nouvel article...');
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        }
        
    // Ajouter les données de l'article
    formData.append('action', 'add_article');
    formData.append('article_id', article.id);
    formData.append('quantite', quantite);
    formData.append('commande_id', '{{ commande.id }}');
        
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
            method: 'POST',
            body: formData,
            headers: {
            'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            console.log('✅ Nouvel article sauvegardé en base de données');
            
            // Mettre à jour l'ID de l'article dans le DOM avec l'ID réel de la base
            if (data.article_id) {
                const articleCard = document.querySelector(`[data-article-id^="new-"]`);
                if (articleCard) {
                    articleCard.setAttribute('data-article-id', data.article_id);
                    articleCard.removeAttribute('data-is-new');
                }
            }
            
            // Mettre à jour le total si fourni
            if (data.total_commande) {
                document.getElementById('total-commande').textContent = `${data.total_commande.toFixed(2)} DH`;
            }
                
                // Mettre à jour le compteur d'articles
                if (data.nb_articles) {
                    document.getElementById('articles-count').textContent = data.nb_articles;
                    document.getElementById('articles-plural').textContent = data.nb_articles > 1 ? 's' : '';
                }
                
        } else {
            console.error('❌ Erreur lors de la sauvegarde:', data.error);
            showNotification('❌ Erreur lors de la sauvegarde: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors de la sauvegarde', 'error');
    });
}

// Fonction pour sauvegarder le remplacement d'un article immédiatement
function sauvegarderRemplacementArticle(ancienArticleId, nouvelArticle, nouvelleQuantite) {
    console.log('🔄 Sauvegarde immédiate du remplacement d\'article...');
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Ajouter les données du remplacement
    formData.append('action', 'replace_article');
    formData.append('ancien_article_id', ancienArticleId);
    formData.append('nouvel_article_id', nouvelArticle.id);
    formData.append('nouvelle_quantite', nouvelleQuantite);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Remplacement d\'article sauvegardé en base de données');
            
            // Mettre à jour l'ID de l'article dans le DOM avec l'ID réel du nouveau panier
            if (data.nouvel_article_id) {
                const articleCard = document.querySelector(`[data-article-id="${ancienArticleId}"]`);
                if (articleCard) {
                    articleCard.setAttribute('data-article-id', data.nouvel_article_id);
                    articleCard.removeAttribute('data-is-replaced');
                }
            }
            
            // Mettre à jour le total si fourni
                if (data.total_commande) {
                    document.getElementById('total-commande').textContent = `${data.total_commande.toFixed(2)} DH`;
                }
                
            // Mettre à jour le compteur d'articles
            if (data.nb_articles) {
                document.getElementById('articles-count').textContent = data.nb_articles;
                document.getElementById('articles-plural').textContent = data.nb_articles > 1 ? 's' : '';
            }
            
            console.log('🔄 Remplacement terminé:', {
                ancien: ancienArticleId,
                nouveau: data.nouvel_article_id,
                article: nouvelArticle.nom
            });
            
            } else {
            console.error('❌ Erreur lors du remplacement:', data.error);
            showNotification('❌ Erreur lors du remplacement: ' + data.error, 'error');
            }
        })
        .catch(error => {
        console.error('❌ Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors du remplacement', 'error');
        });
}



// Ajouter les événements pour la modale d'articles et les raccourcis clavier
document.addEventListener('DOMContentLoaded', function() {
    // Événement pour la sélection d'article
    const articleSelect = document.getElementById('articleSelect');
    if (articleSelect) {
        articleSelect.addEventListener('change', onArticleSelectionChange);
    }
    
    // Événement pour le changement de quantité
    const quantiteInput = document.getElementById('quantiteInput');
    if (quantiteInput) {
        quantiteInput.addEventListener('input', onQuantiteChange);
    }
    
    // Fermer la modale en cliquant à l'extérieur
    const articleModal = document.getElementById('articleModal');
    if (articleModal) {
        articleModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeArticleModal();
            }
        });
    }
    
    // Raccourcis clavier pour l'interface
    document.addEventListener('keydown', function(event) {
        // Ctrl+S désactivé - sauvegarde automatique avec les boutons "Enregistrer"
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            showNotification('ℹ️ Sauvegarde automatique active - utilisez les boutons "Enregistrer"', 'success');
        }
        
        // Ctrl+Enter pour confirmer la commande
        if (event.ctrlKey && event.key === 'Enter') {
            event.preventDefault();
            console.log('⌨️ Raccourci Ctrl+Enter détecté - Confirmation...');
            confirmerCommande();
        }
        
        // Escape pour fermer les modales
        if (event.key === 'Escape') {
            const commentModal = document.getElementById('commentModal');
            const articleModal = document.getElementById('articleModal');
            
            if (commentModal && commentModal.style.display === 'flex') {
                closeCommentModal();
            }
            if (articleModal && articleModal.style.display === 'flex') {
                closeArticleModal();
            }
        }
    });
    
    // Charger les commentaires depuis l'API Django
    chargerCommentairesDisponibles();
    
    // Charger les articles disponibles au chargement de la page
    chargerArticlesDisponibles();
    
    // Charger les opérations existantes depuis la base de données
    chargerOperationsExistantes();
    

});

// ================== MODAL DE CONFIRMATION ==================

// Fonction pour afficher le modal de confirmation
function showConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
}

// Fonction pour masquer le modal de confirmation
function hideConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// Fonction pour procéder à la confirmation
function proceedWithConfirmation() {
    hideConfirmationModal();
    
    // Afficher une notification de traitement en cours
    showNotification('⏳ Confirmation en cours... (vérification du stock)', 'info');
    
    // Récupérer les informations de livraison du formulaire
    const villeSelect = document.getElementById('ville-select');
    const adresseTextarea = document.querySelector('textarea[name="adresse_livraison"]');
    
    const villeId = villeSelect ? villeSelect.value : '';
    const adresse = adresseTextarea ? adresseTextarea.value.trim() : '';
    
    console.log('🏙️ DEBUG: Données de livraison à envoyer:', {
        ville_livraison: villeId,
        adresse_livraison: adresse
    });
    
    // Confirmer la commande avec les informations de livraison
    fetch(`/operateur-confirme/commandes/{{ commande.id }}/confirmer-ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'commentaire': 'Commande confirmée après vérification complète',
                    'ville_livraison': villeId,
                    'adresse_livraison': adresse
                })
        })
        .then(response => response.json())
        .then(data => {
            console.log('📬 DEBUG: Réponse de confirmation reçue:', data);
            
            if (data.success) {
                // Message de succès avec détails du stock
                let successMessage = '✅ Commande confirmée avec succès !';
                
                if (data.articles_decrémentes && data.articles_decrémentes > 0) {
                    successMessage += `\n📦 ${data.articles_decrémentes} article(s) décrémenté(s) du stock.`;
                    
                    // Log détaillé des modifications de stock
                    if (data.details_stock && data.details_stock.length > 0) {
                        console.log('📊 DEBUG: Détails de la décrémentation du stock:');
                        data.details_stock.forEach((item, index) => {
                            console.log(`   Article ${index + 1}: ${item.article}`);
                            console.log(`      - Stock: ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})`);
                        });
                    }
                }
                
                showNotification(successMessage, 'success');
                
                // Rediriger après un court délai pour voir la notification
                setTimeout(() => {
                window.location.href = '{% url "operatConfirme:commandes_confirmees" %}';
                }, 3000); // 3 secondes pour lire les détails
                
            } else {
                // Gestion des erreurs de stock insuffisant
                console.error('❌ DEBUG: Erreur de confirmation:', data.message);
                
                if (data.stock_insuffisant && data.stock_insuffisant.length > 0) {
                    // Préparer les données pour le modal de stock insuffisant
                    window.stockInsuffisantData = data.stock_insuffisant;
                    showStockInsuffisantModal();
                } else {
                    showNotification('❌ Erreur lors de la confirmation : ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('❌ DEBUG: Erreur de connexion:', error);
            showNotification('❌ Une erreur de connexion est survenue : ' + error.message, 'error');
        });
}

// ================== MODAL DE STOCK INSUFFISANT ==================

// Fonction pour afficher le modal de stock insuffisant
function showStockInsuffisantModal() {
    // Remplir le contenu du modal avec les données de stock
    const stockList = document.getElementById('stockInsuffisantList');
    if (stockList && window.stockInsuffisantData) {
        stockList.innerHTML = '';
        window.stockInsuffisantData.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center py-2 px-3 bg-red-50 rounded-lg border border-red-200';
            li.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span class="font-medium text-gray-900">${item.article}</span>
                </div>
                <div class="text-sm text-red-600">
                    <span class="font-medium">Stock: ${item.stock_actuel}</span> | 
                    <span class="font-medium">Demandé: ${item.quantite_demandee}</span>
                </div>
            `;
            stockList.appendChild(li);
        });
    }
    
    const modal = document.getElementById('stockInsuffisantModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
}

// Fonction pour masquer le modal de stock insuffisant
function hideStockInsuffisantModal() {
    const modal = document.getElementById('stockInsuffisantModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// ================== VALIDATION DES SECTIONS ==================

// Fonction pour valider une section
function validerSection(sectionId) {
    const sectionElement = event.target.closest('.verification-item');
    const sectionName = getSectionName(sectionId);
    
    // Traitement spécifique pour les informations de livraison
    if (sectionId === 'informations-livraison') {
        sauvegarderInformationsLivraison(sectionElement, sectionName);
        return;
    }
    
    // Animation de validation pour les autres sections
    sectionElement.classList.add('verified');
    
    // Afficher une notification de succès
    showToast(`✅ ${sectionName} validée avec succès !`, 'success');
    
    // Optionnel : Désactiver le bouton après validation
    const button = event.target;
    button.innerHTML = '<i class="fas fa-check-double mr-2"></i>Validé';
    button.disabled = true;
    button.style.background = '#6b7280';
    button.style.cursor = 'not-allowed';
    button.classList.add('cursor-not-allowed');
    
    // Vérifier si toutes les sections sont validées
    checkAllSectionsValidated();
}

// Fonction pour sauvegarder les informations de livraison
function sauvegarderInformationsLivraison(sectionElement, sectionName) {
    const button = event.target;
    
    // Récupérer seulement l'adresse de livraison (saisie manuelle)
    const adresseTextarea = document.querySelector('textarea[name="adresse_livraison"]');
    const adresse = adresseTextarea ? adresseTextarea.value.trim() : '';
    
    // Désactiver le bouton pendant la sauvegarde
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde...';
    
    // Préparer les données à envoyer (seulement l'adresse)
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('action', 'save_livraison');
    formData.append('adresse_livraison', adresse);
    
    // Envoyer la requête AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animation de validation
            sectionElement.classList.add('verified');
            
            // Afficher une notification de succès
            const message = adresse ? 
                `✅ ${sectionName} sauvegardée avec succès ! Adresse: ${adresse.substring(0, 50)}${adresse.length > 50 ? '...' : ''}` :
                `✅ ${sectionName} validée avec succès !`;
            showToast(message, 'success');
            
            // Mettre à jour le bouton
            button.innerHTML = '<i class="fas fa-check-double mr-2"></i>Validé';
            button.style.background = '#6b7280';
            button.style.cursor = 'not-allowed';
            button.classList.add('cursor-not-allowed');
            
            // Vérifier si toutes les sections sont validées
            checkAllSectionsValidated();
        } else {
            // Erreur lors de la sauvegarde
            showToast(`❌ Erreur lors de la sauvegarde : ${data.error || 'Erreur inconnue'}`, 'error');
            
            // Réactiver le bouton
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-truck mr-2"></i>Valider la livraison';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la sauvegarde des informations de livraison:', error);
        showToast('❌ Erreur de connexion lors de la sauvegarde', 'error');
        
        // Réactiver le bouton
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-truck mr-2"></i>Valider la livraison';
    });
}

// Fonction pour obtenir le nom de la section
function getSectionName(sectionId) {
    const sectionNames = {
        'informations-commande': 'Section Informations Commande',
        'informations-client': 'Section Informations Client',
        'informations-livraison': 'Section Informations Livraison',
        'gestion-operations': 'Section Gestion des Opérations',
        'articles-commande': 'Section Articles de la Commande'
    };
    return sectionNames[sectionId] || 'Section';
}

// Fonction pour vérifier si toutes les sections sont validées
function checkAllSectionsValidated() {
    const allSections = document.querySelectorAll('.verification-item');
    const validatedSections = document.querySelectorAll('.verification-item.verified');
    
    if (allSections.length === validatedSections.length) {
        showToast('🎉 Toutes les sections ont été validées ! Vous pouvez maintenant confirmer la commande.', 'success', 5000);
        
        // Optionnel : Mettre en évidence le bouton de confirmation finale
        const confirmButton = document.querySelector('.btn-confirm');
        if (confirmButton) {
            confirmButton.classList.add('animate-pulse');
            setTimeout(() => {
                confirmButton.classList.remove('animate-pulse');
            }, 3000);
        }
    }
}

// Fonction pour afficher les notifications toast
function showToast(message, type = 'info', duration = 3000) {
    // Créer l'élément toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
    
    // Définir les couleurs selon le type
    const colors = {
        'success': 'bg-green-600',
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'info': 'bg-blue-600'
    };
    
    toast.classList.add(colors[type] || colors['info']);
    toast.innerHTML = message;
    
    // Ajouter au DOM
    document.body.appendChild(toast);
    
    // Animation d'entrée
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Animation de sortie et suppression
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

</script>

<!-- Modal de Confirmation Tailwind -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-lg m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f7d9c4;">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center pb-4 border-b" style="border-color: #f7d9c4;">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background: linear-gradient(135deg, #4B352A, #6d4b3b);">
                    <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold" style="color: #4B352A;">Confirmer la Commande</h3>
            </div>
            <button onclick="hideConfirmationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Êtes-vous sûr de vouloir confirmer cette commande ?</h4>
                    <div class="text-gray-600 space-y-2">
                        <p class="flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Cette action va décrémenter le stock des articles
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-ban mr-2 text-red-500"></i>
                            Cette action ne peut pas être annulée
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-paper-plane mr-2 text-green-500"></i>
                            La commande sera envoyée vers l'administration
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t" style="border-color: #f7d9c4;">
            <button onclick="hideConfirmationModal()" 
                    class="px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" 
                    style="background-color: #f7d9c4; color: #4B352A;">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button onclick="proceedWithConfirmation()" 
                    class="px-6 py-3 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" 
                    style="background: linear-gradient(135deg, #4B352A, #6d4b3b); focus:ring-color: #4B352A;">
                <i class="fas fa-check mr-2"></i>
                Confirmer la Commande
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in-down {
        0% {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .animate-fade-in-down {
        animation: fade-in-down 0.4s ease-out;
    }
</style>

<!-- Modal de Stock Insuffisant Tailwind -->
<div id="stockInsuffisantModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f87171;">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center pb-4 border-b border-red-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-red-700">Stock Insuffisant</h3>
            </div>
            <button onclick="hideStockInsuffisantModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-times-circle text-red-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Confirmation impossible</h4>
                    <p class="text-gray-600">Les articles suivants n'ont pas un stock suffisant pour traiter cette commande :</p>
                </div>
            </div>
            
            <!-- Liste des articles en rupture -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <ul id="stockInsuffisantList" class="space-y-3">
                    <!-- Les éléments seront ajoutés dynamiquement par JavaScript -->
                </ul>
            </div>
            
            <!-- Suggestions d'action -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-lightbulb text-blue-600"></i>
                    </div>
                    <div>
                        <h5 class="font-semibold text-blue-900 mb-2">Suggestions :</h5>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li class="flex items-center">
                                <i class="fas fa-edit mr-2"></i>
                                Modifier les quantités des articles concernés
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Retirer les articles en rupture de stock
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Remplacer par des articles similaires disponibles
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-red-200">
            <button onclick="hideStockInsuffisantModal()" 
                    class="px-6 py-3 bg-red-600 text-white rounded-lg font-medium transition-all duration-200 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transform hover:-translate-y-0.5">
                <i class="fas fa-check mr-2"></i>
                Compris
            </button>
        </div>
    </div>
</div>

{% endblock %} 