{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}

{% block title %}Modifier Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .verification-item {
        transition: all 0.3s ease;
    }
    
    .verification-item.verified {
        background-color: #dcfce7 !important;
        border-color: #16a34a !important;
    }
    
    .check-icon {
        display: none;
        color: #16a34a;
    }
    
    .verification-item.verified .check-icon {
        display: inline;
    }
    
    .btn-verification {
        background: linear-gradient(to right, #16a34a, #15803d);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-verification:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-operation {
        background-color: #8B5A2B !important;
        color: white !important;
        transition: all 0.3s ease;
    }
    
    .btn-operation:hover {
        background-color: #6d4b3b !important;
        transform: scale(1.05);
    }
    
    .btn-confirm {
        background: linear-gradient(to right, #4B352A, #6d4b3b);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-confirm:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3" style="color: #f7d9c4;"></i>
                Modifier Commande {{ commande.id_yz }}
            </h1>
            <p style="color: #f7d9c4;">Modification complète des détails de la commande</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold" style="color: #f7d9c4;">{{ commande.total_cmd|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
        </div>
    </div>



    <!-- Formulaire de modification -->
    <form method="post" id="modification-form">
        {% csrf_token %}
        
        <!-- Disposition en une seule colonne pour éliminer les espaces vides -->
        <div class="space-y-6">
            <!-- Section 1: Informations principales (2 colonnes) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informations de commande -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between" style="color: #4B352A;">
                        <span><i class="fas fa-receipt mr-3" style="color: #6d4b3b;"></i>Informations Commande</span>
                        <button type="button" onclick="verifierSection('commande')" class="btn-verification px-3 py-1 text-xs rounded">
                            <i class="fas fa-check mr-1"></i> Vérifier
                        </button>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID YZ (Non modifiable)</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total (Non modifiable)</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

                <!-- Informations client -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between" style="color: #4B352A;">
                        <span><i class="fas fa-user mr-3" style="color: #6d4b3b;"></i>Informations Client</span>
                        <button type="button" onclick="verifierSection('client')" class="btn-verification px-3 py-1 text-xs rounded">
                            <i class="fas fa-check mr-1"></i> Vérifier
                        </button>
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" name="client_nom" value="{{ commande.client.nom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" name="client_prenom" value="{{ commande.client.prenom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro de téléphone</label>
                            <input type="tel" name="client_telephone" value="{{ commande.client.numero_tel }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client (Non modifiable)</label>
                            <input type="text" value="{% if commande.ville %}{{ commande.ville.nom }}{% else %}{{ commande.ville_init|default:'Non spécifiée' }}{% endif %}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>
            </div>

            <!-- Section 2: Informations de livraison (largeur complète) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.5s;">
                    <h3 class="text-lg font-semibold mb-4 flex items-center justify-between" style="color: #4B352A;">
                        <span><i class="fas fa-truck mr-3" style="color: #6d4b3b;"></i>Informations Livraison</span>
                        <button type="button" onclick="verifierSection('livraison')" class="btn-verification px-3 py-1 text-xs rounded">
                            <i class="fas fa-check mr-1"></i> Vérifier
                        </button>
                    </h3>
                    
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                            <select name="ville_livraison" id="ville-select" onchange="chargerRegionEtFrais()"
                                    class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                    style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                                <option value="">-- Sélectionner une ville --</option>
                                {% for ville in villes %}
                                    <option value="{{ ville.id }}" 
                                            data-region="{{ ville.region.nom_region }}" 
                                            data-frais="{{ ville.frais_livraison|default:0 }}"
                                            {% if commande.ville.id == ville.id %}selected{% endif %}>
                                        {{ ville.nom }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Région (Automatique)</label>
                            <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison (Automatique)</label>
                            <input type="text" id="frais-display" value="{{ commande.ville.frais_livraison|default:0 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                            <textarea name="adresse_livraison" rows="3"
                                      class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                      style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;"
                                      placeholder="Adresse complète de livraison">{{ commande.adresse }}</textarea>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

            <!-- Section 3: Gestion des Opérations (largeur complète) -->
            <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.6s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between" style="color: #4B352A;">
                    <span><i class="fas fa-cogs mr-3" style="color: #6d4b3b;"></i>Gestion des Opérations de Confirmation</span>
                    <button type="button" onclick="verifierSection('operation')" class="btn-verification px-3 py-1 text-xs rounded">
                        <i class="fas fa-check mr-1"></i> Vérifier
                    </button>
                </h3>
                    
                    <div class="space-y-6">
                        <!-- Section Upsell -->
                        <div class="p-4 bg-teal-50 rounded-lg border border-teal-200">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-chart-line mr-2 text-teal-600"></i>
                                <label class="text-sm font-medium text-teal-800">Upsell (Vente Additionnelle)</label>
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="is_upsell" value="true" {% if commande.is_upsell %}checked{% endif %} 
                                           class="mr-2 text-teal-600 focus:ring-teal-500">
                                    <span class="text-sm text-teal-700">Oui - Commande avec upsell</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="is_upsell" value="false" {% if not commande.is_upsell %}checked{% endif %} 
                                           class="mr-2 text-gray-600 focus:ring-gray-500">
                                    <span class="text-sm text-gray-700">Non - Commande normale</span>
                                </label>
                            </div>
                        </div>

                        <!-- Opérations existantes -->
                        {% if commande.operations.exists %}
                        <div class="mb-4">
                            <h4 class="text-md font-medium text-gray-700 mb-3">
                                <i class="fas fa-history mr-2"></i>Historique des opérations
                            </h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                {% for operation in commande.operations.all %}
                                <div class="p-3 bg-gray-50 rounded-lg border">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-2">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                                    {% if operation.type_operation == 'APPEL_1' %}bg-blue-100 text-blue-800
                                                    {% elif operation.type_operation == 'APPEL_2' %}bg-indigo-100 text-indigo-800
                                                    {% elif operation.type_operation == 'APPEL_3' %}bg-purple-100 text-purple-800
                                                    {% elif operation.type_operation == 'APPEL_4' %}bg-pink-100 text-pink-800
                                                    {% elif operation.type_operation == 'APPEL_5' %}bg-red-100 text-red-800
                                                    {% elif operation.type_operation == 'APPEL_6' %}bg-orange-100 text-orange-800
                                                    {% elif operation.type_operation == 'APPEL_7' %}bg-yellow-100 text-yellow-800
                                                    {% elif operation.type_operation == 'APPEL_8' %}bg-red-200 text-red-900
                                                    {% elif operation.type_operation == 'ENVOI_SMS' or operation.type_operation == 'ENVOI_MSG' %}bg-green-100 text-green-800
                                                    {% elif operation.type_operation == 'PROPOSITION_ABONNEMENT' or operation.type_operation == 'PROPOSITION_REDUCTION' %}bg-teal-100 text-teal-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    <i class="fas fa-hashtag mr-1" style="font-size: 8px;"></i>{{ operation.id }}
                                        </span>
                                                <span class="text-sm font-medium text-gray-800">{{ operation.get_type_operation_display }}</span>
                                </div>
                                            
                                            <div class="grid grid-cols-2 gap-4 text-xs">
                                                <div>
                                                    <span class="text-gray-500">Date/Heure:</span>
                                                    <div class="font-medium text-gray-700">{{ operation.date_operation|date:"d/m/Y H:i" }}</div>
                            </div>
                            <div>
                                                    <span class="text-gray-500">Opérateur:</span>
                                                    <div class="font-medium text-gray-700">
                                                        <i class="fas fa-user mr-1"></i>{{ operation.operateur.user.get_full_name|default:operation.operateur.user.username }}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {% if operation.conclusion %}
                                            <div class="mt-2 p-2 bg-white rounded border-l-4 border-blue-400">
                                                <span class="text-xs text-gray-500">Commentaire:</span>
                                                <div class="text-sm text-gray-700 mt-1">{{ operation.conclusion }}</div>
                                            </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Nouvelles opérations -->
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-medium text-blue-800 mb-3">
                                <i class="fas fa-plus mr-2"></i>Ajouter de nouvelles opérations
                            </h4>
                            
                            <div id="operations-container" class="space-y-4">
                                <!-- Liste des opérations disponibles -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <!-- Aucune Action -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_AUCUNE_ACTION" name="operations[]" value="AUCUNE_ACTION" 
                                                       class="mr-3 operation-checkbox">
                                                <label for="op_AUCUNE_ACTION" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                        Aucune action
                                                    </span>
                                                </label>
                    </div>
                                            <button type="button" onclick="openCommentModal('AUCUNE_ACTION', 'Aucune action')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_AUCUNE_ACTION" id="comment_AUCUNE_ACTION" value="">
                                        <div id="preview_AUCUNE_ACTION" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                </div>

                                    <!-- Appel 1 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_1" name="operations[]" value="APPEL_1" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_1" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 1
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_1', 'Appel 1')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                        </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_1" id="comment_APPEL_1" value="">
                                        <div id="preview_APPEL_1" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Appel 2 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_2" name="operations[]" value="APPEL_2" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_2" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 2
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_2', 'Appel 2')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_2" id="comment_APPEL_2" value="">
                                        <div id="preview_APPEL_2" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                        </div>
                        
                                    <!-- Appel 3 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_3" name="operations[]" value="APPEL_3" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_3" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 3
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_3', 'Appel 3')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_3" id="comment_APPEL_3" value="">
                                        <div id="preview_APPEL_3" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                        </div>
                        
                                    <!-- Appel 4 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_4" name="operations[]" value="APPEL_4" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_4" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 4
                                                    </span>
                                                </label>
                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_4', 'Appel 4')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                        </div>
                                        <input type="hidden" name="comment_APPEL_4" id="comment_APPEL_4" value="">
                                        <div id="preview_APPEL_4" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Appel 5 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_5" name="operations[]" value="APPEL_5" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_5" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 5
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_5', 'Appel 5')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_5" id="comment_APPEL_5" value="">
                                        <div id="preview_APPEL_5" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Appel 6 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_6" name="operations[]" value="APPEL_6" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_6" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 6
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_6', 'Appel 6')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_6" id="comment_APPEL_6" value="">
                                        <div id="preview_APPEL_6" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Appel 7 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_7" name="operations[]" value="APPEL_7" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_7" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                        <i class="fas fa-phone mr-1"></i>Appel 7
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_7', 'Appel 7')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_7" id="comment_APPEL_7" value="">
                                        <div id="preview_APPEL_7" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Appel 8 -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_APPEL_8" name="operations[]" value="APPEL_8" class="mr-3 operation-checkbox">
                                                <label for="op_APPEL_8" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-200 text-red-900">
                                                        <i class="fas fa-phone-slash mr-1"></i>Appel 8
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('APPEL_8', 'Appel 8')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_APPEL_8" id="comment_APPEL_8" value="">
                                        <div id="preview_APPEL_8" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- SMS -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_ENVOI_SMS" name="operations[]" value="ENVOI_SMS" class="mr-3 operation-checkbox">
                                                <label for="op_ENVOI_SMS" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        <i class="fas fa-sms mr-1"></i>Envoi SMS
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('ENVOI_SMS', 'Envoi SMS')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_ENVOI_SMS" id="comment_ENVOI_SMS" value="">
                                        <div id="preview_ENVOI_SMS" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- MSG -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_ENVOI_MSG" name="operations[]" value="ENVOI_MSG" class="mr-3 operation-checkbox">
                                                <label for="op_ENVOI_MSG" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                        <i class="fas fa-comment mr-1"></i>Envoi MSG
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('ENVOI_MSG', 'Envoi MSG')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_ENVOI_MSG" id="comment_ENVOI_MSG" value="">
                                        <div id="preview_ENVOI_MSG" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Proposition Abonnement -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_PROPOSITION_ABONNEMENT" name="operations[]" value="PROPOSITION_ABONNEMENT" class="mr-3 operation-checkbox">
                                                <label for="op_PROPOSITION_ABONNEMENT" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                                                        <i class="fas fa-gift mr-1"></i>Abonnement
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('PROPOSITION_ABONNEMENT', 'Proposition Abonnement')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_PROPOSITION_ABONNEMENT" id="comment_PROPOSITION_ABONNEMENT" value="">
                                        <div id="preview_PROPOSITION_ABONNEMENT" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>

                                    <!-- Proposition Réduction -->
                                    <div class="operation-item p-3 border rounded-lg bg-white">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="op_PROPOSITION_REDUCTION" name="operations[]" value="PROPOSITION_REDUCTION" class="mr-3 operation-checkbox">
                                                <label for="op_PROPOSITION_REDUCTION" class="font-medium text-gray-700 cursor-pointer">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                                                        <i class="fas fa-percent mr-1"></i>Réduction
                                                    </span>
                                                </label>
                                            </div>
                                            <button type="button" onclick="openCommentModal('PROPOSITION_REDUCTION', 'Proposition Réduction')" 
                                                    class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors">
                                                <i class="fas fa-comment mr-1"></i>Commentaire
                                            </button>
                                        </div>
                                        <input type="hidden" name="comment_PROPOSITION_REDUCTION" id="comment_PROPOSITION_REDUCTION" value="">
                                        <div id="preview_PROPOSITION_REDUCTION" class="mt-2 text-xs text-gray-600 italic hidden"></div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <div class="text-sm text-red-600 mb-2 font-medium">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        IMPORTANT : Chaque opération sélectionnée DOIT avoir un commentaire rédigé par l'opérateur
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        Les opérations sans commentaire seront automatiquement ignorées lors de la sauvegarde
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

            <!-- Section 4: Articles de la commande (largeur complète) -->
            <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.8s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center justify-between" style="color: #4B352A;">
                    <span><i class="fas fa-box mr-3" style="color: #6d4b3b;"></i>Articles de la Commande ({{ commande.paniers.count }} article{{ commande.paniers.count|pluralize }})</span>
                    <button type="button" onclick="verifierSection('articles')" class="btn-verification px-3 py-1 text-xs rounded">
                        <i class="fas fa-check mr-1"></i> Vérifier
                    </button>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for panier in commande.paniers.all %}
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-gray-300 transition-all">
                        <div class="flex flex-col h-full">
                            <div class="flex-1 mb-3">
                                <div class="font-semibold text-lg mb-1" style="color: #4B352A;">{{ panier.article.nom }}</div>
                                <div class="text-sm text-gray-500 mb-2">
                                    <i class="fas fa-hashtag mr-1"></i>Réf: {{ panier.article.reference }}
                                </div>
                                {% if panier.article.description %}
                                <div class="text-xs text-gray-600 mb-2">{{ panier.article.description|truncatechars:80 }}</div>
                                {% endif %}
                            </div>
                            <div class="border-t pt-3">
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-500">Quantité:</span>
                                        <div class="font-medium text-blue-600">{{ panier.quantite }} unité{{ panier.quantite|pluralize }}</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Prix unitaire:</span>
                                        <div class="font-medium text-green-600">{{ panier.article.prix_unitaire }} DH</div>
                                    </div>
                                </div>
                                <div class="mt-2 pt-2 border-t">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-700">Sous-total:</span>
                                        <span class="text-lg font-bold" style="color: #6d4b3b;">{{ panier.sous_total }} DH</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Résumé total -->
                <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
                    <div class="flex justify-between items-center">
                        <div class="text-lg font-semibold text-gray-700">
                            <i class="fas fa-calculator mr-2"></i>Total de la commande:
                        </div>
                        <div class="text-2xl font-bold" style="color: #4B352A;">
                            {{ commande.total_cmd|floatformat:2 }} DH
                        </div>
                    </div>
                </div>
                
                <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-between items-center mt-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex gap-4">
                <a href="{% url 'operatConfirme:confirmation' %}" 
                   class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Retour à la confirmation
                </a>
                
                <button type="button" onclick="verifierTout()" 
                        class="btn-verification px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-check-double mr-2"></i>
                    Tout Vérifier
                </button>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" onclick="return verifierOperationsSelectionnees()"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-save mr-2"></i>
                    Sauvegarder
                </button>
                
                {% if commande.etat_actuel.enum_etat.libelle == 'Affectée' %}
                <button type="button" onclick="lancerConfirmation()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="fas fa-play mr-2"></i>
                    Lancer Confirmation
                </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'En cours de confirmation' %}
                <button type="button" onclick="annulerLancement()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-undo mr-2"></i>
                    Annuler le Lancement
                </button>
                {% endif %}
                
                <button type="button" onclick="confirmerCommande()" 
                        class="btn-confirm px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-check-circle mr-2"></i>
                    Confirmer la Commande
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modale de commentaire pour les opérations -->
<div id="commentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-comment text-blue-500 mr-3"></i>
            Commentaire pour <span id="operationName" class="text-blue-600"></span>
        </h3>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Petite conclusion de l'opérateur
            </label>
            <textarea id="commentTextarea" rows="4" 
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                      placeholder="⚠️ OBLIGATOIRE : Rédigez votre conclusion personnelle (ex: 'Client contacté, confirme sa commande', 'Produit vérifié en stock', etc.)"></textarea>
            <div class="mt-1 text-xs text-red-600 font-medium">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Commentaire obligatoire - l'opération sera ignorée sans votre conclusion
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closeCommentModal()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-1"></i>Annuler
            </button>
            <button onclick="saveComment()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 hover:bg-blue-700 text-white">
                <i class="fas fa-save mr-1"></i>Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Fonction pour charger automatiquement la région et les frais
function chargerRegionEtFrais() {
    const villeSelect = document.getElementById('ville-select');
    const selectedOption = villeSelect.options[villeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const region = selectedOption.getAttribute('data-region');
        const frais = selectedOption.getAttribute('data-frais');
        
        document.getElementById('region-display').value = region;
        document.getElementById('frais-display').value = frais + ' DH';
    } else {
        document.getElementById('region-display').value = '';
        document.getElementById('frais-display').value = '';
    }
}

// Fonction pour vérifier une section
function verifierSection(section) {
    const sectionElement = document.querySelector(`[onclick="verifierSection('${section}')"]`).closest('.verification-item');
    sectionElement.classList.add('verified');
}

// Fonction pour vérifier toutes les sections
function verifierTout() {
    const sections = document.querySelectorAll('.verification-item');
    sections.forEach(section => {
        section.classList.add('verified');
    });
}

// Variables globales pour la modale
let currentOperationType = '';
let currentOperationName = '';

// Fonction pour ouvrir la modale de commentaire
function openCommentModal(operationType, operationName) {
    console.log('Ouverture modale pour:', operationType, operationName);
    
    try {
        currentOperationType = operationType;
        currentOperationName = operationName;
        
        // Vérifier que la modale existe
        const modal = document.getElementById('commentModal');
        if (!modal) {
            console.error('Modale commentModal introuvable !');
            alert('Erreur : Modale de commentaire introuvable');
            return;
        }
        
        // Mettre à jour le titre de la modale
        const operationNameElement = document.getElementById('operationName');
        if (operationNameElement) {
            operationNameElement.textContent = operationName;
        }
        
        // Charger le commentaire existant s'il y en a un
        const commentField = document.getElementById('comment_' + operationType);
        const textarea = document.getElementById('commentTextarea');
        
        if (commentField && textarea) {
            textarea.value = commentField.value || '';
        }
        
        // Afficher la modale avec animation
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Force le navigateur à reconnaître les changements
        modal.offsetHeight;
        
        console.log('Modale affichée avec succès');
        
        // Focus sur le textarea après un délai court
        setTimeout(() => {
            if (textarea) {
                textarea.focus();
            }
        }, 150);
        
    } catch (error) {
        console.error('Erreur lors de l\'ouverture de la modale:', error);
        alert('Erreur lors de l\'ouverture de la modale: ' + error.message);
    }
}

// Fonction pour fermer la modale
function closeCommentModal() {
    try {
        const modal = document.getElementById('commentModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentOperationType = '';
        currentOperationName = '';
        console.log('Modale fermée');
    } catch (error) {
        console.error('Erreur lors de la fermeture de la modale:', error);
    }
}

// Fonction pour sauvegarder le commentaire
function saveComment() {
    const commentText = document.getElementById('commentTextarea').value.trim();
    
    if (commentText) {
        // Sauvegarder dans le champ hidden
        document.getElementById('comment_' + currentOperationType).value = commentText;
        
        // Mettre à jour l'aperçu
        const previewElement = document.getElementById('preview_' + currentOperationType);
        previewElement.textContent = 'Commentaire: ' + (commentText.length > 50 ? commentText.substring(0, 50) + '...' : commentText);
        previewElement.classList.remove('hidden');
        
        // Cocher automatiquement l'opération si ce n'est pas déjà fait
        document.getElementById('op_' + currentOperationType).checked = true;
    } else {
        // Supprimer le commentaire et l'aperçu
        document.getElementById('comment_' + currentOperationType).value = '';
        document.getElementById('preview_' + currentOperationType).classList.add('hidden');
    }
    
    closeCommentModal();
}

// Fonction pour vérifier qu'au moins une opération est sélectionnée avant la soumission
function verifierOperationsSelectionnees() {
    const checkboxes = document.querySelectorAll('input[name="operations[]"]:checked');
    if (checkboxes.length === 0) {
        alert('⚠️ Veuillez sélectionner au moins une opération avant de sauvegarder.');
        return false;
    }
    
    // Vérifier que chaque opération sélectionnée a un commentaire obligatoire
    let operationsSansCommentaire = [];
    checkboxes.forEach(checkbox => {
        const operationType = checkbox.value;
        const commentValue = document.getElementById('comment_' + operationType).value.trim();
        if (!commentValue) {
            const operationItem = checkbox.closest('.operation-item');
            const label = operationItem.querySelector('label span').textContent;
            operationsSansCommentaire.push(label);
        }
    });
    
    if (operationsSansCommentaire.length > 0) {
        alert(`❌ COMMENTAIRES OBLIGATOIRES MANQUANTS\n\nLes opérations suivantes nécessitent un commentaire de votre part :\n• ${operationsSansCommentaire.join('\n• ')}\n\nVeuillez cliquer sur "Commentaire" pour chaque opération sélectionnée et rédiger votre conclusion.\n\nLes opérations sans commentaire seront ignorées lors de la sauvegarde.`);
        return false;
    }
    
    return true;
}

// Fermer la modale avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCommentModal();
    }
});

// Vérification et initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page chargée, vérification des éléments...');
    
    // Vérifier que la modale existe
    const modal = document.getElementById('commentModal');
    if (!modal) {
        console.error('❌ Modale commentModal introuvable !');
        return;
    } else {
        console.log('✅ Modale commentModal trouvée');
    }
    
    // Vérifier les éléments de la modale
    const operationNameElement = document.getElementById('operationName');
    const textarea = document.getElementById('commentTextarea');
    
    if (!operationNameElement) {
        console.error('❌ Élément operationName introuvable !');
    } else {
        console.log('✅ Élément operationName trouvé');
    }
    
    if (!textarea) {
        console.error('❌ Textarea commentTextarea introuvable !');
    } else {
        console.log('✅ Textarea commentTextarea trouvé');
    }
    
    // Fermer la modale en cliquant à l'extérieur
    modal.addEventListener('click', function(event) {
        if (event.target === this) {
            closeCommentModal();
        }
    });
    
    console.log('Système de modales initialisé avec succès');
    
    // Fonction de test pour vérifier que les modales fonctionnent
    window.testModal = function() {
        console.log('Test de la modale...');
        openCommentModal('TEST', 'Test Opération');
    };
    
    console.log('💡 Pour tester la modale, tapez testModal() dans la console');
});

// Fonction pour changer l'opération (ancienne fonction - gardée pour compatibilité)
function changerOperation() {
    // Cette fonction n'est plus utilisée avec le nouveau système
    console.log('Fonction changerOperation() appelée - système d\'opérations individuelles actif');
        
        // Mettre à jour l'affichage de l'opération actuelle
        const operationInfo = document.querySelector('.bg-green-50');
        if (operationInfo) {
            operationInfo.innerHTML = `
                <div class="flex items-center text-green-700">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span class="text-sm">Opération sélectionnée : <strong>${operationNames[operationSelect.value]}</strong></span>
                </div>
            `;
        }
        
        // Sauvegarder automatiquement l'opération sélectionnée
        fetch('{% url "operatConfirme:selectionner_operation" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'commande_id': {{ commande.id }},
                'type_operation': operationSelect.value,
                'commentaire': commentaireField.value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Opération mise à jour avec succès');
                // Vérifier automatiquement la section opération
                verifierSection('operation');
                // Afficher un message de succès discret
                showNotification('Opération mise à jour avec succès', 'success');
            } else {
                alert('Erreur lors de la mise à jour de l\'opération : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la mise à jour de l\'opération.');
        });
    }
}

// Fonction pour afficher des notifications discrètes
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}



// Fonction pour lancer la confirmation (change l'état de Affectée à En cours)
function lancerConfirmation() {
        fetch(`{% url 'operatConfirme:lancer_confirmation' commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Confirmation lancée avec succès !', 'success');
                // Recharger la page pour voir les changements
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('Erreur lors du lancement : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du lancement de la confirmation.');
        });
}

// Fonction pour annuler le lancement de confirmation (En cours -> Affectée)
function annulerLancement() {
    fetch(`{% url 'operatConfirme:annuler_lancement_confirmation' commande.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Lancement annulé avec succès !', 'success');
            // Recharger la page pour voir les changements
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Erreur lors de l\'annulation : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de l\'annulation du lancement.');
    });
}

// Fonction pour confirmer la commande
function confirmerCommande() {
    // Vérifier que toutes les sections sont vérifiées
    const sectionsVerifiees = document.querySelectorAll('.verification-item.verified');
    if (sectionsVerifiees.length < 6) {
        alert('Veuillez vérifier toutes les sections (y compris l\'état et l\'opération) avant de confirmer la commande.');
        return;
    }
    

        // Processus en plusieurs étapes :
        // 1. Lancer la confirmation si nécessaire
        // 2. Sélectionner "Aucune action" comme opération par défaut
        // 3. Confirmer la commande
        
        // Étape 1: Lancer la confirmation
        fetch(`{% url 'operatConfirme:lancer_confirmation' commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success || data.message.includes('déjà')) { // Si succès ou déjà lancée
                // Étape 2: Sélectionner l'opération choisie par l'utilisateur avec son commentaire
                const operationSelect = document.getElementById('operation-select');
                const commentaireField = document.getElementById('commentaire-operation');
                
                // Vérifier que les éléments existent et ont des valeurs
                if (!operationSelect) {
                    throw new Error('Élément de sélection d\'opération non trouvé');
                }
                if (!commentaireField) {
                    throw new Error('Champ de commentaire non trouvé');
                }
                
                const typeOperation = operationSelect.value || 'AUCUNE_ACTION';
                const commentaire = commentaireField.value || '';
                
                return fetch('{% url "operatConfirme:selectionner_operation" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        'commande_id': {{ commande.id }},
                        'type_operation': typeOperation,
                        'commentaire': commentaire
                    })
                });
            } else {
                throw new Error(data.message);
            }
        })
        .then(response => response.json())
        .then(data => {
            // Étape 3: Confirmer la commande
            return fetch(`/operateur-confirme/commandes/{{ commande.id }}/confirmer-ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'commentaire': 'Commande confirmée après vérification complète'
                })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Commande confirmée avec succès ! Elle a été envoyée vers l\'admin.');
                window.location.href = '{% url "operatConfirme:commandes_confirmees" %}';
            } else {
                alert('Erreur lors de la confirmation : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue : ' + error.message);
        });
}
</script>
{% endblock %} 