{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Variables CSS harmonisées avec le thème de supervision */
    :root {
        --preparation-primary: #070F2B;
        --preparation-dark: #050A1F;
        --preparation-light: #0E1D3D;
        --preparation-text-light: #E6F0FF;
        --preparation-border-accent: #1E3A8A;
        --preparation-hover-bg: #0B1733;
        --preparation-success: #10b981;
        --preparation-warning: #f59e0b;
        --preparation-error: #ef4444;
        --preparation-info: #3b82f6;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    /* Styles harmonisés */
    .theme-header {
        background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%);
        border: 2px solid var(--preparation-border-accent);
        box-shadow: 0 4px 15px rgba(7, 15, 43, 0.3);
        border-radius: 16px;
        padding: 24px;
    }

    .stats-card {
        background: white;
        border: 2px solid var(--preparation-text-light);
        border-radius: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 24px;
    }

    .stats-card:hover {
        border-color: var(--preparation-border-accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
    }

    .stats-icon {
        background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%);
        color: white;
        border-radius: 50%;
        padding: 16px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .table-container {
        background: white;
        border: 2px solid var(--preparation-text-light);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .table-header {
        background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%);
        color: white;
    }

    .table-row {
        transition: all 0.3s ease;
        border-bottom: 1px solid #e5e7eb;
    }

    .table-row:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        transform: translateX(4px);
    }

    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        background: white;
        border: 2px solid var(--preparation-border-accent);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 10px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 400px;
    }

    .toast.show {
        transform: translateX(0);
    }

    /* Navigation tabs */
    .nav-tabs {
        display: flex;
        gap: 8px;
        background: white;
        border-radius: 12px;
        padding: 8px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-tab {
        flex: 1;
        padding: 12px 20px;
        border-radius: 8px;
        text-decoration: none;
        color: #6b7280;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 2px solid transparent;
    }

    .nav-tab:hover {
        background: #f3f4f6;
        color: var(--preparation-primary);
    }

    .nav-tab.active {
        background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%);
        color: white;
        border-color: var(--preparation-border-accent);
    }

    .nav-tab .badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .nav-tab.active .badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .nav-tab:not(.active) .badge {
        background: #e5e7eb;
        color: #374151;
    }
</style>
{% block extra_page_css %}{% endblock %}
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-tête de la page -->
    <div class="theme-header mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center mb-2 text-white">
                    {% block page_icon %}<i class="fas fa-undo mr-3"></i>{% endblock %}
                    {{ page_title }}
                </h1>
                <p class="text-white opacity-90">{{ page_subtitle }}</p>
            </div>
            <div class="flex items-center gap-6 mt-4 md:mt-0">
                <div class="text-center">
                    <div class="text-3xl font-bold text-white">{{ stats.count|default:0 }}</div>
                    <div class="text-sm text-white opacity-80">Article{{ stats.count|pluralize }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation entre les pages -->
    <div class="nav-tabs">
        <a href="{% url 'Superpreparation:articles_retournes_en_attente' %}"
           class="nav-tab {% if current_page == 'en_attente' %}active{% endif %}">
            <i class="fas fa-clock"></i>
            <span>En attente</span>
            <span class="badge">{{ stats_global.total_en_attente|default:0 }}</span>
        </a>
        <a href="{% url 'Superpreparation:articles_retournes_traites' %}"
           class="nav-tab {% if current_page == 'traites' %}active{% endif %}">
            <i class="fas fa-check-circle"></i>
            <span>Traités</span>
            <span class="badge">{{ stats_global.total_traites|default:0 }}</span>
        </a>
        <a href="{% url 'Superpreparation:articles_retournes_reintegres' %}"
           class="nav-tab {% if current_page == 'reintegres' %}active{% endif %}">
            <i class="fas fa-box"></i>
            <span>Réintégrés</span>
            <span class="badge">{{ stats_global.total_reintegres|default:0 }}</span>
        </a>
        <a href="{% url 'Superpreparation:articles_retournes_defectueux' %}"
           class="nav-tab {% if current_page == 'defectueux' %}active{% endif %}">
            <i class="fas fa-times-circle"></i>
            <span>Défectueux</span>
            <span class="badge">{{ stats_global.commandes_urgentes|default:0 }}</span>
        </a>
    </div>

    <!-- Statistiques spécifiques -->
    {% block stats_section %}{% endblock %}

    <!-- Barre de recherche -->
    {% include 'Superpreparation/includes/smart-search-toolbar.html' %}

    <!-- Contenu principal -->
    {% block main_content %}
    <!-- Tableau des articles -->
    <div class="table-container">
        <div class="overflow-x-auto">
            <table id="cmdTable" class="min-w-full text-xs sm:text-sm">
                <thead class="table-header sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Articles & Variantes</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">N° Commande</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Client</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Date de Retour</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Raison</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Prix</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">Statut</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase">État Commande</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% include 'Superpreparation/partials/_articles_retounees_table.html' with page_obj=page_obj %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div data-superprep-pagination data-items-selector="tbody tr" data-container-selector="table" data-per-page="25"></div>
    {% endblock %}
</div>

<!-- Modale de traitement -->
<div id="modaleRaisonTraitement" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-edit mr-2 text-blue-600"></i>
                    Traitement d'article retourné
                </h3>
                <p class="text-sm text-gray-600 mt-1" id="raisonModalSubtitle">Sélectionnez le type de traitement</p>
            </div>
            <button onclick="fermerModaleRaisonTraitement()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <form id="formRaisonTraitement">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Type de traitement <span class="text-red-500">*</span>
                </label>
                <select id="selectRaisonTraitement" name="raison_traitement"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <option value="">Sélectionnez le type de traitement...</option>
                    <option value="Article vérifié et réintégré au stock">Article vérifié et réintégré au stock</option>
                    <option value="Article non réintégrable, commande traité">Article non réintégrable, commande traité</option>
                </select>
            </div>
        </form>

        <div class="flex justify-between items-center pt-4 border-t">
            <button onclick="fermerModaleRaisonTraitement()"
                    class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                <i class="fas fa-times mr-2"></i>Annuler
            </button>
            <button onclick="confirmerTraitementArticle()"
                    id="btnConfirmerTraitement"
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                <i class="fas fa-check mr-2"></i>Confirmer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/Superpreparation/Suivi_des_Commandes/suivi-commandes-smart-search.js' %}"></script>
<script>
// Toast notification system
function showToast(message, type = 'info', duration = 4000) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icon = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle',
        warning: 'fas fa-exclamation-triangle'
    }[type];

    toast.innerHTML = `
        <div class="flex items-center">
            <i class="${icon} mr-3 text-lg"></i>
            <div class="flex-1"><p class="font-medium">${message}</p></div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;

    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// Variables globales pour le traitement
let articleIdEnCours = null;
let actionEnCours = null;

function traiterArticle(articleId, action) {
    articleIdEnCours = articleId;
    actionEnCours = action;

    const actions = {
        'reintegrer_stock': 'réintégrer en stock',
        'marquer_defectueux': 'marquer comme défectueux',
        'marquer_traite': 'marquer comme traité'
    };

    const subtitle = document.getElementById('raisonModalSubtitle');
    if (subtitle) {
        subtitle.textContent = `Action: ${actions[action]}`;
    }

    ouvrirModaleRaisonTraitement();
}

function ouvrirModaleRaisonTraitement() {
    const modale = document.getElementById('modaleRaisonTraitement');
    if (modale) modale.classList.remove('hidden');
}

function fermerModaleRaisonTraitement() {
    const modale = document.getElementById('modaleRaisonTraitement');
    if (modale) modale.classList.add('hidden');
    articleIdEnCours = null;
    actionEnCours = null;
    document.getElementById('formRaisonTraitement')?.reset();
}

function confirmerTraitementArticle() {
    const select = document.getElementById('selectRaisonTraitement');

    if (!select?.value) {
        alert('⚠️ Veuillez sélectionner une raison de traitement');
        return;
    }

    if (!articleIdEnCours || !actionEnCours) {
        alert('❌ Erreur: Informations de traitement manquantes');
        return;
    }

    const btnConfirmer = document.getElementById('btnConfirmerTraitement');
    if (btnConfirmer) {
        btnConfirmer.disabled = true;
        btnConfirmer.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement...';
    }

    const formData = new FormData();
    formData.append('action', actionEnCours);
    formData.append('commentaire', select.value + ` (Traité le ${new Date().toLocaleString()})`);

    const url = `{% url "Superpreparation:service_traiter_article_retourne" 0 %}`.replace('0', articleIdEnCours);

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            fermerModaleRaisonTraitement();
            location.reload();
        } else {
            showToast(`Erreur: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur de réseau lors du traitement', 'error');
    })
    .finally(() => {
        if (btnConfirmer) {
            btnConfirmer.disabled = false;
            btnConfirmer.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer';
        }
    });
}

// Init search
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initSuiviCommandesSearch === 'function') {
        initSuiviCommandesSearch('articles_retournes');
    }
});
</script>
{% block extra_page_js %}{% endblock %}
{% endblock %}
