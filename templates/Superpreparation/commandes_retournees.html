{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block page_subtitle %}{{ page_subtitle }}{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Token CSRF pour les requ√™tes AJAX -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Syst√®me de notifications toast -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="main-content transition-all duration-300" id="mainContent">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg"
         style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-dark));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-undo mr-3" style="color: var(--preparation-border-accent);"></i>
                {{ page_title }}
            </h1>
            <p style="color: white;">{{ page_subtitle }}</p>
        </div>
    </div>

    <!-- Onglets de navigation -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <a href="?tab=actives" 
                   class="tab-link py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 {% if current_tab == 'actives' %}border-red-500 text-red-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    <i class="fas fa-clock mr-2"></i>
                    √Ä traiter ({{ stats.total_actives }})
                </a>
                <a href="?tab=traitees" 
                   class="tab-link py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 {% if current_tab == 'traitees' %}border-green-500 text-green-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    <i class="fas fa-check-circle mr-2"></i>
                    Trait√©es ({{ stats.total_traitees }})
                </a>
            </nav>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 lg:mb-8">
        <!-- Commandes actives -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-red-100 to-red-200 text-red-600 transition-all duration-300 group-hover:from-red-500 group-hover:to-red-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-clock text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">√Ä traiter</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-red-600">{{ stats.total_actives }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes trait√©es -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-check-circle text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Trait√©es</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ stats.total_traitees }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur actives -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-coins text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Actives</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ stats.valeur_actives|floatformat:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur trait√©es -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 transition-all duration-300 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-coins text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Trait√©es</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-blue-600">{{ stats.valeur_traitees|floatformat:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Section de recherche -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="px-4 py-3 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Recherche et Filtres</h3>
        <p class="text-sm text-gray-500 mt-1">Recherchez et filtrez les commandes retourn√©es</p>
    </div>
    
    <div class="p-4">
{% include 'Superpreparation/includes/smart-search-toolbar.html' %}
    </div>
    
    <!-- Script de recherche intelligente (charg√© t√¥t pour les boutons) -->
    <script src="{% static 'js/Superpreparation/Suivi_des_Commandes/suivi-commandes-smart-search.js' %}"></script>
    
    <!-- Script de fallback pour les fonctions manquantes -->
    <script>
        // Fallback si les fonctions ne sont pas charg√©es
        if (typeof window.toggleAdvancedSearch === 'undefined') {
            window.toggleAdvancedSearch = function() {
                const advancedSearch = document.getElementById('advancedSearch');
                if (advancedSearch) {
                    const isHidden = advancedSearch.style.display === 'none' || advancedSearch.classList.contains('hidden');
                    if (isHidden) {
                        advancedSearch.style.display = 'block';
                        advancedSearch.classList.remove('hidden');
                    } else {
                        advancedSearch.style.display = 'none';
                        advancedSearch.classList.add('hidden');
                    }
                }
            };
        }
        
        if (typeof window.clearSmartSearch === 'undefined') {
            window.clearSmartSearch = function() {
                const searchInput = document.getElementById('smartSearch');
                if (searchInput) {
                    searchInput.value = '';
                }
                const filterInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
                filterInputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            };
        }
        
        if (typeof window.applyFilters === 'undefined') {
            window.applyFilters = function() {
                console.log('üîç Filtres appliqu√©s (fallback)');
            };
        }
    </script>
</div>

<!-- Section des donn√©es -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="px-4 py-3 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Commandes Retourn√©es</h3>
        <p class="text-sm text-gray-500 mt-1">Gestion des commandes retourn√©es par les clients</p>
    </div>
    
    <div class="p-4">
        <!-- Version mobile/tablette : Cartes -->
        {% if commandes_retournees %}
        <div class="block lg:hidden space-y-3 mb-4">
            {% for commande in commandes_retournees %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200">
                <!-- En-t√™te de la carte -->
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                            <span class="text-red-600 font-bold text-xs">{{ commande.id_yz }}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 text-sm">{{ commande.client.prenom }} {{ commande.client.nom }}</h3>
                            <p class="text-xs text-gray-500">{{ commande.num_cmd|default:"-" }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-red-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        <div class="text-xs text-gray-500">{{ commande.paniers.count }} article{{ commande.paniers.count|pluralize }}</div>
                    </div>
                </div>
                
                <!-- Informations d√©taill√©es -->
                <div class="space-y-2 text-xs text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-phone w-4 mr-2"></i>
                        <span>{{ commande.client.numero_tel|default:"Non renseign√©" }}</span>
                    </div>
                    {% if commande.ville %}
                    <div class="flex items-center">
                        <i class="fas fa-map-marker-alt w-4 mr-2"></i>
                        <span>{{ commande.ville.nom }}, {{ commande.ville.region.nom_region }}</span>
                    </div>
                    {% endif %}
                    {% if commande.etat_retournee %}
                    <div class="flex items-center">
                        <i class="fas fa-calendar w-4 mr-2"></i>
                        <span>Retourn√©e le {{ commande.etat_retournee.date_debut|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                    {% if current_tab == 'traitees' and commande.etat_retournee.date_fin %}
                    <div class="flex items-center">
                        <i class="fas fa-check w-4 mr-2"></i>
                        <span>Trait√©e le {{ commande.etat_retournee.date_fin|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}"
                           class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white text-xs transition-all hover:shadow-lg"
                           style="background-color: var(--preparation-primary);"
                           title="Voir le panier">
                            <i class="fas fa-shopping-cart mr-1"></i>
                            Panier
                        </a>
                        {% if current_tab == 'actives' %}
                        <button onclick="ouvrirModalTraitement({{ commande.pk }}, '{{ commande.id_yz }}', '{{ commande.num_cmd|default:commande.id_yz }}')"
                                class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white text-xs transition-all hover:shadow-lg bg-orange-600"
                                title="Traiter la commande">
                            <i class="fas fa-tools mr-1"></i>
                            Traiter
                        </button>
                        {% endif %}
                    </div>
                    <div class="flex items-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            <i class="fas fa-undo mr-1"></i>
                            Retourn√©e
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Bouton de s√©lection des colonnes -->
        <div class="hidden lg:flex justify-end mb-3">
            <button id="columnToggle" onclick="toggleColumnVisibility()" 
                    class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-300"
                    title="S√©lectionner les colonnes">
                <i class="fas fa-columns mr-2 text-gray-500"></i>
                S√©lectionner les colonnes
            </button>
        </div>

        <!-- Version desktop : Tableau -->
        <div class="hidden lg:block overflow-x-auto rounded-lg shadow-sm border border-gray-200 mb-4">
        <table id="suivi-prepa-table-retournees" class="w-full divide-y divide-gray-200 table-auto">
            <thead style="background-color: var(--preparation-primary);">
                <tr>
                    <th class="column-id-yz px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">ID YZ</th>
                    <th class="column-num-ext px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">N¬∞ Externe</th>
                    <th class="column-client px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 15%;">Client</th>
                    <th class="column-telephone px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">T√©l√©phone</th>
                    <th class="column-ville-region px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 12%;">Ville & R√©gion</th>
                    <th class="column-date-retour px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Date de retour</th>
                    <th class="column-date-traitement px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Date de traitement</th>
                    {% if current_tab == 'traitees' %}
                    <th class="column-operateur px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 12%;">Trait√© par</th>
                    {% endif %}
                    <th class="column-total px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">Total</th>
                    <th class="column-etat px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">√âtat</th>
                    <th class="column-panier px-2 py-3 text-center text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">Panier</th>
                    <th class="column-actions px-2 py-3 text-center text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if commandes_retournees %}
                    {% for commande in commandes_retournees %}
                    <tr class="hover:bg-gray-50 commande-row" 
                        data-id-yz="{{ commande.id_yz }}"
                        data-num-cmd="{{ commande.num_cmd|default:'' }}"
                        data-client="{{ commande.client.prenom }} {{ commande.client.nom }}"
                        data-phone="{{ commande.client.numero_tel|default:'' }}"
                        data-ville-client="{{ commande.ville_init|default:'' }}"
                        data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom_region }}{% endif %}"
                        data-adresse="{% if commande.client.adresse %}{{ commande.client.adresse }}{% endif %}"
                        data-date-retour="{% if commande.etat_actuel %}{{ commande.etat_actuel.date_debut|date:'d/m/Y' }}{% endif %}"
                        data-total="{{ commande.total_cmd }}"
                        data-etat="Retourn√©e"
                        data-operateur="{% if commande.etat_actuel.operateur %}{{ commande.etat_actuel.operateur.nom }} {{ commande.etat_actuel.operateur.prenom }}{% endif %}">
                        <!-- ID YZ -->
                        <td class="column-id-yz px-2 py-3 text-sm font-medium text-gray-900 truncate">
                            <span class="font-bold">{{ commande.id_yz }}</span>
                        </td>

                        <!-- N¬∞ Externe -->
                        <td class="column-num-ext px-2 py-3 text-sm text-gray-500 truncate">
                            {{ commande.num_cmd|default:"-" }}
                        </td>

                        <!-- Client -->
                        <td class="column-client px-2 py-3 truncate">
                            <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                            {% if commande.client.email %}
                            <div class="text-xs text-gray-500">{{ commande.client.email }}</div>
                            {% endif %}
                        </td>

                        <!-- T√©l√©phone -->
                        <td class="column-telephone px-2 py-3 truncate">
                            {% if commande.client.numero_tel %}
                            <div class="text-sm text-gray-900 font-medium">
                                <i class="fas fa-phone mr-1"></i>
                                {{ commande.client.numero_tel }}
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500">Non renseign√©</div>
                            {% endif %}
                        </td>

                        <!-- Ville & R√©gion -->
                        <td class="column-ville-region px-2 py-3 truncate">
                            {% if commande.ville %}
                                <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                                <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                            {% else %}
                                <div class="text-sm text-gray-500">Non d√©finie</div>
                            {% endif %}
                        </td>

                        <!-- Date de retour -->
                        <td class="column-date-retour px-2 py-3 truncate">
                            {% if commande.etat_retournee %}
                                <div class="text-sm text-gray-900">{{ commande.etat_retournee.date_debut|date:"d/m/Y" }}</div>
                                <div class="text-xs text-gray-500">{{ commande.etat_retournee.date_debut|date:"H:i" }}</div>
                            {% else %}
                                <div class="text-sm text-gray-500">Non d√©finie</div>
                            {% endif %}
                        </td>

                        <!-- Date de traitement -->
                        <td class="column-date-traitement px-2 py-3 truncate">
                            {% if current_tab == 'actives' %}
                                <div class="text-sm text-gray-500 italic">En attente</div>
                            {% else %}
                                {% if commande.etat_retournee and commande.etat_retournee.date_fin %}
                                    <div class="text-sm text-gray-900">{{ commande.etat_retournee.date_fin|date:"d/m/Y" }}</div>
                                    <div class="text-xs text-gray-500">{{ commande.etat_retournee.date_fin|date:"H:i" }}</div>
                                {% else %}
                                    <div class="text-sm text-gray-500">Non d√©finie</div>
                                {% endif %}
                            {% endif %}
                        </td>

                        <!-- Trait√© par (seulement pour l'onglet trait√©es) -->
                        {% if current_tab == 'traitees' %}
                        <td class="column-operateur px-2 py-3 truncate">
                            {% if commande.etat_retournee and commande.etat_retournee.operateur %}
                                <div class="text-sm text-gray-900">{{ commande.etat_retournee.operateur.nom }} {{ commande.etat_retournee.operateur.prenom }}</div>
                                <div class="text-xs text-gray-500">{{ commande.etat_retournee.operateur.type_operateur }}</div>
                            {% else %}
                                <div class="text-sm text-gray-500">Non d√©fini</div>
                            {% endif %}
                        </td>
                        {% endif %}

                        <!-- Total -->
                        <td class="column-total px-2 py-3 truncate">
                            <div class="text-sm font-bold text-red-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        </td>

                        <!-- √âtat -->
                        <td class="column-etat px-2 py-3 text-sm truncate">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                <i class="fas fa-undo mr-1"></i>
                                Retourn√©e
                            </span>
                        </td>

                        <!-- Panier -->
                        <td class="column-panier px-2 py-3 text-center">
                            <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}" 
                               class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                               style="background-color: var(--preparation-primary);"
                               title="Voir le panier de cette commande">
                                <i class="fas fa-shopping-cart text-sm mr-1"></i>
                                <span class="text-xs">{{ commande.paniers.count }}</span>
                            </a>
                        </td>

                        <!-- Actions -->
                        <td class="column-actions px-2 py-3 text-center">
                            {% if current_tab == 'actives' %}
                                <button onclick="ouvrirModalTraitement({{ commande.pk }}, '{{ commande.id_yz }}', '{{ commande.num_cmd|default:commande.id_yz }}')"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700 transition-colors">
                                    <i class="fas fa-tools mr-1"></i> Traiter
                                </button>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600">
                                   Trait√©e
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{% if current_tab == 'traitees' %}11{% else %}10{% endif %}" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <i class="fas fa-undo text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">
                                    {% if current_tab == 'actives' %}
                                        Aucune commande √† traiter
                                    {% else %}
                                        Aucune commande trait√©e
                                    {% endif %}
                                </h3>
                                <p class="text-gray-500">
                                    {% if current_tab == 'actives' %}
                                        Toutes les commandes retourn√©es ont √©t√© trait√©es.
                                    {% else %}
                                        Aucune commande retourn√©e n'a encore √©t√© trait√©e.
                                    {% endif %}
                                </p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        </div>
    </div>
</div>
</div>


<!-- Modale de traitement -->
<div id="modalTraitement" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-t√™te de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-tools text-2xl mr-3 text-orange-500"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Traiter la commande retourn√©e</h3>
                </div>
                <button onclick="fermerModalTraitement()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Informations de la commande -->
            <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-orange-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-orange-700">
                            <strong>Commande:</strong> <span id="modalCommandeId"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Formulaire de traitement -->
            <div class="space-y-4">
                <!-- √âtat du stock -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-boxes mr-2"></i>√âtat du stock
                    </label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="stockBon" name="etat_stock" value="bon" 
                                   class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300" checked>
                            <label for="stockBon" class="ml-2 block text-sm text-gray-700">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                Produits en bon √©tat (stock r√©incr√©ment√©)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="stockDefectueux" name="etat_stock" value="defectueux" 
                                   class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <label for="stockDefectueux" class="ml-2 block text-sm text-gray-700">
                                <i class="fas fa-times-circle text-red-500 mr-1"></i>
                                Produits d√©fectueux (stock non r√©incr√©ment√©)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Commentaire -->
                <div>
                    <label for="commentaireTraitement" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment mr-2"></i>Commentaire de traitement *
                    </label>
                    <textarea id="commentaireTraitement" name="commentaire" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"
                              placeholder="D√©crivez le traitement effectu√©..."></textarea>
                </div>

                <!-- Note d'information -->
                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Information:</strong> Cette action va g√©rer le stock selon l'√©tat s√©lectionn√©. 
                        La commande restera dans l'√©tat "Retourn√©e".
                    </p>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-6 mt-6 border-t">
                <button onclick="fermerModalTraitement()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="confirmerTraitement()" 
                        class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-arrow-right mr-2"></i>Continuer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation personnalis√©e -->
<div id="modalConfirmation" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-t√™te de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-question-circle text-2xl mr-3 text-blue-500"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Confirmation</h3>
                </div>
                <button onclick="fermerModalConfirmation()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Contenu de confirmation -->
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Commande:</strong> <span id="confirmationCommandeId"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-start">
                        <i class="fas fa-tasks text-green-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Action:</p>
                            <p class="text-sm text-gray-600">Gestion du stock (commande reste "Retourn√©e")</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-boxes text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">√âtat du stock:</p>
                            <p class="text-sm text-gray-600" id="confirmationEtatStock"></p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-comment text-purple-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Commentaire:</p>
                            <p class="text-sm text-gray-600" id="confirmationCommentaire"></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        √ätes-vous s√ªr de vouloir proc√©der √† cette action ?
                    </p>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button onclick="fermerModalConfirmation()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="executerTraitement()" 
                        class="px-4 py-2 text-white rounded-md transition-colors bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-check mr-2"></i>Confirmer
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<!-- Styles pour les notifications -->
<style>
.notification {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.notification-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border-left-color: #047857;
}

.notification-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-left-color: #b91c1c;
}

.notification-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-left-color: #b45309;
}

.notification-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border-left-color: #1d4ed8;
}

.notification:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.notification button:hover {
    transform: scale(1.1);
}

/* Animation d'entr√©e et de sortie */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.notification-enter {
    animation: slideInRight 0.3s ease-out;
}

.notification-exit {
    animation: slideOutRight 0.3s ease-in;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Page de suivi des commandes retourn√©es charg√©e.");
    
    // Gestion des onglets
    const tabLinks = document.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const tab = this.getAttribute('href').split('=')[1];
            
            // Mettre √† jour l'URL sans recharger la page
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            window.history.pushState({}, '', url);
            
            // Recharger la page pour afficher le bon onglet
            window.location.reload();
        });
    });
    
    // Gestion du bouton retour du navigateur
    window.addEventListener('popstate', function(e) {
        window.location.reload();
    });
});
</script>
<script src="{% static 'js/common/pagination-table.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (window.createSmartTablePagination) {
        window.createSmartTablePagination({
            tableSelector: '#suivi-prepa-table-retournees',
            rowSelector: '.commande-row',
            perPageOptions: [10,12,25,50,100],
            defaultPerPage: 12
        });
    }
});
</script>

<script>
// Initialiser la recherche intelligente pour cette page
document.addEventListener('DOMContentLoaded', function() {
    if (window.initSuiviCommandesSearch) {
        window.initSuiviCommandesSearch('retourn√©es');
    }
});
</script>

<!-- Script pour les commandes retourn√©es -->
<script src="{% static 'js/Superpreparation/Retourn√©e/Commande_retourn√©e.js' %}"></script>

<!-- JavaScript standardis√© pour le masquage de colonnes -->
<script>
// Fonction pour masquer/afficher les colonnes
function toggleColumnVisibility() {
    const button = document.getElementById('columnToggle');
    
    // Cr√©er le modal de s√©lection des colonnes
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">S√©lectionner les colonnes</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <!-- Checkboxes pour chaque colonne -->
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-id-yz" checked>
                    <span class="ml-2 text-sm text-gray-700">ID YZ</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-num-ext" checked>
                    <span class="ml-2 text-sm text-gray-700">N¬∞ Externe</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-client" checked>
                    <span class="ml-2 text-sm text-gray-700">Client</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-telephone" checked>
                    <span class="ml-2 text-sm text-gray-700">T√©l√©phone</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-ville-region" checked>
                    <span class="ml-2 text-sm text-gray-700">Ville & R√©gion</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-date-retour" checked>
                    <span class="ml-2 text-sm text-gray-700">Date de retour</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-date-traitement" checked>
                    <span class="ml-2 text-sm text-gray-700">Date de traitement</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-operateur" checked>
                    <span class="ml-2 text-sm text-gray-700">Trait√© par</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-total" checked>
                    <span class="ml-2 text-sm text-gray-700">Total</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-etat" checked>
                    <span class="ml-2 text-sm text-gray-700">√âtat</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-panier" checked>
                    <span class="ml-2 text-sm text-gray-700">Panier</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-actions" checked>
                    <span class="ml-2 text-sm text-gray-700">Actions</span>
                </label>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    Annuler
                </button>
                <button onclick="applyColumnVisibility(this.closest('.fixed'))" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                    Appliquer
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadColumnVisibility();
}

// Charger l'√©tat actuel des colonnes
function loadColumnVisibility() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    const checkboxes = document.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        const column = checkbox.dataset.column;
        checkbox.checked = !hiddenColumns.includes(column);
    });
}

// Appliquer la visibilit√© des colonnes
function applyColumnVisibility(modal) {
    const checkboxes = modal.querySelectorAll('.column-checkbox');
    const hiddenColumns = [];
    
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            hiddenColumns.push(checkbox.dataset.column);
        }
    });
    
    // Sauvegarder dans localStorage
    localStorage.setItem('hiddenColumns', JSON.stringify(hiddenColumns));
    
    // Appliquer la visibilit√©
    updateColumnVisibility(hiddenColumns);
    
    // Fermer le modal
    modal.remove();
}

// Mettre √† jour la visibilit√© des colonnes
function updateColumnVisibility(hiddenColumns) {
    // Liste des colonnes disponibles pour cette page
    const columns = [
        'column-id-yz', 'column-num-ext', 'column-client', 'column-telephone',
        'column-ville-region', 'column-date-retour', 'column-date-traitement',
        'column-operateur', 'column-total', 'column-etat', 'column-panier', 'column-actions'
    ];
    
    columns.forEach(column => {
        const elements = document.querySelectorAll(`.${column}`);
        elements.forEach(element => {
            if (hiddenColumns.includes(column)) {
                element.style.display = 'none';
            } else {
                element.style.display = '';
            }
        });
    });
}

// Charger la visibilit√© des colonnes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    updateColumnVisibility(hiddenColumns);
});
</script>
{% endblock %}