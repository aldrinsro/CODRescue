{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block page_subtitle %}{{ page_subtitle }}{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Token CSRF pour les requêtes AJAX -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Système de notifications toast -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="main-content transition-all duration-300 compact-page" id="mainContent">
    <style>
    /* Largeurs minimales par colonne pour garantir la lisibilité des entêtes */
    .compact-page #cmdTable { font-size: 12px; }
    .compact-page #cmdTable th, .compact-page #cmdTable td {
        padding: 6px 8px !important;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle;
    }
    .compact-page #cmdTable th:nth-child(1), .compact-page #cmdTable td:nth-child(1) { width: 90px; min-width: 90px; }   /* Numéro */
    .compact-page #cmdTable th:nth-child(2), .compact-page #cmdTable td:nth-child(2) { width: 100px; min-width: 100px; } /* N° Ext. */
    .compact-page #cmdTable th:nth-child(3), .compact-page #cmdTable td:nth-child(3) { width: 160px; min-width: 160px; } /* Client */
    .compact-page #cmdTable th:nth-child(4), .compact-page #cmdTable td:nth-child(4) { width: 110px; min-width: 110px; } /* Téléphone */
    .compact-page #cmdTable th:nth-child(5), .compact-page #cmdTable td:nth-child(5) { width: 140px; min-width: 140px; } /* Ville & Région */
    .compact-page #cmdTable th:nth-child(6), .compact-page #cmdTable td:nth-child(6) { width: 110px; min-width: 110px; } /* Date renvoie */
    .compact-page #cmdTable th:nth-child(7), .compact-page #cmdTable td:nth-child(7) { width: 120px; min-width: 120px; } /* Date traitement (ou Traité par) */
    /* Les colonnes suivantes peuvent varier selon l'onglet; on applique des largeurs raisonnables */
    .compact-page #cmdTable th:nth-child(8), .compact-page #cmdTable td:nth-child(8) { width: 120px; min-width: 120px; }
    .compact-page #cmdTable th:nth-child(9), .compact-page #cmdTable td:nth-child(9) { width: 100px; min-width: 100px; }
    .compact-page #cmdTable th:nth-child(10), .compact-page #cmdTable td:nth-child(10) { width: 90px; min-width: 90px; }
    .compact-page #cmdTable th:nth-child(11), .compact-page #cmdTable td:nth-child(11) { width: 110px; min-width: 110px; }
    .compact-page #cmdTable th:nth-child(12), .compact-page #cmdTable td:nth-child(12) { width: 110px; min-width: 110px; }
    </style>
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg"
         style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-dark));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-undo mr-3" style="color: var(--preparation-border-accent);"></i>
                {{ page_title }}
            </h1>
            <p style="color: white;">{{ page_subtitle }}</p>
        </div>
    </div>

    <!-- Onglets de navigation -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <a href="?tab=actives" 
                   class="tab-link py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 {% if current_tab == 'actives' %}border-red-500 text-red-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    <i class="fas fa-clock mr-2"></i>
                    À traiter ({{ stats.total_actives }})
                </a>
                <a href="?tab=traitees" 
                   class="tab-link py-4 px-1 border-b-2 font-medium text-sm transition-colors duration-200 {% if current_tab == 'traitees' %}border-green-500 text-green-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    <i class="fas fa-check-circle mr-2"></i>
                    Traitées ({{ stats.total_traitees }})
                </a>
            </nav>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <!-- Commandes actives -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-red-100 to-red-200 text-red-600 transition-all duration-300 group-hover:from-red-500 group-hover:to-red-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">À traiter</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-red-600">{{ stats.total_actives }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes traitées -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Traitées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ stats.total_traitees }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur actives -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Actives</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ stats.valeur_actives|floatformat:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur traitées -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 transition-all duration-300 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Traitées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-blue-600">{{ stats.valeur_traitees|floatformat:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% include 'Superpreparation/includes/smart-search-toolbar.html' %}
    <div class="flex justify-end mb-2">
        <button id="columnToggle" onclick="toggleColumnVisibility()" 
                class="inline-flex items-center px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm font-medium rounded transition-colors h-10" title="Sélectionner les colonnes">
            <i class="fas fa-columns mr-2 text-gray-500"></i>
            Sélectionner les colonnes
        </button>
    </div>
        
    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200" id="tableScrollContainer">
        <table id="cmdTable" class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm" style="table-layout:auto;">
            <thead class="sticky top-0 z-10" style="background-color: var(--preparation-primary);">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Numéro</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N° Ext.</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Téléphone</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville & Région</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date renvoie</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date traitement</th>
                    {% if current_tab == 'traitees' %}
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Traité par</th>
                    {% endif %}
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Panier</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if commandes_retournees %}
                    {% for commande in commandes_retournees %}
                    <tr class="hover:bg-gray-50 commande-row" 
                        data-id-yz="{{ commande.id_yz }}"
                        data-num-cmd="{{ commande.num_cmd|default:'' }}"
                        data-client="{{ commande.client.prenom }} {{ commande.client.nom }}"
                        data-phone="{{ commande.client.numero_tel|default:'' }}"
                        data-ville-client="{{ commande.ville_init|default:'' }}"
                        data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom_region }}{% endif %}"
                        data-adresse="{% if commande.client.adresse %}{{ commande.client.adresse }}{% endif %}"
                        data-date-retour="{% if commande.etat_actuel %}{{ commande.etat_actuel.date_debut|date:'d/m/Y' }}{% endif %}"
                        data-total="{{ commande.total_cmd }}"
                        data-etat="Retournée"
                        data-operateur="{% if commande.etat_actuel.operateur %}{{ commande.etat_actuel.operateur.nom }} {{ commande.etat_actuel.operateur.prenom }}{% endif %}">
                        <td class="px-2 py-2 whitespace-nowrap text-xs font-medium text-gray-900">
                            {{ commande.id_yz }}
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap text-xs text-gray-500">{{ commande.num_cmd|default:"-" }}</td>
                        <!-- Colonne Client -->
                        <td class="px-2 py-2 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                            {% if commande.client.email %}
                            <div class="text-xs text-gray-500">{{ commande.client.email }}</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Téléphone -->
                        <td class="px-2 py-2 whitespace-nowrap">
                            {% if commande.client.numero_tel %}
                            <div class="text-xs text-gray-900 font-medium">
                                <i class="fas fa-phone mr-1"></i>
                                {{ commande.client.numero_tel }}
                            </div>
                            {% else %}
                            <div class="text-xs text-gray-500">Non renseigné</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Ville & Région (ville de livraison) -->
                        <td class="px-2 py-2 whitespace-nowrap">
                            {% if commande.ville %}
                                <div class="text-xs text-gray-900">{{ commande.ville.nom }}</div>
                            {% else %}
                                <div class="text-xs text-gray-500">Non définie</div>
                            {% endif %}
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap">
                            {% if commande.etat_retournee %}
                                <div class="text-xs text-gray-900">{{ commande.etat_retournee.date_debut|date:"d/m/Y" }}</div>
                                <div class="text-xs text-gray-500">{{ commande.etat_retournee.date_debut|date:"H:i" }}</div>
                            {% else %}
                                <div class="text-xs text-gray-500">Non définie</div>
                            {% endif %}
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap">
                            {% if current_tab == 'actives' %}
                                <div class="text-xs text-gray-500 italic">En attente</div>
                            {% else %}
                                {% if commande.etat_retournee and commande.etat_retournee.date_fin %}
                                    <div class="text-xs text-gray-900">{{ commande.etat_retournee.date_fin|date:"d/m/Y" }}</div>
                                    <div class="text-xs text-gray-500">{{ commande.etat_retournee.date_fin|date:"H:i" }}</div>
                                {% else %}
                                    <div class="text-xs text-gray-500">Non définie</div>
                                {% endif %}
                            {% endif %}
                        </td>
                        {% if current_tab == 'traitees' %}
                        <td class="px-2 py-2 whitespace-nowrap">
                            {% if commande.etat_retournee and commande.etat_retournee.operateur %}
                                <div class="text-xs text-gray-900">{{ commande.etat_retournee.operateur.nom }} {{ commande.etat_retournee.operateur.prenom }}</div>
                                <div class="text-xs text-gray-500">{{ commande.etat_retournee.operateur.type_operateur }}</div>
                            {% else %}
                                <div class="text-xs text-gray-500">Non défini</div>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td class="px-2 py-2 whitespace-nowrap">
                            <div class="text-xs font-bold text-green-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        </td>

                        <td class="px-4 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                <i class="fas fa-undo mr-1"></i>
                                Retournée
                            </span>
                        </td>
                        <td class="px-2 py-2 whitespace-nowrap text-center">
                            <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}" 
                               class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                               style="background-color: var(--preparation-primary); hover:background-color: var(--preparation-dark);"
                               title="Voir le panier de cette commande">
                                <i class="fas fa-shopping-cart mr-1"></i> 
                                {{ commande.paniers.count }} article{{ commande.paniers.count|pluralize }}
                            </a>
                        </td>
                        <td>
                            {% if current_tab == 'actives' %}
                                <button onclick="ouvrirModalTraitement({{ commande.pk }}, '{{ commande.id_yz }}', '{{ commande.num_cmd|default:commande.id_yz }}')"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700 transition-colors">
                                    <i class="fas fa-tools mr-1"></i> Traiter
                                </button>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600">
                                   Traitée
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{% if current_tab == 'traitees' %}11{% else %}10{% endif %}" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <i class="fas fa-undo text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">
                                    {% if current_tab == 'actives' %}
                                        Aucune commande à traiter
                                    {% else %}
                                        Aucune commande traitée
                                    {% endif %}
                                </h3>
                                <p class="text-gray-500">
                                    {% if current_tab == 'actives' %}
                                        Toutes les commandes retournées ont été traitées.
                                    {% else %}
                                        Aucune commande retournée n'a encore été traitée.
                                    {% endif %}
                                </p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (client) -->
    <div data-superprep-pagination data-items-selector="tbody tr" data-container-selector="table" data-per-page="25"></div>
</div>
</div>


<!-- Modale de traitement -->
<div id="modalTraitement" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-tête de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-tools text-2xl mr-3 text-orange-500"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Traiter la commande retournée</h3>
                </div>
                <button onclick="fermerModalTraitement()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Informations de la commande -->
            <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-orange-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-orange-700">
                            <strong>Commande:</strong> <span id="modalCommandeId"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Formulaire de traitement -->
            <div class="space-y-4">
                <!-- État du stock -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-boxes mr-2"></i>État du stock
                    </label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="stockBon" name="etat_stock" value="bon" 
                                   class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300" checked>
                            <label for="stockBon" class="ml-2 block text-sm text-gray-700">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                Produits en bon état (stock réincrémenté)
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="stockDefectueux" name="etat_stock" value="defectueux" 
                                   class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <label for="stockDefectueux" class="ml-2 block text-sm text-gray-700">
                                <i class="fas fa-times-circle text-red-500 mr-1"></i>
                                Produits défectueux (stock non réincrémenté)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Commentaire -->
                <div>
                    <label for="commentaireTraitement" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment mr-2"></i>Commentaire de traitement *
                    </label>
                    <textarea id="commentaireTraitement" name="commentaire" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Décrivez le traitement effectué..."></textarea>
                </div>

                <!-- Note d'information -->
                <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Information:</strong> Cette action va gérer le stock selon l'état sélectionné. 
                        La commande restera dans l'état "Retournée".
                    </p>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-6 mt-6 border-t">
                <button onclick="fermerModalTraitement()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="confirmerTraitement()" 
                        class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-arrow-right mr-2"></i>Continuer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation personnalisée -->
<div id="modalConfirmation" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-tête de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-question-circle text-2xl mr-3 text-blue-500"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Confirmation</h3>
                </div>
                <button onclick="fermerModalConfirmation()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Contenu de confirmation -->
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Commande:</strong> <span id="confirmationCommandeId"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-start">
                        <i class="fas fa-tasks text-green-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Action:</p>
                            <p class="text-sm text-gray-600">Gestion du stock (commande reste "Retournée")</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-boxes text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">État du stock:</p>
                            <p class="text-sm text-gray-600" id="confirmationEtatStock"></p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-comment text-purple-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Commentaire:</p>
                            <p class="text-sm text-gray-600" id="confirmationCommentaire"></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Êtes-vous sûr de vouloir procéder à cette action ?
                    </p>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button onclick="fermerModalConfirmation()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="executerTraitement()" 
                        class="px-4 py-2 text-white rounded-md transition-colors bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-check mr-2"></i>Confirmer
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Styles pour les notifications -->
<style>
.notification {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.notification-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border-left-color: #047857;
}

.notification-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-left-color: #b91c1c;
}

.notification-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-left-color: #b45309;
}

.notification-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border-left-color: #1d4ed8;
}

.notification:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.notification button:hover {
    transform: scale(1.1);
}

/* Animation d'entrée et de sortie */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.notification-enter {
    animation: slideInRight 0.3s ease-out;
}

.notification-exit {
    animation: slideOutRight 0.3s ease-in;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Page de suivi des commandes retournées chargée.");
    
    // Gestion des onglets
    const tabLinks = document.querySelectorAll('.tab-link');
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const tab = this.getAttribute('href').split('=')[1];
            
            // Mettre à jour l'URL sans recharger la page
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            window.history.pushState({}, '', url);
            
            // Recharger la page pour afficher le bon onglet
            window.location.reload();
        });
    });
    
    // Gestion du bouton retour du navigateur
    window.addEventListener('popstate', function(e) {
        window.location.reload();
    });
});
</script>

<!-- Script de recherche intelligente -->
<script src="{% static 'js/Superpreparation/Suivi_des_Commandes/suivi-commandes-smart-search.js' %}"></script>
<script>
// Initialiser la recherche intelligente pour cette page
document.addEventListener('DOMContentLoaded', function() {
    initSuiviCommandesSearch('retournees');
});
</script>

<!-- Script pour les commandes retournées -->
<script src="{% static 'js/Superpreparation/Retournée/Commande_retournée.js' %}"></script>
<script>
// Initialiser la recherche intelligente si disponible
document.addEventListener('DOMContentLoaded', function() {
    if (typeof initSuiviCommandesSearch === 'function') {
        initSuiviCommandesSearch('retournées');
    }
});
</script>
{% endblock %}