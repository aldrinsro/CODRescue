{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}


{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-t√™te de la page -->
    <div class="text-white p-6 rounded-xl shadow-lg mb-8" style="background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%); border: 2px solid var(--preparation-border-accent);">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                    <i class="fas fa-truck-loading mr-3 text-yellow-300"></i>
                    {{ page_title|default:'Suivi - Commandes Livr√©es Partiellement' }}
            </h1>
                <p class="text-white opacity-90">{{ page_subtitle|default:'Suivi et gestion des commandes livr√©es partiellement' }}</p>
            </div>
            <div class="flex items-center gap-6 mt-4 md:mt-0">
                <div class="text-center">
                    <div class="text-3xl font-bold text-white">{{ stats.total_commandes|default:0 }}</div>
                    <div class="text-sm text-white opacity-80">Commandes partiellement livr√©es</div>
                </div>
                <div class="text-center border-l border-white/30 pl-6 ml-6">
                    <div class="text-3xl font-bold text-white">{{ stats.commandes_urgentes|default:0 }}</div>
                    <div class="text-sm text-white opacity-80">Urgentes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 lg:mb-8">
        <!-- Total des commandes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-truck text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Livr√©es Partiellement</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ stats.total_commandes|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur totale -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-coins text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Totale</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ stats.valeur_totale|floatformat:0|default:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes urgentes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-red-100 to-red-200 text-red-600 transition-all duration-300 group-hover:from-red-500 group-hover:to-red-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Urgentes</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-red-600">{{ stats.commandes_urgentes|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Section de recherche -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="px-4 py-3 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Recherche et Filtres</h3>
        <p class="text-sm text-gray-500 mt-1">Recherchez et filtrez les commandes livr√©es partiellement</p>
                </div>
    
    <div class="p-4">
        {% include 'Superpreparation/includes/smart-search-toolbar.html' %}
    </div>
    
    <!-- Script de recherche intelligente (charg√© t√¥t pour les boutons) -->
    <script src="{% static 'js/Superpreparation/Suivi_des_Commandes/suivi-commandes-smart-search.js' %}"></script>
    
    <!-- Script de fallback pour les fonctions manquantes -->
    <script>
        // Fallback si les fonctions ne sont pas charg√©es
        if (typeof window.toggleAdvancedSearch === 'undefined') {
            window.toggleAdvancedSearch = function() {
                const advancedSearch = document.getElementById('advancedSearch');
                if (advancedSearch) {
                    const isHidden = advancedSearch.style.display === 'none' || advancedSearch.classList.contains('hidden');
                    if (isHidden) {
                        advancedSearch.style.display = 'block';
                        advancedSearch.classList.remove('hidden');
                    } else {
                        advancedSearch.style.display = 'none';
                        advancedSearch.classList.add('hidden');
                    }
                }
            };
        }
        
        if (typeof window.clearSmartSearch === 'undefined') {
            window.clearSmartSearch = function() {
                const searchInput = document.getElementById('smartSearch');
                if (searchInput) {
                    searchInput.value = '';
                }
                const filterInputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select');
                filterInputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            };
        }
        
        if (typeof window.applyFilters === 'undefined') {
            window.applyFilters = function() {
                console.log('üîç Filtres appliqu√©s (fallback)');
            };
        }
    </script>
</div>

<!-- Section des donn√©es -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="px-4 py-3 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Commandes Livr√©es Partiellement</h3>
        <p class="text-sm text-gray-500 mt-1">Gestion des commandes avec livraison partielle</p>
    </div>
    
    <div class="p-4">
        <!-- Version mobile/tablette : Cartes -->
        {% if commandes_livrees_partiellement %}
        <div class="block lg:hidden space-y-3 mb-4">
            {% for commande in commandes_livrees_partiellement %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200">
                <!-- En-t√™te de la carte -->
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                            <span class="text-orange-600 font-bold text-xs">{{ commande.id_yz }}</span>
                </div>
                <div>
                            <h3 class="font-semibold text-gray-900 text-sm">{{ commande.client.prenom }} {{ commande.client.nom }}</h3>
                            <p class="text-xs text-gray-500">{{ commande.num_cmd|default:"-" }}</p>
                </div>
            </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-orange-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        <div class="text-xs text-gray-500">{{ commande.paniers.count }} article{{ commande.paniers.count|pluralize }}</div>
                </div>
            </div>
                
                <!-- Informations d√©taill√©es -->
                <div class="space-y-2 text-xs text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-phone w-4 mr-2"></i>
                        <span>{{ commande.client.numero_tel|default:"Non renseign√©" }}</span>
                    </div>
                    {% if commande.ville %}
                    <div class="flex items-center">
                        <i class="fas fa-map-marker-alt w-4 mr-2"></i>
                        <span>{{ commande.ville.nom }}, {{ commande.ville.region.nom_region }}</span>
                    </div>
                    {% endif %}
                    {% if commande.etat_actuel %}
                    <div class="flex items-center">
                        <i class="fas fa-calendar w-4 mr-2"></i>
                        <span>Livr√©e partiellement le {{ commande.etat_actuel.date_debut|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}"
                           class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white text-xs transition-all hover:shadow-lg"
                           style="background-color: var(--preparation-primary);"
                           title="Voir le panier">
                            <i class="fas fa-shopping-cart mr-1"></i>
                            Panier
                        </a>
                </div>
                    <div class="flex items-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                            <i class="fas fa-truck mr-1"></i>
                            Livr√©e partiellement
                        </span>
                </div>
            </div>
        </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Bouton de s√©lection des colonnes -->
        <div class="hidden lg:flex justify-end mb-3">
            <button id="columnToggle" onclick="toggleColumnVisibility()" 
                    class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-300"
                    title="S√©lectionner les colonnes">
                <i class="fas fa-columns mr-2 text-gray-500"></i>
                S√©lectionner les colonnes
            </button>
    </div>

        <!-- Version desktop : Tableau -->
        <div class="hidden lg:block overflow-x-auto rounded-lg shadow-sm border border-gray-200 mb-4">
        <table id="suivi-prepa-table-partielles" class="w-full divide-y divide-gray-200 table-auto">
            <thead style="background-color: var(--preparation-primary);">
                <tr>
                    <th class="column-id-yz px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">ID YZ</th>
                    <th class="column-num-ext px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">N¬∞ Externe</th>
                    <th class="column-client px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 15%;">Client</th>
                    <th class="column-telephone px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">T√©l√©phone</th>
                    <th class="column-ville-client px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Ville Client</th>
                    <th class="column-ville-region px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 12%;">Ville & R√©gion</th>
                    <th class="column-date-debut px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Date D√©but</th>
                    <th class="column-total px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">Total</th>
                    <th class="column-etat px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">√âtat</th>
                    <th class="column-panier px-2 py-3 text-center text-xs font-medium text-white uppercase tracking-wider" style="width: 8%;">Panier</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if commandes_livrees_partiellement %}
                        {% for commande in commandes_livrees_partiellement %}
                        <tr class="table-row commande-row" 
                            data-id-yz="{{ commande.id_yz }}"
                            data-num-cmd="{{ commande.num_cmd|default:'' }}"
                            data-client="{{ commande.client.prenom }} {{ commande.client.nom }}"
                            data-phone="{{ commande.client.numero_tel|default:'' }}"
                            data-email="{{ commande.client.email|default:'' }}"
                            data-ville-client="{{ commande.ville_init|default:'' }}"
                            data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom_region }}{% endif %}"
                            data-adresse="{% if commande.client.adresse %}{{ commande.client.adresse }}{% endif %}"
                            data-date-livraison="{% if commande.etat_actuel %}{{ commande.etat_actuel.date_debut|date:'d/m/Y' }}{% endif %}"
                            data-total="{{ commande.total_cmd }}"
                            data-etat="Livr√©e partiellement"
                            data-operateur="{% if commande.etat_actuel.operateur %}{{ commande.etat_actuel.operateur.nom }} {{ commande.etat_actuel.operateur.prenom }}{% endif %}">
                            
                            <!-- ID YZ -->
                            <td class="column-id-yz px-2 py-3 text-sm font-medium text-gray-900 truncate">
                                <span class="font-bold">{{ commande.id_yz }}</span>
                            </td>

                            <!-- N¬∞ Externe -->
                            <td class="column-num-ext px-2 py-3 text-sm text-gray-500 truncate">
                                {{ commande.num_cmd|default:"-" }}
                            </td>
                            
                            <!-- Client -->
                            <td class="column-client px-2 py-3 truncate">
                                <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                                {% if commande.client.email %}
                                <div class="text-xs text-gray-500">{{ commande.client.email }}</div>
                                {% endif %}
                            </td>
                            
                            <!-- T√©l√©phone -->
                            <td class="column-telephone px-2 py-3 truncate">
                                {% if commande.client.numero_tel %}
                                <div class="text-sm text-gray-900 font-medium">
                                    <i class="fas fa-phone mr-1"></i>
                                    {{ commande.client.numero_tel }}
                                </div>
                                {% else %}
                                <div class="text-sm text-gray-500">Non renseign√©</div>
                                {% endif %}
                            </td>
                            
                            <!-- Ville Client -->
                            <td class="column-ville-client px-2 py-3 truncate">
                                {% if commande.ville_init and commande.ville_init != '' %}
                                    <div class="text-sm font-medium text-gray-900">{{ commande.ville_init }}</div>
                                {% else %}
                                    <div class="text-sm text-gray-500">Non sp√©cifi√©e</div>
                                {% endif %}
                            </td>
                            
                            <!-- Ville & R√©gion -->
                            <td class="column-ville-region px-2 py-3 truncate">
                                {% if commande.ville %}
                                    <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                                    <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                                {% else %}
                                    <div class="text-sm text-gray-500">Non d√©finie</div>
                                {% endif %}
                            </td>
                            
                            <!-- Date D√©but -->
                            <td class="column-date-debut px-2 py-3 truncate">
                                {% with etat_actuel=commande.etat_actuel %}
                                    {% if etat_actuel %}
                                        <div class="text-sm text-gray-900">{{ etat_actuel.date_debut|date:"d/m/Y" }}</div>
                                        <div class="text-xs text-gray-500">{{ etat_actuel.date_debut|date:"H:i" }}</div>
                                    {% else %}
                                        <div class="text-sm text-gray-500">Non d√©finie</div>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            
                            <!-- Total -->
                            <td class="column-total px-2 py-3 truncate">
                                <div class="text-sm font-bold text-orange-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                            </td>

                            <!-- √âtat -->
                            <td class="column-etat px-2 py-3 text-sm truncate">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                                    <i class="fas fa-truck mr-1"></i>
                                    Livr√©e partiellement
                                </span>
                            </td>
                            
                            <!-- Panier -->
                            <td class="column-panier px-2 py-3 text-center">
                                <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}" 
                                   class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: var(--preparation-primary);"
                                   title="Voir le panier de cette commande">
                                    <i class="fas fa-shopping-cart text-sm mr-1"></i>
                                    <span class="text-xs">{{ commande.paniers.count }}</span>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="table-cell whitespace-nowrap text-center">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-truck"></i>
                                    </div>
                                    <h3 class="text-xl font-medium text-gray-800 mb-2">Aucune commande livr√©e partiellement</h3>
                                    <p class="text-gray-600 mb-4">Toutes les commandes ont √©t√© livr√©es compl√®tement ou ne sont pas encore livr√©es.</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        </div>
    </div>
</div>

<script>
    // Toast notification system
    function showToast(message, type = 'info', duration = 4000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            info: 'fas fa-info-circle',
            warning: 'fas fa-exclamation-triangle'
        }[type];
        
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="${icon} mr-3 text-lg"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Show animation
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Auto remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
        // Show welcome message
        setTimeout(() => {
            showToast('Bienvenue dans le suivi des commandes livr√©es partiellement !', 'info', 3000);
        }, 1000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'r':
                    e.preventDefault();
                    window.location.reload();
                    showToast('Page actualis√©e !', 'info');
                    break;
            }
        }
});

</script>
<script src="{% static 'js/common/pagination-table.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (window.createSmartTablePagination) {
        window.createSmartTablePagination({
            tableSelector: '#suivi-prepa-table-partielles',
            rowSelector: '.commande-row',
            perPageOptions: [10,12,25,50,100],
            defaultPerPage: 12
        });
    }
});
</script>

<script>
// Initialiser la recherche intelligente pour cette page
document.addEventListener('DOMContentLoaded', function() {
    if (window.initSuiviCommandesSearch) {
        window.initSuiviCommandesSearch('livrees_partiellement');
    }
});
</script>

<!-- JavaScript standardis√© pour le masquage de colonnes -->
<script>
// Fonction pour masquer/afficher les colonnes
function toggleColumnVisibility() {
    const button = document.getElementById('columnToggle');
    
    // Cr√©er le modal de s√©lection des colonnes
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">S√©lectionner les colonnes</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <!-- Checkboxes pour chaque colonne -->
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-id-yz" checked>
                    <span class="ml-2 text-sm text-gray-700">ID YZ</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-num-ext" checked>
                    <span class="ml-2 text-sm text-gray-700">N¬∞ Externe</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-client" checked>
                    <span class="ml-2 text-sm text-gray-700">Client</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-telephone" checked>
                    <span class="ml-2 text-sm text-gray-700">T√©l√©phone</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-ville-client" checked>
                    <span class="ml-2 text-sm text-gray-700">Ville Client</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-ville-region" checked>
                    <span class="ml-2 text-sm text-gray-700">Ville & R√©gion</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-date-debut" checked>
                    <span class="ml-2 text-sm text-gray-700">Date D√©but</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-total" checked>
                    <span class="ml-2 text-sm text-gray-700">Total</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-etat" checked>
                    <span class="ml-2 text-sm text-gray-700">√âtat</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-panier" checked>
                    <span class="ml-2 text-sm text-gray-700">Panier</span>
                </label>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    Annuler
                </button>
                <button onclick="applyColumnVisibility(this.closest('.fixed'))" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                    Appliquer
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadColumnVisibility();
}

// Charger l'√©tat actuel des colonnes
function loadColumnVisibility() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    const checkboxes = document.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        const column = checkbox.dataset.column;
        checkbox.checked = !hiddenColumns.includes(column);
    });
}

// Appliquer la visibilit√© des colonnes
function applyColumnVisibility(modal) {
    const checkboxes = modal.querySelectorAll('.column-checkbox');
    const hiddenColumns = [];
    
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            hiddenColumns.push(checkbox.dataset.column);
        }
    });
    
    // Sauvegarder dans localStorage
    localStorage.setItem('hiddenColumns', JSON.stringify(hiddenColumns));
    
    // Appliquer la visibilit√©
    updateColumnVisibility(hiddenColumns);
    
    // Fermer le modal
    modal.remove();
}

// Mettre √† jour la visibilit√© des colonnes
function updateColumnVisibility(hiddenColumns) {
    // Liste des colonnes disponibles pour cette page
    const columns = [
        'column-id-yz', 'column-num-ext', 'column-client', 'column-telephone',
        'column-ville-client', 'column-ville-region', 'column-date-debut',
        'column-total', 'column-etat', 'column-panier'
    ];
    
    columns.forEach(column => {
        const elements = document.querySelectorAll(`.${column}`);
        elements.forEach(element => {
            if (hiddenColumns.includes(column)) {
                element.style.display = 'none';
            } else {
                element.style.display = '';
            }
        });
    });
}

// Charger la visibilit√© des colonnes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    updateColumnVisibility(hiddenColumns);
});
</script>

{% endblock %}