<!-- Template optimisé et amélioré pour l'impression de tickets -->
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="ticket-commande">
    <div class="ticket-content">
        <!-- HEADER -->
        <div class="ticket-header">
            <!-- Logo -->
            <div class="logo-left">
                <img src="{% static 'logo-tiicket/image.svg' %}" alt="Logo" class="header-logo" />
            </div>
            
            <!-- Informations de commande et Code QR -->
            <div class="header-right">
                <div class="order-info">
                    <div class="ticket-date">
                        <i class="fas fa-calendar-check"></i>
                        Edité le: {{ commande.date_confirmation|date:"d/m/Y" }}
                    </div>
                </div>
                
                <!-- Code QR avec numéro de commande en dessous -->
                <div class="barcode-right">
                    {% if commande.qr_image %}
                    <div class="barcode-wrap">
                        <img src="{{ commande.qr_image }}" 
                             onerror="this.onerror=null; this.src='data:image/png;base64,{{ commande.qr_image }}'" 
                             alt="QR {{ commande.id_yz }}" 
                             class="barcode-image">
                    </div>
                    {% elif commande.qr_base64 %}
                    <div class="barcode-wrap">
                        <img src="data:image/png;base64,{{ commande.qr_base64 }}" 
                             alt="QR {{ commande.id_yz }}" 
                             class="barcode-image">
                    </div>
                    {% elif commande.qr_code_base64 %}
                    <div class="barcode-wrap">
                        <img src="data:image/png;base64,{{ commande.qr_code_base64 }}" 
                             alt="QR {{ commande.id_yz }}" 
                             class="barcode-image">
                    </div>
                    {% elif commande.qr_svg %}
                    <div class="barcode-wrap">
                        <img src="data:image/svg+xml;base64,{{ commande.qr_svg }}" 
                             alt="QR {{ commande.id_yz }}" 
                             class="barcode-image">
                    </div>
                    {% elif commande.qr_url %}
                    <div class="barcode-wrap">
                        <img src="{{ commande.qr_url }}" 
                             alt="QR {{ commande.id_yz }}" 
                             class="barcode-image">
                    </div>
                    {% else %}
                    <div class="barcode-placeholder">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Numéro de commande séparé du code QR -->
                    <div class="order-number-below-qr">
                        #CMD {{ commande.num_cmd|default:commande.id_yz }}#
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INFOS CLIENT -->
        <div class="ticket-body">
            <div class="client-info">
                <div class="client-info-left">
                    <div class="client-line">
                        <i class="fas fa-user-circle"></i> <strong>Client:</strong> {{ commande.client_nom|truncatechars:20 }}
                    </div>
                    <div class="client-line">
                        <i class="fas fa-phone-alt"></i> <strong>Tél:</strong> {{ commande.client_telephone|default:"Non défini" }}
                    </div>
                    <div class="client-line">
                        <i class="fas fa-home"></i> <strong>Adresse:</strong> {{ commande.client_adresse|default:"Non définie"|truncatechars:25 }}
                    </div>
                    <div class="client-line">
                        <i class="fas fa-map-marker-alt"></i> <strong>Ville:</strong> {{ commande.ville_client|default:"Non définie" }}
                    </div>
                </div>
            </div>
            
            <!-- ARTICLES -->
            <div class="articles-section">
                <div class="articles-title">
                    <i class="fas fa-shopping-bag"></i> Articles: (<span class="articles-total-inline">{{ commande.total_articles|default:0 }}</span>)
                </div>
                <div class="articles-list">
                    {% for variante in commande.variantes %}
                        {% if forloop.counter <= 8 %}
                    <div class="article-item">
                             <!-- <i class="fas fa-exclamation-triangle"></i> -->
                        <div class="article-details">
                            <div class="article-ref">{{ variante.article.reference }}</div>
                            <div class="article-color">{{ variante.couleur }}</div>
                            <div class="article-size">{{ variante.pointure }}</div>
                            <div class="article-qty">x{{ variante.quantite }}</div>
                        </div>
                    </div>
                        {% endif %}
                    {% endfor %}
                    {% if commande.variantes|length > 8 %}
                    <div class="article-item">
                        <div class="article-details">
                            <div class="article-ref" style="font-weight:700; color:#111;">+ {{ commande.variantes|length|add:"-8" }} autres…</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <div class="ticket-footer">
            <div class="ticket-price">
                <div class="price-line">
                    <i class="fas fa-coins"></i>
                    <span class="price-amount">{{ commande.total }} DH</span>
                </div>
            </div>
            <div class="footer-company">
                <div><i class="fas fa-globe"></i> www.yoozak.com</div>
                <div><i class="fas fa-phone"></i> 06 34 21 56 39 / 47</div>
                <div><i class="fas fa-map-marker-alt"></i> {{ commande.region|default:"SETTAT" }}</div>
            </div>
        </div>
        
    </div>
</div>

<!-- STYLES -->
<style>
    /* STRUCTURE GLOBALE */
.ticket-commande {
         width: 100mm;
         height: 100mm; /* Format fixe 100x100 mm */
         border: 1px solid #000;
         font-family: Arial, sans-serif;
         font-size: 9.5px; /* Base font size */
         background: #fff;
         margin: 0 auto;
     display: flex;
     flex-direction: column;
         overflow: hidden; /* rester dans la bordure du ticket */
        /* Dimensions de référence */
        --barcode-max-w: 50mm; /* largeur max du code-barres (ajustée au format) */
        --barcode-max-h: 16mm; /* hauteur max du code-barres */
        --ticket-logo-width: calc(var(--barcode-max-w) * 0.55); /* logo proportionnel au code-barres */
        --articles-height: 42mm; /* hauteur fixe de la section articles (ajustée) */
        /* Variables d'espacement (optimisées pour 100x100mm) */
        --section-pad-y: 1.5mm;
        --section-pad-x: 1.5mm;
        --gap-sm: 0.5mm;
        --gap-md: 0.8mm;
        --gap-lg: 1mm;
        /* Tailles de police (agrandies) */
        --articles-font: 8.5px;
        --article-ref-font: 10px;
        --article-meta-font: 8.5px;
}

.ticket-content {
    display: flex;
    flex-direction: column;
    height: 100%;
        justify-content: space-between; /* Distribuer l'espace */
}

    /* HEADER (Sans bande noire) */
.ticket-header {
        background: #fff; /* Fond blanc */
        color: #000; /* Texte noir */
        padding: var(--section-pad-y) var(--section-pad-x);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--gap-md);
        font-size: 12px;
        font-weight: 800;
        height: 25mm; /* Hauteur fixe pour le header */
        border-bottom: 1px solid #eee; /* Ligne de séparation légère */
}

.logo-left {
        text-align: center; 
    display: flex;
    flex-direction: column;
    align-items: center;
        justify-content: center; 
    }

.header-right {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
        gap: var(--gap-md);
        width: 100%;
}

.order-info {
        display: flex;
        flex-direction: column;
        gap: 1mm;
        flex: 1;
}

.header-logo {
        width: 34mm;
        height: auto;
        max-height: 18mm;
        object-fit: contain;
        filter: none;
        background: transparent;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

 
    .barcode-image { 
        max-width: 25mm;
        max-height: 25mm;
        width: 25mm;
        height: 25mm;
        filter: contrast(500%) brightness(500%); /* contraste élevé pour scan */
        image-rendering: pixelated;
        display: block;
        object-fit: contain;
}

.barcode-text {
        font-size: 9px; 
    margin-top: 1mm;
        color: #000; /* noir sur blanc */
        letter-spacing: 0.4px; 
        font-weight: 700;
        text-align: center;
}

.ticket-date {
        font-size: 11px;
        font-weight: 600;
        color: #000; /* Noir pour la date */
    display: flex;
    align-items: center;
        gap: 1mm; 
        letter-spacing: 0.2px;
        text-transform: none;
    }
    .ticket-date i { 
        font-size: 10px; 
        color: #000; /* Icône en noir aussi */
    }

.barcode-right {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 30mm;
        flex-shrink: 0;
        overflow: visible;
        min-height: auto;
}

.order-number-below-qr {
        font-size: 10px;
        font-weight: 700;
        color: #000 !important; /* Force la couleur noire */
        text-align: center;
        margin-top: 1mm;
        letter-spacing: 0.2px;
}

    /* Total articles (cercle central) */
    .articles-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
        width: 16mm; /* Taille du cercle */
        height: 16mm;
        border-radius: 50%;
        background: #000; /* Cercle plein noir */
        color: #fff; /* Chiffre blanc */
        font-size: 14px; /* Taille du chiffre */
        font-weight: 900;
        border: 1px solid #fff; /* Bordure blanche pour contraste */
    }

    .articles-total-inline {
        font-size: 9px; /* Taille plus petite pour le chiffre entre parenthèses */
    font-weight: bold;
        color: #333; /* Couleur du texte */
        margin-left: 1mm; /* Espacement avec le titre */
}

.ticket-date {
        font-size: 10px; 
        font-weight: 600;
        color: #fff;
    display: flex;
    align-items: center;
        gap: 1.5mm; 
    }
    .ticket-date i {
        font-size: 9px;
        color: #fff;
    }

    /* BODY (Section principale blanche) */
.ticket-body {
        padding: var(--section-pad-y) var(--section-pad-x);
        flex: 1; 
    display: flex;
    flex-direction: column;
        gap: var(--gap-md);
}

/* Informations client */
.client-info {
        border-bottom: 1px solid #eee; 
        padding-bottom: var(--gap-lg);
        display: flex;
        flex-direction: column;
        gap: var(--gap-md);
        align-items: flex-start;
        height: 20mm; /* Hauteur fixe pour la section client */
        overflow: hidden;
}

.client-info-left {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: var(--gap-sm);
}

    .client-line {
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
        font-size: 11px;
        color: #222;
        font-weight: 600;
    }
    .client-line i {
        font-size: 10px;
    color: #666;
        width: 10px; /* Aligner les icônes */
    text-align: center;
}
    .client-line strong {
        font-weight: 700;
        margin-right: 0.5mm;
    }

    /* Articles du panier */
.articles-section {
        background: #fdfdfd; /* Fond très léger */
        padding: var(--section-pad-y) var(--section-pad-x);
        border-top: 1px solid #eee;
        height: 50mm; /* hauteur ajustée pour le format 100x100mm */
        overflow: hidden; /* pas de scroll à l'impression */
        flex: 1; /* Prendre l'espace restant */
    }
.articles-title {
        font-size: 12px; 
        font-weight: 800; 
        margin-bottom: var(--gap-md);
    display: flex;
    align-items: center;
    gap: var(--gap-md);
    color: #333;
        padding-bottom: var(--gap-sm);
        border-bottom: 1px dashed #ddd; /* Ligne sous le titre */
}
.articles-title i {
        font-size: 10px;
        color: #888;
}
.articles-list {
        font-size: 8.5px;
        color: #444; 
        line-height: 1.2; 
    word-break: break-word;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* grille 2 colonnes pour jusqu'à 6-8 items */
        gap: var(--gap-sm) var(--gap-md);
        align-items: start;
        grid-auto-rows: minmax(6mm, auto); /* hauteurs cohérentes réduites */
        height: calc(100% - 8mm); /* Prendre l'espace disponible moins le titre */
        overflow: hidden;
}
.article-item {
    margin-bottom: 0.5mm;
        padding-left: var(--gap-sm);
        border-left: 0.4px solid #ccc; /* Ligne de séparation légère */
    display: flex;
        align-items: flex-start; /* Aligner au début en cas de texte long */
        gap: var(--gap-sm);
        break-inside: avoid; /* éviter les coupures entre colonnes */
    }
.article-details {
    display: flex;
        flex-wrap: wrap; /* Permettre le retour à la ligne */
        gap: var(--gap-sm) var(--gap-md);
        font-weight: 500;
    }
.article-ref {
        font-weight: 700; 
        color: #111; 
        font-size: 10px;
    }
    .article-color, .article-size { 
        color: #555; 
        font-size: 9px; 
    }
.article-qty {
        font-weight: 800; 
    color: #059669;
        font-size: 9px;
}

    /* FOOTER (Sans bande noire, section prix) */
.ticket-footer {
        background: #fff; /* Fond blanc */
        color: #000; /* Texte noir */
        padding: var(--section-pad-y) var(--section-pad-x);
    display: flex;
    justify-content: space-between;
    align-items: center;
        gap: var(--gap-sm);
        font-size: 11px;
        font-weight: 600;
        border-top: 1px solid #eee; /* Ligne de séparation légère */
    }
.ticket-price {
    display: flex;
    flex-direction: row; /* prix seulement */
    align-items: center; /* centrer pour un alignement visuel */
    gap: var(--gap-sm);
    white-space: nowrap;
}
    .price-line { display: flex; align-items: center; gap: var(--gap-sm); }
    .footer-company {
    display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--gap-sm);
        font-size: 9px;
        line-height: 1.2;
        max-width: 55mm; /* reste dans la bande */
    }
    .footer-company div {
    display: flex;
    align-items: center;
        gap: 1.2mm;
    }
    .footer-company i { font-size: 8px; color: #9aa0a6; }

/* Styles spécifiques pour l'impression */
@media print {
    @page {
        size: 100mm 100mm;
        margin: 0;
    }
    .ticket-commande {
            width: 100mm !important; 
            height: 100mm !important; /* hauteur fixe */
            margin: 0 auto !important; 
            page-break-after: always; /* S'assurer qu'un nouveau ticket commence sur une nouvelle page */
            overflow: hidden !important; /* rester dans le cadre */
        }
    /* Ajustements pour l'impression */
    .ticket-header { height: 25mm !important; overflow: hidden !important; }
    .client-info { height: 20mm !important; overflow: hidden !important; }
    .articles-section { height: 50mm !important; overflow: hidden !important; }
    .ticket-footer { height: 15mm !important; }
    .ticket-commande:last-child {
            page-break-after: auto; 
        }
        /* Ajustements pour les couleurs d'impression */
        .ticket-header, .ticket-footer {
        background: #fff !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
        body {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
        /* Polices en impression (optimisées pour 100x100mm) */
        .ticket-commande { font-size: 9px !important; }
        .ticket-header { font-size: 10px !important; }
        .header-logo { width: 25mm !important; max-height: 15mm !important; }
        .barcode-image { max-width: 22mm !important; max-height: 22mm !important; width: 22mm !important; height: 22mm !important; }
        .barcode-text { font-size: 8px !important; color: #000 !important; }
        .ticket-date { font-size: 9px !important; color: #000 !important; }
        .ticket-date i { color: #000 !important; }
        .order-number-below-qr { font-size: 8px !important; color: #000 !important; }
        .client-line { font-size: 8px !important; }
        .articles-title { font-size: 10px !important; }
        .articles-list { font-size: 7px !important; }
        .article-ref { font-size: 8px !important; }
        .article-color, .article-size { font-size: 7px !important; }
        .article-qty { font-size: 7px !important; }
        .ticket-footer { font-size: 8px !important; }
        .price-amount { font-size: 10px !important; }
        .footer-company { font-size: 7px !important; }
        .footer-company div { font-size: 7px !important; }
        .footer-company i { font-size: 6px !important; }
}
</style>
