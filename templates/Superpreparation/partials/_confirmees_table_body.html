{% for commande in page_obj %}
<tr class="hover:bg-gray-50 transition-colors border-b border-gray-200 commande-row" 
    data-id-yz="{{ commande.id_yz }}"
    data-num-cmd="{{ commande.num_cmd|default:'' }}"
    data-client="{{ commande.client.nom }} {{ commande.client.prenom }}"
    data-phone="{{ commande.client.numero_tel|default:'' }}"
    data-email="{{ commande.client.email|default:'' }}"
    data-ville-client="{{ commande.ville_init|default:'' }}"
    data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom }}{% endif %}"
    data-adresse="{% if commande.client.adresse %}{{ commande.client.adresse }}{% endif %}"
    data-date-confirmation="{% if commande.etat_confirmation %}{{ commande.etat_confirmation.date_debut|date:'d/m/Y' }}{% endif %}"
    data-total="{{ commande.total_cmd }}"
    data-etat="Confirmée"
    data-operateur="{% if commande.etat_confirmation.operateur %}{{ commande.etat_confirmation.operateur.nom }} {{ commande.etat_confirmation.operateur.prenom }}{% elif commande.etat_actuel.operateur %}{{ commande.etat_actuel.operateur.nom }} {{ commande.etat_actuel.operateur.prenom }}{% endif %}">

    <!-- Checkbox de sélection -->
    <td class="px-4 py-4 whitespace-nowrap text-center">
        <input type="checkbox" class="commande-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" data-commande-id="{{ commande.id }}">
    </td>

    <!-- ID YZ -->
    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r" style="border-color: #F5DEB3;">
        <span class="font-bold" style="color: #2e1b22;">{{ commande.id_yz }}</span>
    </td>

    <!-- N° Externe -->
    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 border-r" style="border-color: #F5DEB3;">
        {{ commande.num_cmd|default:"-" }}
    </td>

    <!-- Client -->
    <td class="px-4 py-4 whitespace-nowrap text-sm border-r" style="border-color: #F5DEB3;">
        {% if commande.client %}
            <div>
                <div class="font-semibold text-gray-900">{{ commande.client.nom }} {{ commande.client.prenom }}</div>
                <div class="text-sm text-gray-500">{{ commande.client.numero_tel }}</div>
            </div>
        {% else %}
            <span class="text-gray-400 italic">Client non défini</span>
        {% endif %}
    </td>

    <!-- Téléphone -->
    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600 border-r" style="border-color: #F5DEB3;">
        {% if commande.client %}
            <span class="font-medium">{{ commande.client.numero_tel|default:"Non renseigné" }}</span>
        {% else %}
            <span class="text-gray-400">-</span>
        {% endif %}
    </td>

    <!-- Ville & Région -->
    <td class="px-4 py-4 whitespace-nowrap text-sm border-r" style="border-color: #F5DEB3;">
        {% if commande.ville %}
            <div>
                <div class="font-medium text-gray-900">{{ commande.ville.nom }}</div>
                {% if commande.ville.region %}
                    <div class="text-xs text-gray-500">{{ commande.ville.region.nom }}</div>
                {% endif %}
            </div>
        {% else %}
            <span class="text-gray-400 italic">{{ commande.ville_init|default:"Non spécifiée" }}</span>
        {% endif %}
    </td>

    <!-- Total -->
    <td class="px-4 py-4 whitespace-nowrap text-sm font-bold border-r" style="border-color: #F5DEB3;">
        <span class="text-green-600">{{ commande.total_cmd|floatformat:2 }} DH</span>
    </td>

    <!-- Date Confirmation -->
    <td class="px-4 py-4 whitespace-nowrap text-sm border-r" style="border-color: #F5DEB3;">
        {% if commande.etat_confirmation %}
            <div class="text-center">
                <div class="font-medium text-gray-900">{{ commande.etat_confirmation.date_debut|date:"d/m/Y" }}</div>
                <div class="text-xs text-gray-500">{{ commande.etat_confirmation.date_debut|date:"H:i" }}</div>
            </div>
        {% else %}
            <span class="text-gray-400 italic">Non confirmée</span>
        {% endif %}
    </td>

    <!-- Opérateur Confirmation -->
    <td class="px-4 py-4 whitespace-nowrap text-sm border-r" style="border-color: #F5DEB3;">
        {% if commande.etat_confirmation and commande.etat_confirmation.operateur %}
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: #2e1b22;">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div>
                    <div class="font-medium text-gray-900">{{ commande.etat_confirmation.operateur.nom }}</div>
                    <div class="text-xs text-gray-500">{{ commande.etat_confirmation.operateur.type_operateur }}</div>
                </div>
            </div>
        {% elif commande.etat_actuel and commande.etat_actuel.operateur %}
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: #2e1b22;">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div>
                    <div class="font-medium text-gray-900">{{ commande.etat_actuel.operateur.nom }}</div>
                    <div class="text-xs text-gray-500">{{ commande.etat_actuel.operateur.type_operateur }}</div>
                </div>
            </div>
        {% else %}
            <span class="text-gray-400 italic">Non affectée</span>
        {% endif %}
    </td>

    <!-- État Préparation -->
    <td class="px-4 py-4 whitespace-nowrap text-sm border-r" style="border-color: #F5DEB3;">
        <div class="flex flex-col space-y-1">
            <!-- État actuel avec icône d'information -->
            <div class="flex items-center">
                {% with commande.etat_actuel as etat_actuel %}
                    {% if etat_actuel.enum_etat.libelle == 'En préparation' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            <i class="fas fa-box-open mr-1"></i>
                            En préparation
                        </span>
                    {% elif etat_actuel.enum_etat.libelle == 'Collectée' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-box mr-1"></i>
                            Collectée
                        </span>
                    {% elif etat_actuel.enum_etat.libelle == 'Emballée' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                            <i class="fas fa-boxes mr-1"></i>
                            Emballée
                        </span>
                    {% elif etat_actuel.enum_etat.libelle == 'Préparée' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            Préparée
                        </span>
                    {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            {{ etat_actuel.enum_etat.libelle }}
                        </span>
                    {% endif %}
                    
                    <!-- Bouton pour afficher/masquer les détails d'état -->
                    <button onclick="toggleEtatDetails('{{ commande.id }}')" 
                            class="ml-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-110"
                            title="Afficher/masquer les détails d'état">
                        <i class="fas fa-info text-gray-600 text-xs"></i>
                    </button>
                {% endwith %}
            </div>
            
            <!-- Détails d'état (masqués par défaut) -->
            <div id="etat-details-{{ commande.id }}" class="hidden mt-2 space-y-1">
                <!-- Affichage de l'état précédent (si applicable) -->
                {% if commande.etat_precedent %}
                    {% if commande.etat_precedent.enum_etat.libelle == 'En cours de livraison' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            <i class="fas fa-truck mr-1"></i>
                            Renvoyée depuis livraison
                        </span>
                        <div class="text-xs text-red-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ commande.etat_precedent.date_fin|date:"d/m/Y H:i" }}
                        </div>
                    {% elif commande.etat_precedent.enum_etat.libelle == 'Préparée' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            <i class="fas fa-undo mr-1"></i>
                            Renvoyée depuis préparation
                        </span>
                        <div class="text-xs text-yellow-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ commande.etat_precedent.date_fin|date:"d/m/Y H:i" }}
                        </div>
                    {% elif commande.etat_precedent.enum_etat.libelle == 'Confirmée' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            Depuis confirmation
                        </span>
                        <div class="text-xs text-green-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ commande.etat_precedent.date_fin|date:"d/m/Y H:i" }}
                        </div>
                    {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            <i class="fas fa-history mr-1"></i>
                            {{ commande.etat_precedent.enum_etat.libelle }}
                        </span>
                        <div class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ commande.etat_precedent.date_fin|date:"d/m/Y H:i" }}
                        </div>
                    {% endif %}
                {% endif %}
                
                <!-- Affichage de l'état de confirmation -->
                {% if commande.etat_confirmation and commande.etat_confirmation.enum_etat.libelle == 'Confirmée' %}
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                        <i class="fas fa-user-tie mr-1"></i>
                        Confirmée par admin
                    </span>
                    <div class="text-xs text-purple-600 mt-1">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ commande.etat_confirmation.date_debut|date:"d/m/Y H:i" }}
                    </div>
                {% endif %}
                
                <!-- Affichage des étapes de préparation -->
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="text-xs font-medium text-gray-700 mb-1">Étapes de préparation :</div>
                    
                    <!-- Étape 1: En préparation -->
                    <div class="flex items-center mb-1">
                        <span class="w-3 h-3 rounded-full bg-blue-500 flex items-center justify-center mr-2">
                            <i class="fas fa-check text-white text-xs"></i>
                        </span>
                        <span class="text-xs text-blue-600">En préparation</span>
                        <span class="text-xs text-gray-500 ml-2">
                            {% if commande.etat_actuel.enum_etat.libelle == 'En préparation' %}
                                <i class="fas fa-clock mr-1"></i>En cours
                            {% else %}
                                <i class="fas fa-check mr-1"></i>Terminé
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Étape 2: Collectée -->
                    <div class="flex items-center mb-1">
                        {% if commande.etat_actuel.enum_etat.libelle == 'Collectée' or commande.etat_actuel.enum_etat.libelle == 'Emballée' or commande.etat_actuel.enum_etat.libelle == 'Préparée' %}
                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                <i class="fas fa-check text-white text-xs"></i>
                            </span>
                            <span class="text-xs text-green-600">Collectée</span>
                            <span class="text-xs text-green-500 ml-2">
                                <i class="fas fa-check mr-1"></i>Terminé
                            </span>
                        {% else %}
                            <span class="w-3 h-3 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                <i class="fas fa-circle text-gray-400 text-xs"></i>
                            </span>
                            <span class="text-xs text-gray-400">Collectée</span>
                            <span class="text-xs text-gray-500 ml-2">
                                <i class="fas fa-clock mr-1"></i>En attente
                            </span>
                        {% endif %}
                    </div>
                    
                    <!-- Étape 3: Emballée -->
                    <div class="flex items-center mb-1">
                        {% if commande.etat_actuel.enum_etat.libelle == 'Emballée' or commande.etat_actuel.enum_etat.libelle == 'Préparée' %}
                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                <i class="fas fa-check text-white text-xs"></i>
                            </span>
                            <span class="text-xs text-green-600">Emballée</span>
                            <span class="text-xs text-green-500 ml-2">
                                <i class="fas fa-check mr-1"></i>Terminé
                            </span>
                        {% else %}
                            <span class="w-3 h-3 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                <i class="fas fa-circle text-gray-400 text-xs"></i>
                            </span>
                            <span class="text-xs text-gray-400">Emballée</span>
                            <span class="text-xs text-gray-500 ml-2">
                                <i class="fas fa-clock mr-1"></i>En attente
                            </span>
                        {% endif %}
                    </div>
                    
                    <!-- Étape 4: Préparée (finalisée par superviseur) -->
                    <div class="flex items-center">
                        {% if commande.etat_actuel.enum_etat.libelle == 'Préparée' %}
                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                <i class="fas fa-check text-white text-xs"></i>
                            </span>
                            <span class="text-xs text-green-600">Préparée</span>
                            <span class="text-xs text-green-500 ml-2">
                                <i class="fas fa-check mr-1"></i>Terminé
                            </span>
                        {% else %}
                            <span class="w-3 h-3 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                <i class="fas fa-circle text-gray-400 text-xs"></i>
                            </span>
                            <span class="text-xs text-gray-400">Préparée</span>
                            <span class="text-xs text-gray-500 ml-2">
                                <i class="fas fa-clock mr-1"></i>En attente
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Affichage de l'affectation aux opérateurs de supervision -->
                {% if commande.operations.all %}
                    <div class="mt-2 pt-2 border-t border-gray-200">
                        <div class="text-xs font-medium text-gray-700 mb-1">Affectations :</div>
                        {% for operation in commande.operations.all %}
                            {% if operation.type_operation == 'AFFECTATION_SUPERVISION' or operation.type_operation == 'REAFFECTATION_SUPERVISION' %}
                                <div class="flex items-center mb-1">
                                    <span class="w-3 h-3 rounded-full bg-indigo-500 flex items-center justify-center mr-2">
                                        <i class="fas fa-user-shield text-white text-xs"></i>
                                    </span>
                                    <span class="text-xs text-indigo-600">
                                        {% if operation.type_operation == 'AFFECTATION_SUPERVISION' %}
                                            Affectée par le supervision
                                        {% else %}
                                            Réaffectée par le supervision
                                        {% endif %}
                                    </span>
                                    <span class="text-xs text-gray-500 ml-2">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ operation.date_operation|date:"d/m/Y H:i" }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Affichage des changements d'état de préparation -->
                {% if commande.operations.all %}
                    <div class="mt-2 pt-2 border-t border-gray-200">
                        <div class="text-xs font-medium text-gray-700 mb-1">Changements d'état :</div>
                        {% for operation in commande.operations.all %}
                            {% if operation.type_operation == 'CHANGEMENT_ETAT_COLLECTEE' or operation.type_operation == 'CHANGEMENT_ETAT_EMBALLEE' %}
                                <div class="flex items-center mb-1">
                                    <span class="w-3 h-3 rounded-full bg-orange-500 flex items-center justify-center mr-2">
                                        <i class="fas fa-{% if operation.type_operation == 'CHANGEMENT_ETAT_COLLECTEE' %}box{% else %}boxes{% endif %} text-white text-xs"></i>
                                    </span>
                                    <span class="text-xs text-orange-600">
                                        {% if operation.type_operation == 'CHANGEMENT_ETAT_COLLECTEE' %}
                                            Marquée comme collectée
                                        {% else %}
                                            Marquée comme emballée
                                        {% endif %}
                                    </span>
                                    <span class="text-xs text-gray-500 ml-2">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ operation.date_operation|date:"d/m/Y H:i" }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </td>

    <!-- Actions -->
    <td class="px-4 py-4 whitespace-nowrap text-center">
        <div class="flex justify-center space-x-2">
            <!-- Bouton Détails -->
            <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}" 
               class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
               title="Détails">
                <i class="fas fa-eye text-sm"></i>
            </a>
            
            <!-- Bouton Impression -->
            <button onclick="showImpressionModal({{ commande.id }}, '{{ commande.id_yz }}', '{{ commande.client.nom }} {{ commande.client.prenom }}')" 
                    class="p-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Imprimer">
                <i class="fas fa-print text-sm"></i>
            </button>
            
            <!-- Bouton Impression Multiple Tickets - COMMENTÉ car remplacé par le bouton fusionné -->
            <!--
            <button onclick="imprimerTicketsMultipleDirect()" 
                    class="p-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Impression Multiple Tickets">
                <i class="fas fa-receipt text-sm"></i>
            </button>
            -->
            
            <!-- Bouton Impression Codes QR Articles - COMMENTÉ car remplacé par le bouton fusionné -->
            <!--
            <button onclick="imprimerCodesQRArticlesDirect()" 
                    class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Impression Codes QR Articles">
                <i class="fas fa-qrcode text-sm"></i>
            </button>
            -->
            
            <!-- Bouton Affecter (si pas encore affectée) -->
            {% if not commande.etat_actuel or not commande.etat_actuel.operateur %}
            <button onclick="showAffectationModal({{ commande.id }}, '{{ commande.id_yz }}')" 
                    class="p-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Affecter">
                <i class="fas fa-users text-sm"></i>
            </button>
            {% else %}
            <!-- Bouton Modifier affectation -->
            <button onclick="showAffectationModal({{ commande.id }}, '{{ commande.id_yz }}')" 
                    class="p-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Modifier">
                <i class="fas fa-edit text-sm"></i>
            </button>
            {% endif %}
            
            <!-- Bouton Finaliser Préparation (si emballée) -->
            {% if commande.etat_actuel.enum_etat.libelle == 'Emballée' %}
            <button onclick="finaliserPreparation({{ commande.id }}, '{{ commande.id_yz }}')" 
                    class="p-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md"
                    title="Finaliser Préparation">
                <i class="fas fa-check-double text-sm"></i>
            </button>
            {% endif %}
        </div>
    </td>
</tr>
{% endfor %}
