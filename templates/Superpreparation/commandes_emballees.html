{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block page_subtitle %}{{ page_subtitle }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300 compact-page" id="mainContent">
    <style>
    /* Mode compact local pour cette page */
    .compact-page #cmdTable { font-size: 12px; }
    .compact-page #cmdTable th, .compact-page #cmdTable td { padding: 6px 8px !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: middle; }

    /* Cartes statistiques unifiées */
    .stats-card {
        background: white;
        border: 2px solid var(--preparation-text-light);
        border-radius: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        padding: 24px;
    }
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--preparation-primary), var(--preparation-light));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    .stats-card:hover {
        border-color: var(--preparation-border-accent);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
    }
    .stats-card:hover::before { transform: scaleX(1); }
    .stats-icon {
        background: linear-gradient(135deg, var(--preparation-primary) 0%, var(--preparation-light) 100%);
        color: white;
        border-radius: 50%;
        width: 60px; height: 60px;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.3s ease;
    }
    .stats-card:hover .stats-icon {
        background: linear-gradient(135deg, var(--preparation-light) 0%, var(--preparation-primary) 100%);
        transform: scale(1.1);
    }

    /* Informations générales — aligné avec Retournées/Livrées Partiellement */
    .info-section { background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:12px 16px; }
    .section-title { font-weight:600; color:#111827; padding-bottom:8px; border-bottom:1px solid #f3f4f6; }
    .info-item { display:flex; align-items:center; gap:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:12px; transition:all .3s ease; opacity:0; animation: fadeInUp .5s ease-out forwards; }
    .info-item:nth-child(1){animation-delay:.05s} .info-item:nth-child(2){animation-delay:.15s} .info-item:nth-child(3){animation-delay:.25s}
    .info-item:hover { background:#f3f4f6; box-shadow: inset 0 0 0 1px #e5e7eb; }
    .info-icon { width:40px; height:40px; border-radius:9999px; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,.12); font-size:1rem; }
    .info-icon.green { background:linear-gradient(135deg,#10b981,#059669); }
    .info-icon.blue { background:linear-gradient(135deg,#3b82f6,#2563eb); }
    .info-icon.purple { background:linear-gradient(135deg,#8b5cf6,#7c3aed); }
    .info-icon.orange { background:linear-gradient(135deg,#f59e0b,#d97706); }
    .info-section:hover { border-color: var(--preparation-border-accent); box-shadow: 0 4px 10px rgba(0,0,0,.08); }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    </style>
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg"
         style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-dark));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-boxes mr-3" style="color: var(--preparation-border-accent);"></i>
                {{ page_title }}
            </h1>
            <p style="color: white;">{{ page_subtitle }}</p>
        </div>
    </div>

    <!-- Statistiques (composants réutilisables) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        {% include 'Superpreparation/includes/stats-card.html' with icon='fa-boxes' label='Emballées' value=stats.total_commandes|default:0 delay=0.1 %}
        {% include 'Superpreparation/includes/stats-card.html' with icon='fa-coins' label='Valeur Totale' value=stats.valeur_totale|floatformat:0|add:' DH' delay=0.2 %}
        {% include 'Superpreparation/includes/stats-card.html' with icon='fa-exclamation-triangle' label='Urgentes' value=stats.commandes_urgentes|default:0 delay=0.3 %}
    </div>

    <!-- Informations générales (même design) -->
    <div class="info-section mb-4">
        <h2 class="section-title flex items-center justify-between cursor-pointer select-none" id="infoSectionToggle" aria-expanded="true">
            <span class="flex items-center">
                <i class="fas fa-info-circle text-blue-600"></i>
                <span class="ml-2">Informations générales</span>
            </span>
            <i class="fas fa-chevron-up text-gray-500 transition-transform duration-200" id="infoSectionChevron"></i>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="infoSectionBody">
            <div class="info-item">
                <div class="info-icon purple"><i class="fas fa-boxes"></i></div>
                <div>
                    <h3 class="font-semibold text-gray-900 text-sm">Commandes emballées</h3>
                    <p class="text-xs text-gray-600">Prêtes pour la finalisation et l'étape suivante</p>
                </div>
            </div>
            <div class="info-item">
                <div class="info-icon blue"><i class="fas fa-search"></i></div>
                <div>
                    <h3 class="font-semibold text-gray-900 text-sm">Contrôle qualité</h3>
                    <p class="text-xs text-gray-600">Vérifiez les articles, quantités et étiquettes</p>
                </div>
            </div>
            <div class="info-item">
                <div class="info-icon green"><i class="fas fa-check-circle"></i></div>
                <div>
                    <h3 class="font-semibold text-gray-900 text-sm">Finalisation multiple</h3>
                    <p class="text-xs text-gray-600">Validez une sélection ou toutes les lignes visibles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre d'outils avec recherche intelligente -->
    <div class="mb-6 flex flex-wrap gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
        <!-- Sélecteur éléments par page -->
        <form method="GET" class="flex items-center">
            {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            
         
        </form>

        <!-- Barre de recherche intelligente -->
        <div class="relative ml-auto overflow-x-auto">
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <input type="text" id="smartSearch" 
                           placeholder="Rechercher par N° Commande, client, téléphone..." 
                           class="block px-4 py-2 pr-10 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-sm w-64 h-10"
                           autocomplete="off">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <button onclick="clearSmartSearch()" 
                        class="inline-flex items-center px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium rounded transition-colors h-10">
                    <i class="fas fa-times"></i>
                </button>
                <button id="columnToggle" onclick="toggleColumnVisibility()" 
                        class="inline-flex items-center px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm font-medium rounded transition-colors h-10" title="Sélectionner les colonnes">
                    <i class="fas fa-columns mr-2 text-gray-500"></i>
                    Sélectionner les colonnes
                </button>
            </div>
        </div>
        <!-- Actions groupées -->
        <div class="flex items-center ml-2">
            <button id="bulkFinalizeBtn"
                    onclick="bulkFinaliserSelection()"
                    class="inline-flex items-center px-3 py-2 rounded-md shadow-sm text-white transition-all hover:shadow-lg h-10"
                    style="background-color: #10b981; hover:background-color: #059669;"
                    title="Finaliser la préparation pour la sélection (si aucune sélection, toutes les lignes visibles)">
                <i class="fas fa-check mr-2"></i>
                Finaliser la sélection <span id="bulkCount" class="ml-1 opacity-80">(0)</span>
            </button>
        </div>
    </div>
        
    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200" id="tableScrollContainer">
        <table id="cmdTable" class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm" style="table-layout:auto;">
            <thead class="sticky top-0 z-10" style="background-color: var(--preparation-primary);">
                <tr>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">
                        <input type="checkbox" id="selectAll" class="form-checkbox h-4 w-4 text-purple-600" title="Tout sélectionner">
                    </th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N° Commande</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N° Ext.</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Téléphone</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville Client</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville & Région</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date Emballage</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>

                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État Préparation</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Panier</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if commandes %}
                    {% for commande in commandes %}
                    <tr class="hover:bg-gray-50 commande-row" 
                        data-id-yz="{{ commande.id_yz }}"
                        data-num-cmd="{{ commande.num_cmd|default:'' }}"
                        data-client="{{ commande.client.prenom }} {{ commande.client.nom }}"
                        data-phone="{{ commande.client.numero_tel|default:'' }}"
                        data-email="{{ commande.client.email|default:'' }}"
                        data-ville-client="{{ commande.ville_init|default:'' }}"
                        data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom_region }}{% endif %}"
                        data-date-emballage="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel %}{{ etat_actuel.date_debut|date:'d/m/Y' }}{% endif %}{% endwith %}"
                        data-total="{{ commande.total_cmd }}"
                        data-etat="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel %}{{ etat_actuel.enum_etat.libelle }}{% endif %}{% endwith %}"
                        data-operateur="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel and etat_actuel.operateur %}{{ etat_actuel.operateur.prenom }} {{ etat_actuel.operateur.nom }}{% endif %}{% endwith %}">
                        <td class="px-4 py-4 whitespace-nowrap text-center">
                            <input type="checkbox" class="row-select form-checkbox h-4 w-4 text-purple-600" data-id="{{ commande.id }}">
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ commande.id_yz }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ commande.num_cmd|default:"-" }}</td>
                        <!-- Colonne Client -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                            {% if commande.client.email %}
                            <div class="text-xs text-gray-500">{{ commande.client.email }}</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Téléphone -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% if commande.client.numero_tel %}
                            <div class="text-sm text-gray-900 font-medium">
                                <i class="fas fa-phone mr-1"></i>
                                {{ commande.client.numero_tel }}
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500">Non renseigné</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Ville Client -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            {% if commande.ville_init and commande.ville_init != '' %}
                                <div style="color: var(--preparation-primary);" class="font-medium">{{ commande.ville_init }}</div>
                            {% else %}
                                <div style="color: var(--preparation-primary);">Non spécifiée</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Ville & Région (ville de livraison) -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% if commande.ville %}
                                <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                                <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                            {% else %}
                                <div class="text-sm text-gray-500">Non définie</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% with etat_actuel=commande.etat_actuel %}
                                {% if etat_actuel %}
                                    <div class="text-sm text-gray-900">{{ etat_actuel.date_debut|date:"d/m/Y" }}</div>
                                    <div class="text-xs text-gray-500">{{ etat_actuel.date_debut|date:"H:i" }}</div>
                                {% else %}
                                    <div class="text-sm text-gray-500">Non définie</div>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-green-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        </td>

                        <td class="px-4 py-4 whitespace-nowrap">
                            {% with etat_actuel=commande.etat_actuel %}
                                <div class="flex items-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        <i class="fas fa-boxes mr-1"></i>
                                        Emballée
                                    </span>
                                </div>
                            {% endwith %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="flex flex-col space-y-1">
                                <!-- État actuel avec icône d'information -->
                                <div class="flex items-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        <i class="fas fa-boxes mr-1"></i>
                                        Emballée
                                    </span>
                                    
                                    <!-- Bouton pour afficher/masquer les détails d'état -->
                                    <button onclick="toggleEtatDetails('{{ commande.id }}')" 
                                            class="ml-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-110"
                                            title="Afficher/masquer les détails d'état">
                                        <i class="fas fa-info text-gray-600 text-xs"></i>
                                    </button>
                                </div>
                                
                                <!-- Détails d'état (masqués par défaut) -->
                                <div id="etat-details-{{ commande.id }}" class="hidden mt-2 space-y-1">
                                    <!-- Affichage des étapes de préparation -->
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs font-medium text-gray-700 mb-1">Étapes de préparation :</div>
                                        
                                        <!-- Étape 1: En préparation -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-green-600">En préparation</span>
                                            <span class="text-xs text-green-500 ml-2">
                                                <i class="fas fa-check mr-1"></i>Terminé
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 2: Collectée -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-green-600">Collectée</span>
                                            <span class="text-xs text-green-500 ml-2">
                                                <i class="fas fa-check mr-1"></i>Terminé
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 3: Emballée -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-purple-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-purple-600">Emballée</span>
                                            <span class="text-xs text-purple-500 ml-2">
                                                <i class="fas fa-clock mr-1"></i>En cours
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 4: Préparée (finalisée par superviseur) -->
                                        <div class="flex items-center">
                                            <span class="w-3 h-3 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                                <i class="fas fa-circle text-gray-400 text-xs"></i>
                                            </span>
                                            <span class="text-xs text-gray-400">Préparée</span>
                                            <span class="text-xs text-gray-500 ml-2">
                                                <i class="fas fa-clock mr-1"></i>En attente
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center" style="min-width: 96px;">
                            <div class="flex items-center justify-center space-x-2">
                                <!-- Panier (icône + compteur) -->
                                <button type="button"
                                   onclick="openPanierModal({{ commande.id }})"
                                   class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: var(--preparation-primary); hover:background-color: var(--preparation-dark);"
                                   title="Voir le panier">
                                    <i class="fas fa-shopping-cart text-sm mr-1"></i>
                                    <span class="text-xs">{{ commande.paniers.count }}</span>
                                </button>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center" style="min-width: 120px;">
                            <div class="flex items-center justify-center space-x-2">
                                <!-- Détails (icône seule) -->
                                <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}"
                                   class="inline-flex items-center justify-center w-9 h-9 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: var(--preparation-primary); hover:background-color: var(--preparation-dark);"
                                   title="Voir la commande" aria-label="Détails">
                                    <i class="fas fa-eye text-sm"></i>
                                    <span class="sr-only">Détails</span>
                                </a>
                                <!-- Finaliser (icône seule) - pour les commandes emballées -->
                                <button onclick="finaliserCommande({{ commande.id }})"
                                   class="inline-flex items-center justify-center w-9 h-9 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: #10b981; hover:background-color: #059669;"
                                   title="Finaliser la préparation" aria-label="Finaliser">
                                    <i class="fas fa-check text-sm"></i>
                                    <span class="sr-only">Finaliser</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="13" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <i class="fas fa-boxes text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Aucune commande emballée</h3>
                                <p class="text-gray-500">Aucune commande n'attend actuellement la finalisation.</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (client) -->
    <div data-superprep-pagination data-items-selector="tbody tr" data-container-selector="table" data-per-page="25"></div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/Suivi_des_Commandes/liste-prepra-smart-search.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function formatMoney(v) { try { return parseFloat(v).toFixed(2) + ' DH'; } catch(e) { return '0.00 DH'; } }

function openPanierModal(commandeId) {
    fetch(`/Superpreparation/api/commande/${commandeId}/panier/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
      .then(r => r.json())
      .then(data => {
        if (!data || data.error || data.success === false) {
            return showToast(data?.error || data?.message || 'Impossible de charger le panier', 'error');
        }
        const cmd = data.commande || {};
        const articles = data.articles || [];

        // Entête
        document.getElementById('panierCmdId').textContent = 'Commande ' + (cmd.id_yz || '');
        document.getElementById('panierClient').textContent = cmd.client_nom || '';
        document.getElementById('panierCount').textContent = (cmd.total_articles || 0) + ' article' + ((cmd.total_articles||0)>1?'s':'');
        document.getElementById('panierTotalEntete').textContent = formatMoney(cmd.total_final || 0);

        // Liste
        const list = document.getElementById('panierItems');
        list.innerHTML = '';
        if (articles.length === 0) {
            document.getElementById('panierEmpty').classList.remove('hidden');
        } else {
            document.getElementById('panierEmpty').classList.add('hidden');
            articles.forEach(a => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-2 border-b last:border-b-0';
                row.innerHTML = `
                    <div>
                        <div class="text-sm font-medium text-gray-800">${a.nom || ''}</div>
                        <div class="text-xs text-gray-500">Ref: ${a.reference || 'N/A'} · PU: ${formatMoney(a.prix_unitaire || 0)}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-700">${a.quantite || 0} × ${parseFloat(a.prix_unitaire||0).toFixed(2)}</div>
                        <div class="text-sm font-semibold text-gray-900">${formatMoney(a.sous_total || 0)}</div>
                    </div>`;
                list.appendChild(row);
            });
        }

        // Totaux
        document.getElementById('panierSousTotal').textContent = formatMoney(cmd.total_montant || cmd.total_articles_montant || 0);
        document.getElementById('panierTotalFinal').textContent = formatMoney(cmd.total_final || 0);

        document.getElementById('panierModal').classList.remove('hidden');
      })
      .catch(() => showToast('Erreur réseau', 'error'));
}

// Sélection globale
document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('selectAll');
    const bulkCountEl = document.getElementById('bulkCount');
    const updateBulkCount = () => {
        const selected = document.querySelectorAll('.row-select:checked').length;
        if (selected > 0) {
            bulkCountEl.textContent = `(${selected})`;
        } else {
            // aucune sélection → indiquer le nombre de lignes visibles
            const visibles = document.querySelectorAll('tbody tr').length;
            bulkCountEl.textContent = `(${visibles})`;
        }
    };

    updateBulkCount();
    if (selectAll) {
        selectAll.addEventListener('change', (e) => {
            document.querySelectorAll('.row-select').forEach(cb => { cb.checked = e.target.checked; });
            updateBulkCount();
        });
    }
    document.addEventListener('change', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('row-select')) {
            // décoche le selectAll si nécessaire
            if (!e.target.checked && selectAll) selectAll.checked = false;
            updateBulkCount();
        }
    });
});

// Finalisation groupée
async function bulkFinaliserSelection() {
    let ids = Array.from(document.querySelectorAll('.row-select:checked'))
        .map(cb => cb.getAttribute('data-id'));
    // Si aucune sélection, prendre toutes les commandes visibles du tableau
    if (ids.length === 0) {
        ids = Array.from(document.querySelectorAll('tbody tr'))
            .map(tr => tr.querySelector('.row-select')?.getAttribute('data-id'))
            .filter(Boolean);
        if (ids.length === 0) {
            return showToast('Aucune commande à finaliser', 'info');
        }
    }

    const confirm = await Swal.fire({
        title: 'Finaliser la sélection',
        text: `Voulez-vous finaliser ${ids.length} commande(s) ?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, finaliser',
        cancelButtonText: 'Annuler'
    });
    if (!confirm.isConfirmed) return;

    Swal.fire({
        title: 'Finalisation en cours...',
        html: '<div id="bulkProgress">0 / ' + ids.length + '</div>',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    let done = 0, errors = 0;
    for (const id of ids) {
        try {
            const res = await fetch(`/Superpreparation/api/commande/${id}/finaliser/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            });
            const data = await res.json();
            if (!data.success) errors++;
        } catch (_) { errors++; }
        done++;
        const el = document.getElementById('bulkProgress');
        if (el) el.textContent = `${done} / ${ids.length}`;
    }

    Swal.fire({
        title: errors === 0 ? 'Succès' : 'Terminé avec erreurs',
        text: errors === 0 ? 'Toutes les commandes ont été finalisées.' : `${errors} commande(s) n'ont pas pu être finalisées.`,
        icon: errors === 0 ? 'success' : 'warning',
        confirmButtonColor: '#10b981'
    }).then(() => window.location.reload());
}

// Fonction pour finaliser une commande depuis la liste
function finaliserCommande(commandeId) {
    Swal.fire({
        title: 'Finaliser la préparation',
        text: "Voulez-vous vraiment finaliser cette commande emballée ?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, finaliser !',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            // Afficher un indicateur de chargement
            Swal.fire({
                title: 'Finalisation en cours...',
                text: 'Veuillez patienter',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Envoyer la requête AJAX
            fetch(`/Superpreparation/api/commande/${commandeId}/finaliser/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Succès !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#10b981'
                    }).then(() => {
                        // Recharger la page pour mettre à jour la liste
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message || 'Une erreur est survenue',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            });
        }
    });
}

// Fonction pour afficher/masquer les détails d'état
function toggleEtatDetails(commandeId) {
    const detailsElement = document.getElementById(`etat-details-${commandeId}`);
    if (detailsElement) {
        detailsElement.classList.toggle('hidden');
    }
}

function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<div class="flex items-center"><i class="fas fa-info-circle mr-2"></i><span>${message}</span></div>`;
    toastContainer.appendChild(toast);
    setTimeout(()=> toast.classList.add('show'), 50);
    setTimeout(()=> { toast.classList.remove('show'); setTimeout(()=> toast.remove(), 300); }, duration);
}
</script>

<!-- Info section repliable avec persistance -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('infoSectionToggle');
    const body = document.getElementById('infoSectionBody');
    const chevron = document.getElementById('infoSectionChevron');
    const STORAGE_KEY = 'yz.infoSection.emballees.open';
    if (!toggle || !body || !chevron) return;

    function setOpen(open) {
        if (open) {
            body.classList.remove('hidden');
            toggle.setAttribute('aria-expanded', 'true');
            chevron.style.transform = 'rotate(0deg)';
            localStorage.setItem(STORAGE_KEY, '1');
        } else {
            body.classList.add('hidden');
            toggle.setAttribute('aria-expanded', 'false');
            chevron.style.transform = 'rotate(180deg)';
            localStorage.setItem(STORAGE_KEY, '0');
        }
    }

    const saved = localStorage.getItem(STORAGE_KEY);
    setOpen(saved !== '0');

    toggle.addEventListener('click', () => {
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        setOpen(!isOpen);
    });
});
</script>

<!-- Modal panier -->
<div id="panierModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closePanierModal()"></div>
  <div class="relative z-10 max-w-3xl mx-auto mt-20 bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <h3 class="text-2xl font-bold">Détails du panier</h3>
      <button class="text-gray-500 hover:text-gray-700" onclick="closePanierModal()"><i class="fas fa-times text-xl"></i></button>
    </div>
    <div class="m-6 p-4 rounded-lg border bg-purple-50">
      <div class="flex items-center justify-between">
        <div>
          <div id="panierCmdId" class="font-semibold text-purple-800">Commande</div>
          <div class="text-sm text-purple-700">Client: <span id="panierClient"></span></div>
        </div>
        <div class="text-right">
          <div id="panierCount" class="text-purple-700 font-semibold"></div>
          <div class="text-sm text-purple-700">Total: <span id="panierTotalEntete"></span></div>
        </div>
      </div>
    </div>
    <div class="px-6 pb-4">
      <div id="panierEmpty" class="text-center py-12 text-gray-500 hidden">
        <i class="fas fa-shopping-basket text-4xl mb-3"></i>
        <div class="text-lg font-semibold">Panier vide</div>
        <div class="text-sm">Cette commande ne contient aucun article.</div>
      </div>
      <div id="panierItems" class="space-y-2"></div>
    </div>
    <div class="px-6 py-4 bg-gray-50 border-t">
      <div class="flex items-center justify-between text-sm mb-2">
        <div class="text-gray-600">Sous-total articles:</div>
        <div id="panierSousTotal" class="text-gray-900">0.00 DH</div>
      </div>
      <div class="flex items-center justify-between font-bold text-lg">
        <div>Total commande:</div>
        <div id="panierTotalFinal" class="text-green-600">0.00 DH</div>
      </div>
    </div>
  </div>
</div>

<script>
function closePanierModal() { document.getElementById('panierModal').classList.add('hidden'); }
</script>
{% endblock %}
