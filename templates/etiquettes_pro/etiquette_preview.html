{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}Aper√ßu √âtiquette - YZ-CMD{% endblock %}

{% block page_title %}Aper√ßu de l'√âtiquette{% endblock %}
{% block page_subtitle %}{{ etiquette.reference }} - {{ etiquette.template.nom }}{% endblock %}

{% block extra_js %}
<script>
console.log('üîç [CLIENT] === DIAGNOSTIC √âTIQUETTE ===');
console.log('üîç [CLIENT] Template code_type:', '{{ etiquette.template.code_type }}');
console.log('üîç [CLIENT] Code_data:', '{{ etiquette.code_data }}');
console.log('üîç [CLIENT] Reference:', '{{ etiquette.reference }}');
console.log('üîç [CLIENT] Commande ID:', '{{ etiquette.commande_id }}');
console.log('üîç [CLIENT] URL barcode:', '{% url "etiquettes_pro:generate_barcode_image" "TEST" %}'.replace('TEST', '{{ etiquette.code_data }}'));
console.log('üîç [CLIENT] URL qrcode:', '{% url "etiquettes_pro:generate_qrcode_image" "TEST" %}'.replace('TEST', '{{ etiquette.code_data }}'));

// Test de connectivit√© r√©seau
fetch('{% url "etiquettes_pro:generate_barcode_image" etiquette.code_data %}')
    .then(response => {
        console.log('üîç [CLIENT] Test barcode - Status:', response.status, 'Type:', response.headers.get('content-type'));
        if (!response.ok) {
            console.error('‚ùå [CLIENT] Erreur HTTP barcode:', response.status, response.statusText);
        }
    })
    .catch(error => {
        console.error('‚ùå [CLIENT] Erreur r√©seau barcode:', error);
    });

fetch('{% url "etiquettes_pro:generate_qrcode_image" etiquette.code_data %}')
    .then(response => {
        console.log('üîç [CLIENT] Test qrcode - Status:', response.status, 'Type:', response.headers.get('content-type'));
        if (!response.ok) {
            console.error('‚ùå [CLIENT] Erreur HTTP qrcode:', response.status, response.statusText);
        }
    })
    .catch(error => {
        console.error('‚ùå [CLIENT] Erreur r√©seau qrcode:', error);
    });
</script>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- CSS externe pour les styles Superpreparation -->
<link rel="stylesheet" href="{% static 'css/Superpreparation/page_cmd_confim.css' %}">
<style>
    .etiquette-preview {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .etiquette-header {
        background: linear-gradient(135deg, {{ etiquette.template.couleur_principale }}, {{ etiquette.template.couleur_secondaire }});
        color: white;
        padding: 20px;
        border-radius: 6px 6px 0 0;
    }
    
    .etiquette-content {
        padding: 30px;
    }
    
    /* Styles dynamiques bas√©s sur le template - OPTIMIS√â 4K ULTRA */
    .dynamic-title {
        font-family: {{ etiquette.template.police_titre }};
        font-size: {{ etiquette.template.taille_titre|add:4 }}px; /* +4px pour 4K Ultra */
        color: {{ etiquette.template.couleur_texte }};
        font-weight: bold;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .dynamic-text {
        font-family: {{ etiquette.template.police_texte }};
        font-size: {{ etiquette.template.taille_texte|add:2 }}px; /* +2px pour 4K Ultra */
        color: {{ etiquette.template.couleur_texte }};
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* Optimisations 4K Ultra pour l'aper√ßu */
    .etiquette-preview {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
    }
    
    .code-image {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        transition: none !important;
        animation: none !important;
        transform: none !important;
        opacity: 1 !important;
        visibility: visible !important;
        display: block !important;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        will-change: auto;
        /* Emp√™cher l'effet de chargement */
        -webkit-transition: none !important;
        -moz-transition: none !important;
        -o-transition: none !important;
        -ms-transition: none !important;
    }
    
    /* Emp√™cher l'animation de chargement des images */
    img[class*="code-image"] {
        opacity: 1 !important;
        transition: none !important;
        animation: none !important;
    }
    
    /* Emp√™cher les animations de chargement globales */
    img {
        transition: none !important;
        animation: none !important;
    }
    
    /* Emp√™cher l'effet de fade-in des images lors du chargement */
    img[src] {
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Emp√™cher l'effet de loading des images */
    img:not([src]) {
        display: none !important;
    }
    
    /* Emp√™cher les animations de chargement des images */
    img[loading] {
        transition: none !important;
        animation: none !important;
    }
    
    /* Styles de bordures dynamiques */
    .etiquette-container {
        {% if etiquette.template.border_enabled %}
        border: {{ etiquette.template.border_width }}px solid {{ etiquette.template.border_color }};
        border-radius: {{ etiquette.template.border_radius }}px;
        {% else %}
        border: none;
        {% endif %}
    }
    
    .section-with-border {
        {% if etiquette.template.border_enabled %}
        border: {{ etiquette.template.border_width }}px solid {{ etiquette.template.border_color }};
        border-radius: {{ etiquette.template.border_radius }}px;
        {% endif %}
    }
    
    .etiquette-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-group {
        background: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #3b82f6;
    }
    
    .info-label {
        font-weight: 600;
        color: #374151;
        font-size: 14px;
        margin-bottom: 5px;
    }
    
    .info-value {
        color: #1f2937;
        font-size: 16px;
    }
    
    .code-section {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f3f4f6;
        border-radius: 8px;
    }
    
    .code-placeholder {
        display: inline-block;
        padding: 20px;
        background: white;
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        color: #6b7280;
        font-family: monospace;
        font-size: 18px;
        font-weight: 600;
    }
    
    .template-info {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 6px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .template-title {
        font-weight: 600;
        color: #0369a1;
        margin-bottom: 10px;
    }
    
    .template-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        font-size: 14px;
        color: #0c4a6e;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }
    
    /* Styles pour les onglets */
    .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .tabs-nav {
        display: flex;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-bottom: 1px solid #e5e7eb;
    }
    
    .tab-btn {
        flex: 1;
        padding: 16px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .tab-btn:hover {
        background: rgba(96, 246, 59, 0.1);
        color: #3b82f6;
    }
    
    .tab-btn.active {
        background: white;
        color: #1e40af;
        font-weight: 600;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .tab-btn.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    }
    
    .tabs-content {
        min-height: 400px;
    }
    
    .tab-panel {
        display: none;
    }
    
    .tab-panel.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Styles pour les formulaires dans les onglets */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .theme-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .theme-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .theme-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
    }
    
    .theme-button-primary, .theme-button-secondary {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        cursor: pointer;
    }
    
    .theme-button-primary {
        background: #0E1D3D;
        color: white;
        border: none;
    }
    
    .theme-button-primary:hover {
        background: #1a2b5c;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(14, 29, 61, 0.3);
    }
    
    .theme-button-secondary {
        background: white;
        color: #374151;
        border: 2px solid #d1d5db;
    }
    
    .theme-button-secondary:hover {
        background: #f9fafb;
        color: #1f2937;
        border-color: #9ca3af;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Styles pour l'aper√ßu en temps r√©el */
    .preview-updating {
        opacity: 0.7;
    }
    
    .preview-updated {
        opacity: 1;
    }
    
    /* Style pour le bouton d'impression (vert) */
    .theme-button-success {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: 2px solid #1e40af;
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        position: relative;
        overflow: hidden;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 12px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .theme-button-success:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        border-color: #1e3a8a;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        color: white;
        text-decoration: none;
    }
    
    .theme-button-success:active {
        transform: translateY(0);
    }
    
    .theme-button-success::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }
    
    .theme-button-success:hover::before {
        left: 100%;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-t√™te de la page -->
    <div class="page-header">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center mb-2">
                    <i class="fas fa-eye mr-3 text-blue-300"></i>
                    Aper√ßu de l'√âtiquette
                </h1>
                <p class="text-white opacity-90">{{ etiquette.reference }} - {{ etiquette.template.nom }}</p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="{% url 'etiquettes_pro:etiquette_list' %}" class="theme-button-secondary">
                    <i class="fas fa-arrow-left"></i> Retour √† la liste
                </a>
            </div>
        </div>
    </div>

    <!-- Aper√ßu de l'√©tiquette -->
    <div class="etiquette-preview">
        <!-- Simulation de l'√©tiquette r√©elle -->
        <div class="bg-gray-100 p-6 rounded-lg">
            <div class="bg-white etiquette-container overflow-hidden max-w-md mx-auto">
                <!-- Ligne 1: Code-barres et date -->
                <div class="flex">
                    <div class="flex-1 p-3 flex items-center section-with-border" style="background-color: {{ etiquette.template.couleur_secondaire }};">
                        <!-- Code visuel (Code-barres ou QR Code) -->
                        {% if etiquette.template.code_type == 'barcode' or etiquette.template.code_type == 'both' %}
                            {% if etiquette.code_data %}
                            <img src="{% url 'etiquettes_pro:generate_barcode_image' etiquette.code_data %}" 
                                 alt="Barcode" 
                                 class="mr-2 code-image"
                                 style="height: {{ etiquette.template.code_height }}px; width: {{ etiquette.template.code_width }}px;"
                                 onload="console.log('‚úÖ [CLIENT] Barcode charg√© ({{ etiquette.template.code_width }}x{{ etiquette.template.code_height }}mm, {{ etiquette.template.code_quality }}):', this.src)"
                                 onerror="console.error('‚ùå [CLIENT] Erreur chargement barcode:', this.src, 'Status:', this.naturalWidth, 'x', this.naturalHeight)"
                                 onabort="console.warn('‚ö†Ô∏è [CLIENT] Chargement barcode interrompu:', this.src)"/>
                            {% else %}
                            <div class="text-red-500 text-xs bg-yellow-100 p-2 rounded">
                                ‚ö†Ô∏è Pas de code_data pour le barcode
                            </div>
                            {% endif %}
                        {% elif etiquette.template.code_type == 'qr' %}
                            {% if etiquette.code_data %}
                            <img src="{% url 'etiquettes_pro:generate_qrcode_image' etiquette.code_data %}" 
                                 alt="QR Code" 
                                 class="mr-2 code-image"
                                 style="height: {{ etiquette.template.code_height }}px; width: {{ etiquette.template.code_width }}px;"
                                 onload="console.log('‚úÖ [CLIENT] QR Code charg√© ({{ etiquette.template.code_width }}x{{ etiquette.template.code_height }}mm, {{ etiquette.template.code_quality }}):', this.src)"
                                 onerror="console.error('‚ùå [CLIENT] Erreur chargement QR Code:', this.src, 'Status:', this.naturalWidth, 'x', this.naturalHeight)"
                                 onabort="console.warn('‚ö†Ô∏è [CLIENT] Chargement QR Code interrompu:', this.src)"/>
                            {% else %}
                            <div class="text-red-500 text-xs bg-yellow-100 p-2 rounded">
                                ‚ö†Ô∏è Pas de code_data pour le QR Code
                            </div>
                            {% endif %}
                        {% endif %}
                        <div class="dynamic-title font-bold">{{ etiquette.reference }}</div>
                    </div>
                    
                    <!-- Cercle avec le total d'articles au milieu entre ID YZ et date -->
                    {% if etiquette.cart_items %}
                        {% with total_articles=etiquette.cart_items|length %}
                        <div class="flex items-center justify-center px-2">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm" 
                                 style="background-color: {{ etiquette.template.couleur_principale }}; border: {{ etiquette.template.border_width }}px solid {{ etiquette.template.border_color }};">
                                {{ total_articles }}
                            </div>
                        </div>
                        {% endwith %}
                    {% endif %}
                    
                    <div class="w-24 text-white p-3 text-center section-with-border" style="background-color: {{ etiquette.template.couleur_principale }};">
                        <div class="text-sm font-bold">{{ etiquette.date_creation|date:"m/d/Y" }}</div>
                    </div>
                </div>
                
                <!-- Ligne 2: Informations client avec ic√¥nes professionnelles -->
                <div class="bg-gray-50 p-3">
                    {% if etiquette.client_nom %}
                        <div class="dynamic-text flex items-center">
                            <div class="w-4 h-4 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                <i class="{{ etiquette.template.icone_client }} text-blue-600 text-xs"></i>
                            </div>
                            <span>Client: {{ etiquette.client_nom }}</span>
                        </div>
                    {% endif %}
                    
                    {% if etiquette.commande_id %}
                        <div class="dynamic-text flex items-center">
                            <div class="w-4 h-4 bg-indigo-100 rounded-full flex items-center justify-center mr-2">
                                <i class="fas fa-shopping-cart text-indigo-600 text-xs"></i>
                            </div>
                            <span>Commande: {{ etiquette.commande_id }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Num√©ro du client -->
                    {% if commande and commande.client and commande.client.numero_tel %}
                    <div class="dynamic-text flex items-center">
                        <div class="w-4 h-4 bg-green-100 rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-phone text-green-600 text-xs"></i>
                        </div>
                        <span>T√©l: {{ commande.client.numero_tel }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Ville -->
        {% if commande and commande.ville_init %}
        <div class="dynamic-text flex items-center">
            <div class="w-4 h-4 bg-purple-100 rounded-full flex items-center justify-center mr-2">
                <i class="{{ etiquette.template.icone_ville }} text-purple-600 text-xs"></i>
            </div>
            <span>Ville: {{ commande.ville_init }}</span>
        </div>
        {% endif %}
                    
                    {% if not etiquette.client_nom and not etiquette.commande_id %}
                        <div class="dynamic-text flex items-center">
                            <div class="w-4 h-4 bg-gray-100 rounded-full flex items-center justify-center mr-2">
                                <i class="fas fa-exclamation-triangle text-gray-600 text-xs"></i>
                            </div>
                            <span>Informations client non disponibles</span>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Ligne 2.5: Articles du panier avec ic√¥nes professionnelles -->
                {% if etiquette.cart_items %}
                <div class="bg-gray-50 p-3">
                    <div class="dynamic-text font-bold mb-2 flex items-center">
                        <div class="w-4 h-4 bg-indigo-100 rounded-full flex items-center justify-center mr-2">
                            <i class="{{ etiquette.template.icone_panier }} text-indigo-600 text-xs"></i>
                        </div>
                        <span>Articles du panier:</span>
                    </div>
                    {% for item in etiquette.cart_items %}
                        <div class="dynamic-text text-sm ml-3 flex items-center mb-1">
                            <div class="w-3 h-3 bg-yellow-100 rounded-full flex items-center justify-center mr-2">
                                <i class="{{ etiquette.template.icone_article }} text-yellow-600 text-xs"></i>
                            </div>
                            <span>{{ item.nom }} {{ item.variante }} x{{ item.quantite }}</span>
                            {% if item.prix_unitaire %}
                                <span class="text-green-600 font-semibold ml-1">({{ item.prix_unitaire|floatformat:2 }} DH)</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Ligne de s√©paration -->
                <div class="border-b mx-3" style="border-width: {{ etiquette.template.border_width }}px; border-color: {{ etiquette.template.border_color }};"></div>
                
                <!-- Ligne 3: Article -->
                <div class="bg-gray-50 p-3 text-center">
                    <div class="font-bold flex items-center justify-center gap-3">
                        {% if etiquette.nom_article %}
                            {{ etiquette.nom_article }}
                        {% else %}
                            {{ etiquette.commande_id|default:etiquette.reference }}
                        {% endif %}
                        
                        <!-- Cercle avec le total d'articles -->
                        {% if etiquette.cart_items %}
                            {% with total_articles=etiquette.cart_items|length %}
                            <div class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold text-sm" 
                                 style="background-color: {{ etiquette.template.couleur_principale }}; border: {{ etiquette.template.border_width }}px solid {{ etiquette.template.border_color }};">
                                {{ total_articles }}
                            </div>
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- S√©parateur -->
                <div class="border-t border-gray-300"></div>
                
                <!-- Ligne 4: Prix et contact avec ic√¥nes professionnelles -->
                <div class="flex">
                    <div class="flex-1 bg-gray-50 p-3">
                        <div class="font-bold flex items-center">
                            <div class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center mr-2">
                                <i class="{{ etiquette.template.icone_prix }} text-green-600 text-sm"></i>
                            </div>
                            <span>
                                {% if etiquette.cart_items %}
                                    <span class="text-green-600 font-semibold" id="total-price">Calcul en cours...</span>
                                    <span class="text-gray-500 text-xs ml-1">(total)</span>
                                {% else %}
                                    Prix non disponible
                                {% endif %}
                            </span>
                        </div>
                        <div class="text-sm flex items-center mt-1">
                            <div class="w-4 h-4 bg-red-100 rounded-full flex items-center justify-center mr-2">
                                <i class="{{ etiquette.template.icone_marque }} text-red-600 text-xs"></i>
                            </div>
                            <span>YOZAK</span>
                        </div>
                    </div>
                    <div class="w-24 text-white p-3 text-center section-with-border" style="background-color: {{ etiquette.template.couleur_principale }};">
        <div class="text-sm font-bold flex items-center justify-center">
            <i class="{{ etiquette.template.icone_ville }} mr-1"></i>
            <span>{% if commande and commande.ville %}{{ commande.ville.nom }}{% else %}VILLE NON D√âFINIE{% endif %}</span>
        </div>
                        <div class="text-xs flex items-center justify-center">
                            <i class="{{ etiquette.template.icone_website }} mr-1"></i>
                            <span>www.yoozak.com</span>
                        </div>
                        <div class="text-xs flex items-center justify-center">
                            <i class="{{ etiquette.template.icone_telephone }} mr-1"></i>
                            <span>06 34 21 56 39 / 47</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informations d√©taill√©es -->
        <div class="mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">D√©tails de l'√©tiquette</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="info-group">
                    <div class="info-label">R√©f√©rence</div>
                    <div class="info-value">{{ etiquette.reference }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">Statut</div>
                    <div class="info-value">
                        {% if etiquette.statut == 'ready' %}
                            <span class="status-badge confirmee">Pr√™te</span>
                        {% elif etiquette.statut == 'printed' %}
                            <span class="status-badge terminee">Imprim√©e</span>
                        {% elif etiquette.statut == 'draft' %}
                            <span class="status-badge en-preparation">Brouillon</span>
                        {% else %}
                            <span class="status-badge">{{ etiquette.get_statut_display }}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if etiquette.nom_article %}
                <div class="info-group">
                    <div class="info-label">Article</div>
                    <div class="info-value">{{ etiquette.nom_article }}</div>
                </div>
                {% endif %}
                
                {% if etiquette.client_nom %}
                <div class="info-group">
                    <div class="info-label">Client</div>
                    <div class="info-value">{{ etiquette.client_nom }}</div>
                </div>
                {% endif %}
                
                <div class="info-group">
                    <div class="info-label">Date de cr√©ation</div>
                    <div class="info-value">{{ etiquette.date_creation|date:"d/m/Y H:i" }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">Code-barres</div>
                    <div class="info-value font-mono">{{ etiquette.code_data }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informations sur le template -->
    <div class="template-info">
        <div class="template-title">
            <i class="fas fa-file-alt mr-2"></i>Template utilis√©
        </div>
        <div class="template-details">
            <div><strong>Nom:</strong> {{ etiquette.template.nom }}</div>
            <div><strong>Type:</strong> {{ etiquette.template.get_type_etiquette_display }}</div>
            <div><strong>Format:</strong> {{ etiquette.template.get_format_page_display }}</div>
            <div><strong>Code:</strong> {{ etiquette.template.get_code_type_display }}</div>
            <div><strong>Police titre:</strong> {{ etiquette.template.police_titre }}</div>
            <div><strong>Taille titre:</strong> {{ etiquette.template.taille_titre }}pt</div>
            <div><strong>Police texte:</strong> {{ etiquette.template.police_texte }}</div>
            <div><strong>Taille texte:</strong> {{ etiquette.template.taille_texte }}pt</div>
        </div>
    </div>
    
    <!-- Syst√®me d'onglets -->
    <div class="tabs-container mt-6">
        <!-- Navigation des onglets -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="template-info">
                <i class="fas fa-info-circle"></i> Informations Template
            </button>
            <button class="tab-btn" data-tab="print-customization">
                <i class="fas fa-print"></i> Personnalisation Impression
            </button>
        </div>
        
        <!-- Contenu des onglets -->
        <div class="tabs-content">
        
            
            <!-- Onglet Informations Template -->
            <div class="tab-panel active" id="template-info-tab">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-info-circle text-green-500 mr-2"></i>Informations du template
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Param√®tres g√©n√©raux</h4>
                            <div class="space-y-2 text-sm">
                                <div><strong>Nom:</strong> {{ etiquette.template.nom }}</div>
                                <div><strong>Type:</strong> {{ etiquette.template.get_type_etiquette_display }}</div>
                                <div><strong>Format:</strong> {{ etiquette.template.get_format_page_display }}</div>
                                <div><strong>Dimensions:</strong> {{ etiquette.template.largeur }}x{{ etiquette.template.hauteur }}mm</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Param√®tres de design</h4>
                            <div class="space-y-2 text-sm">
                                <div><strong>Couleur principale:</strong> <span class="inline-block w-4 h-4 rounded" style="background-color: {{ etiquette.template.couleur_principale }}"></span> {{ etiquette.template.couleur_principale }}</div>
                                <div><strong>Couleur secondaire:</strong> <span class="inline-block w-4 h-4 rounded" style="background-color: {{ etiquette.template.couleur_secondaire }}"></span> {{ etiquette.template.couleur_secondaire }}</div>
                                <div><strong>Police titre:</strong> {{ etiquette.template.police_titre }}</div>
                                <div><strong>Police texte:</strong> {{ etiquette.template.police_texte }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Onglet Personnalisation Impression -->
            <div class="tab-panel" id="print-customization-tab">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-print text-blue-500 mr-2"></i>Personnalisation d'impression
                    </h3>
                    
                    <form id="print-customization-form" class="space-y-6">
                        {% csrf_token %}
                        <input type="hidden" name="template_id" value="{{ etiquette.template.id }}">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Dimensions des codes -->
                            <div class="space-y-4">
                                <h4 class="text-md font-medium text-gray-700 border-b pb-2">
                                    <i class="fas fa-expand-arrows-alt text-gray-500 mr-2"></i>Dimensions des codes
                                </h4>
                                
                                <div class="form-group">
                                    <label for="print_code_width" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-arrows-alt-h text-gray-500"></i> Largeur code (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_code_width" name="print_code_width" 
                                           value="{{ etiquette.template.print_code_width }}" 
                                           min="100" max="500">
                                </div>
                                
                                <div class="form-group">
                                    <label for="print_code_height" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-arrows-alt-v text-gray-500"></i> Hauteur code (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_code_height" name="print_code_height" 
                                           value="{{ etiquette.template.print_code_height }}" 
                                           min="50" max="200">
                                </div>
                                
                                <div class="form-group">
                                    <label for="print_contact_width" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-arrows-alt-h text-gray-500"></i> Largeur section contact (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_contact_width" name="print_contact_width" 
                                           value="{{ etiquette.template.print_contact_width }}" 
                                           min="150" max="400">
                                </div>
                            </div>
                            
                            <!-- √âl√©ments √† afficher -->
                            <div class="space-y-4">
                                <h4 class="text-md font-medium text-gray-700 border-b pb-2">
                                    <i class="fas fa-eye text-gray-500 mr-2"></i>√âl√©ments √† afficher
                                </h4>
                                
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_prices" name="print_show_prices" 
                                               {% if etiquette.template.print_show_prices %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-money-bill-wave text-green-500 mr-1"></i>Afficher les prix
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_articles" name="print_show_articles" 
                                               {% if etiquette.template.print_show_articles %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-list text-blue-500 mr-1"></i>Afficher la liste des articles
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_client_info" name="print_show_client_info" 
                                               {% if etiquette.template.print_show_client_info %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-user text-purple-500 mr-1"></i>Afficher les infos client
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_contact_info" name="print_show_contact_info" 
                                               {% if etiquette.template.print_show_contact_info %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-phone text-orange-500 mr-1"></i>Afficher les infos de contact
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_brand" name="print_show_brand" 
                                               {% if etiquette.template.print_show_brand %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-crown text-red-500 mr-1"></i>Afficher la marque YOZAK
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_date" name="print_show_date" 
                                               {% if etiquette.template.print_show_date %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-calendar text-indigo-500 mr-1"></i>Afficher la date
                                        </span>
                                    </label>
                                    
                                    <label class="flex items-center">
                                        <input type="checkbox" class="theme-checkbox" id="print_show_total_circle" name="print_show_total_circle" 
                                               {% if etiquette.template.print_show_total_circle %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">
                                            <i class="fas fa-circle text-cyan-500 mr-1"></i>Afficher le cercle total articles
                                        </span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Mise en page et polices -->
                            <div class="space-y-4">
                                <h4 class="text-md font-medium text-gray-700 border-b pb-2">
                                    <i class="fas fa-cogs text-gray-500 mr-2"></i>Mise en page & Polices
                                </h4>
                                
                                <div class="form-group">
                                    <label for="print_padding" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-expand text-gray-500"></i> Espacement interne (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_padding" name="print_padding" 
                                           value="{{ etiquette.template.print_padding }}" 
                                           min="5" max="50">
                                </div>
                                
                                <div class="form-group">
                                    <label for="print_font_size_title" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-font text-gray-500"></i> Taille police titre (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_font_size_title" name="print_font_size_title" 
                                           value="{{ etiquette.template.print_font_size_title }}" 
                                           min="10" max="30">
                                </div>
                                
                                <div class="form-group">
                                    <label for="print_font_size_text" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-font text-gray-500"></i> Taille police texte (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_font_size_text" name="print_font_size_text" 
                                           value="{{ etiquette.template.print_font_size_text }}" 
                                           min="8" max="20">
                                </div>
                                
                                <div class="form-group">
                                    <label for="print_font_size_small" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-font text-gray-500"></i> Taille police petit texte (px)
                                    </label>
                                    <input type="number" class="theme-input" id="print_font_size_small" name="print_font_size_small" 
                                           value="{{ etiquette.template.print_font_size_small }}" 
                                           min="6" max="16">
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- R√©glages recommand√©s -->
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-medium text-blue-800 mb-3">
                                <i class="fas fa-star text-yellow-500 mr-2"></i>R√©glages recommand√©s
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="standard">
                                    <div class="font-medium text-blue-800">üìÑ Standard</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 250x80px, Contact: 250px</div>
                                </button>
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="compact">
                                    <div class="font-medium text-blue-800">üì¶ Compact</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 200x60px, Contact: 200px</div>
                                </button>
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="large">
                                    <div class="font-medium text-blue-800">üìã Large</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 300x100px, Contact: 300px</div>
                                </button>
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="minimal">
                                    <div class="font-medium text-blue-800">üéØ Minimal</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 180x50px, Contact: 180px</div>
                                </button>
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="professional">
                                    <div class="font-medium text-blue-800">üíº Professionnel</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 280x90px, Contact: 280px</div>
                                </button>
                                <button type="button" class="preset-btn bg-white border border-blue-300 rounded-lg p-3 text-left hover:bg-blue-50 transition-colors" data-preset="high-quality">
                                    <div class="font-medium text-blue-800">‚ú® Haute qualit√©</div>
                                    <div class="text-xs text-blue-600 mt-1">Codes: 350x120px, Contact: 350px</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" id="reset-print-settings" class="theme-button-secondary">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                            <button type="submit" id="save-print-settings" class="theme-button-primary">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Boutons d'action -->
    <div class="action-buttons">
        <!-- Bouton PDF supprim√© -->
        <a href="#" class="print-btn-manual theme-button-primary" data-etiquette-id="{{ etiquette.id }}">
            <i class="fas fa-print"></i> Imprimer
        </a>
        <a href="{% url 'etiquettes_pro:template_detail' etiquette.template.pk %}" class="theme-button-secondary">
            <i class="fas fa-file-alt"></i> Voir le Template
        </a>
        <a href="{% url 'etiquettes_pro:dashboard' %}" class="theme-button-secondary">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="{% url 'etiquettes_pro:etiquette_list' %}" class="theme-button-secondary">
            <i class="fas fa-list"></i> Retour √† la liste
        </a>
    </div>
</div>

<!-- Script d'impression -->
<script src="{% static 'js/print_etiquette.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Logging c√¥t√© client pour le d√©bogage
    console.log('üîç [CLIENT] Page d\'aper√ßu charg√©e');
    
    // V√©rifier que le script d'impression est charg√©
    if (typeof EtiquettePrinter !== 'undefined') {
        console.log('‚úÖ [CLIENT] Script d\'impression charg√© correctement');
    } else {
        console.error('‚ùå [CLIENT] Script d\'impression non charg√©');
    }
    
    // V√©rifier les boutons d'impression
    const printButtons = document.querySelectorAll('.print-btn-manual');
    console.log(`üîç [CLIENT] Boutons d'impression trouv√©s: ${printButtons.length}`);
    printButtons.forEach((btn, index) => {
        console.log(`üîç [CLIENT] Bouton ${index + 1}:`, {
            id: btn.dataset.etiquetteId,
            classes: btn.className
        });
    });
    
    // V√©rifier les images de codes
    const codeImages = document.querySelectorAll('.code-image');
    codeImages.forEach((img, index) => {
        console.log(`üîç [CLIENT] Image ${index + 1}:`, {
            src: img.src,
            alt: img.alt,
            naturalWidth: img.naturalWidth,
            naturalHeight: img.naturalHeight,
            complete: img.complete
        });
    });
});

// Gestion des onglets
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    // Initialiser l'onglet actif par d√©faut
    console.log('üîç [ONGLETS] Initialisation des onglets...');
    
    // V√©rifier que l'onglet "Informations Template" est actif par d√©faut
    const templateInfoTab = document.getElementById('template-info-tab');
    const templateInfoBtn = document.querySelector('[data-tab="template-info"]');
    
    if (templateInfoTab && templateInfoBtn) {
        templateInfoTab.classList.add('active');
        templateInfoBtn.classList.add('active');
        console.log('‚úÖ [ONGLETS] Onglet "Informations Template" activ√© par d√©faut');
    }
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            console.log(`üîÑ [ONGLETS] Clic sur l'onglet: ${targetTab}`);
            
            // Retirer la classe active de tous les boutons et panneaux
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanels.forEach(panel => panel.classList.remove('active'));
            
            // Ajouter la classe active au bouton cliqu√© et au panneau correspondant
            this.classList.add('active');
            const targetPanel = document.getElementById(targetTab + '-tab');
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log(`‚úÖ [ONGLETS] Onglet "${targetTab}" activ√©`);
            } else {
                console.error(`‚ùå [ONGLETS] Panneau non trouv√©: ${targetTab}-tab`);
            }
        });
    });
    
    // Gestion du formulaire de personnalisation d'impression
    const printForm = document.getElementById('print-customization-form');
    const resetButton = document.getElementById('reset-print-settings');
    
    // Fonction pour mettre √† jour l'aper√ßu visuel de l'√©tiquette
    function updateEtiquettePreview() {
        console.log('üé® [ETIQUETTE] Mise √† jour de l\'aper√ßu visuel...');
        
        // R√©cup√©rer les valeurs actuelles
        const codeWidth = parseInt(document.getElementById('print_code_width')?.value || 250);
        const codeHeight = parseInt(document.getElementById('print_code_height')?.value || 80);
        const contactWidth = parseInt(document.getElementById('print_contact_width')?.value || 250);
        const titleFont = parseInt(document.getElementById('print_font_size_title')?.value || 16);
        const textFont = parseInt(document.getElementById('print_font_size_text')?.value || 12);
        const smallFont = parseInt(document.getElementById('print_font_size_small')?.value || 10);
        
        // R√©cup√©rer les √©l√©ments affich√©s
        const elements = [];
        if (document.getElementById('print_show_prices')?.checked) elements.push('Prix');
        if (document.getElementById('print_show_articles')?.checked) elements.push('Articles');
        if (document.getElementById('print_show_client_info')?.checked) elements.push('Client');
        if (document.getElementById('print_show_contact_info')?.checked) elements.push('Contact');
        if (document.getElementById('print_show_brand')?.checked) elements.push('Marque');
        if (document.getElementById('print_show_date')?.checked) elements.push('Date');
        if (document.getElementById('print_show_total_circle')?.checked) elements.push('Cercle');
        
        // Mettre √† jour l'aper√ßu visuel
        updateEtiquettePreviewVisual(codeWidth, codeHeight, contactWidth, titleFont, textFont, smallFont, elements);
    }
    
    // Fonction pour mettre √† jour l'aper√ßu visuel de l'√©tiquette
    function updateEtiquettePreviewVisual(codeWidth, codeHeight, contactWidth, titleFont, textFont, smallFont, elements) {
        console.log('üé® [ETIQUETTE] Mise √† jour de l\'aper√ßu visuel...');
        
        // Mettre √† jour les dimensions des codes dans l'aper√ßu
        const codeImages = document.querySelectorAll('.code-image');
        codeImages.forEach(img => {
            img.style.width = `${codeWidth}px`;
            img.style.height = `${codeHeight}px`;
            console.log(`üñºÔ∏è [ETIQUETTE] Code mis √† jour: ${codeWidth}x${codeHeight}px`);
        });
        
        // Mettre √† jour la largeur de la section contact
        const contactSections = document.querySelectorAll('.preview-contact-info, .preview-date');
        contactSections.forEach(section => {
            section.style.width = `${contactWidth}px`;
            console.log(`üìû [ETIQUETTE] Section contact mise √† jour: ${contactWidth}px`);
        });
        
        // Mettre √† jour les tailles de police
        const titleElements = document.querySelectorAll('.dynamic-title');
        titleElements.forEach(el => {
            el.style.fontSize = `${titleFont}px`;
        });
        
        const textElements = document.querySelectorAll('.dynamic-text');
        textElements.forEach(el => {
            el.style.fontSize = `${textFont}px`;
        });
        
        const smallElements = document.querySelectorAll('.text-xs, .text-sm');
        smallElements.forEach(el => {
            el.style.fontSize = `${smallFont}px`;
        });
        
        console.log(`üìù [ETIQUETTE] Polices mises √† jour: Titre ${titleFont}px, Texte ${textFont}px, Petit ${smallFont}px`);
        
        // Mettre √† jour la visibilit√© des √©l√©ments selon les checkboxes
        updateElementVisibility(elements);
        
        console.log('‚úÖ [ETIQUETTE] Aper√ßu visuel mis √† jour');
    }
    
    // Fonction pour mettre √† jour la visibilit√© des √©l√©ments
    function updateElementVisibility(elements) {
        console.log('üëÅÔ∏è [VISIBILITE] Mise √† jour de la visibilit√© des √©l√©ments...');
        
        // Fonction helper pour montrer/cacher un √©l√©ment
        function toggleElement(selector, show, elementName) {
            const element = document.querySelector(selector);
            if (element) {
                element.style.display = show ? 'block' : 'none';
                console.log(`${show ? '‚úÖ' : '‚ùå'} [VISIBILITE] ${elementName}: ${show ? 'Affich√©' : 'Masqu√©'}`);
            }
        }
        
        // Mettre √† jour la visibilit√© selon les √©l√©ments s√©lectionn√©s
        toggleElement('.preview-price', elements.includes('Prix'), 'Prix');
        toggleElement('.preview-cart-items', elements.includes('Articles'), 'Articles du panier');
        toggleElement('.preview-client-info', elements.includes('Client'), 'Informations client');
        toggleElement('.preview-contact-info', elements.includes('Contact'), 'Section contact');
        toggleElement('.preview-brand', elements.includes('Marque'), 'Marque YOZAK');
        toggleElement('.preview-date', elements.includes('Date'), 'Date');
        toggleElement('.preview-total-circle', elements.includes('Cercle'), 'Cercle total articles');
        
        console.log('‚úÖ [VISIBILITE] Visibilit√© mise √† jour');
    }
    
    // Ajouter les √©v√©nements pour l'aper√ßu d'impression
    function attachPreviewEvents() {
        console.log('üîó [PREVIEW] Attachement des √©v√©nements d\'aper√ßu...');
        
        // √âv√©nements pour les champs num√©riques
        const printInputs = document.querySelectorAll('#print_code_width, #print_code_height, #print_contact_width, #print_font_size_title, #print_font_size_text, #print_font_size_small');
        console.log('üìù [PREVIEW] Champs num√©riques trouv√©s:', printInputs.length);
        
        printInputs.forEach((input, index) => {
            if (input) {
                input.addEventListener('input', function() {
                    console.log(`üîÑ [PREVIEW] Changement d√©tect√© sur ${input.id}: ${input.value}`);
                    updateEtiquettePreview();
                });
                input.addEventListener('change', function() {
                    console.log(`üîÑ [PREVIEW] Changement confirm√© sur ${input.id}: ${input.value}`);
                    updateEtiquettePreview();
                });
                console.log(`‚úÖ [PREVIEW] √âv√©nements attach√©s √† ${input.id}`);
            }
        });
        
        // √âv√©nements pour les checkboxes
        const printCheckboxes = document.querySelectorAll('input[name^="print_show_"]');
        console.log('‚òëÔ∏è [PREVIEW] Checkboxes trouv√©es:', printCheckboxes.length);
        
        printCheckboxes.forEach((checkbox, index) => {
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    console.log(`üîÑ [PREVIEW] Checkbox ${checkbox.name} chang√©e: ${checkbox.checked}`);
                    updateEtiquettePreview();
                });
                console.log(`‚úÖ [PREVIEW] √âv√©nements attach√©s √† ${checkbox.name}`);
            }
        });
        
        // Initialiser l'aper√ßu d'impression
        console.log('üöÄ [PREVIEW] Initialisation de l\'aper√ßu...');
        updateEtiquettePreview();
    }
    
    // Fonction de d√©bogage pour v√©rifier les √©l√©ments
    function debugPreviewElements() {
        console.log('üîç [DEBUG] V√©rification des √©l√©ments d\'aper√ßu...');
        
        const elements = [
            'print_code_width', 'print_code_height', 'print_contact_width',
            'print_font_size_title', 'print_font_size_text', 'print_font_size_small',
            'preview-code-size', 'preview-contact-width', 'preview-title-font',
            'preview-text-font', 'preview-small-font', 'preview-elements'
        ];
        
        elements.forEach(id => {
            const element = document.getElementById(id);
            console.log(`${element ? '‚úÖ' : '‚ùå'} [DEBUG] ${id}:`, element ? 'Trouv√©' : 'Non trouv√©');
        });
        
        const checkboxes = document.querySelectorAll('input[name^="print_show_"]');
        console.log(`‚òëÔ∏è [DEBUG] Checkboxes trouv√©es: ${checkboxes.length}`);
        checkboxes.forEach(checkbox => {
            console.log(`‚úÖ [DEBUG] ${checkbox.name}:`, checkbox.checked ? 'Coch√©e' : 'D√©coch√©e');
        });
    }
    
    // Attacher les √©v√©nements imm√©diatement
    attachPreviewEvents();
    
    // Attacher aussi apr√®s un d√©lai pour s'assurer que tous les √©l√©ments sont charg√©s
    setTimeout(() => {
        debugPreviewElements();
        attachPreviewEvents();
    }, 500);
    
    // Attacher aussi apr√®s un d√©lai plus long au cas o√π
    setTimeout(attachPreviewEvents, 1000);
    
    // Fonction de test pour v√©rifier le fonctionnement
    function testPreviewSystem() {
        console.log('üß™ [TEST] Test du syst√®me d\'aper√ßu...');
        
        // Test 1: V√©rifier que tous les √©l√©ments existent
        const requiredElements = [
            'print_code_width', 'print_code_height', 'print_contact_width',
            'print_font_size_title', 'print_font_size_text', 'print_font_size_small'
        ];
        
        let allElementsFound = true;
        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`‚ùå [TEST] √âl√©ment manquant: ${id}`);
                allElementsFound = false;
            } else {
                console.log(`‚úÖ [TEST] √âl√©ment trouv√©: ${id}`);
            }
        });
        
        // Test 2: V√©rifier les classes CSS
        const requiredClasses = [
            '.preview-price', '.preview-cart-items', '.preview-client-info',
            '.preview-contact-info', '.preview-brand', '.preview-date', '.preview-total-circle'
        ];
        
        requiredClasses.forEach(className => {
            const element = document.querySelector(className);
            if (!element) {
                console.warn(`‚ö†Ô∏è [TEST] Classe CSS manquante: ${className}`);
            } else {
                console.log(`‚úÖ [TEST] Classe CSS trouv√©e: ${className}`);
            }
        });
        
        // Test 3: Simuler un changement
        const testInput = document.getElementById('print_code_width');
        if (testInput) {
            const originalValue = testInput.value;
            testInput.value = '300';
            testInput.dispatchEvent(new Event('input'));
            
            setTimeout(() => {
                testInput.value = originalValue;
                testInput.dispatchEvent(new Event('input'));
                console.log('‚úÖ [TEST] Test de simulation termin√©');
            }, 1000);
        }
        
        console.log(`üéØ [TEST] R√©sultat: ${allElementsFound ? 'SUCC√àS' : '√âCHEC'}`);
    }
    
    // Lancer le test apr√®s 2 secondes
    setTimeout(testPreviewSystem, 2000);
    
    // Calculer le total des prix
    function calculateTotalPrice() {
        console.log('üí∞ [CALCUL] Calcul du total des prix...');
        
        const cartItems = {{ etiquette.cart_items|safe }};
        let total = 0;
        
        if (cartItems && Array.isArray(cartItems)) {
            cartItems.forEach(item => {
                if (item.prix_unitaire) {
                    total += parseFloat(item.prix_unitaire);
                    console.log(`üí∞ [CALCUL] Article: ${item.nom} - Prix: ${item.prix_unitaire} DH`);
                }
            });
        }
        
        const totalElement = document.getElementById('total-price');
        if (totalElement) {
            totalElement.textContent = `${total.toFixed(2)} DH`;
            console.log(`üí∞ [CALCUL] Total calcul√©: ${total.toFixed(2)} DH`);
        }
    }
    
    // Calculer le total au chargement de la page
    setTimeout(calculateTotalPrice, 100);
    
    // Gestion des r√©glages recommand√©s
    const presetButtons = document.querySelectorAll('.preset-btn');
    presetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const preset = this.getAttribute('data-preset');
            applyPreset(preset);
        });
    });
    
    // Fonction pour appliquer un preset
    function applyPreset(preset) {
        console.log(`üéØ [PRESET] Application du preset: ${preset}`);
        
        const presets = {
            'standard': {
                code_width: 250,
                code_height: 80,
                contact_width: 250,
                title_font: 16,
                text_font: 12,
                small_font: 10
            },
            'compact': {
                code_width: 200,
                code_height: 60,
                contact_width: 200,
                title_font: 14,
                text_font: 11,
                small_font: 9
            },
            'large': {
                code_width: 300,
                code_height: 100,
                contact_width: 300,
                title_font: 18,
                text_font: 14,
                small_font: 12
            },
            'minimal': {
                code_width: 180,
                code_height: 50,
                contact_width: 180,
                title_font: 13,
                text_font: 10,
                small_font: 8
            },
            'professional': {
                code_width: 280,
                code_height: 90,
                contact_width: 280,
                title_font: 17,
                text_font: 13,
                small_font: 11
            },
            'high-quality': {
                code_width: 350,
                code_height: 120,
                contact_width: 350,
                title_font: 20,
                text_font: 16,
                small_font: 14
            }
        };
        
        const config = presets[preset];
        if (config) {
            // Appliquer les valeurs
            document.getElementById('print_code_width').value = config.code_width;
            document.getElementById('print_code_height').value = config.code_height;
            document.getElementById('print_contact_width').value = config.contact_width;
            document.getElementById('print_font_size_title').value = config.title_font;
            document.getElementById('print_font_size_text').value = config.text_font;
            document.getElementById('print_font_size_small').value = config.small_font;
            
            // D√©clencher la mise √† jour de l'aper√ßu
            updateEtiquettePreview();
            
            // Mettre en surbrillance le bouton s√©lectionn√©
            presetButtons.forEach(btn => btn.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-100'));
            this.classList.add('ring-2', 'ring-blue-500', 'bg-blue-100');
            
            console.log(`‚úÖ [PRESET] Preset ${preset} appliqu√© avec succ√®s`);
        }
    }
    
    // Gestion de la soumission du formulaire
    if (printForm) {
        printForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const templateId = formData.get('template_id');
            
            try {
                const response = await fetch(`/etiquettes-pro/templates/${templateId}/update-print-settings/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Afficher un message de succ√®s
                        showNotification('Param√®tres d\'impression sauvegard√©s avec succ√®s !', 'success');
                        
                        // Recharger la page pour appliquer les changements
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showNotification('Erreur lors de la sauvegarde: ' + result.error, 'error');
                    }
                } else {
                    showNotification('Erreur de communication avec le serveur', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
            }
        });
    }
    
    // Gestion du bouton de r√©initialisation
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les param√®tres d\'impression aux valeurs par d√©faut ?')) {
                // R√©initialiser aux valeurs par d√©faut
                document.getElementById('print_code_width').value = 250;
                document.getElementById('print_code_height').value = 80;
                document.getElementById('print_contact_width').value = 250;
                document.getElementById('print_padding').value = 15;
                document.getElementById('print_font_size_title').value = 16;
                document.getElementById('print_font_size_text').value = 12;
                document.getElementById('print_font_size_small').value = 10;
                
                // Cocher toutes les cases
                document.querySelectorAll('input[name^="print_show_"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                updatePrintPreview();
                showNotification('Param√®tres r√©initialis√©s', 'info');
            }
        });
    }
    
    // Fonction pour afficher les notifications
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        // Styles pour les notifications
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;
        
        if (type === 'success') {
            notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        } else if (type === 'error') {
            notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        } else {
            notification.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
        }
        
        document.body.appendChild(notification);
        
        // Supprimer la notification apr√®s 3 secondes
        setTimeout(() => {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // Gestion des notifications
    const style = document.createElement('style');
    style.textContent = `
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
