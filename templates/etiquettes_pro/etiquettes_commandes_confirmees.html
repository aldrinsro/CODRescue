{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}Étiquettes Commandes Confirmées - YZ-CMD{% endblock %}

{% block page_title %}Étiquettes Commandes Confirmées{% endblock %}
{% block page_subtitle %}Aperçu des tickets pour toutes les commandes confirmées{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- CSS externe pour les styles Superpreparation -->
<link rel="stylesheet" href="{% static 'css/Superpreparation/page_cmd_confim.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-tête de la page -->
    <div class="page-header">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center mb-2">
                    <i class="fas fa-tags mr-3 text-green-300"></i>
                    Étiquettes Commandes Confirmées
                </h1>
                <p class="text-white opacity-90">Aperçu des tickets pour toutes les commandes confirmées</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-4">
                <a href="{% url 'etiquettes_pro:generate_etiquettes_confirmees' %}" class="theme-button-primary">
                    <i class="fas fa-magic"></i> Générer Automatiquement
                </a>
                <a href="{% url 'etiquettes_pro:dashboard' %}" class="theme-button-secondary">
                    <i class="fas fa-arrow-left"></i> Retour Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-800">{{ total_etiquettes|default:0 }}</div>
                    <div class="text-sm text-gray-600">Étiquettes Générées</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-tags"></i>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-800">{{ etiquettes_ready|default:0 }}</div>
                    <div class="text-sm text-gray-600">Prêtes à Imprimer</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-print"></i>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-800">{{ etiquettes_printed|default:0 }}</div>
                    <div class="text-sm text-gray-600">Déjà Imprimées</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-2xl font-bold text-gray-800">{{ commandes_sans_etiquettes_count|default:0 }}</div>
                    <div class="text-sm text-gray-600">Commandes sans Étiquettes</div>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Informations sur le template -->
    {% if template %}
    <div class="info-section mb-6">
        <h3 class="section-title">
            <i class="fas fa-info-circle text-blue-500"></i>
            Template Utilisé
        </h3>
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-lg font-semibold text-gray-800">{{ template.nom }}</h4>
                    <p class="text-gray-600">{{ template.description }}</p>
                    <div class="flex gap-4 mt-2">
                        <span class="status-badge confirmee">{{ template.get_type_etiquette_display }}</span>
                        <span class="status-badge en-preparation">{{ template.get_format_page_display }}</span>
                        <span class="status-badge terminee">{{ template.get_code_type_display }}</span>
                    </div>
                </div>
                <div class="text-right">
                    <a href="{% url 'etiquettes_pro:template_detail' template.pk %}" class="theme-button-secondary">
                        <i class="fas fa-eye"></i> Voir Template
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Liste des étiquettes -->
    {% if etiquettes %}
    <div class="table-container">
        <div class="table-responsive">
            <table class="w-full">
                <thead class="table-header">
                    <tr>
                        <th class="table-cell">Référence</th>
                        <th class="table-cell">Commande</th>
                        <th class="table-cell">Client</th>
                        <th class="table-cell">Statut</th>
                        <th class="table-cell">Date Création</th>
                        <th class="table-cell">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for etiquette in etiquettes %}
                    <tr class="table-row">
                        <td class="table-cell">
                            <div class="flex items-center">
                                <i class="fas fa-tag mr-2 text-blue-500"></i>
                                <span class="font-mono">{{ etiquette.reference }}</span>
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="flex items-center">
                                <i class="fas fa-shopping-cart mr-2 text-green-500"></i>
                                <span>{{ etiquette.commande_id }}</span>
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-2 text-purple-500"></i>
                                <span>{{ etiquette.client_nom|default:"-" }}</span>
                            </div>
                        </td>
                        <td class="table-cell">
                            {% if etiquette.statut == 'ready' %}
                                <span class="status-badge confirmee">Prête</span>
                            {% elif etiquette.statut == 'printed' %}
                                <span class="status-badge terminee">Imprimée</span>
                            {% elif etiquette.statut == 'draft' %}
                                <span class="status-badge en-preparation">Brouillon</span>
                            {% else %}
                                <span class="status-badge">{{ etiquette.get_statut_display }}</span>
                            {% endif %}
                        </td>
                        <td class="table-cell">{{ etiquette.date_creation|date:"d/m/Y H:i" }}</td>
                        <td class="table-cell">
                            <div class="action-buttons-container">
                                <a href="{% url 'etiquettes_pro:etiquette_pdf' etiquette.id %}" class="action-button" title="Télécharger PDF">
                                    <i class="fas fa-download"></i>
                                </a>
                                <a href="{% url 'etiquettes_pro:etiquette_preview' etiquette.id %}" class="theme-button-secondary" title="Aperçu">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if etiquettes.has_other_pages %}
    <nav aria-label="Pagination des étiquettes" class="mt-6">
        <ul class="pagination justify-content-center">
            {% if etiquettes.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ etiquettes.previous_page_number }}">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">
                    Page {{ etiquettes.number }} sur {{ etiquettes.paginator.num_pages }}
                </span>
            </li>
            
            {% if etiquettes.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ etiquettes.next_page_number }}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ etiquettes.paginator.num_pages }}">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Message si aucune étiquette -->
    <div class="text-center py-12">
        <div class="empty-state">
            <i class="fas fa-tags fa-3x text-muted mb-4"></i>
            <h4 class="text-muted">Aucune étiquette générée</h4>
            <p class="text-muted mb-6">
                Aucune étiquette n'a encore été générée pour les commandes confirmées.
            </p>
            <a href="{% url 'etiquettes_pro:generate_etiquettes_confirmees' %}" class="theme-button-primary">
                <i class="fas fa-magic"></i> Générer les Étiquettes
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Information sur la génération automatique -->
    <div class="info-section mt-6">
        <h3 class="section-title">
            <i class="fas fa-info-circle text-blue-500"></i>
            À propos de la génération automatique
        </h3>
        <p class="text-gray-600">
            Cette fonctionnalité génère automatiquement des étiquettes pour toutes les commandes confirmées 
            en utilisant le template par défaut "Template Livraison Standard". 
            Chaque étiquette contient les informations de la commande, le client et un code-barres unique.
        </p>
    </div>
</div>
{% endblock %}
