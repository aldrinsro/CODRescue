{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}Mes Étiquettes - YZ-CMD{% endblock %}

{% block page_title %}Mes Étiquettes{% endblock %}
{% block page_subtitle %}Gestion et impression des étiquettes pour commandes confirmées{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- CSS externe pour les styles Superpreparation -->
<link rel="stylesheet" href="{% static 'css/Superpreparation/page_cmd_confim.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-tête de la page -->
    <div class="page-header">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center mb-2">
                    <i class="fas fa-tags mr-3 text-green-300"></i>
                    Mes Étiquettes
                </h1>
                <p class="text-white opacity-90">Gestion et impression des étiquettes pour commandes confirmées</p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="{% url 'etiquettes_pro:template_create' %}" class="theme-button-primary">
                    <i class="fas fa-plus"></i> Créer une Étiquette
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div id="stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 lg:mb-8">
        <!-- Total étiquettes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 transition-all duration-300 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-tags text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Total étiquettes</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-blue-600">{{ total_count|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Brouillons -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-600 transition-all duration-300 group-hover:from-yellow-500 group-hover:to-yellow-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-edit text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Brouillons</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-yellow-600">{{ draft_count|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prêtes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-check-circle text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Prêtes</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ ready_count|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imprimées -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-print text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Imprimées</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ printed_count|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Commandes avec Paniers -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 mb-6">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i class="fas fa-shopping-cart mr-3 text-blue-600"></i>
                    <h2 class="text-lg font-bold text-gray-800">Commandes Confirmées avec Paniers</h2>
                    <span id="commandes-count" class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">0</span>
                    <div id="auto-refresh-indicator" class="ml-2 flex items-center text-xs text-gray-500">
                        <i class="fas fa-sync-alt mr-1"></i>
                        <span>Auto-actualisation: 30s</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="refresh-commandes" class="theme-button-secondary text-sm">
                        <i class="fas fa-sync-alt mr-1"></i>Actualiser
                    </button>
                    <button id="generate-all-etiquettes" class="theme-button-primary text-sm" disabled>
                        <i class="fas fa-magic mr-1"></i>Générer Toutes les Étiquettes
                    </button>
                </div>
            </div>
            
            <!-- Liste des commandes avec paniers -->
            <div id="commandes-container" class="space-y-3">
                <div id="commandes-loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500">Chargement des commandes...</p>
                </div>
                <div id="commandes-list" class="hidden">
                    <!-- Les commandes seront chargées dynamiquement ici -->
                </div>
                <div id="no-commandes" class="hidden text-center py-8">
                    <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
                    <p class="text-gray-600">Toutes les commandes confirmées avec paniers ont déjà des étiquettes !</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre d'outils de sélection multiple -->
    <div id="bulk-actions-toolbar" class="bg-white rounded-xl shadow-lg border border-gray-200 mb-6 p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">
                    <span id="selected-count">0</span> étiquette(s) sélectionnée(s)
                </span>
                <div class="flex items-center space-x-2">
                    <button id="select-all-btn" class="theme-button-secondary text-sm">
                        <i class="fas fa-check-square mr-1"></i>Tout sélectionner
                    </button>
                    <button id="deselect-all-btn" class="theme-button-secondary text-sm">
                        <i class="fas fa-square mr-1"></i>Tout désélectionner
                    </button>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="bulk-print-btn" class="theme-button-primary">
                    <i class="fas fa-print mr-2"></i>Impression multiple
                </button>
                <button id="bulk-qr-details-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-qrcode mr-2"></i>QR Articles Détails
                </button>
                <button id="bulk-qr-simple-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-qrcode mr-2"></i>QR Articles Simples
                </button>
                <button id="bulk-delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                    <i class="fas fa-trash mr-2"></i>Supprimer multiple
                </button>
            </div>
        </div>
    </div>

    <!-- Liste des étiquettes -->
    {% if etiquettes %}
    <div id="etiquettes-container" class="etiquettes-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for etiquette in etiquettes %}
        <div class="etiquette-card bg-white rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" data-etiquette-id="{{ etiquette.id }}">
            <!-- En-tête de la carte -->
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" class="etiquette-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" data-etiquette-id="{{ etiquette.id }}">
                        <h3 class="etiquette-reference text-lg font-bold text-gray-800">{{ etiquette.reference }}</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if etiquette.statut == 'ready' %}
                            <span class="etiquette-statut status-badge confirmee">
                                <i class="fas fa-check"></i> Prête
                            </span>
                        {% elif etiquette.statut == 'printed' %}
                            <span class="etiquette-statut status-badge terminee">
                                <i class="fas fa-print"></i> Imprimée
                            </span>
                        {% elif etiquette.statut == 'draft' %}
                            <span class="etiquette-statut status-badge en-preparation">
                                <i class="fas fa-edit"></i> Brouillon
                            </span>
                        {% else %}
                            <span class="etiquette-statut status-badge">{{ etiquette.get_statut_display }}</span>
                        {% endif %}
                        
                        <!-- Compteurs d'impressions -->
                        <div class="flex items-center gap-1">
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium {% if etiquette.compteur_impression_ticket > 0 %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-500{% endif %}" title="Tickets imprimés">
                                <i class="fas fa-ticket-alt mr-1"></i>{{ etiquette.compteur_impression_ticket }}
                            </span>
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium {% if etiquette.compteur_impression_qr > 0 %}bg-purple-100 text-purple-800{% else %}bg-gray-100 text-gray-500{% endif %}" title="Codes QR imprimés">
                                <i class="fas fa-qrcode mr-1"></i>{{ etiquette.compteur_impression_qr }}
                            </span>
                        </div>
                    </div>
                </div>
                <p class="etiquette-template text-sm text-gray-600">
                    <i class="fas fa-tag mr-2 text-blue-500"></i>{{ etiquette.template.nom }}
                </p>
            </div>
            
            <!-- Contenu de la carte -->
            <div class="p-4">
                <div class="space-y-3">
                    <!-- Commande -->
                    <div class="flex items-center">
                        <i class="fas fa-shopping-cart w-5 text-green-500 mr-3"></i>
                        <div>
                            <p class="text-xs text-gray-500">Commande</p>
                            <p class="etiquette-commande text-sm font-medium text-gray-800">
                                {% if etiquette.nom_article %}
                                    {{ etiquette.nom_article }}
                                {% elif etiquette.commande_id %}
                                    #{{ etiquette.commande_id }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Articles -->
                    <div class="flex items-center">
                        <i class="fas fa-box w-5 text-orange-500 mr-3"></i>
                        <div>
                            <p class="text-xs text-gray-500">Articles</p>
                            <p class="text-sm font-medium text-gray-800 etiquette-articles">
                                {% if etiquette.cart_items %}
                                    {% for item in etiquette.cart_items %}
                                        {% if forloop.first %}
                                            {% if item.reference %}
                                                <span class="font-semibold text-blue-600">{{ item.reference }}</span><br>
                                                <span class="text-gray-600">{{ item.nom|truncatechars:20 }}</span>
                                            {% else %}
                                                {{ item.nom|truncatechars:25 }}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if etiquette.cart_items|length > 1 %}
                                        <span class="text-gray-500">+{{ etiquette.cart_items|length|add:"-1" }} autres</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Client -->
                    {% if etiquette.client_nom %}
                    <div class="flex items-center">
                        <i class="fas fa-user w-5 text-purple-500 mr-3"></i>
                        <div>
                            <p class="text-xs text-gray-500">Client</p>
                            <p class="etiquette-client text-sm font-medium text-gray-800">{{ etiquette.client_nom|truncatechars:25 }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Date -->
                    <div class="flex items-center">
                        <i class="fas fa-calendar w-5 text-indigo-500 mr-3"></i>
                        <div>
                            <p class="text-xs text-gray-500">Créée le</p>
                            <p class="etiquette-date text-sm font-medium text-gray-800">{{ etiquette.date_creation|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <!-- Bouton PDF supprimé -->
                        <a href="{% url 'etiquettes_pro:etiquette_preview' etiquette.id %}" 
                           class="theme-button-secondary" title="Aperçu">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'etiquettes_pro:generate_qr_codes_articles' etiquette.id %}" 
                           class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors duration-200" title="QR Articles Détails">
                            <i class="fas fa-qrcode"></i>
                        </a>
                        <a href="{% url 'etiquettes_pro:generate_qr_codes_simple' etiquette.id %}" 
                           class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors duration-200" title="QR Articles Simples">
                            <i class="fas fa-qrcode"></i>
                        </a>
                        {% if etiquette.statut == 'draft' %}
                        <button class="theme-button-secondary" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500">
                        ID: {{ etiquette.id }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- La pagination intelligente sera gérée par JavaScript -->

{% else %}
<!-- Message si aucune étiquette -->
<div class="text-center py-5">
    <div class="empty-state">
        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Aucune étiquette trouvée</h4>
        <p class="text-muted mb-4">
            {% if request.GET.search or request.GET.statut or request.GET.template %}
                Aucune étiquette ne correspond à vos critères de recherche.
            {% else %}
                Vous n'avez pas encore créé d'étiquettes.
            {% endif %}
        </p>
        
        {% if request.GET.search or request.GET.statut or request.GET.template %}
            <a href="{% url 'etiquettes_pro:etiquette_list' %}" class="theme-button-secondary">
                <i class="fas fa-times mr-2"></i> Effacer les filtres
            </a>
        {% else %}
            <a href="{% url 'etiquettes_pro:template_create' %}" class="theme-button-primary">
                <i class="fas fa-plus mr-2"></i> Créer votre première étiquette
            </a>
        {% endif %}
    </div>
</div>
{% endif %}

</div>

<!-- Scripts pour la pagination et recherche intelligente -->
<script src="{% static 'js/etiquettes_pro/smart-pagination.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/smart-search.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/bulk-print.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/bulk-delete.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/bulk-qr-simple.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/bulk-qr-details.js' %}"></script>
<script src="{% static 'js/etiquettes_pro/realtime-commandes.js' %}"></script>

<!-- Script d'impression -->
<script src="{% static 'js/print_etiquette.js' %}"></script>

<!-- Script de débogage pour la barre d'outils -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 [DEBUG] DOM chargé');
    
    const toolbar = document.getElementById('bulk-actions-toolbar');
    console.log('🔍 [DEBUG] Barre d\'outils trouvée:', toolbar);
    
    if (toolbar) {
        console.log('🔍 [DEBUG] Classes de la barre d\'outils:', toolbar.className);
        console.log('🔍 [DEBUG] Style display:', window.getComputedStyle(toolbar).display);
        console.log('🔍 [DEBUG] Style visibility:', window.getComputedStyle(toolbar).visibility);
        
        // Forcer la visibilité
        toolbar.classList.remove('hidden');
        toolbar.style.display = 'block';
        toolbar.style.visibility = 'visible';
        
        console.log('🔍 [DEBUG] Barre d\'outils forcée visible');
    }
    
    // Vérifier les boutons
    const printBtn = document.getElementById('bulk-print-btn');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    
    console.log('🔍 [DEBUG] Bouton impression:', printBtn);
    console.log('🔍 [DEBUG] Bouton suppression:', deleteBtn);
    
    if (printBtn) {
        printBtn.disabled = false;
        console.log('🔍 [DEBUG] Bouton impression activé');
    }
    
    if (deleteBtn) {
        deleteBtn.disabled = false;
        console.log('🔍 [DEBUG] Bouton suppression activé');
    }
});
</script>

{% block extra_js %}
<script>
// Initialisation des modules après le chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 [ÉTIQUETTES] Initialisation des modules intelligents');
    
    // Vérifier que les modules sont chargés
    if (window.smartPaginationEtiquettes && window.smartSearchEtiquettes) {
        console.log('✅ [ÉTIQUETTES] Modules de pagination et recherche chargés');
    } else {
        console.error('❌ [ÉTIQUETTES] Modules non chargés');
    }
});
</script>
{% endblock %}
{% endblock %}
