{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}Étiquettes Professionnelles - YZ-CMD{% endblock %}

{% block page_title %}Étiquettes Professionnelles{% endblock %}
{% block page_subtitle %}Système d'impression haute qualité pour commandes confirmées{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- CSS externe pour les styles Superpreparation -->
<link rel="stylesheet" href="{% static 'css/Superpreparation/page_cmd_confim.css' %}">
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- Toast notifications container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- En-tête de la page -->
    <div class="page-header">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h1 class="text-3xl font-bold flex items-center mb-2">
                    <i class="fas fa-tags mr-3 text-green-300"></i>
                    Étiquettes Professionnelles
                </h1>
                <p class="text-white opacity-90">Système d'impression haute qualité pour commandes confirmées</p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="{% url 'etiquettes_pro:template_create' %}" class="theme-button-primary">
                    <i class="fas fa-plus"></i> Créer une Étiquette
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <!-- Accès rapide (section fine) -->
    <div id="quick-access" class="bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
        <div class="px-4 py-2 border-b border-gray-100">
            <h3 class="text-sm font-semibold text-gray-800 flex items-center">
                <i class="fas fa-bolt mr-2 text-gray-500"></i> Accès rapide
            </h3>
        </div>
        <div class="px-4 py-2">
            <div class="flex flex-wrap items-center gap-2">
                <a href="{% url 'etiquettes_pro:template_list' %}" class="theme-button-secondary text-sm px-3 py-1.5 flex items-center">
                    <i class="fas fa-file-alt mr-2"></i> Modèles d'étiquettes
                </a>
                <a href="{% url 'etiquettes_pro:template_create' %}" class="theme-button-primary text-sm px-3 py-1.5 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Créer un modèle
                </a>
                <a href="{% url 'etiquettes_pro:etiquette_list' %}" class="theme-button-secondary text-sm px-3 py-1.5 flex items-center">
                    <i class="fas fa-tags mr-2"></i> Mes étiquettes
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div id="stats-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 lg:mb-8">
        <!-- Total étiquettes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 transition-all duration-300 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-tags text-lg sm:text-xl"></i>
                </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Total étiquettes</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-blue-600">{{ etiquettes_count|default:0 }}</p>
                </div>
            </div>
        </div>
                </div>

        <!-- Templates -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-purple-100 to-purple-200 text-purple-600 transition-all duration-300 group-hover:from-purple-500 group-hover:to-purple-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-file-alt text-lg sm:text-xl"></i>
                </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Templates</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-purple-600">{{ templates_count|default:0 }}</p>
            </div>
        </div>
                </div>
                </div>

        <!-- Prêtes -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-check-circle text-lg sm:text-xl"></i>
            </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Prêtes</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ etiquettes_ready|default:0 }}</p>
        </div>
                </div>
                </div>
            </div>

        <!-- Imprimées -->
        <div class="group bg-white rounded-xl shadow-lg p-3 sm:p-4 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 h-full flex flex-col" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between flex-grow">
                <div class="flex items-center flex-grow">
                    <div class="p-2 sm:p-3 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110 flex-shrink-0">
                        <i class="fas fa-print text-lg sm:text-xl"></i>
                    </div>
                    <div class="ml-2 sm:ml-3 flex-grow">
                        <p class="text-xs font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Imprimées</p>
                        <p class="text-xl sm:text-2xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ etiquettes_printed|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Étiquettes avec pagination intelligente -->
    {% if all_etiquettes_with_commandes %}
    <div class="info-section mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
        <h3 class="section-title">
                    <i class="fas fa-tags" style="color: var(--preparation-success);"></i>
                    Étiquettes des Commandes Confirmées
        </h3>
                <p class="text-sm text-gray-600 mt-1">
                    Seules les étiquettes des commandes confirmées avec des articles dans le panier sont affichées
                </p>
            </div>
            <div class="flex items-center space-x-2">
                <span id="etiquettes-count" class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">{{ total_count|default:0 }}</span>
                <button id="refresh-etiquettes" class="theme-button-secondary text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>Actualiser
                </button>
            </div>
        </div>
        
        <!-- Barre d'outils de sélection multiple -->
        <div id="bulk-actions-toolbar" class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        <span id="selected-count">0</span> étiquette(s) sélectionnée(s)
                    </span>
                    <div class="flex items-center space-x-2">
                        <button id="select-all-btn" class="theme-button-secondary text-sm">
                            <i class="fas fa-check-square mr-1"></i>Tout sélectionner
                        </button>
                        <button id="deselect-all-btn" class="theme-button-secondary text-sm">
                            <i class="fas fa-square mr-1"></i>Tout désélectionner
                        </button>
                    </div>
                </div>
                    <div class="flex items-center space-x-2">
                        <button id="bulk-print-btn" class="theme-button-primary">
                            <i class="fas fa-print mr-2"></i>Impression multiple
                        </button>
                        <button id="bulk-qr-details-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                            <i class="fas fa-qrcode mr-2"></i>QR Articles Détails
                        </button>
                        <button id="bulk-qr-simple-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                            <i class="fas fa-qrcode mr-2"></i>QR Articles Simples
                        </button>
                        <button id="bulk-delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                            <i class="fas fa-trash mr-2"></i>Supprimer multiple
                        </button>
                </div>
            </div>
        </div>
        
        <!-- Version mobile/tablette : Cartes -->
        <div class="block lg:hidden space-y-3 mb-4">
            {% for item in all_etiquettes_with_commandes %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200">
                <!-- En-tête de la carte -->
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 font-bold text-xs">{{ item.etiquette.id }}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 text-sm">{{ item.etiquette.reference }}</h3>
                            <p class="text-xs text-gray-500">{{ item.etiquette.template.nom }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-green-600">{{ item.etiquette.reference }}</div>
                        <div class="text-xs text-gray-500">{{ item.etiquette.date_creation|date:"d/m/Y" }}</div>
                    </div>
                </div>
                
                <!-- Informations détaillées -->
                <div class="grid grid-cols-2 gap-2 mb-2 text-xs">
                    <div>
                        <span class="text-gray-500">Commande:</span>
                        <div class="font-medium">
                            {% if item.etiquette.nom_article %}
                                {{ item.etiquette.nom_article }}
                            {% elif item.etiquette.commande_id %}
                                #{{ item.etiquette.commande_id }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-500">Date:</span>
                        <div class="font-medium">{{ item.etiquette.date_creation|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                
                <!-- États -->
                <div class="flex flex-wrap gap-1 mb-2">
                    {% if item.etiquette.statut == 'ready' %}
                        <span class="px-1.5 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Prête
                        </span>
                    {% elif item.etiquette.statut == 'printed' %}
                        <span class="px-1.5 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            <i class="fas fa-print mr-1"></i>Imprimée
                        </span>
                    {% elif item.etiquette.statut == 'draft' %}
                        <span class="px-1.5 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            <i class="fas fa-edit mr-1"></i>Brouillon
                        </span>
                    {% else %}
                        <span class="px-1.5 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                            <i class="fas fa-question mr-1"></i>{{ item.etiquette.get_statut_display }}
                        </span>
                    {% endif %}
                    
                    {% if item.etat_commande %}
                        <span class="px-1.5 py-0.5 text-xs font-semibold rounded-full text-white" style="background-color: {{ item.etat_commande.enum_etat.couleur }};">
                            <i class="fas fa-tag mr-1"></i>{{ item.etat_commande.enum_etat.libelle }}
                        </span>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                    <div class="flex items-center space-x-1">
                        <input type="checkbox" class="etiquette-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" data-etiquette-id="{{ item.etiquette.id }}">
                        <span class="text-xs text-gray-500">Sélectionner</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <a href="{% url 'etiquettes_pro:etiquette_preview' item.etiquette.id %}" class="inline-flex items-center justify-center w-7 h-7 rounded-md shadow-sm text-white text-xs bg-blue-600">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'etiquettes_pro:generate_qr_codes_articles' item.etiquette.id %}" class="inline-flex items-center justify-center w-7 h-7 rounded-md shadow-sm text-white text-xs bg-green-600">
                            <i class="fas fa-qrcode"></i>
                        </a>
                        <button class="print-btn inline-flex items-center justify-center w-7 h-7 rounded-md shadow-sm text-white text-xs bg-blue-600" data-etiquette-id="{{ item.etiquette.id }}">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Contrôles du tableau -->
        <div class="hidden lg:flex justify-end mb-4">
            <button id="columnToggle" onclick="toggleColumnVisibility()" 
                    class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-300"
                    title="Sélectionner les colonnes">
                <i class="fas fa-columns mr-2 text-gray-500"></i>
                Sélectionner les colonnes
            </button>
        </div>

        <!-- Version desktop : Tableau -->
        <div class="hidden lg:block overflow-x-auto rounded-lg shadow-sm border border-gray-200 mb-4">
            <table class="w-full divide-y divide-gray-200 table-auto" id="etiquettes-table">
                <thead style="background-color: var(--preparation-primary);">
                    <tr>
                        <th class="column-selection px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 5%;">
                            <input type="checkbox" id="select-all-checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" data-target="select-all-btn">
                        </th>
                        <th class="column-reference px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 15%;">ID Commande(Id_YZ)</th>
                        <th class="column-template px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 15%;">Template</th>
                        <th class="column-commande px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 15%;">Num Ext Commande</th>
                        <th class="column-statut px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Statut</th>
                        <th class="column-etat px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 12%;">État Commande</th>
                        <th class="column-date px-2 py-3 text-left text-xs font-medium text-white uppercase tracking-wider" style="width: 10%;">Date</th>
                        <th class="column-actions px-2 py-3 text-center text-xs font-medium text-white uppercase tracking-wider" style="width: 18%;">Actions</th>
                        </tr>
                    </thead>
                <tbody id="etiquettes-tbody" class="bg-white divide-y divide-gray-200">
                    {% for item in all_etiquettes_with_commandes %}
                    <tr class="etiquette-row hover:bg-gray-50 transition-colors duration-200" data-etiquette-id="{{ item.etiquette.id }}">
                        <td class="column-selection px-2 py-3 text-sm truncate">
                            <input type="checkbox" class="etiquette-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500" data-etiquette-id="{{ item.etiquette.id }}">
                        </td>
                        <td class="column-reference px-2 py-3 text-sm font-medium text-gray-900 truncate">{{ item.etiquette.reference }}</td>
                        <td class="column-template px-2 py-3 text-sm text-gray-500 truncate">{{ item.etiquette.template.nom }}</td>
                        <td class="column-commande px-2 py-3 text-sm text-gray-500 truncate">
                            {% if item.etiquette.nom_article %}
                                {{ item.etiquette.nom_article }}
                            {% elif item.etiquette.commande_id %}
                                #{{ item.etiquette.commande_id }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="column-statut px-2 py-3 text-sm truncate">
                            <div class="flex items-center gap-2">
                                {% if item.etiquette.statut == 'ready' %}
                                    <span class="etiquette-statut px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Prête</span>
                                {% elif item.etiquette.statut == 'printed' %}
                                    <span class="etiquette-statut px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Imprimée</span>
                                {% elif item.etiquette.statut == 'draft' %}
                                    <span class="etiquette-statut px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Brouillon</span>
                                {% else %}
                                    <span class="etiquette-statut px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">{{ item.etiquette.get_statut_display }}</span>
                                {% endif %}
                                
                                <!-- Compteurs d'impressions -->
                                <div class="flex items-center gap-1 text-xs text-gray-500">
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium {% if item.etiquette.compteur_impression_ticket > 0 %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-500{% endif %}" title="Tickets imprimés">
                                        <i class="fas fa-ticket-alt mr-1"></i>{{ item.etiquette.compteur_impression_ticket }}
                                    </span>
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium {% if item.etiquette.compteur_impression_qr > 0 %}bg-purple-100 text-purple-800{% else %}bg-gray-100 text-gray-500{% endif %}" title="Codes QR imprimés">
                                        <i class="fas fa-qrcode mr-1"></i>{{ item.etiquette.compteur_impression_qr }}
                                    </span>
                                </div>
                            </div>
                        </td>
                        <td class="column-etat px-2 py-3 text-sm truncate">
                            {% if item.etat_commande %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full text-white" style="background-color: {{ item.etat_commande.enum_etat.couleur }};">
                                    {{ item.etat_commande.enum_etat.libelle }}
                                </span>
                            {% elif item.commande %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">État inconnu</span>
                                {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                    {% if item.etiquette.commande_id %}Commande non trouvée{% else %}Pas de commande{% endif %}
                                </span>
                                {% endif %}
                            </td>
                        <td class="column-date px-2 py-3 text-sm text-gray-500 truncate">{{ item.etiquette.date_creation|date:"d/m/Y H:i" }}</td>
                        <td class="column-actions px-2 py-3 text-center text-sm font-medium truncate">
                            <div class="flex items-center justify-center space-x-2">
                                <a href="{% url 'etiquettes_pro:etiquette_preview' item.etiquette.id %}" class="text-indigo-600 hover:text-indigo-900 transition-colors duration-200" title="Aperçu">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                <a href="{% url 'etiquettes_pro:generate_qr_codes_articles' item.etiquette.id %}" class="text-green-600 hover:text-green-900 transition-colors duration-200" title="QR Articles Détails">
                                    <i class="fas fa-qrcode"></i>
                                </a>
                                <a href="{% url 'etiquettes_pro:generate_qr_codes_simple' item.etiquette.id %}" class="text-gray-600 hover:text-gray-900 transition-colors duration-200" title="QR Articles Simples">
                                    <i class="fas fa-qrcode"></i>
                                </a>
                                <button class="print-btn text-blue-600 hover:text-blue-900 transition-colors duration-200" data-etiquette-id="{{ item.etiquette.id }}" title="Imprimer">
                                    <i class="fas fa-print"></i>
                                </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
        </div>
    </div>
    {% else %}
    <!-- Message si aucune étiquette -->
    <div class="info-section mb-6">
        <div class="text-center py-8">
            <div class="empty-state">
                <i class="fas fa-tags fa-3x text-gray-400 mb-3"></i>
                <h4 class="text-gray-600">Aucune étiquette trouvée</h4>
                <p class="text-gray-500 mb-4">
                    Vous n'avez pas encore créé d'étiquettes.
                </p>
                <a href="{% url 'etiquettes_pro:template_create' %}" class="theme-button-primary">
                    <i class="fas fa-plus mr-2"></i> Créer votre première étiquette
                </a>
            </div>
        </div>
    </div>
    {% endif %}


</div>

<!-- Scripts pour la pagination et recherche intelligente -->
<script src="{% static 'js/etiquettes_pro/smart-search.js' %}"></script>
    <script src="{% static 'js/etiquettes_pro/bulk-print.js' %}"></script>
    <script src="{% static 'js/etiquettes_pro/bulk-delete.js' %}"></script>
    <script src="{% static 'js/etiquettes_pro/bulk-qr-simple.js' %}"></script>
    <script src="{% static 'js/etiquettes_pro/bulk-qr-details.js' %}"></script>
    <!-- Script d'impression individuelle -->
    <script src="{% static 'js/print_etiquette.js' %}"></script>
    <!-- Script de synchronisation des statuts -->
    <script src="{% static 'js/etiquettes_pro/status-sync.js' %}"></script>

    <!-- Repositionner Accès rapide après la Recherche Intelligente -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var quick = document.getElementById('quick-access');

        if (!quick) {
            return;
        }

        // Masquer temporairement pour éviter le clignotement lors du déplacement
        var previousVisibility = quick.style.visibility;
        quick.style.visibility = 'hidden';

        function placeQuickAccessOnce() {
            var search = document.getElementById('smartSearchContainer');
            if (!search || !search.parentNode) {
                return false;
            }

            // Idempotent: ne pas déplacer si déjà bien placé
            if (search.nextSibling === quick) {
                return true;
            }

            search.parentNode.insertBefore(quick, search.nextSibling);
            return true;
        }

        // Essai immédiat
        if (placeQuickAccessOnce()) {
            quick.style.visibility = previousVisibility || '';
            return;
        }

        // Observer l'apparition de la recherche intelligente puis déplacer une seule fois
        var observer = new MutationObserver(function(mutations, obs) {
            if (placeQuickAccessOnce()) {
                quick.style.visibility = previousVisibility || '';
                obs.disconnect();
            }
        });

        observer.observe(document.body, { childList: true, subtree: true });

        // Filet de sécurité: arrêt après 5 secondes si jamais introuvable
        setTimeout(function() {
            try { observer.disconnect(); } catch (e) {}
            quick.style.visibility = previousVisibility || '';
        }, 5000);
    });
    </script>


<!-- Script de masquage de colonnes -->
<script>
// Fonction pour masquer/afficher les colonnes
function toggleColumnVisibility() {
    const button = document.getElementById('columnToggle');
    
    // Créer le modal de sélection des colonnes
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Sélectionner les colonnes</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-3">
                <!-- Checkboxes pour chaque colonne -->
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-selection" checked>
                    <span class="ml-2 text-sm text-gray-700">Sélection</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-reference" checked>
                    <span class="ml-2 text-sm text-gray-700">Référence</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-template" checked>
                    <span class="ml-2 text-sm text-gray-700">Template</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-commande" checked>
                    <span class="ml-2 text-sm text-gray-700">Commande</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-statut" checked>
                    <span class="ml-2 text-sm text-gray-700">Statut</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-etat" checked>
                    <span class="ml-2 text-sm text-gray-700">État Commande</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-date" checked>
                    <span class="ml-2 text-sm text-gray-700">Date</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" class="column-checkbox" data-column="column-actions" checked>
                    <span class="ml-2 text-sm text-gray-700">Actions</span>
                </label>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                    Annuler
                </button>
                <button onclick="applyColumnVisibility(this.closest('.fixed'))" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                    Appliquer
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    loadColumnVisibility();
}

// Charger l'état actuel des colonnes
function loadColumnVisibility() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    const checkboxes = document.querySelectorAll('.column-checkbox');
    
    checkboxes.forEach(checkbox => {
        const column = checkbox.dataset.column;
        checkbox.checked = !hiddenColumns.includes(column);
    });
}

// Appliquer la visibilité des colonnes
function applyColumnVisibility(modal) {
    const checkboxes = modal.querySelectorAll('.column-checkbox');
    const hiddenColumns = [];
    
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            hiddenColumns.push(checkbox.dataset.column);
        }
    });
    
    // Sauvegarder dans localStorage
    localStorage.setItem('hiddenColumns', JSON.stringify(hiddenColumns));
    
    // Appliquer la visibilité
    updateColumnVisibility(hiddenColumns);
    
    // Fermer le modal
    modal.remove();
}

// Mettre à jour la visibilité des colonnes
function updateColumnVisibility(hiddenColumns) {
    // Liste des colonnes disponibles
    const columns = [
        'column-selection', 'column-reference', 'column-template', 'column-commande', 
        'column-statut', 'column-etat', 'column-date', 'column-actions'
    ];
    
    columns.forEach(column => {
        const elements = document.querySelectorAll(`.${column}`);
        elements.forEach(element => {
            if (hiddenColumns.includes(column)) {
                element.style.display = 'none';
            } else {
                element.style.display = '';
            }
        });
    });
}

// Charger la visibilité des colonnes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const hiddenColumns = JSON.parse(localStorage.getItem('hiddenColumns') || '[]');
    updateColumnVisibility(hiddenColumns);
});
</script>

<!-- Script de pagination intelligente pour le tableau dashboard -->
<script>
// ================== PAGINATION INTELLIGENTE POUR TABLEAU DASHBOARD ==================

// Variables globales pour la pagination du tableau
let currentPage = 1;
let itemsPerPage = 12;  // 12 éléments par page par défaut
let totalItems = 0;
let allRows = [];
let filteredRows = [];

// Initialisation de la pagination du tableau
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 [DASHBOARD ÉTIQUETTES] Initialisation de la pagination du tableau');
    
    // Délai pour s'assurer que tous les éléments sont chargés
    setTimeout(() => {
        initializeTablePagination();
    }, 100);
});

// Initialiser la pagination du tableau
function initializeTablePagination() {
    console.log('🔧 [PAGINATION-TABLEAU] Initialisation de la pagination intelligente');
    
    // Collecter toutes les lignes du tableau
    collectAllRows();
    
    // Vérifier s'il y a des éléments à paginer
    if (allRows.length === 0) {
        console.log('⚠️ [PAGINATION-TABLEAU] Aucune ligne trouvée pour la pagination');
        return;
    }
    
    console.log(`✅ [PAGINATION-TABLEAU] ${totalItems} lignes collectées`);
    
    // Créer les contrôles de pagination
    createTablePaginationControls();
    
    // Afficher la première page
    showTablePage(1);
}

// Collecter toutes les lignes du tableau
function collectAllRows() {
    console.log('🔍 [PAGINATION-TABLEAU] Collecte des lignes...');
    
    const rows = document.querySelectorAll('.etiquette-row');
    allRows = Array.from(rows).map((row, index) => {
        return {
            element: row,
            index: index,
            reference: row.querySelector('.etiquette-reference')?.textContent?.trim() || '',
            template: row.querySelector('.etiquette-template')?.textContent?.trim() || '',
            commande: row.querySelector('.etiquette-commande')?.textContent?.trim() || '',
            date: row.querySelector('.etiquette-date')?.textContent?.trim() || '',
            statut: row.querySelector('.etiquette-statut')?.textContent?.trim() || ''
        };
    });
    
    totalItems = allRows.length;
    filteredRows = [...allRows];
    
    console.log(`📊 [PAGINATION-TABLEAU] ${totalItems} lignes collectées`);
}

// Créer les contrôles de pagination pour le tableau
function createTablePaginationControls() {
    // Vérifier si les contrôles existent déjà
    if (document.getElementById('tablePaginationControls')) {
        return;
    }
    
    console.log('🎛️ [PAGINATION-TABLEAU] Création des contrôles de pagination');
    
    // Créer le conteneur de pagination avec le thème uniforme
    const paginationContainer = document.createElement('div');
    paginationContainer.id = 'tablePaginationControls';
    paginationContainer.className = 'flex items-center justify-between mt-6 px-6 py-4 bg-white rounded-xl shadow-lg border border-gray-200';
    
    // Informations sur les éléments
    const infoContainer = document.createElement('div');
    infoContainer.className = 'flex items-center text-sm text-gray-600';
    infoContainer.innerHTML = `
        <i class="fas fa-info-circle mr-2 text-gray-500"></i>
        <span id="tablePaginationInfo">Affichage de 1 à ${Math.min(itemsPerPage, totalItems)} sur ${totalItems} étiquettes</span>
    `;
    
    // Contrôles de pagination
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'flex items-center space-x-2';
    
    // Bouton précédent
    const prevButton = document.createElement('button');
    prevButton.id = 'tablePrevPage';
    prevButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100 hover:border-gray-400 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors';
    prevButton.innerHTML = '<i class="fas fa-chevron-left mr-1"></i>Précédent';
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            showTablePage(currentPage - 1);
        }
    });
    
    // Numéros de page
    const pageNumbersContainer = document.createElement('div');
    pageNumbersContainer.id = 'tablePageNumbers';
    pageNumbersContainer.className = 'flex items-center space-x-1';
    
    // Bouton suivant
    const nextButton = document.createElement('button');
    nextButton.id = 'tableNextPage';
    nextButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100 hover:border-gray-400 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors';
    nextButton.innerHTML = 'Suivant<i class="fas fa-chevron-right ml-1"></i>';
    nextButton.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
        if (currentPage < totalPages) {
            showTablePage(currentPage + 1);
        }
    });
    
    // Séparateur
    const separator = document.createElement('div');
    separator.className = 'mx-2 text-gray-400';
    separator.innerHTML = '|';
    
    // Sélecteur d'éléments par page
    const itemsPerPageSelect = document.createElement('select');
    itemsPerPageSelect.id = 'tableItemsPerPageSelect';
    itemsPerPageSelect.className = 'theme-input text-sm';
    itemsPerPageSelect.innerHTML = `
        <option value="6">6 par page</option>
        <option value="9">9 par page</option>
        <option value="12" selected>12 par page</option>
        <option value="15">15 par page</option>
        <option value="18">18 par page</option>
        <option value="21">21 par page</option>
        <option value="24">24 par page</option>
    `;
    itemsPerPageSelect.addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        showTablePage(1);
    });
    
    // Assembler les contrôles
    controlsContainer.appendChild(prevButton);
    controlsContainer.appendChild(pageNumbersContainer);
    controlsContainer.appendChild(nextButton);
    controlsContainer.appendChild(separator);
    controlsContainer.appendChild(itemsPerPageSelect);
    
    // Assembler le conteneur principal
    paginationContainer.appendChild(infoContainer);
    paginationContainer.appendChild(controlsContainer);
    
    // Insérer après le tableau (compatibilité sans .table-responsive)
    const etiquettesTable = document.getElementById('etiquettes-table');
    let insertAfterNode = null;
    if (etiquettesTable) {
        // Essayer d'insérer après le conteneur direct si existant, sinon après la table
        insertAfterNode = etiquettesTable.closest('div') || etiquettesTable;
    }

    if (insertAfterNode && insertAfterNode.parentNode) {
        insertAfterNode.parentNode.insertBefore(paginationContainer, insertAfterNode.nextSibling);
        console.log('✅ [PAGINATION-TABLEAU] Contrôles de pagination insérés');
    } else {
        console.error('❌ [PAGINATION-TABLEAU] Impossible d\'insérer les contrôles: tableau introuvable');
    }
}

// Afficher une page spécifique du tableau
function showTablePage(page) {
    const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
    
    if (page < 1 || page > totalPages) {
        return;
    }
    
    currentPage = page;
    
    console.log(`📄 [PAGINATION-TABLEAU] Affichage de la page ${page}/${totalPages}`);
    
    // Masquer toutes les lignes
    allRows.forEach(row => {
        row.element.style.display = 'none';
        row.element.style.opacity = '0';
        row.element.style.transform = 'translateY(20px)';
    });
    
    // Calculer les indices de début et fin
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredRows.length);
    
    // Afficher les lignes de la page courante
    for (let i = startIndex; i < endIndex; i++) {
        const row = filteredRows[i];
        row.element.style.display = '';
        row.element.style.opacity = '1';
        row.element.style.transform = 'translateY(0)';
    }
    
    // Mettre à jour les contrôles
    updateTablePaginationControls();
    
    // Animation d'apparition
    animateTablePageItems(startIndex, endIndex);
}

// Mettre à jour les contrôles de pagination du tableau
function updateTablePaginationControls() {
    const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredRows.length);
    
    // Mettre à jour les informations
    const infoElement = document.getElementById('tablePaginationInfo');
    if (infoElement) {
        if (filteredRows.length === 0) {
            infoElement.textContent = 'Aucune étiquette à afficher';
        } else {
            infoElement.textContent = `Affichage de ${startIndex} à ${endIndex} sur ${filteredRows.length} étiquettes`;
        }
    }
    
    // Mettre à jour les boutons précédent/suivant
    const prevButton = document.getElementById('tablePrevPage');
    const nextButton = document.getElementById('tableNextPage');
    
    if (prevButton) {
        prevButton.disabled = currentPage === 1;
    }
    if (nextButton) {
        nextButton.disabled = currentPage === totalPages || totalPages === 0;
    }
    
    // Mettre à jour les numéros de page
    updateTablePageNumbers(totalPages);
}

// Mettre à jour les numéros de page du tableau
function updateTablePageNumbers(totalPages) {
    const pageNumbersContainer = document.getElementById('tablePageNumbers');
    if (!pageNumbersContainer) return;
    
    pageNumbersContainer.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Logique de pagination intelligente
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Ajuster si on est proche de la fin
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Bouton première page
    if (startPage > 1) {
        const firstButton = createTablePageButton(1, currentPage === 1);
        pageNumbersContainer.appendChild(firstButton);
        
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-gray-500';
            ellipsis.textContent = '...';
            pageNumbersContainer.appendChild(ellipsis);
        }
    }
    
    // Pages visibles
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = createTablePageButton(i, currentPage === i);
        pageNumbersContainer.appendChild(pageButton);
    }
    
    // Bouton dernière page
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-gray-500';
            ellipsis.textContent = '...';
            pageNumbersContainer.appendChild(ellipsis);
        }
        
        const lastButton = createTablePageButton(totalPages, currentPage === totalPages);
        pageNumbersContainer.appendChild(lastButton);
    }
}

// Créer un bouton de page pour le tableau
function createTablePageButton(pageNumber, isActive) {
    const button = document.createElement('button');
    button.className = `px-3 py-1 text-sm font-medium rounded-md transition-colors ${
        isActive 
            ? 'bg-gray-800 text-white border border-gray-800' 
            : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 hover:border-gray-400'
    }`;
    button.textContent = pageNumber;
    button.addEventListener('click', () => showTablePage(pageNumber));
    return button;
}

// Animation des éléments de la page du tableau
function animateTablePageItems(startIndex, endIndex) {
    const itemsToAnimate = filteredRows.slice(startIndex, endIndex);
    
    itemsToAnimate.forEach((item, index) => {
        setTimeout(() => {
            item.element.style.transition = 'all 0.3s ease-out';
            item.element.style.opacity = '1';
            item.element.style.transform = 'translateY(0)';
        }, index * 50); // Délai progressif
    });
}

// Filtrer les lignes du tableau
function filterTableRows(filteredData) {
    console.log('🔍 [PAGINATION-TABLEAU] Filtrage des lignes');
    filteredRows = filteredData || allRows;
    currentPage = 1;
    showTablePage(1);
}

// Fonction pour réinitialiser la pagination du tableau
function resetTablePagination() {
    console.log('🔄 [PAGINATION-TABLEAU] Réinitialisation de la pagination');
    filteredRows = [...allRows];
    currentPage = 1;
    showTablePage(1);
}

// API publique pour la pagination intelligente du tableau
window.smartPaginationTable = {
    init: initializeTablePagination,
    showPage: showTablePage,
    filterRows: filterTableRows,
    resetPagination: resetTablePagination,
    getFilteredRows: () => filteredRows,
    getStats: () => ({
        currentPage: currentPage,
        totalPages: Math.ceil(filteredRows.length / itemsPerPage),
        itemsPerPage: itemsPerPage,
        totalItems: totalItems,
        filteredItems: filteredRows.length,
        startIndex: (currentPage - 1) * itemsPerPage + 1,
        endIndex: Math.min(currentPage * itemsPerPage, filteredRows.length)
    }),
    setItemsPerPage: (newItemsPerPage) => {
        itemsPerPage = newItemsPerPage;
        currentPage = 1;
        showTablePage(1);
    }
};

console.log('✅ [PAGINATION-TABLEAU] Module de pagination intelligente pour tableau chargé');
</script>


<!-- Script de débogage pour la barre d'outils -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 [DEBUG DASHBOARD] DOM chargé');
    
    const toolbar = document.getElementById('bulk-actions-toolbar');
    console.log('🔍 [DEBUG DASHBOARD] Barre d\'outils trouvée:', toolbar);
    
    if (toolbar) {
        console.log('🔍 [DEBUG DASHBOARD] Classes de la barre d\'outils:', toolbar.className);
        console.log('🔍 [DEBUG DASHBOARD] Style display:', window.getComputedStyle(toolbar).display);
        console.log('🔍 [DEBUG DASHBOARD] Style visibility:', window.getComputedStyle(toolbar).visibility);
        
        // Forcer la visibilité
        toolbar.classList.remove('hidden');
        toolbar.style.display = 'block';
        toolbar.style.visibility = 'visible';
        
        console.log('🔍 [DEBUG DASHBOARD] Barre d\'outils forcée visible');
    }
    
    // Vérifier les boutons
    const printBtn = document.getElementById('bulk-print-btn');
    const deleteBtn = document.getElementById('bulk-delete-btn');
    
    console.log('🔍 [DEBUG DASHBOARD] Bouton impression:', printBtn);
    console.log('🔍 [DEBUG DASHBOARD] Bouton suppression:', deleteBtn);
    
    if (printBtn) {
        printBtn.disabled = false;
        console.log('🔍 [DEBUG DASHBOARD] Bouton impression activé');
    }
    
    if (deleteBtn) {
        deleteBtn.disabled = false;
        console.log('🔍 [DEBUG DASHBOARD] Bouton suppression activé');
    }
});
</script>

<!-- Script pour connecter le checkbox de l'en-tête avec les boutons de sélection -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 [DEBUG DASHBOARD] Initialisation des contrôles de sélection');
    
    // Récupérer les éléments
    const headerCheckbox = document.getElementById('select-all-checkbox');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const refreshBtn = document.getElementById('refresh-etiquettes');
    
    console.log('🔍 [DEBUG DASHBOARD] Éléments trouvés:', {
        headerCheckbox: !!headerCheckbox,
        selectAllBtn: !!selectAllBtn,
        deselectAllBtn: !!deselectAllBtn,
        refreshBtn: !!refreshBtn
    });
    
    // Connecter le checkbox de l'en-tête avec les boutons
    if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function() {
            console.log('🔍 [DEBUG DASHBOARD] Checkbox en-tête changé:', this.checked);
            
            if (this.checked) {
                // Simuler un clic sur "Tout sélectionner"
                if (selectAllBtn) {
                    selectAllBtn.click();
                }
            } else {
                // Simuler un clic sur "Tout désélectionner"
                if (deselectAllBtn) {
                    deselectAllBtn.click();
                }
            }
        });
    }
    
    // Gérer le bouton Actualiser
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            console.log('🔍 [DEBUG DASHBOARD] Bouton Actualiser cliqué');
            
            // Afficher un indicateur de chargement
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Actualisation...';
            this.disabled = true;
            
            // Recharger la page après un court délai
            setTimeout(() => {
                window.location.reload();
            }, 500);
        });
    }
    
    // Synchroniser l'état du checkbox de l'en-tête avec les sélections
    function syncHeaderCheckbox() {
        if (headerCheckbox) {
            const checkboxes = document.querySelectorAll('.etiquette-checkbox');
            const checkedBoxes = document.querySelectorAll('.etiquette-checkbox:checked');
            
            if (checkboxes.length === 0) {
                headerCheckbox.indeterminate = false;
                headerCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                headerCheckbox.indeterminate = false;
                headerCheckbox.checked = true;
            } else if (checkedBoxes.length > 0) {
                headerCheckbox.indeterminate = true;
                headerCheckbox.checked = false;
            } else {
                headerCheckbox.indeterminate = false;
                headerCheckbox.checked = false;
            }
        }
    }
    
    // Écouter les changements sur les checkboxes individuelles
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('etiquette-checkbox')) {
            console.log('🔍 [DEBUG DASHBOARD] Checkbox individuel changé');
            syncHeaderCheckbox();
        }
    });
    
    // Synchroniser au chargement
    syncHeaderCheckbox();
    
    console.log('✅ [DEBUG DASHBOARD] Contrôles de sélection initialisés');
    
    // Vérifier que EtiquettePrinter est disponible
});
</script>

{% block extra_js %}
{% endblock %}
{% endblock %}
