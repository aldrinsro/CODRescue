{% extends 'composant_generale/operatLogistic/base.html' %}
{% load static %}

{% block title %}Détail Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    
    .animate-fadeIn {
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    :root {
        --logistic-primary: #2563eb;
        --logistic-dark: #1d4ed8;
        --logistic-light: #dbeafe;
        --logistic-border: #3b82f6;
    }

    .sav-action-btn {
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .sav-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent" 
     data-commande-id="{{ commande.id }}"
     data-commande-id-yz="{{ commande.id_yz }}"
     data-commande-payement="{{ commande.total_cmd }}">
    <!-- En-tête avec navigation -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, var(--logistic-primary), var(--logistic-dark));">
        <div class="flex items-center space-x-4">
            <a href="{% url 'operatLogistic:liste_commandes' %}" 
               class="flex items-center px-4 py-2 bg-white text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-300 shadow-sm border border-gray-200 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>
                Retour à la liste
            </a>
            <div class="text-2xl font-bold">
                <i class="fas fa-truck mr-3" style="color: var(--logistic-light);"></i>
                Commande {{ commande.id_yz }}
            </div>
            x
        </div>
        

    </div>

    <!-- Section Actions Rapides de Livraison -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-bolt mr-2"></i>Actions Rapides de Livraison
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Statut de livraison -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-truck text-blue-600 text-xl"></i>
                    <span class="text-xs font-medium text-blue-700 px-2 py-1 bg-blue-200 rounded-full">
                        {{ commande.etat_actuel.enum_etat.libelle|default:"En cours" }}
                    </span>
                </div>
                <h3 class="font-semibold text-blue-800 mb-2">Statut Actuel</h3>
                <p class="text-sm text-blue-600">
                    {% if commande.etat_actuel %}
                        {{ commande.etat_actuel.enum_etat.libelle }}
                    {% else %}
                        En attente de traitement
                    {% endif %}
                </p>
            </div>

            <!-- Contact client -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-phone text-green-600 text-xl"></i>
                    <span class="text-xs font-medium text-green-700 px-2 py-1 bg-green-200 rounded-full">
                        Contact
                    </span>
                </div>
                <h3 class="font-semibold text-green-800 mb-2">Contact Client</h3>
                <p class="text-sm text-green-600">
                    {{ commande.client.numero_tel|default:"Non renseigné" }}
                </p>
                {% if commande.client.numero_tel %}
                    <a href="tel:{{ commande.client.numero_tel }}" 
                       class="inline-flex items-center mt-2 px-3 py-1 bg-green-600 text-white text-xs rounded-full hover:bg-green-700 transition-colors">
                        <i class="fas fa-phone mr-1"></i>Appeler
                    </a>
                {% endif %}
            </div>

            <!-- Localisation -->
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
                    <span class="text-xs font-medium text-purple-700 px-2 py-1 bg-purple-200 rounded-full">
                        {{ commande.ville.nom }}
                    </span>
                </div>
                <h3 class="font-semibold text-purple-800 mb-2">Zone de Livraison</h3>
                <p class="text-sm text-purple-600">
                    {{ commande.ville.nom }}
                    {% if commande.ville.region %}
                        <br><span class="text-xs">Région: {{ commande.ville.region.nom_region }}</span>
                    {% endif %}
                </p>
            </div>

            <!-- Valeur commande -->
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-money-bill-wave text-orange-600 text-xl"></i>
                    <span class="text-xs font-medium text-orange-700 px-2 py-1 bg-orange-200 rounded-full">
                        {{ commande.paniers.count }} articles
                    </span>
                </div>
                <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                    Valeur Totale
                    <button type="button" 
                            onclick="afficherModalValeurTotale()" 
                            class="ml-2 text-orange-600 hover:text-orange-800 transition-colors"
                            title="Voir le détail du calcul">
                        <i class="fas fa-info-circle text-sm"></i>
                    </button>
                </h3>
                <p class="text-lg font-bold text-orange-600">
                    {{ commande.total_cmd|floatformat:2 }} DH
                </p>
                <p class="text-xs text-orange-500 mt-1 flex items-center">
                    {% if commande.frais_livraison %}
                    Avec {{ commande.ville.frais_livraison|default:0|floatformat:2 }} de frais DH livraison
                    <button type="button" 
                            onclick="afficherModalFraisLivraison()" 
                            class="ml-1 text-orange-500 hover:text-orange-700 transition-colors"
                            title="Voir le détail des frais de livraison">
                        <i class="fas fa-info-circle text-xs"></i>
                    </button>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Section Timeline de Livraison -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold flex items-center" style="color: var(--logistic-primary);">
                <i class="fas fa-history mr-2"></i>Timeline de Livraison
            </h2>
            <button type="button" 
                    onclick="toggleTimeline()" 
                    class="flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200"
                    id="timeline-toggle-btn">
                <i class="fas fa-chevron-down mr-2" id="timeline-icon"></i>
                <span id="timeline-toggle-text">Masquer</span>
            </button>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 transition-all duration-300 ease-in-out" id="timeline-content">
            <div class="space-y-4">
                {% for etat in commande.etats.all|slice:":8" %}
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mt-2" 
                         style="background-color: {{ etat.enum_etat.couleur|default:'#6b7280' }};"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">{{ etat.enum_etat.libelle }}</p>
                        <p class="text-xs text-gray-500">
                            {{ etat.date_debut|date:"d/m/Y à H:i" }}
                            {% if etat.operateur %}
                                par {{ etat.operateur.nom_complet }}
                            {% endif %}
                        </p>
                        {% if etat.commentaire %}
                            <p class="text-xs text-gray-400 mt-1 italic">{{ etat.commentaire|truncatechars:80 }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 italic">Aucun historique disponible</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert mb-6 p-4 rounded-xl border-l-4 animate-slideInUp alert-dismissible
                    {% if message.tags == 'success' %}border-green-500 bg-green-50 text-green-700{% endif %}
                    {% if message.tags == 'error' %}border-red-500 bg-red-50 text-red-700{% endif %}
                    {% if message.tags == 'warning' %}border-yellow-500 bg-yellow-50 text-yellow-700{% endif %}"
             data-message-id="message-{{ forloop.counter }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="{% if message.tags == 'success' %}fas fa-check-circle{% elif message.tags == 'error' %}fas fa-exclamation-circle{% else %}fas fa-info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
                <button type="button" class="ml-4 text-gray-400 hover:text-gray-600 transition-colors" onclick="dismissMessage('message-{{ forloop.counter }}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Section 1: Informations Client -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-user mr-2"></i>Informations Client
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Nom complet -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Nom complet :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-user mr-2" style="color: var(--logistic-primary);"></i>
                    {{ commande.client.prenom }} {{ commande.client.nom }}
                </p>
            </div>
            
            <!-- Téléphone -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Téléphone :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-phone mr-2" style="color: var(--logistic-primary);"></i>
                    {{ commande.client.numero_tel|default:"Non renseigné" }}
                </p>
            </div>

            <!-- Email -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Source :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-database mr-2" style="color: var(--logistic-primary);"></i>
                            {{ commande.source }}    
                </p>
            </div>

            <!-- Ville Client (origine) -->
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <label class="block text-sm font-semibold mb-2 text-orange-600">Ville Client (origine) :</label>
                <p class="text-lg font-medium text-orange-800">
                    <i class="fas fa-home mr-2"></i>
                    {{ commande.ville_init|default:"Non spécifiée" }}
                </p>
            </div>

            <!-- Ville de livraison -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <label class="block text-sm font-semibold mb-2 text-green-600">Ville de livraison :</label>
                <p class="text-lg font-medium text-green-800">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    {{ commande.ville.nom }}
                </p>
                {% if commande.ville.region %}
                    <p class="text-sm text-green-600 mt-1">
                        <i class="fas fa-globe mr-1"></i>
                        Région : {{ commande.ville.region.nom_region }}
                    </p>
                {% endif %}
            </div>

            <!-- Frais de livraison -->
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <label class="block text-sm font-semibold mb-2 text-purple-600 flex items-center">
                    
                    Frais de livraison :
                  
                </label>
                {% if commande.frais_livraison %}
                <p class="text-lg font-medium text-purple-800">
                    <i class="fas fa-truck mr-2"></i>
                    {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH
                </p>
                {% else %}
                <p class="text-lg font-medium text-purple-800">
                    <i class="fas fa-truck mr-2"></i>
                    Non inclus dans cette commande 
                </p>
                {% endif %}
            </div>

            <!-- Adresse de livraison -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 col-span-1 md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-semibold mb-2 text-blue-600">
                    <i class="fas fa-map-marked-alt mr-2"></i>Adresse de livraison complète :
                </label>
                <p class="text-lg font-medium text-blue-800">
                    {{ commande.adresse|default:"Adresse non renseignée" }}
                </p>
            </div>
        </div>
    </div>

    <!-- Section 2: Informations Générales de la Commande -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-info-circle mr-2"></i>Informations Générales de la Commande
        </h2>
        
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             <!-- ID YZ -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">ID YZ :</label>
                 <p class="text-lg font-bold text-gray-800">
                     <i class="fas fa-barcode mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.id_yz }}
                 </p>
             </div>
             
             <!-- N° Externe -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">N° Externe :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-hashtag mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.num_cmd|default:"-" }}
                 </p>
             </div>
             
             <!-- Date de commande -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">Date de commande :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-calendar-alt mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.date_cmd|date:"d/m/Y" }}
                 </p>
             </div>

             <!-- Date de création -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">statut de paiement :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-money-bill-wave mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.payement }}
                 </p>
             </div>

             <!-- Valeur de la commande -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">Valeur de la commande :</label>
                 <p class="text-xl font-bold text-gray-800">
                     <i class="fas fa-money-bill-wave mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.total_cmd|floatformat:2 }} DH
                 </p>
             </div>

             <!-- État actuel -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">État actuel :</label>
                 <div class="flex items-center">
                     <div class="w-3 h-3 rounded-full mr-2" style="background-color: #10b981;"></div>
                     <p class="text-lg font-medium text-gray-800">
                         <i class="fas fa-truck mr-2" style="color: var(--logistic-primary);"></i>
                         {{ commande.etat_actuel.enum_etat.libelle|default:"En cours de livraison" }}
                     </p>
                 </div>
                 <p class="text-xs text-gray-600 mt-1">
                     <i class="fas fa-clock mr-1"></i>
                     {% if commande.etat_actuel %}
                         Dernière mise à jour : {{ commande.etat_actuel.date_debut|date:"d/m/Y à H:i" }}
                     {% else %}
                         État en cours de mise à jour
                     {% endif %}
                 </p>
             </div>

             <!-- Informations de livraison -->
             {% with dernier_envoi=commande.envois.last %}
             {% if dernier_envoi %}
             <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                 <label class="block text-sm font-semibold mb-2 text-blue-600">Informations de livraison :</label>
                 <div class="space-y-2">
                     <p class="text-sm text-blue-800">
                         <i class="fas fa-calendar-alt mr-2"></i>
                         Date de livraison prévue : {{ dernier_envoi.date_livraison_prevue|date:"d/m/Y" }}
                     </p>
                     
                     {% if dernier_envoi.status == 'reporte' and dernier_envoi.date_report %}
                     <div class="mt-2">
                         <p class="text-sm text-orange-800">
                             <i class="fas fa-clock mr-2"></i>
                             Reportée au : {{ dernier_envoi.date_report|date:"d/m/Y" }}
                         </p>
                         {% if dernier_envoi.motif_report %}
                         <p class="text-xs text-orange-600 mt-1">
                             <i class="fas fa-info-circle mr-1"></i>
                             Motif : {{ dernier_envoi.motif_report }}
                         </p>
                         {% endif %}
                     </div>
                     {% endif %}

                     {% if dernier_envoi.status == 'livre' %}
                     <p class="text-sm text-green-800">
                         <i class="fas fa-check-circle mr-2"></i>
                         Livrée le : {{ dernier_envoi.date_modification|date:"d/m/Y" }}
                     </p>
                     {% endif %}

                     <p class="text-xs text-gray-600 mt-1">
                         <i class="fas fa-user mr-1"></i>
                         Opérateur : {{ dernier_envoi.operateur.nom_complet|default:"Non assigné" }}
                     </p>
                 </div>
             </div>
             {% endif %}
             {% endwith %}
         </div>
    </div>

    <!-- Section 3: Articles du Panier (Lecture seule) -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6  " style="border-color: var(--logistic-border);">
        <div class="flex justify-between items-center mb-6 ">
            <h2 class="text-2xl font-bold flex items-center" style="color: var(--logistic-primary);">
            <i class="fas fa-shopping-basket mr-2"></i>Articles du Panier ({{ commande.paniers.count }} articles)
            <span class="px-3 py-1 bg-gray-100 text-gray-600 text-sm font-semibold rounded-full flex items-center ml-3">
                <i class="fas fa-lock mr-1"></i>Lecture seule
            </span>
            {% if commande.compteur > 0 %}
            <span class="px-3 py-1 bg-orange-100 text-orange-800 text-sm font-semibold rounded-full flex items-center ml-2">
                <i class="fas fa-arrow-alt-circle-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
            </span>
            {% endif %}
        </h2>
        {# Ancien bouton "Ajouter un article" supprimé #}
        </div>
        
        <!-- Avertissement pour les commandes confirmées -->
        {% if commande_confirmee %}
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <h3 class="font-semibold text-yellow-800">Commande confirmée - Impact sur le stock</h3>
                </div>
                <p class="text-sm text-yellow-700 mt-2">
                    <strong>Cette commande a déjà été confirmée et a impacté le stock.</strong> 
                    Toute modification d'articles (ajout, suppression, modification de quantité) 
                    mettra automatiquement à jour le stock des articles concernés.
                </p>
                <ul class="list-disc list-inside text-xs text-yellow-600 mt-2 space-y-1">
                    <li><strong>Ajout d'articles :</strong> Le stock sera décrémenté</li>
                    <li><strong>Suppression d'articles :</strong> Le stock sera géré par les opérateurs de préparation</li>
                    <li><strong>Augmentation de quantité :</strong> Le stock sera décrémenté pour la différence</li>
                    <li><strong>Diminution de quantité :</strong> Le stock sera géré par les opérateurs de préparation</li>
                </ul>
            </div>
                                 {% endif %}
        
        <!-- Indicateur de livraison partielle -->
        {% if commande.etat_actuel.enum_etat.libelle == 'Livrée Partiellement' %}
        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-300 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-box-open text-2xl text-green-600 mt-1"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Livraison Partielle Effectuée
                    </h3>
                    <p class="text-green-700 mb-3">
                        Cette commande a été livrée partiellement. Certains articles ont été livrés au client, 
                        tandis que d'autres ont été retournés pour traitement.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded border border-green-200">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="font-medium text-green-800">Articles Livrés</span>
                            </div>
                            <p class="text-sm text-green-700">
                                Les articles affichés ci-dessous ont été livrés au client avec les quantités indiquées.
                            </p>
                        </div>
                        <div class="bg-white p-3 rounded border border-orange-200">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-undo text-orange-600 mr-2"></i>
                                <span class="font-medium text-orange-800">Articles Retournés</span>
                            </div>
                            <p class="text-sm text-orange-700">
                                Les articles non livrés ont été transférés vers une commande de renvoi pour traitement.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Liste des articles existants -->
        <div id="articles-container" class="space-y-3 mb-6">
            {% include 'operatLogistic/partials/_articles_section.html' %}
        </div>

        <!-- Résumé total -->
        <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
            <div class="flex flex-col space-y-2">
                <!-- Ligne principale du total -->
            <div class="flex justify-between items-center">
                    <div class="text-lg font-semibold text-gray-700 flex items-center">
                    <i class="fas fa-calculator mr-2"></i>Total de la commande:
                </div>
                <div class="text-2xl font-bold" style="color: var(--logistic-primary);" id="total-commande" data-frais-livraison="{{ commande.ville.frais_livraison|default:0 }}" data-inclure-frais="{{ commande.frais_livraison|yesno:'true,false' }}" data-articles-count="{{ commande.paniers.count }}">
                    {{commande.total_cmd|floatformat:2}} DH
                    </div>
                </div>
                
                
            </div>
                        </div>
                        </div>
    
    <!-- Section Actions de Modification du Panier Client -->
    {% if commande.etat_actuel.enum_etat.libelle == 'En cours de livraison' %}
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mt-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-undo mr-2"></i>Renvoi en Préparation
        </h2>
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-200 p-4 mb-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-purple-600 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-semibold text-purple-800 mb-2">Cas d'utilisation</h3>
                    <p class="text-sm text-purple-700 mb-2">
                        Utilisez cette fonctionnalité quand le client souhaite modifier sa commande :
                    </p>
                    <ul class="text-sm text-purple-700 list-disc list-inside space-y-1">
                        <li>Ajouter un ou plusieurs articles à sa commande</li>
                        <li>Modifier les quantités d'articles existants</li>
                        <li>Supprimer des articles de sa commande</li>
                        <li>Changer d'articles</li>
                    </ul>
                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Note :</strong> La commande sera retournée aux opérateurs de préparation qui effectueront les modifications demandées par le client.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-center">
            <button onclick="openRenvoyerModal()" class="sav-action-btn" style="background-color: #8B5CF6;">
                <i class="fas fa-undo mr-2"></i>Renvoi en Préparation
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Section Actions de Livraison (SAV) -->
    {% if commande.etat_actuel.enum_etat.libelle != 'Retournée' and commande.etat_actuel.enum_etat.libelle != 'Livrée Partiellement'  %}
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mt-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-shipping-fast mr-2"></i>Actions de Livraison (SAV)
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="openSavModal('Reportée'); document.getElementById('nouvel_etat_input').value='Reportée';" class="sav-action-btn" style="background-color: #F59E0B;">
                <i class="fas fa-clock mr-2"></i>Reporter
            </button>
            <button onclick="openSavModal('Livrée'); document.getElementById('nouvel_etat_input').value='Livrée';" class="sav-action-btn" style="background-color: #10B981;">
                <i class="fas fa-check-circle mr-2"></i>Livrée
            </button>
            <button onclick="ouvrirModalLivraisonPartielle()" class="sav-action-btn" style="background-color: #3B82F6;">
                <i class="fas fa-box-open mr-2"></i>Livraison Partielle
            </button>
            <button onclick="openSavModal('Retournée'); document.getElementById('nouvel_etat_input').value='Retournée';" class="sav-action-btn" style="background-color: #EF4444;">
                <i class="fas fa-times-circle mr-2"></i>Retournée
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Modale de Confirmation SAV -->
    <div id="savModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="savModalTitle">Mettre à jour l'état</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="savForm" action="{% url 'operatLogistic:changer_etat_sav' commande.id %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="nouvel_etat" id="nouvel_etat_input">
                        <div class="text-left">
                            <!-- Champ date de report (caché par défaut) -->
                            <div id="dateReportDiv" class="mb-4 hidden">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Date de report de la commande</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label for="date_report" class="block text-sm font-medium text-gray-700">
                                        Nouvelle date de livraison pour tous les articles
                                    </label>
                                    <input type="date" 
                                           name="date_report" 
                                           id="date_report"
                                           class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                           required>
                                    <p class="mt-2 text-sm text-gray-500">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Cette date sera appliquée à tous les articles de la commande
                                    </p>
                                    <!-- Résumé des articles -->
                                    <div class="mt-4 border-t border-gray-200 pt-4">
                                        <p class="text-sm font-medium text-gray-700 mb-2">Articles concernés :</p>
                                        <ul class="space-y-2">
                                        {% for panier in commande.paniers.all %}
                                            <li class="text-sm text-gray-600">
                                                <i class="fas fa-box mr-2"></i>
                                                {{ panier.article.nom }}
                                                {% if panier.variante %}
                                                    -
                                                    {% if panier.variante.couleur %}{{ panier.variante.couleur.nom }}{% endif %}
                                                    {% if panier.variante.pointure %}{% if panier.variante.couleur %} / {% endif %}{{ panier.variante.pointure.pointure }}{% endif %}
                                                    {% if panier.variante.taille %}{% if panier.variante.couleur or panier.variante.pointure %} / {% endif %}{{ panier.variante.taille }}{% endif %}
                                                    {% if panier.variante.modele %}{% if panier.variante.couleur or panier.variante.pointure or panier.variante.taille %} / {% endif %}{{ panier.variante.modele }}{% endif %}
                                                    {% if panier.variante.matiere %}{% if panier.variante.couleur or panier.variante.pointure or panier.variante.taille or panier.variante.modele %} / {% endif %}{{ panier.variante.matiere }}{% endif %}
                                                {% endif %}
                                                {% if panier.article.reference %}
                                                    <span class="text-xs text-gray-500">(Réf: {{ panier.article.reference }})</span>
                                                {% endif %}
                                                <span class="text-xs text-gray-500 ml-2">Quantité: {{ panier.quantite }}</span>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Champ date de livraison (caché par défaut) -->
                            <div id="dateLivraisonDiv" class="mb-4 hidden">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Date de livraison</h3>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <label for="date_livraison" class="block text-sm font-medium text-gray-700">
                                        <i class="fas fa-calendar-check mr-1 text-green-600"></i>
                                        Date de livraison effective
                                    </label>
                                    <input type="date" 
                                           name="date_livraison" 
                                           id="date_livraison"
                                           class="w-full mt-2 p-2 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500"
                                           required>
                                    <p class="mt-2 text-sm text-gray-600">
                                        <i class="fas fa-info-circle mr-1 text-green-600"></i>
                                        Veuillez indiquer la date à laquelle la commande a été effectivement livrée
                                    </p>
                                </div>
                            </div>

                            <label for="commentaire" class="text-sm font-medium text-gray-700">Commentaire (obligatoire)</label>
                            <select name="commentaire" id="commentaire" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">Sélectionner un commentaire...</option>
                                <optgroup label="Livraison" class="optgroup-livraison" style="display: none;">
                                    <option value="Commande livrée avec succès">Commande livrée avec succès</option>
                                    <option value="Livraison effectuée dans les délais">Livraison effectuée dans les délais</option>
                                    <option value="Client satisfait de la livraison">Client satisfait de la livraison</option>
                                </optgroup>
                                <optgroup label="Problèmes de qualité" class="optgroup-problemes">
                                    <option value="Article défectueux détecté">Article défectueux détecté</option>
                                    <option value="Problème de qualité signalé par le client">Problème de qualité signalé par le client</option>
                                    <option value="Article endommagé lors du transport">Article endommagé lors du transport</option>
                                    <option value="Défaut de fabrication constaté">Défaut de fabrication constaté</option>
                                </optgroup>
                                <optgroup label="Retours et échanges" class="optgroup-retours">
                                    <option value="Retour demandé par le client">Retour demandé par le client</option>
                                    <option value="Échange de taille demandé">Échange de taille demandé</option>
                                    <option value="Échange de couleur demandé">Échange de couleur demandé</option>
                                    <option value="Article non conforme à la commande">Article non conforme à la commande</option>
                                </optgroup>
                                <optgroup label="Communication client" class="optgroup-communication">
                                    <option value="Client non joignable">Client non joignable</option>
                                    <option value="Adresse de livraison incorrecte">Adresse de livraison incorrecte</option>
                                    <option value="Client absent au moment de la livraison">Client absent au moment de la livraison</option>
                                    <option value="Refus de livraison par le client">Refus de livraison par le client</option>
                                </optgroup>
                                <optgroup label="Autres" class="optgroup-autres">
                                    <option value="Demande spéciale du client">Demande spéciale du client</option>
                                    <option value="Modification de commande demandée">Modification de commande demandée</option>
                                    <option value="Urgence signalée par le client">Urgence signalée par le client</option>
                                    <option value="Autre motif - voir détails">Autre motif - voir détails</option>
                                </optgroup>
                            </select>
                            <!-- Champ de commentaire personnalisé (masqué par défaut) -->
                            <div id="commentairePersonnalise" class="mt-2 hidden">
                                <label for="commentaireCustom" class="text-sm font-medium text-gray-700">Commentaire personnalisé</label>
                                <textarea name="commentaireCustom" id="commentaireCustom" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Décrivez le problème ou la situation..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmSavBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Confirmer la mise à jour
                    </button>
                    <button id="cancelSavBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de Livraison Partielle -->
    <div id="livraisonPartielleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-box-open mr-3 text-blue-600"></i>
                        Livraison Partielle - Commande {{ commande.id_yz }}
                    </h3>
                    <button onclick="fermerModalLivraisonPartielle()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Instructions :</strong> Sélectionnez les articles que vous allez livrer au client. 
                                Les articles non sélectionnés seront automatiquement retournés aux opérateurs de préparation 
                                pour traitement (remplacement, correction, etc.).
                            </p>
                        </div>
                    </div>
                </div>

                <form id="livraisonPartielleForm" action="{% url 'operatLogistic:livraison_partielle' commande.id %}" method="POST">
                    {% csrf_token %}
                    
                    <!-- Ces champs seront remplis dynamiquement par JavaScript juste avant la soumission -->
                    <input type="hidden" name="articles_livres" id="articlesLivresJsonInput">
                    <input type="hidden" name="articles_renvoyes" id="articlesRetournesJsonInput">
                    
                    <!-- Section Articles à Livrer -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-green-700 mb-4 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            Articles à Livrer au Client
                        </h4>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="articlesALivrerContainer">
                                {% for panier in commande.paniers.all %}
<!-- Panier {{ panier.id }}: {{ panier.article.nom }} - Prix: {{ panier.prix_actuel_pour_affichage|default:panier.article.prix_unitaire }} DH -->
                                <div class="article-livraison-card bg-white rounded-lg border border-green-300 p-4 hover:border-green-400 transition-colors"
                                     data-panier-id="{{ panier.id }}"
                                     data-article-id="{{ panier.article.id }}"
                                     data-variante-id="{% if panier.variante %}{{ panier.variante.id }}{% endif %}"
                                     data-article-nom="{{ panier.article.nom }}"
                                     data-is-upsell="{{ panier.article.isUpsell|yesno:'true,false' }}"
                                     data-compteur="{{ commande.compteur }}"
                                     data-prix-unitaire="{{ panier.article.prix_unitaire }}"
                                     data-prix-actuel="{{ panier.prix_actuel_pour_affichage|default:panier.article.prix_unitaire }}"
                                     data-quantite-max="{{ panier.quantite }}"
                                     data-sous-total="{{ panier.sous_total }}">
                                    <div class="flex items-start space-x-3">
                                        <input type="checkbox" 
                                               id="livrer_{{ panier.id }}" 
                                               class="article-livrer-checkbox h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-1"
                                               data-panier-id="{{ panier.id }}"
                                               checked>
                                        <div class="flex-1">
                                            <label for="livrer_{{ panier.id }}" class="cursor-pointer">
                                                <div class="font-medium text-gray-900">
                                                    {{ panier.article.nom }}
                                                    {% if panier.article.isUpsell and commande.compteur > 0 %}
                                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700 ml-2">
                                                            <i class="fas fa-arrow-up mr-1"></i>Upsell Niv.{{ commande.compteur }}
                                                        </span>
                                                    {% endif %}
                                                    {% if panier.variante %}
                                                        <br><small class="text-gray-600">
                                                        {% if panier.variante.couleur %}{{ panier.variante.couleur.nom }}{% endif %}
                                                        {% if panier.variante.pointure %}{% if panier.variante.couleur %} / {% endif %}{{ panier.variante.pointure.pointure }}{% endif %}
                                                        {% if panier.variante.taille %}{% if panier.variante.couleur or panier.variante.pointure %} / {% endif %}{{ panier.variante.taille }}{% endif %}
                                                        {% if panier.variante.modele %}{% if panier.variante.couleur or panier.variante.pointure or panier.variante.taille %} / {% endif %}{{ panier.variante.modele }}{% endif %}
                                                        {% if panier.variante.matiere %}{% if panier.variante.couleur or panier.variante.pointure or panier.variante.taille or panier.variante.modele %} / {% endif %}{{ panier.variante.matiere }}{% endif %}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    {% if panier.article.reference %}
                                                        Réf: {{ panier.article.reference }}<br>
                                                    {% endif %}
                                                    {% if panier.variante %}
                                                        {% if panier.variante.couleur %}
                                                        Couleur: {{ panier.variante.couleur }}<br>
                                                        {% endif %}
                                                        {% if panier.variante.pointure %}
                                                        Pointure: {{ panier.variante.pointure }}<br>
                                                        {% endif %}
                                                        {% if panier.variante.taille %}
                                                        Taille: {{ panier.variante.taille }}<br>
                                                        {% endif %}
                                                        {% if panier.variante.modele %}
                                                        Modèle: {{ panier.variante.modele }}<br>
                                                        {% endif %}
                                                        {% if panier.variante.matiere %}
                                                        Matière: {{ panier.variante.matiere }}<br>
                                                        {% endif %}
                                                    {% endif %}
                                                     <div class="flex justify-between items-center mt-1">
                                                         <span>Prix unitaire: {% if commande.compteur > 0 and panier.article.isUpsell %}{% if commande.compteur == 1 and panier.article.prix_upsell_1 %}{{ panier.article.prix_upsell_1|floatformat:2 }}{% elif commande.compteur == 2 and panier.article.prix_upsell_2 %}{{ panier.article.prix_upsell_2|floatformat:2 }}{% elif commande.compteur == 3 and panier.article.prix_upsell_3 %}{{ panier.article.prix_upsell_3|floatformat:2 }}{% elif commande.compteur >= 4 and panier.article.prix_upsell_4 %}{{ panier.article.prix_upsell_4|floatformat:2 }}{% else %}{{ panier.article.prix_unitaire|floatformat:2 }}{% endif %}{% else %}{{ panier.article.prix_unitaire|floatformat:2 }}{% endif %} DH{% if commande.compteur > 0 and panier.article.isUpsell %}<small class="ml-1 text-green-600">(Niveau {{ commande.compteur }})</small>{% endif %}</span>
                                                         <span class="font-medium text-blue-600">Sous-total: {{ panier.sous_total|floatformat:2 }} DH</span>
                                                     </div>
                                                </div>
                                            </label>
                                            <div class="mt-3">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                                    Quantité à livrer:
                                                </label>
                                                <input type="number" 
                                                       min="1" 
                                                       max="{{ panier.quantite }}" 
                                                       value="{{ panier.quantite }}"
                                                       class="quantite-livrer-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                       data-panier-id="{{ panier.id }}">
                                                <div class="text-xs text-gray-500 mt-1">
                                                    Max: {{ panier.quantite }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Section Articles à Renvoyer -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-orange-700 mb-4 flex items-center">
                            <i class="fas fa-undo mr-2"></i>
                            Articles à Retourner
                        </h4>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="articlesARenvoyerContainer">
                                <!-- Les articles non sélectionnés apparaîtront ici dynamiquement -->
                                <!-- Pour chaque article à retourner, on ajoute un champ select pour l'état -->
                            </div>
                            <div id="aucunArticleRenvoyer" class="text-center py-8 text-gray-500">
                                <i class="fas fa-info-circle text-2xl mb-2"></i>
                                <p>Aucun article à retourner. Tous les articles seront livrés.</p>
                            </div>
                            
                        </div>
                    </div>

                    <!-- Résumé -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>
                            Résumé de la Livraison Partielle
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="totalArticlesLivres">0</div>
                                <div class="text-sm text-gray-600">Articles à livrer</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600" id="totalArticlesRenvoyes">0</div>
                                <div class="text-sm text-gray-600">Articles à retourner</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalValeurLivree">0.00 DH</div>
                                <div class="text-sm text-gray-600">Valeur livrée</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="totalValeurRenvoyee">0.00 DH</div>
                                <div class="text-sm text-gray-600">Valeur retournée</div>
                            </div>
                            {% if commande.frais_livraison and commande.ville.frais_livraison %}
                            <div class="text-center">
                                <div class="text-2xl font-bold text-indigo-600" id="totalFraisLivraison">{{ commande.ville.frais_livraison|floatformat:2 }} DH</div>
                                <div class="text-sm text-gray-600">Frais de livraison</div>
                            </div>
                            {% endif %}
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600" 
                                     id="totalCommandeLivraison" 
                                     data-total-commande="{{ commande.total_cmd|stringformat:"%.2f" }}"
                                     data-frais-livraison="{{ commande.ville.frais_livraison|default:0|stringformat:"%.2f" }}"
                                     data-inclure-frais="{{ commande.frais_livraison|yesno:'true,false' }}">{{ commande.total_cmd|floatformat:2 }} DH</div>
                                <div class="text-sm text-gray-600">Total original</div>
                                {% if commande.frais_livraison and commande.ville.frais_livraison %}
                                <div class="text-xs text-gray-500">(incl. frais)</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Pourcentage de livraison -->
                        <div class="mt-4 text-center">
                            <div class="text-lg font-medium text-gray-700">
                                Pourcentage de livraison: <span id="pourcentageLivraison" class="text-blue-600 font-bold">100%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="barreProgresLivraison" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Commentaire -->
                    <div class="mb-6">
                        <label for="commentaireLivraisonPartielle" class="block text-sm font-medium text-gray-700 mb-2">
                            Commentaire sur la livraison partielle (obligatoire)
                        </label>
                        <select name="commentaire" 
                                  id="commentaireLivraisonPartielle" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required>
                            <option value="">Sélectionner un commentaire...</option>
                            <optgroup label="Problèmes de qualité">
                                <option value="Article défectueux détecté">Article défectueux détecté</option>
                                <option value="Problème de qualité signalé par le client">Problème de qualité signalé par le client</option>
                                <option value="Article endommagé lors du transport">Article endommagé lors du transport</option>
                                <option value="Défaut de fabrication constaté">Défaut de fabrication constaté</option>
                            </optgroup>
                            <optgroup label="Modifications demandées">
                                <option value="Échange de taille demandé">Échange de taille demandé</option>
                                <option value="Échange de couleur demandé">Échange de couleur demandé</option>
                                <option value="Article non conforme à la commande">Article non conforme à la commande</option>
                                <option value="Modification de commande demandée">Modification de commande demandée</option>
                            </optgroup>
                            <optgroup label="Autres">
                                <option value="Demande spéciale du client">Demande spéciale du client</option>
                                <option value="Urgence signalée par le client">Urgence signalée par le client</option>
                                <option value="Autre motif - voir détails">Autre motif - voir détails</option>
                            </optgroup>
                        </select>
                        <!-- Champ de commentaire personnalisé (masqué par défaut) -->
                        <div id="commentairePersonnaliseLivraisonPartielle" class="mt-2 hidden">
                            <label for="commentaireCustomLivraisonPartielle" class="text-sm font-medium text-gray-700">Commentaire personnalisé</label>
                            <textarea name="commentaireCustom" 
                                      id="commentaireCustomLivraisonPartielle" 
                                      rows="3" 
                                      class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                                      placeholder="Décrivez le problème ou la situation..."></textarea>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex justify-end space-x-4">
                        <button type="button" 
                                onclick="fermerModalLivraisonPartielle()" 
                                class="px-6 py-2 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-colors">
                            Annuler
                        </button>
                        <button type="submit" 
                                id="confirmerLivraisonPartielleBtn"
                                onclick="mettreAJourDonneesAvantSoumission()"
                                class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-check mr-2"></i>
                            Confirmer la Livraison Partielle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal d'ajout/modification d'articles (DÉSACTIVÉE - Mode lecture seule) -->
    <div id="addArticleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50" style="display: none !important;">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="articleModalTitle">Ajouter un article</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="articleForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Sélection d'article -->
                            <div id="article-selection-field">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                
                                <!-- Légende des badges -->
                                <div class="mb-3 p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200 shadow-sm">
                                    <div class="text-xs font-semibold text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-info-circle mr-1 text-blue-500"></i>
                                        Légende des types d'articles :
                                    </div>
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium cursor-pointer hover:bg-blue-200" 
                                              onclick="filtrerArticles('all')" id="filter-all">
                                            <i class="fas fa-search mr-1"></i>TOUS <span class="ml-1 bg-blue-200 px-1 rounded" id="count-all">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium cursor-pointer hover:bg-red-200" 
                                              onclick="filtrerArticles('promo')" id="filter-promo">
                                            <i class="fas fa-fire mr-1"></i>PROMO <span class="ml-1 bg-red-200 px-1 rounded" id="count-promo">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium cursor-pointer hover:bg-orange-200" 
                                              onclick="filtrerArticles('liquidation')" id="filter-liquidation">
                                            <i class="fas fa-tags mr-1"></i>LIQUIDATION <span class="ml-1 bg-orange-200 px-1 rounded" id="count-liquidation">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium cursor-pointer hover:bg-purple-200" 
                                              onclick="filtrerArticles('test')" id="filter-test">
                                            <i class="fas fa-flask mr-1"></i>TEST <span class="ml-1 bg-purple-200 px-1 rounded" id="count-test">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium cursor-pointer hover:bg-green-200" 
                                              onclick="filtrerArticles('upsell')" id="filter-upsell">
                                            <i class="fas fa-arrow-up mr-1"></i>UPSELL <span class="ml-1 bg-green-200 px-1 rounded" id="count-upsell">0</span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2 italic">
                                        💡 Les articles sont colorés dans la liste selon leur type pour faciliter l'identification<br>
                                        ⌨️ Raccourcis: Alt+1 (Tous), Alt+2 (Promo), Alt+3 (Liquidation), Alt+4 (Test), Alt+5 (Upsell)
                                    </div>
                                </div>
                                
                                <select id="articleSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Sélectionner un article --</option>
                                </select>
                            </div>
                            
                            <!-- Affichage du nom d'article (pour modifications) -->
                            <div id="article-display-field" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                <input type="text" id="articleDisplay" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                            </div>
                            
                            <!-- Quantité -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantité</label>
                                <input type="number" id="quantiteInput" min="1" step="1" value="1" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <!-- Informations de l'article sélectionné -->
                        <div id="article-info" class="hidden mt-4">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                    <i class="fas fa-info-circle mr-2"></i>Détails de l'article
                                </h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                                        <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-tag mr-2 text-blue-600"></i>Informations produit
                                        </h5>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Référence :</span>
                                                <span id="info-reference" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Prix actuel :</span>
                                                <span id="info-prix" class="font-bold text-green-600"></span>
                                            </div>
                                            <div class="flex justify-between border-t pt-2">
                                                <span class="text-gray-700 font-medium">Sous-total :</span>
                                                <span id="info-sous-total" class="font-bold text-blue-600 text-lg"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                                        <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-boxes mr-2 text-green-600"></i>Détails techniques
                                        </h5>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Taille :</span>
                                                <span id="info-pointure" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Couleur :</span>
                                                <span id="info-couleur" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Catégorie :</span>
                                                <span id="info-categorie" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Stock :</span>
                                                <span id="info-stock" class="font-medium text-green-600"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmerArticleBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Confirmer
                    </button>
                    <button id="annulerArticleBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

 
    <!-- Modale de confirmation livraison partielle -->
    <div id="confirmationLivraisonPartielleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-32 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-check-circle text-green-500 text-4xl mr-2"></i>
                    <span class="text-2xl font-bold text-green-700">Livraison partielle réussie !</span>
                </div>
                <div class="mb-4">
                    <div class="text-lg text-gray-800 mb-2" id="confirmation-livraison-details"></div>
                </div>
                <button id="fermerConfirmationLivraisonBtn" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors mt-2">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/OperteurSAV/modals.js' %}"></script>
<script>
// Variables globales pour les articles
let articlesDisponibles = [];
let currentArticleId = null;
let isEditingArticle = false;
let compteurCommande = {{ commande.compteur }};
let filtreActuel = 'all'; // Filtre actuellement actif
let commandeId = {{ commande.id }};

// Fonction pour calculer le prix upsell selon le compteur
function getPrixUpsell(article, compteur) {
    // Utiliser le compteur de la commande pour déterminer le prix
    const prixUnitaire = article.prix_actuel || article.prix_unitaire;
    
    if (compteur === 0) {
        // Pas d'upsell actif
        return prixUnitaire;
    } else if (compteur === 1 && article.prix_upsell_1) {
        // Niveau 1 d'upsell
        return parseFloat(article.prix_upsell_1);
    } else if (compteur === 2 && article.prix_upsell_2) {
        // Niveau 2 d'upsell
        return parseFloat(article.prix_upsell_2);
    } else if (compteur === 3 && article.prix_upsell_3) {
        // Niveau 3 d'upsell
        return parseFloat(article.prix_upsell_3);
    } else if (compteur >= 4 && article.prix_upsell_4) {
        // Niveau 4 d'upsell (pour compteur >= 4)
        return parseFloat(article.prix_upsell_4);
    }
    
    // Si pas de prix upsell défini pour ce niveau, utiliser le prix unitaire
    return prixUnitaire;
}

function remplirSelectArticles() {
    const select = document.getElementById('articleSelect');
    select.innerHTML = '<option value="">-- Sélectionner un article --</option>';
    
    // Compter les articles par type
    const counts = {
        all: 0,
        promo: 0,
        liquidation: 0,
        test: 0,
        upsell: 0
    };
    
    let articlesAffiches = 0;
    
    articlesDisponibles.forEach(article => {
        // Compter tous les articles
        counts.all++;
        
        // Compter par type
        if (article.has_promo_active || article.phase === 'PROMO') counts.promo++;
        if (article.phase === 'LIQUIDATION') counts.liquidation++;
        if (article.phase === 'EN_TEST') counts.test++;
        if (article.isUpsell) counts.upsell++;
        
        // Appliquer le filtre
        let afficher = false;
        switch (filtreActuel) {
            case 'all':
                afficher = true;
                break;
            case 'promo':
                afficher = article.has_promo_active || article.phase === 'PROMO';
                break;
            case 'liquidation':
                afficher = article.phase === 'LIQUIDATION';
                break;
            case 'test':
                afficher = article.phase === 'EN_TEST';
                break;
            case 'upsell':
                afficher = article.isUpsell;
                break;
        }
        
        if (afficher) {
            const option = document.createElement('option');
            option.value = article.id;
            
            // Construire le texte de l'option
            let optionText = article.nom || 'Article sans nom';
            
            // Ajouter les badges de statut
            const badges = [];
            if (article.has_promo_active || article.phase === 'PROMO') badges.push('🔥PROMO');
            if (article.phase === 'LIQUIDATION') badges.push('🏷️LIQUIDATION');
            if (article.phase === 'EN_TEST') badges.push('🧪TEST');
            if (article.isUpsell) badges.push('⬆️UPSELL');
            
            if (badges.length > 0) {
                optionText += ` [${badges.join(' ')}]`;
            }
            
            // Utiliser getPrixUpsell pour calculer le prix à afficher
            const prixAffiche = getPrixUpsell(article, compteurCommande);
            if (prixAffiche > 0) {
                optionText += ` - ${prixAffiche.toFixed(2)} DH`;
            }
            
            // Ajouter détails
            const details = [];
            if (article.pointure && article.pointure.trim()) {
                details.push(`T:${article.pointure}`);
            }
            if (article.couleur && article.couleur.trim()) {
                details.push(`C:${article.couleur}`);
            }
            
            if (details.length > 0) {
                optionText += ` (${details.join(', ')})`;
            }
            
            option.textContent = optionText;
            option.dataset.article = JSON.stringify(article);
            
            // Appliquer le style selon le type
            appliquerStyleOption(option, article);
            
            select.appendChild(option);
            articlesAffiches++;
        }
    });
    
    // Mettre à jour les compteurs
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-promo').textContent = counts.promo;
    document.getElementById('count-liquidation').textContent = counts.liquidation;
    document.getElementById('count-test').textContent = counts.test;
    document.getElementById('count-upsell').textContent = counts.upsell;
    
    // Mettre à jour l'apparence des filtres
    mettreAJourFiltres();
}

function appliquerStyleOption(option, article) {
    // Couleurs selon le type d'article
    if (article.has_promo_active || article.phase === 'PROMO') {
        option.style.backgroundColor = '#fee2e2';
        option.style.color = '#dc2626';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'LIQUIDATION') {
        option.style.backgroundColor = '#fed7aa';
        option.style.color = '#ea580c';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'EN_TEST') {
        option.style.backgroundColor = '#e9d5ff';
        option.style.color = '#9333ea';
        option.style.fontWeight = 'bold';
    } else if (article.isUpsell) {
        option.style.backgroundColor = '#dcfce7';
        option.style.color = '#16a34a';
        option.style.fontWeight = 'bold';
    } else {
        option.style.backgroundColor = '#f8fafc';
        option.style.color = '#374151';
    }
}

function filtrerArticles(type) {
    filtreActuel = type;
    remplirSelectArticles();
}

function mettreAJourFiltres() {
    // Réinitialiser tous les filtres
    document.querySelectorAll('[id^="filter-"]').forEach(filter => {
        filter.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
        filter.classList.add('hover:bg-blue-200');
    });
    
    // Mettre en évidence le filtre actuel
    const filtreActif = document.getElementById(`filter-${filtreActuel}`);
    if (filtreActif) {
        filtreActif.classList.add('ring-2', 'ring-blue-500', 'bg-blue-200');
        filtreActif.classList.remove('hover:bg-blue-200');
    }
}

function afficherInfosArticle(article) {
    const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
    const prixActuel = getPrixUpsell(article, compteurCommande);
    const sousTotal = (prixActuel * quantite).toFixed(2);
    
    // Informations de base
    document.getElementById('info-reference').textContent = article.reference || '-';
    document.getElementById('info-prix').textContent = `${prixActuel.toFixed(2)} DH`;
    document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    
    // Informations détaillées
    document.getElementById('info-pointure').textContent = article.pointure || 'Non spécifiée';
    document.getElementById('info-couleur').textContent = article.couleur || 'Non spécifiée';
    document.getElementById('info-categorie').textContent = article.categorie || 'Non spécifiée';
    document.getElementById('info-stock').textContent = `${article.qte_disponible || 0} unité(s)`;
    
    // Afficher la section des informations
    document.getElementById('article-info').classList.remove('hidden');
}

function rafraichirSectionArticles() {
    const container = document.getElementById('articles-container');
    container.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Chargement des articles...</p></div>';

    fetch(`/operateur-logistique/commande/{{ commande.id }}/rafraichir-articles/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                container.innerHTML = data.html;
                
                // Mettre à jour le compteur d'articles
                document.getElementById('articles-count').textContent = data.count;
                document.getElementById('articles-plural').textContent = data.count > 1 ? 's' : '';
                
                // Mettre à jour le total
                document.getElementById('total-commande').textContent = `${parseFloat(data.total).toFixed(2)} DH`;
                
                // Mettre à jour le compteur upsell global
                if (data.compteur !== undefined) {
                    compteurCommande = data.compteur;
                    console.log(`🎯 Compteur upsell mis à jour: ${compteurCommande}`);
                    
                    // Mettre à jour l'affichage du compteur dans l'interface
                    const compteurSpan = document.querySelector('.bg-orange-100');
                    if (compteurSpan) {
                        if (data.compteur > 0) {
                            compteurSpan.style.display = 'inline-flex';
                            if (data.compteur == 1) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 1';
                            } else if (data.compteur == 2) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 2';
                            } else if (data.compteur == 3) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 3';
                            } else if (data.compteur >= 4) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 4+';
                            }
                        } else {
                            compteurSpan.style.display = 'none';
                        }
                    }
                }
            } else {
                container.innerHTML = '<div class="text-center p-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Erreur lors du chargement des articles</p></div>';
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            container.innerHTML = '<div class="text-center p-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Erreur de réseau</p></div>';
        });
}

function showNotification(message, type = 'info') {
    // === CONSOLE LOG POUR ATTESTER LA NOTIFICATION ===
    console.log('🔔 [NOTIFICATION] Affichage d\'une notification:', {
        message: message,
        type: type,
        timestamp: new Date().toISOString(),
        function: 'showNotification (v1)'
    });
    
    // Créer et afficher une notification toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    
    // Permettre les retours à la ligne
    toast.style.whiteSpace = 'pre-line';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // === CONSOLE LOG POUR SUIVI DE L'AFFICHAGE ===
    console.log('📱 [NOTIFICATION] Toast ajouté au DOM:', {
        duration: type === 'warning' ? 7000 : 3000,
        timestamp: new Date().toISOString()
    });
    
    // Supprimer automatiquement après 3 secondes (plus long pour les avertissements)
    const duration = type === 'warning' ? 7000 : 3000;
    setTimeout(() => {
        console.log('🗑️ [NOTIFICATION] Suppression automatique du toast:', {
            message: message.substring(0, 50) + '...',
            timestamp: new Date().toISOString()
        });
        toast.remove();
    }, duration);
}

function showStockNotification(action, articleName, quantite, stockChange = null) {
    let message = '';
    let type = 'info';
    
    switch(action) {
        case 'ajout':
            message = `✅ Article ajouté: ${articleName}`;
            if (stockChange) {
                message += `\n📦 Stock décrémenté: -${quantite} unités`;
            }
            type = 'success';
            break;
        case 'suppression':
            message = `🗑️ Article supprimé: ${articleName}`;
            if (stockChange) {
                message += `\n📦 Article retourné en préparation`;
            }
            type = 'success';
            break;
        case 'modification':
            message = `📝 Quantité modifiée: ${articleName}`;
            if (stockChange && stockChange > 0) {
                message += `\n📦 Stock décrémenté: -${stockChange} unités`;
            } else if (stockChange && stockChange < 0) {
                message += `\n📦 Article retourné en préparation`;
            }
            type = 'success';
            break;
        case 'stock_insuffisant':
            message = `❌ Stock insuffisant pour ${articleName}`;
            if (quantite) {
                message += `\nStock demandé: ${quantite} unités`;
            }
            type = 'error';
            break;
        default:
            message = `Action effectuée: ${articleName}`;
    }
    
    showNotification(message, type);
}

function isCommandeConfirmee() {
    // Utiliser la variable définie côté serveur
    return {{ commande_confirmee|yesno:"true,false" }};
}

// ================== GESTIONNAIRES D'ÉVÉNEMENTS ==================

document.addEventListener('DOMContentLoaded', function() {
    // Gestion du select de commentaire
    const commentaireSelect = document.getElementById('commentaire');
    const commentairePersonnalise = document.getElementById('commentairePersonnalise');
    const commentaireCustom = document.getElementById('commentaireCustom');
    
    if (commentaireSelect && commentairePersonnalise && commentaireCustom) {
        commentaireSelect.addEventListener('change', function() {
            if (this.value === 'Autre motif - voir détails') {
                commentairePersonnalise.classList.remove('hidden');
                commentaireCustom.required = true;
            } else {
                commentairePersonnalise.classList.add('hidden');
                commentaireCustom.required = false;
                commentaireCustom.value = '';
            }
        });
    }
    
    // Gestion du select de commentaire pour la livraison partielle
    const commentaireLivraisonPartielleSelect = document.getElementById('commentaireLivraisonPartielle');
    const commentairePersonnaliseLivraisonPartielle = document.getElementById('commentairePersonnaliseLivraisonPartielle');
    const commentaireCustomLivraisonPartielle = document.getElementById('commentaireCustomLivraisonPartielle');
    
    if (commentaireLivraisonPartielleSelect && commentairePersonnaliseLivraisonPartielle && commentaireCustomLivraisonPartielle) {
        commentaireLivraisonPartielleSelect.addEventListener('change', function() {
            if (this.value === 'Autre motif - voir détails') {
                commentairePersonnaliseLivraisonPartielle.classList.remove('hidden');
                commentaireCustomLivraisonPartielle.required = true;
            } else {
                commentairePersonnaliseLivraisonPartielle.classList.add('hidden');
                commentaireCustomLivraisonPartielle.required = false;
                commentaireCustomLivraisonPartielle.value = '';
            }
        });
    }
    
    // Vérifier s'il y a un paramètre d'action dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const actionParam = urlParams.get('action');
    
    if (actionParam) {
        // Ouvrir automatiquement la modale appropriée selon l'action
        switch(actionParam) {
            case 'Reportée':
            case 'Livrée':
            case 'Retournée':
                openSavModal(actionParam);
                break;
            case 'Livrée Partiellement':
                ouvrirModalLivraisonPartielle();
                break;
            case 'Annulée (SAV)':
                openSavModal(actionParam);
                break;
        }
        
        // Nettoyer l'URL en supprimant le paramètre
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // Gestionnaires pour le modal SAV
    const savModal = document.getElementById('savModal');
    const cancelSavBtn = document.getElementById('cancelSavBtn');
    const confirmSavBtn = document.getElementById('confirmSavBtn');
    const savForm = document.getElementById('savForm');

    if (cancelSavBtn) {
        cancelSavBtn.addEventListener('click', function() {
            savModal.classList.add('hidden');
            savForm.reset();
            // Masquer le champ de commentaire personnalisé
            const commentairePersonnalise = document.getElementById('commentairePersonnalise');
            if (commentairePersonnalise) {
                commentairePersonnalise.classList.add('hidden');
            }
        });
    }

    if (confirmSavBtn) {
        confirmSavBtn.addEventListener('click', function() {
            // Validation du formulaire SAV
        const commentaire = document.getElementById('commentaire').value.trim();
        if (commentaire === '') {
                showNotification('⚠️ Le commentaire est obligatoire', 'warning');
            return;
        }
        
        // Si "Autre motif" est sélectionné, vérifier le commentaire personnalisé
        if (commentaire === 'Autre motif - voir détails') {
            const commentaireCustom = document.getElementById('commentaireCustom').value.trim();
            if (commentaireCustom === '') {
                showNotification('⚠️ Veuillez détailler le motif dans le commentaire personnalisé', 'warning');
                return;
            }
        }

        const etat = document.getElementById('nouvel_etat_input').value;
        if (!etat || etat.trim() === '') {
            showNotification('❌ Erreur: Nouvel état non spécifié.', 'error');
            return;
        }
        
        if (etat === 'Reportée') {
            const dateReportInput = document.getElementById('date_report');
            if (!dateReportInput.value) {
                    showNotification('⚠️ Veuillez sélectionner une date de report', 'warning');
                return;
            }
        }
        
        
            // Désactiver le bouton pour éviter les doubles soumissions
            const submitBtn = this;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement...';
            
            // Préparer les données du formulaire
            const formData = new FormData(savForm);
            
            // Debug: Vérifier la valeur du champ nouvel_etat avant envoi
            const nouvelEtatInput = document.getElementById('nouvel_etat_input');
            console.log('🔧 DEBUG avant envoi - nouvel_etat_input value:', nouvelEtatInput ? nouvelEtatInput.value : 'INTROUVABLE');
            console.log('🔧 DEBUG avant envoi - FormData nouvel_etat:', formData.get('nouvel_etat'));
            
            // Si un commentaire personnalisé est fourni, l'ajouter
            const commentaireCustom = document.getElementById('commentaireCustom');
            if (commentaireCustom && commentaireCustom.value.trim()) {
                formData.set('commentaire', commentaireCustom.value.trim());
            }
            
            // Soumettre le formulaire via AJAX
            fetch(savForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(`✅ ${data.message}`, 'success');
                    // Fermer la modale
                    document.getElementById('savModal').classList.add('hidden');
                    // Recharger la page pour afficher les changements
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                    // Réactiver le bouton
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Confirmer la mise à jour';
            }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                // Réactiver le bouton
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Confirmer la mise à jour';
            });
        });
    }

    // Gestionnaires pour le modal d'articles
    const articleModal = document.getElementById('addArticleModal');
    const annulerArticleBtn = document.getElementById('annulerArticleBtn');
    const confirmerArticleBtn = document.getElementById('confirmerArticleBtn');
    const articleSelect = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');

    if (annulerArticleBtn) {
        annulerArticleBtn.addEventListener('click', function() {
            articleModal.classList.add('hidden');
            document.getElementById('articleForm').reset();
            document.getElementById('article-info').classList.add('hidden');
        });
    }

    if (confirmerArticleBtn) {
        confirmerArticleBtn.addEventListener('click', function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (isEditingArticle) {
                // Modifier l'article
                const quantite = parseInt(quantiteInput.value);
                if (!quantite || quantite <= 0) {
                    alert('Veuillez saisir une quantité valide.');
                    return;
                }
                
                fetch(`/operateur-logistique/commande/{{ commande.id }}/modifier-quantite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'panier_id': currentArticleId,
                        'quantite': quantite
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Afficher une notification adaptée selon le statut de la commande
                        const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
                        
                        if (articleCard) {
                            try {
                                const articleData = JSON.parse(articleCard.dataset.article);
                                
                                if (isCommandeConfirmee()) {
                                    const quantiteElement = articleCard.querySelector('.text-blue-600');
                                    let quantiteActuelle = 0;
                                    if (quantiteElement) {
                                        const match = quantiteElement.textContent.match(/\d+/);
                                        quantiteActuelle = match ? parseInt(match[0]) : 0;
                                    }
                                    
                                    const difference = quantite - quantiteActuelle;
                                    showStockNotification('modification', articleData.nom, quantite, difference);
                                } else {
                                    showNotification('✅ Article modifié avec succès', 'success');
                                }
                            } catch (jsonError) {
                                console.error('Erreur de parsing JSON:', jsonError);
                                showNotification('✅ Article modifié avec succès', 'success');
                            }
                        } else {
                            showNotification('✅ Article modifié avec succès', 'success');
                        }
                        
                        rafraichirSectionArticles();
                        articleModal.classList.add('hidden');
                    } else {
                        // Vérifier si c'est une erreur de stock
                        if (data.error && data.error.includes('Stock insuffisant')) {
                            const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
                            
                            if (articleCard) {
                                try {
                                    const articleData = JSON.parse(articleCard.dataset.article);
                                    showStockNotification('stock_insuffisant', articleData.nom, quantite);
                                } catch (jsonError) {
                                    showNotification('❌ Stock insuffisant', 'error');
                                }
                            } else {
                                showNotification('❌ Stock insuffisant', 'error');
                            }
                        } else {
                            showNotification('❌ Erreur: ' + data.error, 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                });
            } else {
                // Ajouter un nouvel article
                const articleId = articleSelect.value;
                const quantite = parseInt(quantiteInput.value);
                
                if (!articleId) {
                    alert('Veuillez sélectionner un article.');
                    return;
                }
                
                if (!quantite || quantite <= 0) {
                    alert('Veuillez saisir une quantité valide.');
                    return;
                }
                
                fetch(`/operateur-logistique/commande/{{ commande.id }}/ajouter-article/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'article_id': articleId,
                        'quantite': quantite
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Afficher une notification adaptée selon le statut de la commande
                        const selectedOption = articleSelect.options[articleSelect.selectedIndex];
                        let articleData = null;
                        
                        try {
                            articleData = JSON.parse(selectedOption.dataset.article);
                        } catch (jsonError) {
                            console.error('Erreur de parsing JSON article:', jsonError);
                            showNotification('✅ Article ajouté avec succès', 'success');
                            rafraichirSectionArticles();
                            articleModal.classList.add('hidden');
                            return;
                        }
                        
                        if (isCommandeConfirmee()) {
                            showStockNotification('ajout', articleData.nom, quantite, true);
                        } else {
                            showNotification('✅ Article ajouté avec succès', 'success');
                        }
                        
                        rafraichirSectionArticles();
                        articleModal.classList.add('hidden');
                    } else {
                        // Vérifier si c'est une erreur de stock
                        if (data.error && data.error.includes('Stock insuffisant')) {
                            const selectedOption = articleSelect.options[articleSelect.selectedIndex];
                            try {
                                const articleData = JSON.parse(selectedOption.dataset.article);
                                showStockNotification('stock_insuffisant', articleData.nom, quantite);
                            } catch (jsonError) {
                                showNotification('❌ Stock insuffisant', 'error');
                            }
                        } else {
                            showNotification('❌ Erreur: ' + data.error, 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                });
            }
        });
    }

    // Gestionnaire pour le changement d'article sélectionné
    if (articleSelect) {
        articleSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const articleData = JSON.parse(selectedOption.dataset.article);
                afficherInfosArticle(articleData);
            } else {
                document.getElementById('article-info').classList.add('hidden');
            }
        });
    }

    // Gestionnaire pour le changement de quantité
    if (quantiteInput) {
        quantiteInput.addEventListener('input', function() {
            const selectedOption = articleSelect.options[articleSelect.selectedIndex];
            if (selectedOption.value) {
                const articleData = JSON.parse(selectedOption.dataset.article);
                afficherInfosArticle(articleData);
            }
        });
    }

    // Fermer la modale si on clique en dehors
    savModal.addEventListener('click', function(e) {
        if (e.target === savModal) {
            savModal.classList.add('hidden');
            savForm.reset();
        }
    });

    // Raccourcis clavier pour les filtres
    document.addEventListener('keydown', function(e) {
        if (e.altKey) {
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    filtrerArticles('all');
                    break;
                case '2':
                    e.preventDefault();
                    filtrerArticles('promo');
                    break;
                case '3':
                    e.preventDefault();
                    filtrerArticles('liquidation');
                    break;
                case '4':
                    e.preventDefault();
                    filtrerArticles('test');
                    break;
                case '5':
                    e.preventDefault();
                    filtrerArticles('upsell');
                    break;
            }
        }
    });

    // Auto-masquer les messages
    const successMessages = document.querySelectorAll('.alert-dismissible');
    successMessages.forEach(function(message, index) {
        if (message.classList.contains('bg-green-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 5000);
        }
        
        if (message.classList.contains('bg-red-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 10000);
        }
        
        if (message.classList.contains('bg-yellow-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 7000);
        }
    });
});

// Fonction pour fermer un message
function dismissMessage(messageId) {
    const message = document.querySelector(`[data-message-id="${messageId}"]`);
    if (message) {
        message.style.transition = 'all 0.5s ease-out';
        message.style.opacity = '0';
        message.style.transform = 'translateY(-20px)';
        setTimeout(function() {
            message.remove();
        }, 500);
    }
}

// Fonction pour fermer tous les messages
function dismissAllMessages() {
    const messages = document.querySelectorAll('.alert-dismissible');
    messages.forEach(function(message) {
        const messageId = message.getAttribute('data-message-id');
        dismissMessage(messageId);
    });
}

// Gestionnaire pour le formulaire SAV
document.addEventListener('DOMContentLoaded', function() {
    const savForm = document.getElementById('savDefectueuxForm');
    if (savForm) {
        savForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const articlesDefectueux = document.getElementById('articlesDefectueuxSav').value;
            const articles = JSON.parse(articlesDefectueux);
            
            if (articles.length === 0) {
                showNotification('⚠️ Veuillez sélectionner au moins un article à remplacer par un neuf', 'warning');
                return;
            }
            
            const commentaire = document.getElementById('commentaireSav').value.trim();
            if (!commentaire) {
                showNotification('⚠️ Veuillez décrire les défauts constatés et les améliorations apportées', 'warning');
                return;
            }
            
            // Afficher une notification de traitement
            showNotification('⏳ Création de la commande SAV en cours...', 'info');
            
            // Soumettre le formulaire
            const formData = new FormData(savForm);
            
            // Si un commentaire personnalisé est fourni, l'ajouter
            const commentaireCustom = document.getElementById('commentaireCustom');
            if (commentaireCustom && commentaireCustom.value.trim()) {
                formData.set('commentaire', commentaireCustom.value.trim());
            }
            
            fetch(savForm.action, {
                method: 'POST',
                body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                    showNotification(`✅ ${data.message}`, 'success');
                    fermerModalSavDefectueux();
                    // Rediriger vers la nouvelle commande SAV après 2 secondes
                    setTimeout(() => {
                        window.location.href = `/operateur-logistique/commande/${data.commande_sav_id}/`;
                    }, 2000);
            } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau lors de la création de la commande SAV', 'error');
            });
        });
    }
});

// Fonction pour afficher les notifications
function showNotification(message, type = 'info') {
    // === CONSOLE LOG POUR ATTESTER LA NOTIFICATION ===
    console.log('🔔 [NOTIFICATION] Affichage d\'une notification:', {
        message: message,
        type: type,
        timestamp: new Date().toISOString(),
        function: 'showNotification (v2)',
        location: 'operatLogistic/detail_commande.html'
    });
    
    // Créer l'élément de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // Couleurs selon le type
    const colors = {
        'success': 'bg-green-500 text-white',
        'error': 'bg-red-500 text-white',
        'warning': 'bg-yellow-500 text-white',
        'info': 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    
    // Icônes selon le type
    const icons = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="${icons[type] || icons.info} mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // === CONSOLE LOG POUR SUIVI DE L'AFFICHAGE ===
    console.log('📱 [NOTIFICATION] Notification ajoutée au DOM:', {
        message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
        type: type,
        timestamp: new Date().toISOString()
    });
    
    // Animation d'entrée
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
        console.log('✨ [NOTIFICATION] Animation d\'entrée déclenchée:', {
            timestamp: new Date().toISOString()
        });
    }, 100);
    
    // Auto-suppression après 5 secondes
    setTimeout(() => {
        console.log('⏰ [NOTIFICATION] Début de l\'animation de sortie:', {
            message: message.substring(0, 30) + '...',
            timestamp: new Date().toISOString()
        });
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                console.log('🗑️ [NOTIFICATION] Suppression définitive:', {
                    timestamp: new Date().toISOString()
                });
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// Fonction pour rafraîchir la section des articles
function rafraichirSectionArticles() {
    const container = document.getElementById('articles-container');
    if (container) {
        fetch(`/operateur-logistique/commande/{{ commande.id }}/rafraichir-articles/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.innerHTML = data.html;
                    // Mettre à jour le total affiché
                    const totalElement = document.getElementById('total-commande');
                    if (totalElement && data.total_commande !== undefined) {
                        totalElement.textContent = data.total_commande.toFixed(2) + ' DH';
                    }
        }
    })
    .catch(error => {
                console.error('Erreur lors du rafraîchissement:', error);
            });
    }
}

// Fonction pour vérifier si la commande est confirmée
function isCommandeConfirmee() {
    const statutElement = document.querySelector('[data-statut-commande]');
    return statutElement && statutElement.dataset.statutCommande === 'confirmée';
}


// Fonction pour basculer l'affichage de la timeline
function toggleTimeline() {
    const content = document.getElementById('timeline-content');
    const icon = document.getElementById('timeline-icon');
    const text = document.getElementById('timeline-toggle-text');
    const button = document.getElementById('timeline-toggle-btn');
    
    if (!content || !icon || !text || !button) {
        console.error('Éléments de timeline non trouvés');
        return;
    }
    
    // Vérifier si la timeline est actuellement visible
    const isVisible = content.style.display !== 'none' && content.style.opacity !== '0';
    
    if (isVisible) {
        // Masquer la timeline
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        setTimeout(() => {
            content.style.display = 'none';
        }, 300);
        icon.className = 'fas fa-chevron-down mr-2';
        text.textContent = 'Afficher';
        button.classList.remove('bg-gray-100', 'text-gray-700');
        button.classList.add('bg-green-100', 'text-green-700');
    } else {
        // Afficher la timeline
        content.style.display = 'block';
        content.style.opacity = '1';
        content.style.maxHeight = 'none';
        content.style.overflow = 'visible';
        icon.className = 'fas fa-chevron-up mr-2';
        text.textContent = 'Masquer';
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100', 'text-gray-700');
    }
}

// Initialiser les calculs avec frais de livraison et la timeline au chargement
document.addEventListener('DOMContentLoaded', function() {
    calculerTotalAvecLivraison();
    
    // Initialiser l'état de la timeline (ouverte par défaut)
    const content = document.getElementById('timeline-content');
    const icon = document.getElementById('timeline-icon');
    const text = document.getElementById('timeline-toggle-text');
    const button = document.getElementById('timeline-toggle-btn');
    
    if (content && icon && text && button) {
        // S'assurer que la timeline est visible par défaut
        content.style.display = 'block';
        content.style.opacity = '1';
        content.style.maxHeight = 'none';
        icon.className = 'fas fa-chevron-up mr-2';
        text.textContent = 'Masquer';
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100', 'text-gray-700');
    }
});

// ================== GESTION DE LA LIVRAISON PARTIELLE ==================

// Initialiser les données des paniers pour le JavaScript
window.currentPaniersData = [
    {% for panier in commande.paniers.all %}
    {
        id: {{ panier.id }},
        nom: "{{ panier.article.nom|escapejs }}",
        article_id: {{ panier.article.id }},
        quantite: {{ panier.quantite }},
        prix_unitaire: "{{ panier.article.prix_unitaire|stringformat:"%.2f" }}",
        prix_actuel: "{{ panier.prix_actuel_pour_affichage|default:panier.article.prix_unitaire|stringformat:"%.2f" }}",
        sous_total: "{{ panier.sous_total|stringformat:"%.2f" }}",
        reference: "{{ panier.article.reference|default:''|escapejs }}",
        compteur: {{ commande.compteur }},
        is_upsell: {{ panier.article.isUpsell|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
console.log('🔧 DEBUG: Données des paniers initialisées:', window.currentPaniersData);

// Fonctions ouvrirModalLivraisonPartielle et fermerModalLivraisonPartielle déplacées vers static/js/OperteurSAV/modals.js

function initialiserModalLivraisonPartielleTemplate() {
    console.log('DEBUG: Initialisation du modal de livraison partielle');
    
    // Initialiser les événements pour les checkboxes
    const checkboxes = document.querySelectorAll('.article-livrer-checkbox');
    console.log('DEBUG: Nombre de checkboxes trouvées:', checkboxes.length);
    checkboxes.forEach(checkbox => {
        checkbox.removeEventListener('change', handleCheckboxChange); // Éviter les doubles écouteurs
        checkbox.addEventListener('change', handleCheckboxChange);
    });
    
    // Initialiser les événements pour les inputs de quantité
    const inputs = document.querySelectorAll('.quantite-livrer-input');
    console.log('DEBUG: Nombre d\'inputs de quantité trouvés:', inputs.length);
    inputs.forEach(input => {
        input.removeEventListener('change', mettreAJourResumeLivraisonPartielle); // Éviter les doubles écouteurs
        input.removeEventListener('input', mettreAJourResumeLivraisonPartielle); // Éviter les doubles écouteurs
        input.addEventListener('change', mettreAJourResumeLivraisonPartielle);
        input.addEventListener('input', mettreAJourResumeLivraisonPartielle);
    });

    
    // Mettre à jour le résumé initial
    mettreAJourResumeLivraisonPartielle();
    console.log('DEBUG: Modal initialisé avec succès');
    
    // Ajouter un écouteur d'événements pour le champ commentaire
    const commentaireInput = document.getElementById('commentaireLivraisonPartielle');
    if (commentaireInput) {
        commentaireInput.addEventListener('input', function() {
            console.log('DEBUG: Commentaire modifié:', this.value);
            mettreAJourResumeLivraisonPartielle();
        });
    } else {
        console.error('DEBUG: Champ commentaire non trouvé');
    }
}

// Handler pour le changement de checkbox
function handleCheckboxChange() {
    const quantiteInput = document.querySelector(`.quantite-livrer-input[data-panier-id="${this.dataset.panierId}"]`);
    const etatSelect = document.querySelector(`.etat-article-renvoye[data-article-id="${this.dataset.panierId}"]`); // Utilise panierId comme articleId ici
    
    if (quantiteInput) {
        quantiteInput.disabled = !this.checked;
        if (!this.checked) {
            quantiteInput.value = quantiteInput.getAttribute('max'); // Réinitialise la quantité si décoché
        }
    }
    mettreAJourResumeLivraisonPartielle();
}

function mettreAJourResumeLivraisonPartielle() {
    console.log('DEBUG: Début de miseAJourResumeLivraisonPartielle');
    const articlesLivres = [];
    const articlesRenvoyes = [];
    let totalArticlesLivres = 0;
    let totalArticlesRenvoyes = 0;
    let totalValeurLivree = 0;
    let totalValeurRenvoyee = 0;
    
    // Pas de fallback texte: on s'appuie uniquement sur data-attributes/JSON numériques

    // Parcourir tous les articles du panier original
    document.querySelectorAll('.article-livraison-card').forEach(card => {
        const panierId = parseInt(card.dataset.panierId);
        const articleId = parseInt(card.dataset.articleId);
        const varianteId = card.dataset.varianteId ? parseInt(card.dataset.varianteId) : null;
        const articleNom = card.dataset.articleNom;
        
        // Récupérer les informations de variante depuis le DOM
        const nomElement = card.querySelector('.font-medium.text-gray-900');
        const nomCompletAvecVariante = nomElement ? nomElement.textContent.trim() : articleNom;
        
        // --- DEBUG COMPLET START ---
        console.log('=== DEBUG ARTICLE START ===');
        console.log('DEBUG LP - Card element:', card);
        console.log('DEBUG LP - Raw data-article-prix:', card.dataset.articlePrix);
        console.log('DEBUG LP - Raw data-article-prix TYPE:', typeof card.dataset.articlePrix);
        console.log('DEBUG LP - Raw data-article-prix LENGTH:', (card.dataset.articlePrix || '').length);
        console.log('DEBUG LP - Raw data-sous-total:', card.dataset.sousTotal);
        console.log('DEBUG LP - Raw data-quantite-max:', card.dataset.quantiteMax);
        console.log('DEBUG LP - Raw data-is-upsell:', card.dataset.isUpsell);
        console.log('DEBUG LP - Raw data-compteur:', card.dataset.compteur);
        console.log('DEBUG LP - Raw data-article (brut):', card.dataset.article);
        console.log('DEBUG LP - Tous les datasets du card:', card.dataset);
        
        const articlePrix = parseFloat(card.dataset.articlePrix || '0');
        const sousTotal = parseFloat(card.dataset.sousTotal || '0');
        const quantiteMax = parseInt(card.dataset.quantiteMax || '1');
        const isUpsell = card.dataset.isUpsell === 'true';
        const compteur = parseInt(card.dataset.compteur || '0');
        
        console.log('DEBUG LP - Parsed articlePrix (float):', articlePrix);
        console.log('DEBUG LP - Parsed sousTotal (float):', sousTotal);
        console.log('DEBUG LP - Parsed quantiteMax (int):', quantiteMax);
        console.log('DEBUG LP - Parsed isUpsell (bool):', isUpsell);
        console.log('DEBUG LP - Parsed compteur (int):', compteur);
        
        // Calculer le prix unitaire actuel (pas le prix de base)
        let prixUnitaire = articlePrix;
        if (prixUnitaire === 0 && sousTotal > 0 && quantiteMax > 0) {
            prixUnitaire = sousTotal / quantiteMax;
            console.log('DEBUG LP - Prix calculé depuis sous-total:', prixUnitaire);
        }
        
        // Si le prix est toujours 0, essayer de récupérer depuis les données de l'article
        if (prixUnitaire === 0) {
            console.log('ERREUR LP - Prix unitaire = 0, récupération alternative...');
            
            // Essayer de récupérer depuis data-article du card
            try {
                const articleData = JSON.parse(card.dataset.article || '{}');
                console.log('DEBUG LP - articleData récupérée:', articleData);
                
                // NOUVEAU: Toujours utiliser prix_actuel car il contient déjà le bon prix selon le contexte
                prixUnitaire = parseFloat(articleData.prix_actuel || articleData.prix_unitaire || 0);
                console.log('DEBUG LP - Prix actuel récupéré:', prixUnitaire);
                console.log('DEBUG LP - Prix unitaire de base:', articleData.prix_unitaire);
                console.log('DEBUG LP - Données upsell disponibles:', {
                    prix_upsell_1: articleData.prix_upsell_1,
                    prix_upsell_2: articleData.prix_upsell_2,
                    prix_upsell_3: articleData.prix_upsell_3,
                    prix_upsell_4: articleData.prix_upsell_4
                });
            } catch (e) {
                console.error('ERREUR LP - Impossible de parser data-article:', e);
            }
        }
        
        // Pour les articles upsell, le prix doit déjà être le prix upsell dans data-article-prix
        if (isUpsell && compteur > 0) {
            console.log('DEBUG LP - Article UPSELL détecté - Niveau:', compteur);
            console.log('DEBUG LP - Prix upsell utilisé:', prixUnitaire);
        } else {
            console.log('DEBUG LP - Article NORMAL - Prix unitaire de base:', prixUnitaire);
        }
        
        console.log('DEBUG LP - Prix unitaire final utilisé:', prixUnitaire);
        
        if (prixUnitaire === 0) {
            console.error('ERREUR CRITIQUE LP - Prix unitaire reste à 0 !');
            console.error('ERREUR CRITIQUE LP - Data attributes:', {
                articlePrix: card.dataset.articlePrix,
                sousTotal: card.dataset.sousTotal,
                quantiteMax: card.dataset.quantiteMax,
                article: card.dataset.article
            });
            
            // FALLBACK D'URGENCE: Essayer de récupérer depuis l'affichage HTML du prix
            console.log('FALLBACK - Tentative récupération depuis DOM...');
            const prixElements = card.querySelectorAll('[class*="prix"], [class*="DH"], span, div');
            prixElements.forEach((el, idx) => {
                if (el.textContent && el.textContent.includes('DH')) {
                    console.log(`FALLBACK - Element ${idx}:`, el.textContent.trim());
                }
            });
            
            // Essayer de récupérer le prix depuis le text "Prix unitaire: X.XX DH"
            // AUCUN FALLBACK DOM: si data manquante, on reste à 0 et on loggue
        }
        
        console.log('=== DEBUG ARTICLE END ===');
        // --- DEBUG COMPLET END ---
        
        const checkbox = card.querySelector('.article-livrer-checkbox');
        const quantiteInput = card.querySelector('.quantite-livrer-input');

        let quantiteLivree = 0;
        let quantiteRenvoyee = 0;
        
        if (checkbox.checked) {
            quantiteLivree = parseInt(quantiteInput.value) || 0;
            quantiteRenvoyee = quantiteMax - quantiteLivree;

            if (quantiteLivree > 0) {
                articlesLivres.push({
                    panier_id: panierId,
                    article_id: articleId,
                    variante_id: varianteId,
                    quantite: quantiteLivree,
                    nom: nomCompletAvecVariante,
                    prix_unitaire: prixUnitaire, // This should be a float
                    is_upsell: isUpsell,
                    compteur: compteur
                });
                totalArticlesLivres += quantiteLivree;
                totalValeurLivree += quantiteLivree * prixUnitaire;
            }
            
            if (quantiteRenvoyee > 0) {
                const isUpsell = card.dataset.isUpsell === 'true';
                const compteur = parseInt(card.dataset.compteur || '0');
                
                console.log('=== DEBUG ARTICLE RENVOYÉ START ===');
                console.log('DEBUG AR - Article ID:', articleId);
                console.log('DEBUG AR - Quantité renvoyée:', quantiteRenvoyee);
                console.log('DEBUG AR - Prix unitaire final:', prixUnitaire);
                console.log('DEBUG AR - Is upsell:', isUpsell);
                console.log('DEBUG AR - Compteur:', compteur);
                console.log('DEBUG AR - Nom complet:', nomCompletAvecVariante);
                console.log('=== DEBUG ARTICLE RENVOYÉ END ===');
                
                const prix = Number(prixUnitaire) || 0;
                articlesRenvoyes.push({
                    panier_id: panierId,
                    article_id: articleId,
                    variante_id: varianteId,
                    quantite: quantiteRenvoyee,
                    nom: nomCompletAvecVariante,
                    prix_unitaire: prix,
                    prix_actuel: prix,
                    is_upsell: isUpsell,
                    compteur: compteur
                });
                totalArticlesRenvoyes += quantiteRenvoyee;
                totalValeurRenvoyee += quantiteRenvoyee * prix;
            }
        } else {
            quantiteRenvoyee = quantiteMax;
            const isUpsell = card.dataset.isUpsell === 'true';
            const compteur = parseInt(card.dataset.compteur || '0');
            
            console.log('=== DEBUG ARTICLE RENVOYÉ COMPLET START ===');
            console.log('DEBUG ARC - Article ID:', articleId);
            console.log('DEBUG ARC - Quantité renvoyée (complète):', quantiteRenvoyee);
            console.log('DEBUG ARC - Prix unitaire final:', prixUnitaire);
            console.log('DEBUG ARC - Is upsell:', isUpsell);
            console.log('DEBUG ARC - Compteur:', compteur);
            console.log('DEBUG ARC - Nom complet:', nomCompletAvecVariante);
            console.log('=== DEBUG ARTICLE RENVOYÉ COMPLET END ===');
            
            const prix = Number(prixUnitaire) || 0;
            articlesRenvoyes.push({
                panier_id: panierId,
                article_id: articleId,
                variante_id: varianteId,
                quantite: quantiteRenvoyee,
                nom: nomCompletAvecVariante,
                prix_unitaire: prix,
                prix_actuel: prix,
                is_upsell: isUpsell,
                compteur: compteur
            });
            totalArticlesRenvoyes += quantiteRenvoyee;
            totalValeurRenvoyee += quantiteRenvoyee * prix;
        }
    });
    
    // --- DEBUG PRIX FINAL ---
    console.log('DEBUG LP - Final articlesLivres before send:', articlesLivres); // Log 3: Final array
    console.log('DEBUG LP - Final articlesRenvoyes before send:', articlesRenvoyes); // Log 4: Final array
    
    // --- DEBUG COMPTEUR UPSELL ---
    console.log('=== DEBUG COMPTEUR UPSELL START ===');
    
    // Calculer le total des quantités upsell qui seront livrées
    let totalQuantiteUpsellLivrees = 0;
    articlesLivres.forEach(article => {
        if (article.is_upsell) {
            totalQuantiteUpsellLivrees += article.quantite;
            console.log(`DEBUG COMPTEUR - Article livré upsell: ${article.nom}, Quantité: ${article.quantite}`);
        }
    });
    
    // Calculer le total des quantités upsell qui seront renvoyées
    let totalQuantiteUpsellRenvoyees = 0;
    articlesRenvoyes.forEach(article => {
        if (article.is_upsell) {
            totalQuantiteUpsellRenvoyees += article.quantite;
            console.log(`DEBUG COMPTEUR - Article renvoyé upsell: ${article.nom}, Quantité: ${article.quantite}`);
        }
    });
    
    const compteurActuel = parseInt(document.querySelector('[data-compteur]')?.dataset.compteur || '0');
    const nouveauCompteur = totalQuantiteUpsellLivrees >= 2 ? totalQuantiteUpsellLivrees - 1 : 0;
    
    console.log(`DEBUG COMPTEUR - Compteur actuel: ${compteurActuel}`);
    console.log(`DEBUG COMPTEUR - Total quantité upsell livrées: ${totalQuantiteUpsellLivrees}`);
    console.log(`DEBUG COMPTEUR - Total quantité upsell renvoyées: ${totalQuantiteUpsellRenvoyees}`);
    console.log(`DEBUG COMPTEUR - Nouveau compteur calculé: ${nouveauCompteur}`);
    console.log(`DEBUG COMPTEUR - Changement: ${compteurActuel} → ${nouveauCompteur}`);
    
    console.log('=== DEBUG COMPTEUR UPSELL END ===');
    // --- DEBUG PRIX FINAL ---

    // Mettre à jour les champs cachés (qui seront utilisés par le submit handler)
    document.getElementById('articlesLivresJsonInput').value = JSON.stringify(articlesLivres);
    document.getElementById('articlesRetournesJsonInput').value = JSON.stringify(articlesRenvoyes);
    
    // Gérer l'affichage de la section des articles à renvoyer
    const aucunArticleRenvoyer = document.getElementById('aucunArticleRenvoyer');
    
    if (totalArticlesRenvoyes > 0) {
        aucunArticleRenvoyer.classList.add('hidden');
    } else {
        aucunArticleRenvoyer.classList.remove('hidden');
    }
    
    // Mettre à jour l'affichage du résumé
    document.getElementById('totalArticlesLivres').textContent = totalArticlesLivres;
    document.getElementById('totalArticlesRenvoyes').textContent = totalArticlesRenvoyes;
    document.getElementById('totalValeurLivree').textContent = totalValeurLivree.toFixed(2) + ' DH';
    document.getElementById('totalValeurRenvoyee').textContent = totalValeurRenvoyee.toFixed(2) + ' DH';
    
    // Calculer et afficher le pourcentage de livraison
    const totalCommandeElement = document.getElementById('totalCommandeLivraison');
    const totalCommande = parseFloat(totalCommandeElement.dataset.totalCommande) || 0;
    const pourcentage = totalCommande > 0 ? (totalValeurLivree / totalCommande * 100) : 0;
    
    // Mettre à jour le pourcentage et la barre de progression
    const pourcentageElement = document.getElementById('pourcentageLivraison');
    const barreProgresElement = document.getElementById('barreProgresLivraison');
    
    if (pourcentageElement && barreProgresElement) {
        pourcentageElement.textContent = pourcentage.toFixed(1) + '%';
        barreProgresElement.style.width = Math.min(100, pourcentage).toFixed(1) + '%';
        
        // Changer la couleur selon le pourcentage
        if (pourcentage >= 80) {
            barreProgresElement.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
            pourcentageElement.className = 'text-green-600 font-bold';
        } else if (pourcentage >= 50) {
            barreProgresElement.className = 'bg-yellow-600 h-2 rounded-full transition-all duration-300';
            pourcentageElement.className = 'text-yellow-600 font-bold';
        } else {
            barreProgresElement.className = 'bg-red-600 h-2 rounded-full transition-all duration-300';
            pourcentageElement.className = 'text-red-600 font-bold';
        }
    }
    
    // Mettre à jour la section des articles à renvoyer
    console.log('DEBUG: Appel de mettreAJourSectionArticlesRenvoyes avec', articlesRenvoyes.length, 'articles');
    mettreAJourSectionArticlesRenvoyes(articlesRenvoyes);
    
    // Le bouton reste toujours activé
    const confirmerBtn = document.getElementById('confirmerLivraisonPartielleBtn');
    const commentaireInput = document.getElementById('commentaireLivraisonPartielle');
    
    // Suppression de la désactivation conditionnelle - le bouton reste toujours actif
    confirmerBtn.disabled = false;
    console.log('DEBUG: Fin de miseAJourResumeLivraisonPartielle - Bouton toujours activé');
}

// Fonction appelée juste avant la soumission pour s'assurer que les données sont à jour
function mettreAJourDonneesAvantSoumission() {
    console.log('🔧 DEBUG: Mise à jour des données avant soumission');
    
    // Forcer la mise à jour des données
    mettreAJourDonneesLivraison();
    
    // Vérifier que les champs sont remplis
    const articlesLivresInput = document.getElementById('articlesLivresJsonInput');
    const articlesRetournesInput = document.getElementById('articlesRetournesJsonInput');
    
    console.log('🔧 DEBUG: Articles livrés input value:', articlesLivresInput.value);
    console.log('🔧 DEBUG: Articles retournés input value:', articlesRetournesInput.value);
    
    // S'assurer qu'on a au moins des tableaux vides
    if (!articlesLivresInput.value || articlesLivresInput.value.trim() === '') {
        articlesLivresInput.value = '[]';
        console.log('⚠️ WARNING: articles_livres était vide, défini à []');
    }
    
    if (!articlesRetournesInput.value || articlesRetournesInput.value.trim() === '') {
        articlesRetournesInput.value = '[]';
        console.log('⚠️ WARNING: articles_retournes était vide, défini à []');
    }
}

// Cette fonction est maintenant gérée par modals.js avec les données du backend

// ================== SUPPRIMÉ - Gestionnaire maintenant dans modals.js ==================
// Le gestionnaire de soumission du formulaire de livraison partielle a été déplacé
// vers modals.js pour éviter les doubles exécutions


</script>
{% endblock %} 