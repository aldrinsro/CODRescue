{% extends 'composant_generale/operatLogistic/base.html' %}
{% load static %}

{% block title %}Commandes Livr√©es Partiellement - SAV - YZ-CMD{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-t√™te de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" 
         style="background: linear-gradient(to right, #3182CE, #2B6CB0);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-box-open mr-3"></i>
                Commandes Livr√©es Partiellement - SAV
            </h1>
            <p class="opacity-80">Liste des commandes avec livraison partielle</p>
        </div>
        <div class="text-right mt-4 md:mt-0">
            <div class="text-3xl font-bold">{{ commandes|length }}</div>
            <div class="text-sm opacity-80">Commandes Partiellement Livr√©es</div>
        </div>
    </div>

    <!-- Tableau des commandes -->
    <div class="overflow-x-auto mb-8 bg-white rounded-xl shadow-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: var(--logistic-primary);">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N¬∫ commande</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">T√©l√©phone</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville & R√©gion</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
                        <div class="flex items-center">
                            <i class="fas fa-box-open mr-1"></i>Articles
                            <span class="ml-1 text-xs opacity-75">(d√©tail livraison)</span>
                        </div>
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date Livraison Partielle</th>


                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Statut de paiement<th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Statut Actuel</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Op√©rateur</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Commentaire</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for commande in commandes %}
                <tr class="hover:bg-gray-50" 
                    data-commande-id="{{ commande.id }}"
                    data-articles-livres='{% if commande.articles_livres_partiellement %}[{% for article_data in commande.articles_livres_partiellement %}{"nom": "{{ article_data.nom|escapejs }}", "reference": "{{ article_data.reference|escapejs }}", "quantite_livree": {{ article_data.quantite_livree }}, "prix_unitaire": "{{ article_data.prix_unitaire|stringformat:'%.2f' }}", "pointure": "{{ article_data.pointure|default:''|escapejs }}", "couleur": "{{ article_data.couleur|default:''|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]{% else %}[]{% endif %}'
                    data-articles-retournes='{% if commande.articles_retournes.exists %}[{% for article_retourne in commande.articles_retournes.all %}{"nom": "{{ article_retourne.article.nom|escapejs }}", "reference": "{% if article_retourne.variante and article_retourne.variante.reference_variante %}{{ article_retourne.variante.reference_variante|escapejs }}{% else %}{{ article_retourne.article.reference|escapejs }}{% endif %}", "quantite": {{ article_retourne.quantite_retournee }}, "prix_unitaire": "{{ article_retourne.prix_unitaire_origine|stringformat:'%.2f' }}", "pointure": "{% if article_retourne.variante and article_retourne.variante.pointure %}{{ article_retourne.variante.pointure.pointure|escapejs }}{% endif %}", "couleur": "{% if article_retourne.variante and article_retourne.variante.couleur %}{{ article_retourne.variante.couleur.nom|escapejs }}{% endif %}", "statut": "{{ article_retourne.get_statut_retour_display|escapejs }}", "date_retour": "{{ article_retourne.date_retour|date:'d/m/Y H:i'|escapejs }}", "raison": "{{ article_retourne.raison_retour|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]{% else %}[]{% endif %}'
                    data-commentaire="{{ commande.commentaire_livraison_partielle|escapejs }}"
                    data-date-livraison="{% if commande.date_livraison_partielle %}{{ commande.date_livraison_partielle|date:'d/m/Y H:i' }}{% endif %}"
                    data-operateur="{% if commande.operateur_livraison %}{{ commande.operateur_livraison.prenom }} {{ commande.operateur_livraison.nom }}{% endif %}">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ commande.id_yz }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ commande.client.numero_tel }}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                        {% if commande.ville.region %}
                            <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-bold text-gray-900">{{ commande.total_cmd|floatformat:2 }} DH</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-shopping-cart mr-1"></i>
                                    {{ commande.paniers.count }} article{{ commande.paniers.count|pluralize }}
                                </div>
                                <div class="flex space-x-1">
                                    <button onclick="afficherPanierComplet({{ commande.id }}, '{{ commande.num_cmd }}')" 
                                            class="text-green-600 hover:text-green-800 transition-colors"
                                            title="Voir le panier complet">
                                        <i class="fas fa-shopping-bag text-sm"></i>
                                    </button>
                                    <button onclick="afficherDetailsArticles({{ commande.id }}, '{{ commande.num_cmd }}')" 
                                            class="text-blue-600 hover:text-blue-800 transition-colors"
                                            title="Voir les d√©tails de livraison partielle">
                                        <i class="fas fa-eye text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- R√©sum√© compact -->
                            <div class="text-xs text-gray-600 mt-1">
                                {% if commande.articles_livres_partiellement %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-1">
                                        <i class="fas fa-check mr-1"></i>{{ commande.articles_livres_partiellement|length }} livr√©{{ commande.articles_livres_partiellement|length|pluralize }}
                                    </span>
                                {% endif %}
                                {% if commande.articles_retournes.exists %}
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                        <i class="fas fa-undo mr-1"></i>{{ commande.articles_retournes.count }} retourn√©{{ commande.articles_retournes.count|pluralize }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if commande.Date_livraison %}
                        <div class="text-sm text-gray-900">{{ commande.Date_livraison|date:"d/m/Y" }}</div>
                        {% else %}
                            <div class="text-sm text-gray-400">-</div>
                        {% endif %}
                    </td>



                        
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if commande.payement == 'Pay√©' %}
                        <div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-money-bill-wave mr-1"></i>{{ commande.payement }}
                            </span>
                        </div>
                            <div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock mr-1"></i>{{ commande.Date_paiement|date:"d/m/Y " }}
                            </span>
                            </div>
                        {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-clock mr-1"></i>{{ commande.payement }}
                            </span>

                        {% endif %}
                    </td>

                        <td></td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if commande.etat_actuel_sav %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                    <i class="fas fa-box-open mr-1"></i>Livr√©e partiellement
                                </span>
                       
                        {% else %}
                            <div class="text-sm text-gray-400">-</div>
                        {% endif %}
                    </td>


                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if commande.etat_actuel_sav and commande.etat_actuel_sav.operateur %}
                            <div class="text-sm text-gray-900">{{ commande.etat_actuel_sav.operateur.prenom }} {{ commande.etat_actuel_sav.operateur.nom }}</div>
                            <div class="text-xs text-gray-500">{{ commande.etat_actuel_sav.operateur.mail }}</div>
                        {% else %}
                            <div class="text-sm text-gray-400">-</div>
                        {% endif %}
                    </td>


                    <td class="px-4 py-4">
                        {% if commande.etat_actuel_sav and commande.etat_actuel_sav.commentaire %}
                            <div class="text-sm text-gray-900 truncate max-w-xs" title="{{ commande.etat_actuel_sav.commentaire }}">
                                {{ commande.etat_actuel_sav.commentaire|truncatechars:50 }}
                            </div>
                        {% else %}
                            <div class="text-sm text-gray-400">Aucun commentaire</div>
                        {% endif %}
                    </td>
                    
                    <td class="px-4 py-4 whitespace-nowrap text-center">
                        <div class="flex justify-center space-x-2">
                            <a href="{% url 'operatLogistic:detail_commande' commande.id %}"
                               class="text-blue-600 hover:text-blue-900 transition-colors"
                               title="Voir le d√©tail de la commande">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button onclick="openSavActionsModal({{ commande.id }}, '{{ commande.id_yz }}')"
                                    class="text-orange-600 hover:text-orange-900 transition-colors"
                                    title="Actions SAV">
                                <i class="fas fa-tools"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                        <p>Aucune commande livr√©e partiellement trouv√©e.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination globale -->
    {% include 'operatLogistic/partials/_pagination.html' %}
</div>

<!-- Modale du Panier Complet -->
<div id="panierCompletModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-shopping-bag mr-2 text-green-600"></i>
                    Panier Complet de la Commande
                </h3>
                <p class="text-sm text-gray-600 mt-1">
                    Commande <span id="panierCommandeNumDisplay" class="font-semibold text-green-600"></span>
                </p>
            </div>
            <button onclick="fermerPanierComplet()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="panierCompletContent" class="space-y-6">
            <!-- Le contenu sera charg√© dynamiquement -->
        </div>
        
        <div class="flex justify-end mt-6 pt-4 border-t border-gray-200">
            <button onclick="fermerPanierComplet()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                <i class="fas fa-times mr-2"></i>Fermer
            </button>
        </div>
    </div>
</div>

<!-- Modale des D√©tails des Articles -->
<div id="articlesDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-box-open mr-2 text-blue-600"></i>
                    D√©tails des Articles - Livraison Partielle
                </h3>
                <p class="text-sm text-gray-600 mt-1">
                    Commande <span id="commandeNumDisplay" class="font-semibold text-blue-600"></span>
                </p>
            </div>
            <button onclick="fermerDetailsArticles()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="articlesDetailsContent" class="space-y-6">
            <!-- Le contenu sera charg√© dynamiquement -->
        </div>
        
        <div class="flex justify-end mt-6 pt-4 border-t border-gray-200">
            <button onclick="fermerDetailsArticles()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
                <i class="fas fa-times mr-2"></i>Fermer
            </button>
        </div>
    </div>
</div>

<!-- Modale des Actions SAV -->
<div id="savActionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-start mb-6">
            <div class="text-center flex-1">
            <h3 class="text-xl leading-6 font-bold text-gray-900 ">Actions de Livraison (SAV)</h3>
                <p class="text-sm text-gray-600">Commande <span id="commandeIdDisplay" class="font-semibold text-blue-600"></span></p>
            </div>
             <button onclick="fermerModalSav()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-100" title="Fermer">
                 <i class="fas fa-times text-2xl"></i>
             </button>
        </div>
        <div class="text-center">
    

                <button id="marquerPayeBtn" onclick="marquerCommePaye()" class="sav-action-card bg-green-50 hover:bg-green-100 border-2 border-green-200 hover:border-green-300 rounded-lg p-4 transition-all duration-200">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-money-bill-wave text-3xl text-green-500 mb-2"></i>
                        <span class="font-semibold text-green-800">Marquer Pay√©</span>
                        <span class="text-xs text-green-600 mt-1">Confirmer le paiement</span>
                    </div>
                </button>
            </div>

            <div class="flex justify-center">
                <button id="cancelSavActionsBtn" onclick="fermerModalSav()" class="px-6 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale SAV pour changer l'√©tat -->
<div id="savModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="savModalTitle">Mettre √† jour l'√©tat</h3>
            <div class="mt-2 px-7 py-3">
                <form id="savForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="nouvel_etat" id="nouvel_etat_input">
                    <div class="text-left">
                        <!-- Champ commentaire -->
                        <div class="mb-4">
                            <label for="commentaire" class="text-sm font-medium text-gray-700">Commentaire (obligatoire)</label>
                            <select name="commentaire" id="commentaire" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">S√©lectionner un commentaire...</option>
                                <optgroup label="Retours et √©changes" class="optgroup-retours" style="display: none;">
                                    <option value="Retour demand√© par le client">Retour demand√© par le client</option>
                                    <option value="√âchange de taille demand√©">√âchange de taille demand√©</option>
                                    <option value="√âchange de couleur demand√©">√âchange de couleur demand√©</option>
                                    <option value="Article ne correspond pas √† la commande">Article ne correspond pas √† la commande</option>
                                </optgroup>
                                <optgroup label="Probl√®mes de qualit√©" class="optgroup-problemes" style="display: none;">
                                    <option value="Article d√©fectueux d√©tect√©">Article d√©fectueux d√©tect√©</option>
                                    <option value="Probl√®me de qualit√© signal√© par le client">Probl√®me de qualit√© signal√© par le client</option>
                                    <option value="Article endommag√© lors du transport">Article endommag√© lors du transport</option>
                                    <option value="D√©faut de fabrication constat√©">D√©faut de fabrication constat√©</option>
                                </optgroup>
                                <optgroup label="Communication client" class="optgroup-communication" style="display: none;">
                                    <option value="Client insatisfait de la qualit√©">Client insatisfait de la qualit√©</option>
                                    <option value="Client demande un remboursement">Client demande un remboursement</option>
                                    <option value="Probl√®me de communication avec le client">Probl√®me de communication avec le client</option>
                                </optgroup>
                                <optgroup label="Autres motifs" class="optgroup-autres" style="display: none;">
                                    <option value="Demande sp√©ciale du client">Demande sp√©ciale du client</option>
                                    <option value="Modification de commande demand√©e">Modification de commande demand√©e</option>
                                    <option value="Autre motif - voir d√©tails">Autre motif - voir d√©tails</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Champ commentaire personnalis√© (cach√© par d√©faut) -->
                        <div id="commentairePersonnalise" class="mb-4 hidden">
                            <label for="commentaireCustom" class="text-sm font-medium text-gray-700">Commentaire personnalis√©</label>
                            <textarea name="commentaireCustom" id="commentaireCustom" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="D√©crivez le motif sp√©cifique..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelSavBtn" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                            <i class="fas fa-times mr-2"></i>Annuler
                        </button>
                        <button type="button" id="confirmSavBtn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                            <i class="fas fa-check mr-2"></i>Confirmer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modale de Confirmation pour Marquer Pay√© -->
<div id="confirmPayeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-60">
    <div class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-lg bg-white">
        <div class="text-center">
            <!-- Ic√¥ne de confirmation -->
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <i class="fas fa-money-bill-wave text-2xl text-green-600"></i>
            </div>

            <!-- Titre -->
            <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmer le Paiement</h3>

            <!-- Message -->
            <div class="mb-6">
                <p class="text-sm text-gray-500">
                    √ätes-vous s√ªr de vouloir marquer la commande
                    <span id="confirmCommandeId" class="font-semibold text-blue-600"></span>
                    comme pay√©e ?
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    Cette action mettra √† jour le statut de paiement de la commande.
                </p>
            </div>

            <!-- Champ date de paiement -->
            <div class="mb-6">
                <label for="datePaiement" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-1 text-green-600"></i>Date de paiement
                </label>
                <input type="date"
                       id="datePaiement"
                       name="datePaiement"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 transition-colors"
                       required>
                <p class="text-xs text-gray-400 mt-1">S√©lectionnez la date √† laquelle le paiement a √©t√© re√ßu</p>
            </div>

            <!-- Boutons d'action -->
            <div class="flex space-x-3 justify-center">
                <button id="confirmPayeBtn" onclick="confirmerPaiement()" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                    <i class="fas fa-check mr-2"></i>Confirmer
                </button>
                <button id="cancelPayeBtn" onclick="annulerPaiement()" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
let currentCommandeId = null;
let currentCommandeIdYz = null;
let currentCommandePayement = null;
let savedCommandeId = null; // Variable pour sauvegarder l'ID pendant la confirmation

// ================== GESTION DU SAV ==================

function openSavModal(etat, commandeId = null) {
    // Si un ID de commande est fourni, l'utiliser, sinon utiliser currentCommandeId
    if (commandeId) {
        currentCommandeId = commandeId;
    }

    // V√©rifier qu'on a un ID de commande
    if (!currentCommandeId) {
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Impossible de d√©terminer l\'ID de la commande'
        });
        return;
    }

    document.getElementById('nouvel_etat_input').value = etat;

    // Titre et couleur selon l'√©tat
    let titre = '';
    let couleur = '';
    let icone = '';

    switch(etat) {
        case 'Retourn√©e':
            titre = 'Retourner la Commande';
            couleur = 'text-red-600';
            icone = 'fa-times-circle';
            break;
        default:
            titre = 'Mettre √† jour l\'√©tat';
            couleur = 'text-gray-600';
            icone = 'fa-edit';
    }

    // Mettre √† jour le titre de la modale
    document.getElementById('savModalTitle').innerHTML = `
        <i class="fas ${icone} ${couleur} mr-2"></i>${titre}
    `;

    // R√©initialiser le formulaire
    document.getElementById('commentaire').value = '';

    // Masquer le champ de commentaire personnalis√©
    const commentairePersonnalise = document.getElementById('commentairePersonnalise');
    if (commentairePersonnalise) {
        commentairePersonnalise.classList.add('hidden');
    }

    // G√©rer l'affichage des options de commentaire selon l'√©tat
    const optgroupRetours = document.querySelector('.optgroup-retours');
    const optgroupProblemes = document.querySelector('.optgroup-problemes');
    const optgroupCommunication = document.querySelector('.optgroup-communication');
    const optgroupAutres = document.querySelector('.optgroup-autres');

    // Masquer toutes les options par d√©faut
    if (optgroupRetours) optgroupRetours.style.display = 'none';
    if (optgroupProblemes) optgroupProblemes.style.display = 'none';
    if (optgroupCommunication) optgroupCommunication.style.display = 'none';
    if (optgroupAutres) optgroupAutres.style.display = 'none';

    // Afficher les options selon l'√©tat
    switch(etat) {
        case 'Retourn√©e':
            if (optgroupRetours) optgroupRetours.style.display = 'block';
            if (optgroupProblemes) optgroupProblemes.style.display = 'block';
            if (optgroupCommunication) optgroupCommunication.style.display = 'block';
            if (optgroupAutres) optgroupAutres.style.display = 'block';
            break;
    }

    // Ouvrir le modal
    document.getElementById('savModal').classList.remove('hidden');
}

// Fonction pour fermer la modale SAV et r√©initialiser les variables
function fermerModalSav() {
    const actionsModal = document.getElementById('savActionsModal');
    if (actionsModal) {
        actionsModal.classList.add('hidden');
    }
    currentCommandeId = null;
    currentCommandeIdYz = null;
    currentCommandePayement = null;
}

function openSavActionsModal(commandeId, commandeIdYz) {
    try {
        console.log('üîç Debug - openSavActionsModal appel√©e avec:', { commandeId, commandeIdYz });
        currentCommandeId = commandeId;
        currentCommandeIdYz = commandeIdYz;
        console.log('üîç Debug - Variables assign√©es:', { currentCommandeId, currentCommandeIdYz });

        // R√©cup√©rer les donn√©es de la commande depuis le DOM
        const row = document.querySelector(`tr[data-commande-id="${commandeId}"]`);
        if (!row) {
            console.error('Commande non trouv√©e:', commandeId);
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Commande non trouv√©e'
            });
            return;
        }

        // Extraire le statut de paiement depuis la ligne du tableau
        const payementCell = row.querySelector('td:nth-child(8)'); // Colonne statut de paiement
        if (payementCell) {
            const payementSpan = payementCell.querySelector('span');
            if (payementSpan) {
                const payementText = payementSpan.textContent.trim();
                // Logique corrig√©e : si le texte contient "Non Pay√©e" ou "Non pay√©", c'est non pay√©
                if (payementText.includes('Non Pay√©e') || payementText.includes('Non pay√©')) {
                    currentCommandePayement = 'Non pay√©';
                } else if (payementText.includes('Pay√©')) {
                    currentCommandePayement = 'Pay√©';
                } else {
                    currentCommandePayement = 'Non pay√©'; // Par d√©faut
                }
                console.log('üîç Debug - Texte de paiement extrait:', payementText);
                console.log('üîç Debug - Statut interpr√©t√©:', currentCommandePayement);
            }
        }

        // Mettre √† jour l'affichage
        document.getElementById('commandeIdDisplay').textContent = commandeIdYz;

        // G√©rer l'affichage du bouton "Marquer Pay√©" selon le statut
        const marquerPayeBtn = document.getElementById('marquerPayeBtn');
        console.log('üîç Debug - Bouton marquerPayeBtn trouv√©:', marquerPayeBtn);
        console.log('üîç Debug - Statut de paiement:', currentCommandePayement);

        if (marquerPayeBtn) {
            if (currentCommandePayement === 'Pay√©') {
                marquerPayeBtn.style.display = 'none';
                console.log('üîç Debug - Bouton masqu√© (commande pay√©e)');
            } else {
                marquerPayeBtn.style.display = 'block';
                console.log('üîç Debug - Bouton affich√© (commande non pay√©e)');
            }
        } else {
            console.error('‚ùå Debug - Bouton marquerPayeBtn non trouv√© dans le DOM');
        }

        // Afficher la modale
        document.getElementById('savActionsModal').classList.remove('hidden');

    } catch (error) {
        console.error('Erreur lors de l\'ouverture de la modale SAV:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Erreur lors de l\'ouverture de la modale'
        });
    }
}

function marquerCommePaye() {
    console.log('üîç Debug - marquerCommePaye appel√©e avec:', { currentCommandeId, currentCommandeIdYz });

    // Sauvegarder les variables avant de fermer la modale
    const commandeId = currentCommandeId;
    const commandeIdYz = currentCommandeIdYz;

    // Sauvegarder l'ID pour la confirmation
    savedCommandeId = commandeId;

        // Fermer la modale des actions SAV
    fermerModalSav();

    // Initialiser le champ date avec la date actuelle
    const datePaiement = document.getElementById('datePaiement');
    if (datePaiement) {
        const today = new Date().toISOString().split('T')[0];
        datePaiement.value = today;
    }

    // Afficher la modale de confirmation
    document.getElementById('confirmCommandeId').textContent = commandeIdYz;
    document.getElementById('confirmPayeModal').classList.remove('hidden');
}

// Fonction pour confirmer le paiement
function confirmerPaiement() {
    console.log('üîç Debug - confirmerPaiement appel√©e avec savedCommandeId:', savedCommandeId);
    const commandeId = savedCommandeId;

    // R√©cup√©rer la date de paiement
    const datePaiement = document.getElementById('datePaiement').value;
    if (!datePaiement) {
        Swal.fire({
            icon: 'warning',
            title: 'Attention',
            text: 'Veuillez s√©lectionner une date de paiement'
        });
        return;
    }

        // Cr√©er un FormData pour envoyer les donn√©es
        const formData = new FormData();
        formData.append('statut_paiement', 'Pay√©');
        formData.append('date_paiement', datePaiement);

        // Envoyer la requ√™te AJAX
    fetch(`{% url 'operatLogistic:marquer_commande_payee' 0 %}`.replace('0', commandeId), {
            method: 'POST',
            body: formData,
            headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
        .then(data => {
            if (data.success) {
            // Fermer la modale de confirmation
            document.getElementById('confirmPayeModal').classList.add('hidden');

            // Afficher un message de succ√®s plus √©l√©gant
            const successMessage = document.createElement('div');
            successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successMessage.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${data.message || 'Commande marqu√©e comme pay√©e avec succ√®s'}</span>
                </div>
            `;
            document.body.appendChild(successMessage);

            // Supprimer le message apr√®s 3 secondes
            setTimeout(() => {
                successMessage.remove();
            }, 3000);

                // Recharger la page pour mettre √† jour la liste
                setTimeout(() => {
                    location.reload();
            }, 1000);
            } else {
            // Fermer la modale de confirmation
            document.getElementById('confirmPayeModal').classList.add('hidden');
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: data.error
            });
            }
        })
        .catch(error => {
        console.error('Erreur:', error);
        // Fermer la modale de confirmation
        document.getElementById('confirmPayeModal').classList.add('hidden');
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Erreur de r√©seau lors de la mise √† jour du paiement.'
        });
    });
}

// Fonction pour annuler le paiement
function annulerPaiement() {
    console.log('üîç Debug - Fonction annulerPaiement ex√©cut√©e');
    document.getElementById('confirmPayeModal').classList.add('hidden');
    savedCommandeId = null; // R√©initialiser la variable sauvegard√©e
}

// Fonction pour afficher les d√©tails des articles
function afficherDetailsArticles(commandeId, commandeNum) {
    document.getElementById('commandeNumDisplay').textContent = commandeNum;
    
    // R√©cup√©rer les donn√©es de la commande depuis le DOM
    const row = document.querySelector(`tr[data-commande-id="${commandeId}"]`);
    if (!row) {
        console.error('Commande non trouv√©e:', commandeId);
        return;
    }
    
    // Extraire les donn√©es des articles depuis les attributs data
    const articlesLivres = JSON.parse(row.getAttribute('data-articles-livres') || '[]');
    const articlesRetournes = JSON.parse(row.getAttribute('data-articles-retournes') || '[]');
    const commentaire = row.getAttribute('data-commentaire') || '';
    const dateLivraison = row.getAttribute('data-date-livraison') || '';
    const operateur = row.getAttribute('data-operateur') || '';
    
    // Construire le contenu HTML
    let content = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Informations g√©n√©rales -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>Informations de Livraison
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date de livraison partielle :</span>
                        <span class="font-medium">${dateLivraison}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Op√©rateur :</span>
                        <span class="font-medium">${operateur}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total articles :</span>
                        <span class="font-medium">${articlesLivres.length + articlesRetournes.length}</span>
                    </div>
                </div>
            </div>
            
            <!-- Commentaire -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-comment mr-2"></i>Commentaire
                </h4>
                <p class="text-sm text-gray-700">${commentaire || 'Aucun commentaire'}</p>
            </div>
        </div>
    `;
    
    // Section des articles livr√©s
    if (articlesLivres.length > 0) {
        content += `
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <h4 class="font-semibold text-green-800 mb-4 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>Articles Livr√©s Partiellement (${articlesLivres.length})
                </h4>
                <div class="space-y-3">
        `;
        
        articlesLivres.forEach(article => {
            let prix = parseFloat(article.prix_unitaire);
            if (isNaN(prix) || prix === 0) prix = 0.00;
            content += `
                <div class="bg-white p-3 rounded-lg border border-green-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${article.nom}</div>
                            <div class="text-sm text-gray-500">R√©f: ${article.reference}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                ${article.pointure ? `Taille: ${article.pointure} | ` : ''}
                                ${article.couleur ? `Couleur: ${article.couleur}` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">
                                    <i class="fas fa-box-open mr-1"></i>Livr√©
                                </span>
                                <span class="text-lg font-bold text-green-600">${article.quantite_livree}x</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${prix.toFixed(2)} DH</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        content += `
                </div>
            </div>
        `;
    }
    
    // Section des variantes retourn√©es
    if (articlesRetournes.length > 0) {
        content += `
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <h4 class="font-semibold text-orange-800 mb-4 flex items-center">
                    <i class="fas fa-undo mr-2"></i>Variantes Retourn√©es (${articlesRetournes.length})
                </h4>
                <div class="space-y-3">
        `;
        
        articlesRetournes.forEach(article => {
            let badgeStatut = '';
            if (article.statut === 'En attente') {
                badgeStatut = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 ml-2"><i class="fas fa-clock mr-1"></i>En attente</span>`;
            } else if (article.statut === 'R√©int√©gr√© en stock') {
                badgeStatut = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ml-2"><i class="fas fa-check-circle mr-1"></i>R√©int√©gr√©</span>`;
            } else if (article.statut === 'D√©fectueux') {
                badgeStatut = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 ml-2"><i class="fas fa-times-circle mr-1"></i>D√©fectueux</span>`;
            } else {
                badgeStatut = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 ml-2"><i class="fas fa-info-circle mr-1"></i>${article.statut}</span>`;
            }
            let prix = parseFloat(article.prix_unitaire);
            if (isNaN(prix) || prix === 0) prix = 0.00;
            content += `
                <div class="bg-white p-3 rounded-lg border border-orange-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${article.nom} ${badgeStatut}</div>
                            <div class="text-sm text-gray-500">R√©f: ${article.reference}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                ${article.pointure ? `Pointure : ${article.pointure} | ` : ''}
                                ${article.couleur ? `Couleur: ${article.couleur}` : ''}
                            </div>
                            ${article.date_retour ? `<div class="text-xs text-orange-600 mt-1"><i class="fas fa-calendar mr-1"></i>Retourn√©e le: ${article.date_retour}</div>` : ''}
                            ${article.raison ? `<div class="text-xs text-gray-500 mt-1"><i class="fas fa-comment mr-1"></i>${article.raison.substring(0, 50)}${article.raison.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 mr-2">
                                    <i class="fas fa-undo mr-1"></i>Retourn√©e
                                </span>
                                <span class="text-lg font-bold text-orange-600">${article.quantite}x</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${prix.toFixed(2)} DH</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        content += `
                </div>
            </div>
        `;
    }
    
    document.getElementById('articlesDetailsContent').innerHTML = content;
    document.getElementById('articlesDetailsModal').classList.remove('hidden');
}

// Fonction pour fermer la modale des d√©tails
function fermerDetailsArticles() {
    document.getElementById('articlesDetailsModal').classList.add('hidden');
}

// Fonction pour afficher le panier complet
function afficherPanierComplet(commandeId, commandeNum) {
    document.getElementById('panierCommandeNumDisplay').textContent = commandeNum;
    
    // Charger les donn√©es du panier via AJAX
    fetch(`/operateur-logistique/api/commande/${commandeId}/panier/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                afficherContenuPanierComplet(data);
            } else {
                console.error('Erreur:', data.error);
                document.getElementById('panierCompletContent').innerHTML = `
                    <div class="text-center text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Erreur lors du chargement du panier: ${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('panierCompletContent').innerHTML = `
                <div class="text-center text-red-600">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Erreur de r√©seau: ${error.message}</p>
                </div>
            `;
        });
    
    document.getElementById('panierCompletModal').classList.remove('hidden');
}

// Fonction pour afficher le contenu du panier complet
function afficherContenuPanierComplet(data) {
    const commande = data.commande;
    const paniers = data.paniers;
    
    let content = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Informations de la commande -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>Informations de la Commande
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">N¬∞ Commande :</span>
                        <span class="font-medium">${commande.id_yz}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">N¬∞ Commande :</span>
                        <span class="font-medium">${commande.num_cmd || '-'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total :</span>
                        <span class="font-medium">${commande.total_cmd} DH</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Nombre d'articles :</span>
                        <span class="font-medium">${paniers.length}</span>
                    </div>
                </div>
            </div>
            
            <!-- √âtat actuel -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-tag mr-2"></i>√âtat Actuel
                </h4>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Statut :</span>
                        <span class="font-medium">${commande.etat_actuel || 'Non d√©fini'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date de cr√©ation :</span>
                        <span class="font-medium">${commande.date_cmd || '-'}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Section des articles du panier
    if (paniers.length > 0) {
        content += `
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-shopping-cart mr-2"></i>Articles du Panier (${paniers.length})
                </h4>
                <div class="space-y-3">
        `;
        
        paniers.forEach(panier => {
            content += `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${panier.nom}</div>
                            <div class="text-sm text-gray-500">R√©f: ${panier.reference}</div>
                            <div class="text-xs text-gray-400 mt-1">
                                ${panier.pointure ? `Taille: ${panier.pointure} | ` : ''}
                                ${panier.couleur ? `Couleur: ${panier.couleur}` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-gray-600">${panier.quantite}x</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${panier.prix_unitaire} DH</div>
                            <div class="text-sm font-semibold text-blue-600 mt-1">${panier.sous_total} DH</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        content += `
                </div>
            </div>
        `;
    } else {
        content += `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-shopping-cart text-4xl mb-2 opacity-50"></i>
                <p>Aucun article dans le panier</p>
            </div>
        `;
    }
    
    document.getElementById('panierCompletContent').innerHTML = content;
}

// Fonction pour fermer la modale du panier complet
function fermerPanierComplet() {
    document.getElementById('panierCompletModal').classList.add('hidden');
}



document.addEventListener('DOMContentLoaded', function() {
    console.log("Page de commandes livr√©es partiellement charg√©e.");

    // ================== GESTION DE LA MODALE SAV ==================

    // Gestion du select de commentaire
    const commentaireSelect = document.getElementById('commentaire');
    const commentairePersonnalise = document.getElementById('commentairePersonnalise');
    const commentaireCustom = document.getElementById('commentaireCustom');

    if (commentaireSelect && commentairePersonnalise && commentaireCustom) {
        commentaireSelect.addEventListener('change', function() {
            if (this.value === 'Autre motif - voir d√©tails') {
                commentairePersonnalise.classList.remove('hidden');
                commentaireCustom.required = true;
            } else {
                commentairePersonnalise.classList.add('hidden');
                commentaireCustom.required = false;
                commentaireCustom.value = '';
            }
        });
    }

    // Gestion du formulaire SAV
    const savForm = document.getElementById('savForm');
    const confirmSavBtn = document.getElementById('confirmSavBtn');
    const cancelSavBtn = document.getElementById('cancelSavBtn');

    if (confirmSavBtn) {
        confirmSavBtn.addEventListener('click', function(e) {
            // Emp√™cher la soumission classique du formulaire
            e.preventDefault();

            // Validation du formulaire SAV
            const commentaire = document.getElementById('commentaire').value.trim();
            if (commentaire === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Attention',
                    text: 'Le commentaire est obligatoire'
                });
                return;
            }

            // Si "Autre motif" est s√©lectionn√©, v√©rifier le commentaire personnalis√©
            if (commentaire === 'Autre motif - voir d√©tails') {
                const commentaireCustom = document.getElementById('commentaireCustom');
                if (!commentaireCustom || !commentaireCustom.value.trim()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Attention',
                        text: 'Le commentaire personnalis√© est obligatoire pour "Autre motif"'
                    });
                    return;
                }
            }

            // Soumettre le formulaire via AJAX
            const formData = new FormData(savForm);

            // Si un commentaire personnalis√© est fourni, l'ajouter
            if (commentaireCustom && commentaireCustom.value.trim()) {
                formData.set('commentaire', commentaireCustom.value.trim());
            }

            // D√©finir l'URL de soumission avec l'ID de la commande
            const commandeId = currentCommandeId;
            if (!commandeId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de d√©terminer l\'ID de la commande'
                });
                return;
            }

            savForm.action = `/operateur-logistique/commande/${commandeId}/changer-etat-sav/`;

            fetch(savForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Succ√®s',
                        text: data.message
                    });
                    // Fermer la modale SAV
                    document.getElementById('savModal').classList.add('hidden');
                    // Fermer aussi la modale des actions SAV
                    document.getElementById('savActionsModal').classList.add('hidden');
                    // R√©initialiser le formulaire
                    savForm.reset();
                    // Masquer le champ de commentaire personnalis√©
                    const commentairePersonnalise = document.getElementById('commentairePersonnalise');
                    if (commentairePersonnalise) {
                        commentairePersonnalise.classList.add('hidden');
                    }
                    // Pas de redirection - rester sur la m√™me page
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Une erreur est survenue lors de la soumission'
                });
            });
        });
    }

    if (cancelSavBtn) {
        cancelSavBtn.addEventListener('click', function() {
            document.getElementById('savModal').classList.add('hidden');
            savForm.reset();
            // Masquer le champ de commentaire personnalis√©
            const commentairePersonnalise = document.getElementById('commentairePersonnalise');
            if (commentairePersonnalise) {
                commentairePersonnalise.classList.add('hidden');
            }
        });
    }

    // Fermer la modale SAV avec la touche √âchap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const savModal = document.getElementById('savModal');
            if (savModal && !savModal.classList.contains('hidden')) {
                savModal.classList.add('hidden');
                savForm.reset();
                const commentairePersonnalise = document.getElementById('commentairePersonnalise');
                if (commentairePersonnalise) {
                    commentairePersonnalise.classList.add('hidden');
                }
            }
        }
    });

    // ================== FIN GESTION MODALE SAV ==================

    const actionsModal = document.getElementById('savActionsModal');
    const cancelActionsBtn = document.getElementById('cancelSavActionsBtn');

    // Fermer la modale des actions
    if (cancelActionsBtn) {
        cancelActionsBtn.addEventListener('click', fermerModalSav);
    }

    // Fermer les modales si on clique en dehors
    if (actionsModal) {
        actionsModal.addEventListener('click', function(e) {
            if (e.target === actionsModal) {
                fermerModalSav();
            }
        });
    }

    // Fermer la modale avec la touche √âchap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && actionsModal && !actionsModal.classList.contains('hidden')) {
            fermerModalSav();
        }
    });

    // Gestion de la modale des d√©tails des articles
    const articlesDetailsModal = document.getElementById('articlesDetailsModal');
    if (articlesDetailsModal) {
        articlesDetailsModal.addEventListener('click', function(e) {
            if (e.target === articlesDetailsModal) {
                fermerDetailsArticles();
            }
        });
    }

    // Gestion de la modale du panier complet
    const panierCompletModal = document.getElementById('panierCompletModal');
    if (panierCompletModal) {
        panierCompletModal.addEventListener('click', function(e) {
            if (e.target === panierCompletModal) {
                fermerPanierComplet();
            }
        });
    }

    // Gestion de la modale de confirmation de paiement
    const confirmPayeModal = document.getElementById('confirmPayeModal');
    const confirmPayeBtn = document.getElementById('confirmPayeBtn');
    const cancelPayeBtn = document.getElementById('cancelPayeBtn');

    console.log('üîç Debug - √âl√©ments de la modale de confirmation:', {
        confirmPayeModal,
        confirmPayeBtn,
        cancelPayeBtn
    });

    if (confirmPayeBtn) {
        console.log('üîç Debug - Ajout du gestionnaire d\'√©v√©nement pour confirmPayeBtn');
        confirmPayeBtn.addEventListener('click', function(e) {
            console.log('üîç Debug - Clic d√©tect√© sur confirmPayeBtn');
            e.preventDefault();
            e.stopPropagation();
            confirmerPaiement();
        });
    } else {
        console.error('‚ùå Debug - confirmPayeBtn non trouv√© dans le DOM');
    }

    if (cancelPayeBtn) {
        console.log('üîç Debug - Ajout du gestionnaire d\'√©v√©nement pour cancelPayeBtn');
        cancelPayeBtn.addEventListener('click', function(e) {
            console.log('üîç Debug - Clic d√©tect√© sur cancelPayeBtn');
            e.preventDefault();
            e.stopPropagation();
            annulerPaiement();
        });
    } else {
        console.error('‚ùå Debug - cancelPayeBtn non trouv√© dans le DOM');
    }

    if (confirmPayeModal) {
        confirmPayeModal.addEventListener('click', function(e) {
            if (e.target === confirmPayeModal) {
                annulerPaiement();
            }
        });
    }

    // Fermer la modale de confirmation avec la touche √âchap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && confirmPayeModal && !confirmPayeModal.classList.contains('hidden')) {
            annulerPaiement();
        }
    });
});
</script>
{% endblock %}
